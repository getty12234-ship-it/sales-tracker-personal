<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«æ–½ç­–ãƒ„ãƒ¼ãƒ«</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyDky9IIUZNbgFvv5kQFKFyFIMddTBYMBOE",
            authDomain: "sales-tracker-1e15a.firebaseapp.com",
            databaseURL: "https://sales-tracker-1e15a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sales-tracker-1e15a",
            storageBucket: "sales-tracker-1e15a.firebasestorage.app",
            messagingSenderId: "342349456010",
            appId: "1:342349456010:web:a6c08087598bdbccf10373"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const TEAM_ID = 'personal'; // ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«å°‚ç”¨
    </script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', 'Meiryo', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            line-height: 1.5;
            min-height: 100vh;
            position: relative;
        }
        /* å­£ç¯€ã®èƒŒæ™¯ - ã¯ã£ãã‚Šè¦‹ãˆã‚‹å­£ç¯€ãƒ†ãƒ¼ãƒ */
        body.season-1 { background: linear-gradient(180deg, #1a3a5a 0%, #0f172a 30%, #0f172a 100%); } /* 1æœˆï¼šå†¬ */
        body.season-2 { background: linear-gradient(180deg, #4a2040 0%, #0f172a 30%, #0f172a 100%); } /* 2æœˆï¼šãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³ */
        body.season-3 { background: linear-gradient(180deg, #2a4a3a 0%, #0f172a 30%, #0f172a 100%); } /* 3æœˆï¼šæ˜¥ */
        body.season-4 { background: linear-gradient(180deg, #4a3045 0%, #0f172a 30%, #0f172a 100%); } /* 4æœˆï¼šæ¡œ */
        body.season-5 { background: linear-gradient(180deg, #2a4a2a 0%, #0f172a 30%, #0f172a 100%); } /* 5æœˆï¼šæ–°ç·‘ */
        body.season-6 { background: linear-gradient(180deg, #2a3a5a 0%, #0f172a 30%, #0f172a 100%); } /* 6æœˆï¼šæ¢…é›¨ */
        body.season-7 { background: linear-gradient(180deg, #2a4a5a 0%, #0f172a 30%, #0f172a 100%); } /* 7æœˆï¼šå¤ */
        body.season-8 { background: linear-gradient(180deg, #3a3a5a 0%, #0f172a 30%, #0f172a 100%); } /* 8æœˆï¼šå¤ç¥­ã‚Š */
        body.season-9 { background: linear-gradient(180deg, #4a3a2a 0%, #0f172a 30%, #0f172a 100%); } /* 9æœˆï¼šç§‹ */
        body.season-10 { background: linear-gradient(180deg, #4a2a1a 0%, #0f172a 30%, #0f172a 100%); } /* 10æœˆï¼šãƒãƒ­ã‚¦ã‚£ãƒ³ */
        body.season-11 { background: linear-gradient(180deg, #4a3520 0%, #0f172a 30%, #0f172a 100%); } /* 11æœˆï¼šç´…è‘‰ */
        body.season-12 { background: linear-gradient(180deg, #2a3550 0%, #0f172a 30%, #0f172a 100%); } /* 12æœˆï¼šã‚¯ãƒªã‚¹ãƒã‚¹ */

        .seasonal-deco {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            font-size: 32px;
            opacity: 0.8;
            text-shadow: 0 2px 12px rgba(0,0,0,0.5);
            animation: float 6s ease-in-out infinite;
        }
        .seasonal-deco:nth-child(odd) { animation-delay: -3s; }
        .seasonal-deco.small { font-size: 22px; opacity: 0.6; }
        .seasonal-deco.large { font-size: 48px; opacity: 0.7; }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }

        .seasonal-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            z-index: 10000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        body.season-1 .seasonal-banner { background: linear-gradient(90deg, #60a5fa, #e0f2fe, #60a5fa); }
        body.season-2 .seasonal-banner { background: linear-gradient(90deg, #f472b6, #fce7f3, #f472b6); }
        body.season-3 .seasonal-banner { background: linear-gradient(90deg, #86efac, #fef3c7, #86efac); }
        body.season-4 .seasonal-banner { background: linear-gradient(90deg, #fbcfe8, #fce7f3, #fbcfe8); }
        body.season-5 .seasonal-banner { background: linear-gradient(90deg, #86efac, #bbf7d0, #86efac); }
        body.season-6 .seasonal-banner { background: linear-gradient(90deg, #93c5fd, #c7d2fe, #93c5fd); }
        body.season-7 .seasonal-banner { background: linear-gradient(90deg, #38bdf8, #67e8f9, #38bdf8); }
        body.season-8 .seasonal-banner { background: linear-gradient(90deg, #c084fc, #fbbf24, #c084fc); }
        body.season-9 .seasonal-banner { background: linear-gradient(90deg, #fb923c, #fcd34d, #fb923c); }
        body.season-10 .seasonal-banner { background: linear-gradient(90deg, #f97316, #a855f7, #f97316); }
        body.season-11 .seasonal-banner { background: linear-gradient(90deg, #f59e0b, #dc2626, #f59e0b); }
        body.season-12 .seasonal-banner { background: linear-gradient(90deg, #ef4444, #22c55e, #ef4444); }

        /* å­£ç¯€ã”ã¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚«ãƒ©ãƒ¼ */
        body.season-1 header { background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); }
        body.season-2 header { background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); }
        body.season-3 header { background: linear-gradient(135deg, #10b981 0%, #6ee7b7 100%); }
        body.season-4 header { background: linear-gradient(135deg, #ec4899 0%, #fbcfe8 100%); }
        body.season-5 header { background: linear-gradient(135deg, #22c55e 0%, #86efac 100%); }
        body.season-6 header { background: linear-gradient(135deg, #6366f1 0%, #a5b4fc 100%); }
        body.season-7 header { background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%); }
        body.season-8 header { background: linear-gradient(135deg, #8b5cf6 0%, #fbbf24 100%); }
        body.season-9 header { background: linear-gradient(135deg, #f97316 0%, #fbbf24 100%); }
        body.season-10 header { background: linear-gradient(135deg, #f97316 0%, #a855f7 100%); }
        body.season-11 header { background: linear-gradient(135deg, #dc2626 0%, #f59e0b 100%); }
        body.season-12 header { background: linear-gradient(135deg, #dc2626 0%, #22c55e 100%); }

        .container { max-width: 1800px; margin: 0 auto; padding: 16px; position: relative; z-index: 1; }

        header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            padding: 20px 24px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        header h1 { font-size: 22px; font-weight: 700; }
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 6px;
        }
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
        }
        .sync-dot.offline { background: #ef4444; }
        .sync-dot.syncing { background: #eab308; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .header-controls { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }

        .member-selector {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 8px;
        }
        .member-selector select {
            background: transparent;
            border: none;
            color: white;
            font-size: 14px;
            font-weight: 600;
            padding: 6px 24px 6px 8px;
            cursor: pointer;
            min-width: 120px;
        }
        .member-selector select option {
            background: #1e293b;
            color: white;
        }

        .period-toggle {
            display: flex;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            overflow: hidden;
        }
        .period-btn {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.7);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }
        .period-btn:hover { color: white; }
        .period-btn.active {
            background: rgba(255,255,255,0.25);
            color: white;
        }

        .week-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.15);
            padding: 6px 14px;
            border-radius: 8px;
        }
        .week-nav.hidden { display: none; }
        .week-nav button {
            background: none; border: none; color: white;
            font-size: 18px; cursor: pointer; padding: 4px 8px;
        }
        .week-nav span { font-size: 14px; font-weight: 600; min-width: 200px; text-align: center; }

        select, input[type="text"], input[type="number"], input[type="date"] {
            background: #1e293b;
            border: 1px solid #334155;
            color: #e2e8f0;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 13px;
        }
        select:focus, input:focus, textarea:focus { outline: none; border-color: #6366f1; }
        textarea {
            background: #1e293b;
            border: 1px solid #334155;
            color: #e2e8f0;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 13px;
            resize: vertical;
            font-family: inherit;
        }

        .tabs {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            background: #0f172a;
            padding: 6px;
            border-radius: 12px;
            border: 1px solid #334155;
        }
        .tab {
            flex: 1;
            min-width: 100px;
            padding: 16px 20px;
            background: transparent;
            border: none;
            color: #94a3b8;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            white-space: nowrap;
            transition: all 0.2s;
            text-align: center;
        }
        .tab:hover { background: #1e293b; color: #e2e8f0; }
        .tab.active { background: #6366f1; color: white; box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .section {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid #334155;
        }
        .section h2 { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
        .section h3 { font-size: 14px; font-weight: 600; color: #94a3b8; margin: 16px 0 12px; }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        .summary-card {
            background: #0f172a;
            border-radius: 10px;
            padding: 14px;
            border: 1px solid #334155;
        }
        .summary-card h4 {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .summary-card .value { font-size: 26px; font-weight: 700; }
        .summary-card .sub { font-size: 12px; color: #64748b; margin-top: 2px; }
        .summary-card .rate { font-size: 14px; font-weight: 600; }

        .good { color: #22c55e; }
        .warning { color: #eab308; }
        .danger { color: #ef4444; }
        .info { color: #6366f1; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #334155; }
        th {
            background: #0f172a;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            position: sticky;
            top: 0;
        }
        tr:hover { background: rgba(99, 102, 241, 0.08); }
        .table-scroll { overflow-x: auto; max-height: 500px; overflow-y: auto; }

        .input-sm { width: 60px; text-align: center; padding: 4px 6px; font-size: 13px; }
        .input-md { width: 100px; }
        .input-lg { width: 100%; }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary { background: #6366f1; color: white; }
        .btn-primary:hover { background: #4f46e5; }
        .btn-secondary { background: #334155; color: #e2e8f0; }
        .btn-secondary:hover { background: #475569; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }

        .progress-bar {
            width: 100%;
            height: 5px;
            background: #334155;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 4px;
        }
        .progress-bar .fill { height: 100%; border-radius: 3px; }
        .progress-bar .fill.good { background: #22c55e; }
        .progress-bar .fill.warning { background: #eab308; }
        .progress-bar .fill.danger { background: #ef4444; }

        .mini-chart {
            margin-top: 8px;
            height: 40px;
            width: 100%;
        }
        .mini-chart svg {
            width: 100%;
            height: 100%;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }
        .chart-card {
            background: #0f172a;
            border-radius: 10px;
            padding: 14px;
            border: 1px solid #334155;
        }
        .chart-card h4 {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 10px;
        }
        .chart-container {
            position: relative;
            height: 120px;
        }
        .chart-container svg {
            width: 100%;
            height: 100%;
        }
        .chart-legend {
            display: flex;
            gap: 16px;
            margin-top: 8px;
            font-size: 11px;
            color: #64748b;
        }
        .chart-legend span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .legend-line {
            width: 16px;
            height: 2px;
        }
        .legend-line.target {
            background: #64748b;
            background: repeating-linear-gradient(90deg, #64748b 0, #64748b 4px, transparent 4px, transparent 7px);
        }
        .legend-line.actual {
            background: #6366f1;
        }

        .chart-tooltip {
            position: absolute;
            background: #1e293b;
            border: 1px solid #6366f1;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 11px;
            color: #e2e8f0;
            pointer-events: none;
            z-index: 100;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
        }
        .chart-tooltip.show {
            display: block;
        }
        .chart-container svg circle {
            cursor: pointer;
        }

        .daily-header {
            display: grid;
            grid-template-columns: 120px repeat(7, 1fr) 80px;
            gap: 4px;
            margin-bottom: 4px;
            position: sticky;
            top: 0;
            background: #1e293b;
            z-index: 10;
            padding: 8px 0;
        }
        .daily-row {
            display: grid;
            grid-template-columns: 120px repeat(7, 1fr) 80px;
            gap: 4px;
            margin-bottom: 2px;
        }
        .daily-row.sub { padding-left: 20px; grid-template-columns: 100px repeat(7, 1fr) 80px; }
        .daily-cell {
            background: #0f172a;
            border-radius: 4px;
            padding: 6px;
            text-align: center;
            font-size: 12px;
        }
        .daily-cell.header { background: transparent; font-weight: 600; color: #64748b; }
        .daily-cell.label { text-align: left; font-weight: 500; display: flex; align-items: center; }
        .daily-cell.category { background: #334155; font-weight: 600; color: #e2e8f0; }
        .daily-cell.total { background: #334155; font-weight: 600; }
        .daily-cell input {
            width: 100%;
            background: transparent;
            border: 1px solid transparent;
            color: #e2e8f0;
            text-align: center;
            padding: 4px;
            border-radius: 4px;
            font-size: 13px;
        }
        .daily-cell input:hover { border-color: #475569; }
        .daily-cell input:focus { border-color: #6366f1; background: #1e293b; }
        .muchaku-btn {
            padding: 2px 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            color: white;
            transition: opacity 0.2s;
        }
        .muchaku-btn:hover { opacity: 0.8; }
        .muchaku-btn.empty { background: #475569; opacity: 0.5; }
        .muchaku-btn.pending { background: #eab308; }
        .muchaku-btn.done { background: #22c55e; }

        .issue-box {
            background: #0f172a;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 12px;
            border-left: 3px solid #ef4444;
        }
        .issue-box.cause { border-left-color: #eab308; }
        .issue-box label {
            display: block;
            font-size: 11px;
            color: #ef4444;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .issue-box.cause label { color: #eab308; }
        .issue-box input, .issue-box textarea {
            width: 100%;
            background: transparent;
            border: none;
            color: #e2e8f0;
            font-size: 14px;
            padding: 4px 0;
        }

        .cause-action-card {
            background: #0f172a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #334155;
        }
        .cause-action-card.primary { border-color: #eab308; }
        .cause-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .cause-num {
            background: #475569;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }
        .cause-num.primary { background: #eab308; color: #0f172a; }
        .cause-input {
            flex: 1;
            background: transparent;
            border: none;
            border-bottom: 1px solid #334155;
            color: #e2e8f0;
            font-size: 14px;
            padding: 4px 0;
        }
        .cause-input:focus { outline: none; border-bottom-color: #6366f1; }
        .action-row {
            display: grid;
            grid-template-columns: 1fr 100px 120px 30px;
            gap: 8px;
            align-items: center;
            padding: 8px;
            background: #1e293b;
            border-radius: 6px;
            margin-top: 8px;
        }
        .action-row.completed { opacity: 0.5; }
        .action-row input[type="text"] { background: transparent; border: none; color: #e2e8f0; }
        .action-row input[type="checkbox"] { width: 16px; height: 16px; accent-color: #22c55e; }

        .reason-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }
        .reason-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #0f172a;
            border-radius: 6px;
        }
        .reason-item label { font-size: 13px; }
        .reason-item input { width: 50px; text-align: center; }

        .case-item {
            display: grid;
            grid-template-columns: 80px 1fr 1fr 40px;
            gap: 10px;
            padding: 10px;
            background: #0f172a;
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        .kpi-item {
            background: #0f172a;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }
        .kpi-item .label { font-size: 10px; color: #64748b; text-transform: uppercase; margin-bottom: 4px; }
        .kpi-item .value { font-size: 20px; font-weight: 700; }

        .account-section {
            border: 1px solid #334155;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .account-header {
            background: #334155;
            padding: 10px 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .account-header h4 { font-size: 14px; font-weight: 600; }
        .account-body { padding: 14px; display: none; }
        .account-body.open { display: block; }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #334155;
        }
        .modal h3 { font-size: 18px; margin-bottom: 16px; }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; font-size: 13px; color: #94a3b8; margin-bottom: 4px; }
        .form-group input, .form-group select { width: 100%; }
        @keyframes settingsHighlight {
            0% { background: #6366f1; }
            100% { background: #0f172a; }
        }
        .settings-updated {
            animation: settingsHighlight 0.5s ease-out;
        }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

        .goal-table { margin-top: 12px; }
        .goal-row {
            display: grid;
            grid-template-columns: 150px repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 6px;
        }
        .goal-row.header { font-weight: 600; color: #64748b; font-size: 12px; }
        .goal-cell { padding: 8px; background: #0f172a; border-radius: 4px; text-align: center; }
        .goal-cell.label { text-align: left; background: transparent; }

        .setup-guide {
            background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%);
            border: 1px solid #3b82f6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .setup-guide h3 { color: #60a5fa; margin-bottom: 12px; }
        .setup-guide ol { margin-left: 20px; }
        .setup-guide li { margin-bottom: 8px; }
        .setup-guide code {
            background: #0f172a;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .daily-header, .daily-row { grid-template-columns: 100px repeat(7, 50px) 60px; overflow-x: auto; }
        }

        .week-tabs {
            display: flex;
            gap: 4px;
            background: #0f172a;
            padding: 4px;
            border-radius: 8px;
        }
        .week-tab {
            padding: 6px 12px;
            background: transparent;
            border: none;
            color: #64748b;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            white-space: nowrap;
        }
        .week-tab:hover { color: #e2e8f0; background: #334155; }
        .week-tab.active { background: #6366f1; color: white; }

        .display-toggle {
            display: flex;
            gap: 4px;
            background: #0f172a;
            padding: 4px;
            border-radius: 8px;
        }
        .display-toggle .btn { border-radius: 6px; }
        .display-toggle .btn.active { background: #6366f1; color: white; }

        .nippo-day-card {
            background: #0f172a;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #334155;
        }
        .nippo-day-card .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #334155;
        }
        .nippo-day-card .day-title {
            font-size: 16px;
            font-weight: 600;
            color: #e2e8f0;
        }
        .nippo-day-card .member-name {
            font-size: 13px;
            color: #6366f1;
            background: rgba(99,102,241,0.15);
            padding: 4px 10px;
            border-radius: 4px;
        }
        .nippo-block {
            margin-bottom: 16px;
        }
        .nippo-block:last-child { margin-bottom: 0; }
        .nippo-block-label {
            font-size: 12px;
            font-weight: 600;
            color: #94a3b8;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .nippo-block-label .icon { font-size: 14px; }
        .nippo-video-container {
            background: #1e293b;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }
        .nippo-video-container video, .nippo-video-container iframe {
            width: 100%;
            max-height: 200px;
            border-radius: 6px;
        }
        .nippo-video-url {
            width: 100%;
            background: #1e293b;
            border: 1px solid #334155;
            color: #e2e8f0;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 13px;
        }
        .nippo-textarea {
            width: 100%;
            min-height: 80px;
            background: #1e293b;
            border: 1px solid #334155;
            color: #e2e8f0;
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
            resize: vertical;
            font-family: inherit;
        }
        .nippo-textarea:focus { border-color: #6366f1; outline: none; }
        .video-upload-row {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 10px;
            align-items: center;
            padding: 8px;
            background: #0f172a;
            border-radius: 6px;
            margin-bottom: 6px;
        }
        .video-upload-row .date-label {
            font-weight: 500;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="authModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:99999;display:flex;align-items:center;justify-content:center">
        <div style="background:#1e293b;padding:40px;border-radius:16px;text-align:center;max-width:400px;width:90%">
            <h2 style="color:#6366f1;margin-bottom:8px">ğŸ” ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«æ–½ç­–ãƒ„ãƒ¼ãƒ«</h2>
            <p style="color:#94a3b8;font-size:14px;margin-bottom:24px">ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼å°‚ç”¨ãƒšãƒ¼ã‚¸ã§ã™</p>
            <input type="password" id="authPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
                   style="width:100%;padding:12px 16px;font-size:16px;background:#0f172a;border:2px solid #334155;color:#e2e8f0;border-radius:8px;margin-bottom:16px"
                   onkeypress="if(event.key==='Enter')checkPassword()">
            <button onclick="checkPassword()"
                    style="width:100%;padding:12px;font-size:16px;background:#6366f1;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600">
                ãƒ­ã‚°ã‚¤ãƒ³
            </button>
            <p id="authError" style="color:#ef4444;margin-top:12px;font-size:13px;display:none">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</p>
        </div>
    </div>

    <div class="chart-tooltip" id="chartTooltip"></div>
    <div class="container" id="mainContainer" style="display:none">
        <header>
            <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
                <h1>ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«æ–½ç­–ãƒ„ãƒ¼ãƒ«</h1>
                <div class="sync-status">
                    <div class="sync-dot" id="syncDot"></div>
                    <span id="syncText">ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜</span>
                </div>
            </div>
            <div class="header-controls">
                <div class="member-selector">
                    <span style="font-size:12px;color:#94a3b8;margin-right:8px">ãƒ¡ãƒ³ãƒãƒ¼:</span>
                    <select id="memberSelect" onchange="onMemberChange()">
                        <option value="all">å…¨ä½“</option>
                    </select>
                </div>
                <div class="period-toggle">
                    <button class="period-btn active" id="btnWeek" onclick="setViewPeriod('week')">é€±æ¬¡</button>
                    <button class="period-btn" id="btnMonth" onclick="setViewPeriod('month')">å…¨æ—¥</button>
                </div>
                <div class="week-nav" id="weekNav">
                    <button onclick="prevWeek()">â—€</button>
                    <span id="weekLabel">1/17ã€œ1/23ï¼ˆç¬¬3é€±ï¼‰</span>
                    <button onclick="nextWeek()">â–¶</button>
                </div>
                <div class="week-nav" id="monthSelector" style="display:none;">
                    <button onclick="prevMonth()">â—€</button>
                    <span id="monthLabel">2026å¹´1æœˆ</span>
                    <button onclick="nextMonth()">â–¶</button>
                </div>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('summary')">ã‚µãƒãƒªãƒ¼</button>
            <button class="tab" onclick="switchTab('daily')">æ—¥åˆ¥æ•°å­—</button>
            <button class="tab" onclick="switchTab('nippo')">æ—¥å ±</button>
            <button class="tab" onclick="switchTab('review')">æ–½ç­–ã‚·ãƒ¼ãƒˆ</button>
            <button class="tab" onclick="switchTab('instagram')">ã‚¤ãƒ³ã‚¹ã‚¿</button>
            <button class="tab" onclick="switchTab('settings')">è¨­å®š</button>
        </div>

        <!-- ã‚µãƒãƒªãƒ¼ã‚¿ãƒ– -->
        <div id="tab-summary" class="tab-content active">
            <div class="summary-grid">
                <div class="summary-card">
                    <h4>æŠ•ç¨¿æ•°</h4>
                    <div class="value" id="sPost">0</div>
                    <div class="sub">ç›®æ¨™: <span id="sPostGoal">0</span></div>
                    <div class="rate" id="sPostRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="sPostBar"></div></div>
                </div>
                <div class="summary-card">
                    <h4>ã‚¢ãƒç²å¾—</h4>
                    <div class="value" id="sApoGet">0</div>
                    <div class="sub">ç›®æ¨™: <span id="sApoGetGoal">0</span></div>
                    <div class="rate" id="sApoGetRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="sApoGetBar"></div></div>
                </div>
                <div class="summary-card">
                    <h4>ã‚¢ãƒå®Ÿæ–½</h4>
                    <div class="value" id="sApoExec">0</div>
                    <div class="sub">ç›®æ¨™: <span id="sApoExecGoal">0</span></div>
                    <div class="rate" id="sApoExecRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="sApoExecBar"></div></div>
                </div>
                <div class="summary-card">
                    <h4>å‹•å“¡ç›´ã‚¯ãƒ­ç²å¾—</h4>
                    <div class="value" id="sDoinGet">0</div>
                    <div class="sub">ç›®æ¨™: <span id="sDoinGetGoal">0</span></div>
                    <div class="rate" id="sDoinGetRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="sDoinGetBar"></div></div>
                </div>
                <div class="summary-card">
                    <h4>å‹•å“¡ç›´ã‚¯ãƒ­å®Ÿæ–½</h4>
                    <div class="value" id="sDoinExec">0</div>
                    <div class="sub">ç›®æ¨™: <span id="sDoinExecGoal">0</span></div>
                    <div class="rate" id="sDoinExecRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="sDoinExecBar"></div></div>
                </div>
                <div class="summary-card">
                    <h4>é¢è«‡ç²å¾—</h4>
                    <div class="value" id="sMendan">0</div>
                    <div class="sub">ç›®æ¨™: <span id="sMendanGoal">0</span></div>
                    <div class="rate" id="sMendanRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="sMendanBar"></div></div>
                </div>
                <div class="summary-card">
                    <h4>é¢è«‡å®Ÿæ–½</h4>
                    <div class="value" id="sMendanExec">0</div>
                    <div class="sub">ç›®æ¨™: <span id="sMendanExecGoal">0</span></div>
                    <div class="rate" id="sMendanExecRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="sMendanExecBar"></div></div>
                </div>
                <div class="summary-card">
                    <h4>æˆç´„</h4>
                    <div class="value" id="sSeiyaku">0</div>
                    <div class="sub">ç›®æ¨™: <span id="sSeiyakuGoal">0</span></div>
                    <div class="rate" id="sSeiyakuRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="sSeiyakuBar"></div></div>
                </div>
            </div>

            <div class="section">
                <h2>é€²æ—ã‚°ãƒ©ãƒ•</h2>
                <div class="charts-grid" id="chartsGrid"></div>
            </div>

            <div class="section">
                <h2>ç¢ºèªæ•°å­—ãƒ»é …ç›®ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</h2>
                <div class="kpi-grid">
                    <div class="kpi-item"><div class="label">ç„¡ç€åœ°ç‡</div><div class="value" id="kMuchaku">0%</div></div>
                    <div class="kpi-item"><div class="label">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåˆ°é”ç‡</div><div class="value" id="kTarget">0%</div></div>
                    <div class="kpi-item"><div class="label">NGç‡</div><div class="value" id="kNg">0%</div></div>
                    <div class="kpi-item"><div class="label">ãƒ†ã‚¹ã‚¯ãƒ­ç‡</div><div class="value" id="kTestClose">0%</div></div>
                    <div class="kpi-item"><div class="label">ã‚ªãƒ•ã‚¡ãƒ¼ç‡</div><div class="value" id="kOffer">0%</div></div>
                </div>
            </div>

            <!-- ç„¡ç€åœ°å†…è¨³ -->
            <div class="section">
                <h2>ç„¡ç€åœ°å†…è¨³ <span id="sMuchakuTotal" style="font-size:14px;color:#94a3b8">(0ä»¶)</span></h2>
                <div id="summaryMuchakuBreakdown" class="kpi-grid" style="grid-template-columns:repeat(auto-fit,minmax(100px,1fr))"></div>
            </div>

            <!-- NGç†ç”±å†…è¨³ -->
            <div class="section">
                <h2>NGç†ç”±å†…è¨³ <span id="sNgTotal" style="font-size:14px;color:#94a3b8">(0ä»¶)</span> <button onclick="debugNgData()" style="font-size:10px;padding:2px 6px;background:#ef4444;border:none;color:white;border-radius:4px;cursor:pointer">ãƒ‡ãƒãƒƒã‚°</button></h2>
                <div id="summaryNgBreakdown" class="kpi-grid" style="grid-template-columns:repeat(auto-fit,minmax(120px,1fr))"></div>
            </div>

            <!-- æ®‹æ¡ˆä»¶ãƒ»å‹•å“¡ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»å‹•å“¡å¾Œç„¡ç€åœ°ï¼ˆå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼‰ -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:16px;margin-bottom:16px">
                <div class="section" style="margin-bottom:0">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                        <h2>æ®‹æ¡ˆä»¶ <span id="sCasesCount" style="font-size:14px;color:#94a3b8">(0ä»¶)</span></h2>
                        <button class="btn btn-primary btn-sm" onclick="addCase()">+ è¿½åŠ </button>
                    </div>
                    <div id="caseList" style="max-height:200px;overflow-y:auto"></div>
                </div>
                <div class="section" style="margin-bottom:0">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                        <h2>å‹•å“¡ã‚­ãƒ£ãƒ³ã‚»ãƒ« <span id="sCancelsCount" style="font-size:14px;color:#94a3b8">(0ä»¶)</span></h2>
                        <button class="btn btn-primary btn-sm" onclick="addCancel()">+ è¿½åŠ </button>
                    </div>
                    <div id="cancelList" style="max-height:200px;overflow-y:auto"></div>
                </div>
            </div>

            <div class="section">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <h2>å‹•å“¡å¾Œç„¡ç€åœ° <span id="sDoinMuchakuLabel" style="font-size:14px;color:#94a3b8"></span></h2>
                    <button class="btn btn-primary btn-sm" onclick="addDoinMuchaku()">+ è¿½åŠ </button>
                </div>
                <div id="doinMuchakuList" style="max-height:250px;overflow-y:auto"></div>
            </div>

            <div class="section">
                <h2>ãƒ¡ãƒ³ãƒãƒ¼åˆ¥ã‚µãƒãƒªãƒ¼</h2>
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th>åå‰</th>
                                <th>æŠ•ç¨¿</th>
                                <th>ã‚¢ãƒç²å¾—</th>
                                <th>ã‚¢ãƒå®Ÿæ–½</th>
                                <th>CXL</th>
                                <th>ãƒ†ã‚¹ã‚¯ãƒ­</th>
                                <th>ã‚ªãƒ•ã‚¡ãƒ¼</th>
                                <th>NG</th>
                                <th>ç„¡ç€åœ°</th>
                                <th>å‹•å“¡ç²</th>
                                <th>å‹•å“¡å®Ÿ</th>
                                <th>é¢è«‡ç²</th>
                                <th>é¢è«‡å®Ÿ</th>
                                <th>æˆç´„</th>
                            </tr>
                        </thead>
                        <tbody id="memberTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- æ—¥åˆ¥æ•°å­—ã‚¿ãƒ– -->
        <div id="tab-daily" class="tab-content">
            <div class="section">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px">
                    <h2>æ—¥åˆ¥å…¥åŠ›</h2>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        <button class="btn btn-secondary btn-sm" onclick="exportDailyCsv()">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('dailyCsvImport').click()">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                        <input type="file" id="dailyCsvImport" accept=".csv" style="display:none" onchange="importDailyCsv(event)">
                        <button class="btn btn-primary btn-sm" onclick="document.getElementById('monthCsvImport').click()">æœˆé–“CSVå–è¾¼</button>
                        <input type="file" id="monthCsvImport" accept=".csv" style="display:none" onchange="importMonthCsv(event)">
                    </div>
                </div>
                <div class="table-scroll" style="max-height:none">
                    <div id="dailyInputArea"></div>
                </div>
            </div>
        </div>

        <!-- æ—¥å ±ã‚¿ãƒ– -->
        <div id="tab-nippo" class="tab-content">
            <div class="section">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px">
                    <h2>æ—¥å ±ï¼ˆã‚¤ãƒ³ãƒ—ãƒƒãƒˆå‹•ç”» + ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ + æ„Ÿè¬æ—¥è¨˜ï¼‰</h2>
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                        <div class="week-tabs" id="weekTabs"></div>
                        <p style="font-size:12px;color:#94a3b8;margin:0">â€» ä¸Šéƒ¨ã®ãƒ¡ãƒ³ãƒãƒ¼é¸æŠã§è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ</p>
                    </div>
                </div>
                <div style="margin-bottom:16px;display:flex;gap:8px;flex-wrap:wrap">
                    <button class="btn btn-primary btn-sm" onclick="openVideoUploadModal()">å‹•ç”»ã‚’ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆ1ãƒ¶æœˆåˆ†ï¼‰</button>
                    <button class="btn btn-primary btn-sm" onclick="document.getElementById('videoCsvImport').click()">å‹•ç”»CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                    <input type="file" id="videoCsvImport" accept=".csv" style="display:none" onchange="importVideoCsv(event)">
                    <button class="btn btn-secondary btn-sm" onclick="exportNippoCsv()">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button class="btn btn-secondary btn-sm" onclick="document.getElementById('nippoCsvImport').click()">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                    <input type="file" id="nippoCsvImport" accept=".csv" style="display:none" onchange="importNippoCsv(event)">
                </div>
                <div id="nippoContent"></div>
            </div>
        </div>

        <!-- æ–½ç­–ã‚·ãƒ¼ãƒˆã‚¿ãƒ– -->
        <div id="tab-review" class="tab-content">
            <div style="display:grid;grid-template-columns:350px 1fr;gap:16px;align-items:start">
                <!-- å·¦å´ï¼šã‚µãƒãƒªãƒ¼æƒ…å ±ï¼ˆå›ºå®šï¼‰ -->
                <div style="position:sticky;top:16px;max-height:calc(100vh - 120px);overflow-y:auto">
                    <div class="section" style="margin-bottom:12px;background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);border:1px solid #6366f1">
                        <h2 style="font-size:14px;margin-bottom:12px">æ•°å­—ã‚µãƒãƒªãƒ¼</h2>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
                            <div class="summary-card" style="padding:8px">
                                <h4 style="font-size:9px">æŠ•ç¨¿æ•°</h4>
                                <div class="value" id="rsPost" style="font-size:16px">0</div>
                                <div class="sub" style="font-size:9px">ç›®æ¨™: <span id="rsPostGoal">0</span> <span class="rate" id="rsPostRate" style="font-size:10px"></span></div>
                                <div class="progress-bar" style="height:3px"><div class="fill" id="rsPostBar"></div></div>
                            </div>
                            <div class="summary-card" style="padding:8px">
                                <h4 style="font-size:9px">ã‚¢ãƒç²å¾—</h4>
                                <div class="value" id="rsApoGet" style="font-size:16px">0</div>
                                <div class="sub" style="font-size:9px">ç›®æ¨™: <span id="rsApoGetGoal">0</span> <span class="rate" id="rsApoGetRate" style="font-size:10px"></span></div>
                                <div class="progress-bar" style="height:3px"><div class="fill" id="rsApoGetBar"></div></div>
                            </div>
                            <div class="summary-card" style="padding:8px">
                                <h4 style="font-size:9px">ã‚¢ãƒå®Ÿæ–½</h4>
                                <div class="value" id="rsApoExec" style="font-size:16px">0</div>
                                <div class="sub" style="font-size:9px">ç›®æ¨™: <span id="rsApoExecGoal">0</span> <span class="rate" id="rsApoExecRate" style="font-size:10px"></span></div>
                                <div class="progress-bar" style="height:3px"><div class="fill" id="rsApoExecBar"></div></div>
                            </div>
                            <div class="summary-card" style="padding:8px">
                                <h4 style="font-size:9px">å‹•å“¡ç²å¾—</h4>
                                <div class="value" id="rsDoinGet" style="font-size:16px">0</div>
                                <div class="sub" style="font-size:9px">ç›®æ¨™: <span id="rsDoinGetGoal">0</span> <span class="rate" id="rsDoinGetRate" style="font-size:10px"></span></div>
                                <div class="progress-bar" style="height:3px"><div class="fill" id="rsDoinGetBar"></div></div>
                            </div>
                            <div class="summary-card" style="padding:8px">
                                <h4 style="font-size:9px">å‹•å“¡å®Ÿæ–½</h4>
                                <div class="value" id="rsDoinExec" style="font-size:16px">0</div>
                                <div class="sub" style="font-size:9px">ç›®æ¨™: <span id="rsDoinExecGoal">0</span> <span class="rate" id="rsDoinExecRate" style="font-size:10px"></span></div>
                                <div class="progress-bar" style="height:3px"><div class="fill" id="rsDoinExecBar"></div></div>
                            </div>
                            <div class="summary-card" style="padding:8px">
                                <h4 style="font-size:9px">é¢è«‡ç²å¾—</h4>
                                <div class="value" id="rsMendanGet" style="font-size:16px">0</div>
                                <div class="sub" style="font-size:9px">ç›®æ¨™: <span id="rsMendanGetGoal">0</span> <span class="rate" id="rsMendanGetRate" style="font-size:10px"></span></div>
                                <div class="progress-bar" style="height:3px"><div class="fill" id="rsMendanGetBar"></div></div>
                            </div>
                            <div class="summary-card" style="padding:8px">
                                <h4 style="font-size:9px">é¢è«‡å®Ÿæ–½</h4>
                                <div class="value" id="rsMendanExec" style="font-size:16px">0</div>
                                <div class="sub" style="font-size:9px">ç›®æ¨™: <span id="rsMendanExecGoal">0</span> <span class="rate" id="rsMendanExecRate" style="font-size:10px"></span></div>
                                <div class="progress-bar" style="height:3px"><div class="fill" id="rsMendanExecBar"></div></div>
                            </div>
                            <div class="summary-card" style="padding:8px">
                                <h4 style="font-size:9px">æˆç´„</h4>
                                <div class="value" id="rsSeiyaku" style="font-size:16px">0</div>
                                <div class="sub" style="font-size:9px">ç›®æ¨™: <span id="rsSeiyakuGoal">0</span> <span class="rate" id="rsSeiyakuRate" style="font-size:10px"></span></div>
                                <div class="progress-bar" style="height:3px"><div class="fill" id="rsSeiyakuBar"></div></div>
                            </div>
                        </div>
                        <div class="kpi-grid" style="grid-template-columns:repeat(2,1fr);gap:6px">
                            <div class="kpi-item" style="padding:6px"><div class="label" style="font-size:8px">ç„¡ç€åœ°ç‡</div><div class="value" id="rsMuchaku" style="font-size:13px">0%</div></div>
                            <div class="kpi-item" style="padding:6px"><div class="label" style="font-size:8px">NGç‡</div><div class="value" id="rsNg" style="font-size:13px">0%</div></div>
                            <div class="kpi-item" style="padding:6px"><div class="label" style="font-size:8px">ãƒ†ã‚¹ã‚¯ãƒ­ç‡</div><div class="value" id="rsTestClose" style="font-size:13px">0%</div></div>
                            <div class="kpi-item" style="padding:6px"><div class="label" style="font-size:8px">ã‚ªãƒ•ã‚¡ãƒ¼ç‡</div><div class="value" id="rsOffer" style="font-size:13px">0%</div></div>
                            <div class="kpi-item" style="padding:6px"><div class="label" style="font-size:8px">å‹•å“¡ç‡</div><div class="value" id="rsDoinRate" style="font-size:13px">0%</div></div>
                            <div class="kpi-item" style="padding:6px"><div class="label" style="font-size:8px">æˆç´„ç‡</div><div class="value" id="rsSeiyakuRate" style="font-size:13px">0%</div></div>
                        </div>
                    </div>

                    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ç”¨ã‚°ãƒ©ãƒ• -->
                    <div class="section" style="margin-bottom:12px;padding:12px">
                        <h2 style="font-size:13px;margin-bottom:8px">é€²æ—ã‚°ãƒ©ãƒ•</h2>
                        <div id="reviewChartsGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px"></div>
                    </div>

                    <div class="section" style="margin-bottom:12px;padding:12px">
                        <h2 style="font-size:13px;margin-bottom:8px">ç„¡ç€åœ°å†…è¨³ <span id="rsMuchakuTotal" style="font-size:11px;color:#94a3b8"></span></h2>
                        <div id="rsMuchakuBreakdown" style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:11px;margin-bottom:10px"></div>
                        <div style="background:#0f172a;border-radius:6px;padding:8px;border-left:3px solid #eab308">
                            <div style="font-size:10px;color:#eab308;margin-bottom:4px">æœ€å¤šç†ç”±: <strong id="rsTopReason">-</strong></div>
                            <div style="font-size:10px;color:#94a3b8;margin-bottom:4px">å¯¾ç­–:</div>
                            <textarea id="rsTopReasonAction" placeholder="ã“ã®ç†ç”±ã«å¯¾ã™ã‚‹å¯¾ç­–..." style="width:100%;height:50px;font-size:11px;resize:none" onchange="saveTopReasonAction()"></textarea>
                        </div>
                    </div>

                    <div class="section" style="margin-bottom:12px;padding:12px">
                        <h2 style="font-size:13px;margin-bottom:8px">NGç†ç”±å†…è¨³ <span id="rsNgTotal" style="font-size:11px;color:#94a3b8"></span></h2>
                        <div id="rsNgBreakdown" style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:11px"></div>
                    </div>

                    <div class="section" style="margin-bottom:12px;padding:12px">
                        <h2 style="font-size:13px;margin-bottom:8px">æ®‹æ¡ˆä»¶ <span id="rsCasesCount" style="font-size:11px;color:#94a3b8"></span></h2>
                        <div id="rsCasesList" style="max-height:100px;overflow-y:auto;font-size:11px"></div>
                    </div>

                    <div class="section" style="margin-bottom:12px;padding:12px">
                        <h2 style="font-size:13px;margin-bottom:8px">å‹•å“¡ã‚­ãƒ£ãƒ³ã‚»ãƒ« <span id="rsCancelsCount" style="font-size:11px;color:#94a3b8"></span></h2>
                        <div id="rsCancelsList" style="max-height:100px;overflow-y:auto;font-size:11px"></div>
                    </div>

                    <div class="section" style="padding:12px">
                        <h2 style="font-size:13px;margin-bottom:8px">å‹•å“¡å¾Œç„¡ç€åœ° <span id="rsDoinMuchakuCount" style="font-size:11px;color:#94a3b8"></span></h2>
                        <div id="rsDoinMuchakuList" style="max-height:100px;overflow-y:auto;font-size:11px"></div>
                    </div>
                </div>

                <!-- å³å´ï¼šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div>
                    <div class="section">
                        <h2>1ç•ªã®æ•°å­—èª²é¡Œ</h2>
                        <div class="issue-box">
                            <label>æ•°å­—èª²é¡Œ</label>
                            <input type="text" id="mainIssue" placeholder="ä¾‹: å‹•å“¡ç›´ã‚¯ãƒ­ç²å¾—ã«é–¢ã—ã¦ã€æ—¥äºˆç®—ã«å¯¾ã™ã‚‹æ—¥çµæœã®é”æˆç‡ãŒ25%ã¨ä½ã„" onchange="saveReview()">
                        </div>
                        <div class="issue-box cause">
                            <label>åŸå› </label>
                            <input type="text" id="mainCause" placeholder="ä¾‹: ãƒ†ã‚¹ã‚¯ãƒ­ç‡ï¼š40%ã€ã‚ªãƒ•ã‚¡ãƒ¼ç‡9%ã¨ä½ã„" onchange="saveReview()">
                        </div>
                    </div>

                    <div class="section">
                        <h2>1ç•ªã®åŸå› 5ã¤ã¨æ–½ç­–ï¼ˆ1ç•ªã«é»„è‰²ï¼‰</h2>
                        <div id="causeActionList"></div>
                    </div>
                </div><!-- å³å´çµ‚äº† -->
            </div><!-- ã‚°ãƒªãƒƒãƒ‰çµ‚äº† -->
        </div><!-- æ–½ç­–ã‚·ãƒ¼ãƒˆã‚¿ãƒ–çµ‚äº† -->

        <!-- ã‚¤ãƒ³ã‚¹ã‚¿ã‚¿ãƒ– -->
        <div id="tab-instagram" class="tab-content">
            <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé¸æŠ -->
            <div class="section" style="padding: 12px 16px; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <label style="font-size: 14px; font-weight: 600;">åˆ†æå¯¾è±¡:</label>
                        <select id="igAccountSelect" onchange="changeIgAccount()" style="min-width: 200px; padding: 8px 12px;">
                            <option value="all">å…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆè¨ˆ</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="exportInstagramCSV()">ğŸ“Š CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                </div>
            </div>
            <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
            <div class="summary-grid">
                <div class="summary-card">
                    <h4>DMé€ä¿¡æ•°</h4>
                    <div class="value" id="igSend">0</div>
                    <div class="sub">ç›®æ¨™: <span id="igSendGoal">0</span></div>
                    <div class="rate" id="igSendRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="igSendBar"></div></div>
                </div>
                <div class="summary-card">
                    <h4>DMè¿”ä¿¡æ•°</h4>
                    <div class="value" id="igReply">0</div>
                    <div class="sub">ç›®æ¨™: <span id="igReplyGoal">0</span></div>
                    <div class="rate" id="igReplyRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="igReplyBar"></div></div>
                </div>
                <div class="summary-card">
                    <h4>ã‚ªãƒ•ã‚¡ãƒ¼æ•°</h4>
                    <div class="value" id="igOffer">0</div>
                    <div class="sub">ç›®æ¨™: <span id="igOfferGoal">0</span></div>
                    <div class="rate" id="igOfferRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="igOfferBar"></div></div>
                </div>
                <div class="summary-card">
                    <h4>ã‚¢ãƒç²å¾—</h4>
                    <div class="value" id="igApoGet">0</div>
                    <div class="sub">ç›®æ¨™: <span id="igApoGetGoal">0</span></div>
                    <div class="rate" id="igApoGetRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="igApoGetBar"></div></div>
                </div>
                <div class="summary-card">
                    <h4>ã‚¢ãƒå®Ÿæ–½</h4>
                    <div class="value" id="igApoExec">0</div>
                    <div class="sub">ç›®æ¨™: <span id="igApoExecGoal">0</span></div>
                    <div class="rate" id="igApoExecRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="igApoExecBar"></div></div>
                </div>
                <div class="summary-card">
                    <h4>å‹•å“¡å®Ÿæ–½</h4>
                    <div class="value" id="igDoinExec">0</div>
                    <div class="sub">ç›®æ¨™: <span id="igDoinExecGoal">0</span></div>
                    <div class="rate" id="igDoinExecRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="igDoinExecBar"></div></div>
                </div>
                <div class="summary-card">
                    <h4>æˆç´„</h4>
                    <div class="value" id="igSeiyaku">0</div>
                    <div class="sub">ç›®æ¨™: <span id="igSeiyakuGoal">0</span></div>
                    <div class="rate" id="igSeiyakuRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="igSeiyakuBar"></div></div>
                </div>
            </div>

            <!-- é€²æ—ã‚°ãƒ©ãƒ• -->
            <div class="section">
                <h2>é€²æ—ã‚°ãƒ©ãƒ•</h2>
                <div class="charts-grid" id="igChartsGrid"></div>
            </div>

            <!-- KPIãƒ»ãƒ•ã‚¡ãƒãƒ«åˆ†æ -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                <div class="section">
                    <h2>ç¢ºèªæ•°å­—ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</h2>
                    <div class="kpi-grid" style="grid-template-columns:1fr 1fr">
                        <div class="kpi-item"><div class="label">è¿”ä¿¡ç‡</div><div class="value" id="igKpiReply">0%</div></div>
                        <div class="kpi-item"><div class="label">ã‚ªãƒ•ã‚¡ãƒ¼åˆ°é”ç‡</div><div class="value" id="igKpiOfferReach">0%</div></div>
                        <div class="kpi-item"><div class="label">ã‚ªãƒ•ã‚¡ãƒ¼é€šéç‡</div><div class="value" id="igKpiOfferPass">0%</div></div>
                        <div class="kpi-item"><div class="label">ã‚¢ãƒç²å¾—ç‡</div><div class="value" id="igKpiApoGet">0%</div></div>
                        <div class="kpi-item"><div class="label">ã‚¢ãƒå®Ÿæ–½ç‡</div><div class="value" id="igKpiApoExec">0%</div></div>
                        <div class="kpi-item"><div class="label">å‹•å“¡ç‡</div><div class="value" id="igKpiDoin">0%</div></div>
                        <div class="kpi-item"><div class="label">æˆç´„ç‡</div><div class="value" id="igKpiSeiyaku">0%</div></div>
                    </div>
                </div>

                <div class="section">
                    <h2>ãƒ•ã‚¡ãƒãƒ«åˆ†æ</h2>
                    <div id="igFunnel" style="display:flex;flex-direction:column;gap:4px"></div>
                </div>
            </div>

            <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ¥ã‚µãƒãƒªãƒ¼ -->
            <div class="section">
                <h2>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ¥ã‚µãƒãƒªãƒ¼</h2>
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</th>
                                <th>DMé€ä¿¡</th>
                                <th>è¿”ä¿¡</th>
                                <th>ã‚ªãƒ•ã‚¡ãƒ¼</th>
                                <th>ã‚¢ãƒç²</th>
                                <th>ã‚¢ãƒå®Ÿ</th>
                                <th>å‹•å“¡</th>
                                <th>æˆç´„</th>
                                <th>è¿”ä¿¡ç‡</th>
                                <th>æˆç´„ç‡</th>
                            </tr>
                        </thead>
                        <tbody id="igAccountSummaryTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ¥ãƒ‡ãƒ¼ã‚¿å…¥åŠ› -->
            <div class="section">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                    <h2>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ¥ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn-sm" onclick="document.getElementById('igCsvImport').click()" style="background:#059669">ğŸ“¥ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                        <input type="file" id="igCsvImport" accept=".csv" style="display:none" onchange="importInstagramCsv(this.files[0])">
                        <button class="btn btn-primary btn-sm" onclick="addAccount()">+ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¿½åŠ </button>
                    </div>
                </div>
                <div id="accountList"></div>
            </div>
        </div>

        <!-- è¨­å®šã‚¿ãƒ– -->
        <div id="tab-settings" class="tab-content">
            <div class="setup-guide" id="setupGuide">
                <h3>ğŸ”¥ Firebase ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ</h3>
                <p style="margin-bottom:12px">ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•çš„ã«Firebaseã«ä¿å­˜ãƒ»åŒæœŸã•ã‚Œã¾ã™ã€‚</p>
                <div id="firebaseStatus" style="padding:12px;background:#1e3a2f;border-radius:8px;margin-top:12px">
                    <div style="display:flex;align-items:center;gap:8px">
                        <span style="color:#22c55e">â—</span>
                        <span>Firebaseæ¥ç¶šä¸­...</span>
                    </div>
                </div>
            </div>

            <div class="section" style="background:#1e293b;border:2px solid #3b82f6;padding:20px;border-radius:12px">
                <h2 style="color:#3b82f6">ğŸ‘¤ ã‚ãªãŸã¯èª°ã§ã™ã‹ï¼Ÿ</h2>
                <p style="font-size:13px;color:#94a3b8;margin:12px 0">ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨ã®ãŸã‚ã€è‡ªåˆ†ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚åŒæœŸæ™‚ã«ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿è­·ã—ã¾ã™ã€‚</p>
                <div class="form-group">
                    <label>ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼</label>
                    <select id="currentUserSelect" onchange="saveCurrentUser()" style="width:100%;max-width:300px">
                        <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
                    </select>
                </div>
                <div id="currentUserWarning" style="display:none;margin-top:12px;padding:12px;background:#7c2d12;border-left:4px solid #ea580c;border-radius:6px;font-size:12px;color:#fed7aa">
                    âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ã„ã¾ã›ã‚“ã€‚åŒæœŸæ©Ÿèƒ½ã‚’ä½¿ã†å‰ã«å¿…ãšé¸æŠã—ã¦ãã ã•ã„ã€‚
                </div>
            </div>

            <div class="section">
                <h2>ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</h2>
                <div id="memberList" style="margin-top:12px"></div>
                <button class="btn btn-primary" style="margin-top:12px" onclick="openModal('memberModal')">+ ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </button>
            </div>

            <div class="section">
                <h2>ãƒ¡ãƒ³ãƒãƒ¼åˆ¥ æœˆé–“äºˆç®—ãƒ»ç›®æ¨™è¨­å®š</h2>
                <p style="font-size:12px;color:#94a3b8;margin-bottom:12px" id="settingsHint">â€» ä¸Šéƒ¨ã®ãƒ¡ãƒ³ãƒãƒ¼é¸æŠã§è¨­å®šå¯¾è±¡ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™</p>
                <button class="btn" style="background:#6366f1;margin-bottom:12px;font-size:11px" onclick="debugShowSettings()">ğŸ” ãƒ‡ãƒãƒƒã‚°: ãƒ‡ãƒ¼ã‚¿ç¢ºèª</button>

                <div id="settingsEditableArea">
                    <h3 style="font-size:14px;color:#94a3b8;margin-bottom:8px">æœˆé–“äºˆç®—</h3>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px">
                        <div class="form-group"><label>å¿…è¦æŠ•ç¨¿æ•°</label><input type="number" id="bPost" onchange="saveSettings()"></div>
                        <div class="form-group"><label>ã‚¢ãƒç²å¾—</label><input type="number" id="bApoGet" onchange="saveSettings()"></div>
                        <div class="form-group"><label>ã‚¢ãƒå®Ÿæ–½</label><input type="number" id="bApoExec" onchange="saveSettings()"></div>
                        <div class="form-group"><label>å‹•å“¡ç›´ã‚¯ãƒ­ç²å¾—</label><input type="number" id="bDoinGet" onchange="saveSettings()"></div>
                        <div class="form-group"><label>å‹•å“¡ç›´ã‚¯ãƒ­å®Ÿæ–½</label><input type="number" id="bDoinExec" onchange="saveSettings()"></div>
                        <div class="form-group"><label>é¢è«‡ç²å¾—</label><input type="number" id="bMendan" onchange="saveSettings()"></div>
                        <div class="form-group"><label>æˆç´„</label><input type="number" id="bSeiyaku" onchange="saveSettings()"></div>
                    </div>

                    <h3 style="font-size:14px;color:#94a3b8;margin-bottom:8px">æœˆé–“ç›®æ¨™</h3>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
                        <div class="form-group"><label>å¿…è¦æŠ•ç¨¿æ•°</label><input type="number" id="mPost" onchange="saveSettings()"></div>
                        <div class="form-group"><label>ã‚¢ãƒç²å¾—</label><input type="number" id="mApoGet" onchange="saveSettings()"></div>
                        <div class="form-group"><label>ã‚¢ãƒå®Ÿæ–½</label><input type="number" id="mApoExec" onchange="saveSettings()"></div>
                        <div class="form-group"><label>å‹•å“¡ç›´ã‚¯ãƒ­ç²å¾—</label><input type="number" id="mDoinGet" onchange="saveSettings()"></div>
                        <div class="form-group"><label>å‹•å“¡ç›´ã‚¯ãƒ­å®Ÿæ–½</label><input type="number" id="mDoinExec" onchange="saveSettings()"></div>
                        <div class="form-group"><label>é¢è«‡ç²å¾—</label><input type="number" id="mMendan" onchange="saveSettings()"></div>
                        <div class="form-group"><label>é¢è«‡å®Ÿæ–½</label><input type="number" id="mMendanExec" onchange="saveSettings()"></div>
                        <div class="form-group"><label>æˆç´„</label><input type="number" id="mSeiyaku" onchange="saveSettings()"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>ã‚¤ãƒ³ã‚¹ã‚¿æœˆé–“ç›®æ¨™è¨­å®š</h2>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px">
                    <div class="form-group"><label>DMé€ä¿¡æ•°</label><input type="number" id="igGoalSend" onchange="saveSettings()"></div>
                    <div class="form-group"><label>DMè¿”ä¿¡æ•°</label><input type="number" id="igGoalReply" onchange="saveSettings()"></div>
                    <div class="form-group"><label>ã‚ªãƒ•ã‚¡ãƒ¼æ•°</label><input type="number" id="igGoalOffer" onchange="saveSettings()"></div>
                    <div class="form-group"><label>ã‚¢ãƒç²å¾—</label><input type="number" id="igGoalApoGet" onchange="saveSettings()"></div>
                    <div class="form-group"><label>ã‚¢ãƒå®Ÿæ–½</label><input type="number" id="igGoalApoExec" onchange="saveSettings()"></div>
                    <div class="form-group"><label>å‹•å“¡å®Ÿæ–½</label><input type="number" id="igGoalDoinExec" onchange="saveSettings()"></div>
                    <div class="form-group"><label>æˆç´„</label><input type="number" id="igGoalSeiyaku" onchange="saveSettings()"></div>
                </div>
            </div>

            <div class="section">
                <h2>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
                    <button class="btn btn-secondary" onclick="exportData()">å…¨ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                    <button class="btn btn-danger" onclick="clearData()">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
                    <button class="btn btn-danger" onclick="resetLocalOnly()">ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="memberModal">
        <div class="modal">
            <h3>ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </h3>
            <div class="form-group">
                <label>åå‰</label>
                <input type="text" id="newMemberName">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('memberModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="addMember()">è¿½åŠ </button>
            </div>
        </div>
    </div>

    <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="accountModal">
        <div class="modal">
            <h3>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¿½åŠ </h3>
            <div class="form-group">
                <label>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå</label>
                <input type="text" id="newAccountName" placeholder="ä¾‹: ã‚†ã‚‹ã‚¤ãƒŒæ¸©æ³‰">
            </div>
            <div class="form-group">
                <label>URLï¼ˆä»»æ„ï¼‰</label>
                <input type="text" id="newAccountUrl" placeholder="https://instagram.com/...">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('accountModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="saveNewAccount()">è¿½åŠ </button>
            </div>
        </div>
    </div>

    <!-- å‹•ç”»ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="videoUploadModal">
        <div class="modal" style="max-width:700px">
            <h3>å‹•ç”»ã‚’ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆ1ãƒ¶æœˆåˆ†ï¼‰</h3>
            <p style="margin-bottom:12px;color:#94a3b8;font-size:13px">å„æ—¥ã®ã‚¤ãƒ³ãƒ—ãƒƒãƒˆå‹•ç”»URLã‚’ã¾ã¨ã‚ã¦è¨­å®šã§ãã¾ã™ã€‚</p>
            <div id="videoUploadList" style="max-height:400px;overflow-y:auto"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('videoUploadModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="saveVideoUrls()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ç„¡ç€åœ°ç†ç”±ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="muchakuModal">
        <div class="modal" style="max-width:450px">
            <h3>ç„¡ç€åœ°ã®ç†ç”± <span id="muchakuModalDate" style="font-size:14px;color:#94a3b8"></span></h3>
            <p style="margin-bottom:16px;color:#94a3b8;font-size:13px">è©²å½“ã™ã‚‹ç†ç”±ã®ä»¶æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            <div id="muchakuReasonInputs" style="display:grid;gap:8px"></div>
            <div class="form-group" style="margin-top:12px">
                <label>ãã®ä»–ã®è©³ç´°ï¼ˆä»»æ„ï¼‰</label>
                <input type="text" id="muchakuOtherNote" placeholder="ãã®ä»–ã®å…·ä½“çš„ãªç†ç”±...">
            </div>
            <div style="margin-top:12px;padding:10px;background:#0f172a;border-radius:6px;display:flex;justify-content:space-between">
                <span>åˆè¨ˆ</span>
                <span><strong id="muchakuReasonTotal">0</strong> / <span id="muchakuTargetCount">0</span></span>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('muchakuModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="saveMuchakuReasons()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- NGç†ç”±ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="ngModal">
        <div class="modal" style="max-width:450px">
            <h3>NGã®ç†ç”± <span id="ngModalDate" style="font-size:14px;color:#94a3b8"></span></h3>
            <p style="margin-bottom:16px;color:#94a3b8;font-size:13px">è©²å½“ã™ã‚‹ç†ç”±ã®ä»¶æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            <div id="ngReasonInputs" style="display:grid;gap:8px"></div>
            <div class="form-group" style="margin-top:12px">
                <label>ãã®ä»–ã®è©³ç´°ï¼ˆä»»æ„ï¼‰</label>
                <input type="text" id="ngOtherNote" placeholder="ãã®ä»–ã®å…·ä½“çš„ãªç†ç”±...">
            </div>
            <div style="margin-top:12px;padding:10px;background:#0f172a;border-radius:6px;display:flex;justify-content:space-between">
                <span>åˆè¨ˆ</span>
                <span><strong id="ngReasonTotal">0</strong> / <span id="ngTargetCount">0</span></span>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('ngModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="saveNgReasons()">ä¿å­˜</button>
            </div>
        </div>
    </div>


    <script>
        // ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
        let data = {
            members: [],
            accounts: [],
            settings: {
                budget: { post: 56, apoGet: 50, apoExec: 46, doinGet: 7, doinExec: 4, mendan: 2, seiyaku: 1 },
                monthly: { post: 56, apoGet: 50, apoExec: 46, doinGet: 7, doinExec: 4, mendan: 2, seiyaku: 1 },
                currentUserId: null // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆãƒ¡ãƒ³ãƒãƒ¼IDï¼‰
            },
            weeks: {},
            monthVideos: {},
            lastUpdated: null // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆãƒ‡ãƒ¼ã‚¿æ›´æ–°æ¤œçŸ¥ç”¨ï¼‰
        };

        // ãƒšãƒ¼ã‚¸çŠ¶æ…‹ã‚’localStorageã‹ã‚‰å¾©å…ƒ
        const savedState = JSON.parse(localStorage.getItem('personalTrackerState') || '{}');
        const now = new Date();
        let currentYear = savedState.year || now.getFullYear();
        let currentMonth = savedState.month || (now.getMonth() + 1);
        let currentWeekNum = savedState.week || 1;
        let selectedMember = savedState.member || 'all';
        let selectedIgAccount = 'all'; // ã‚¤ãƒ³ã‚¹ã‚¿åˆ†æç”¨ã®é¸æŠã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
        let syncStatus = 'local';
        let nippoViewMode = 'all'; // 'all' or 'single'
        let nippoSelectedMember = '';
        let viewPeriod = savedState.viewPeriod || 'week'; // 'week' or 'month'

        // ãƒšãƒ¼ã‚¸çŠ¶æ…‹ã‚’ä¿å­˜
        function savePageState() {
            localStorage.setItem('personalTrackerState', JSON.stringify({
                year: currentYear,
                month: currentMonth,
                week: currentWeekNum,
                member: selectedMember,
                viewPeriod: viewPeriod
            }));
        }

        // æœˆã‚­ãƒ¼ã‚’å–å¾—ï¼ˆä¾‹: "2026-1"ï¼‰
        function getMonthKey() {
            return `${currentYear}-${currentMonth}`;
        }

        const metrics = [
            { cat: 'æŠ•ç¨¿', items: [
                { key: 'post', label: 'æŠ•ç¨¿æ•°' }
            ]},
            { cat: 'LINE', items: [
                { key: 'lineExchange', label: 'LINEäº¤æ›' }
            ]},
            { cat: 'ã‚¢ãƒ', items: [
                { key: 'apoGet', label: 'ç²å¾—' },
                { key: 'apoExec', label: 'å®Ÿæ–½æ•°' },
                { key: 'apoCxl', label: 'CXL' },
                { key: 'testClose', label: 'ãƒ†ã‚¹ã‚¯ãƒ­' },
                { key: 'offer', label: 'ã‚ªãƒ•ã‚¡ãƒ¼' },
                { key: 'ng', label: 'NG' },
                { key: 'muchaku', label: 'ç„¡ç€åœ°' }
            ]},
            { cat: 'å‹•å“¡', items: [
                { key: 'doinGet', label: 'å‹•å“¡ç²å¾—' },
                { key: 'doinGetCxl', label: 'å‹•å“¡ç²å¾—å¾ŒCXL' },
                { key: 'doinExec', label: 'å‹•å“¡å®Ÿæ–½' },
                { key: 'doinExecCxl', label: 'å‹•å“¡å®Ÿæ–½å¾ŒCXL' }
            ]},
            { cat: 'é¢è«‡', items: [
                { key: 'mendanGet', label: 'é¢è«‡ç²å¾—' },
                { key: 'mendanGetCxl', label: 'é¢è«‡ç²å¾—å¾ŒCXL' },
                { key: 'mendanExec', label: 'é¢è«‡å®Ÿæ–½' },
                { key: 'mendanExecCxl', label: 'é¢è«‡å®Ÿæ–½å¾ŒCXL' }
            ]},
            { cat: 'æˆç´„', items: [
                { key: 'seiyaku', label: 'æˆç´„' },
                { key: 'coolingOff', label: 'ã‚¯ãƒ¼ãƒªãƒ³ã‚°ã‚ªãƒ•' }
            ]}
        ];

        const muchakuReasonLabels = ['ã“ã ã‚ã‚ŠãŒå¼·ã„', 'æ¨ªæ§', 'å‹§èª˜ãƒ–ãƒ­ãƒƒã‚¯', 'ä¸å®‰ãŒå¼·ã„', 'ä»Šã˜ã‚ƒãªã„', 'å®Œå…¨å‰¯æ¥­ãƒ‹ãƒ¼ã‚º', 'ãã®ä»–'];
        const ngReasonLabels = ['é‡‘ç­–NG', 'æ—¢å©šNG', 'è·æ¥­NG', 'ã‚¹ã‚¿ãƒ³ã‚¹NG', 'ç²¾ç¥NG'];

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼
        const TEAM_PASSWORD = 'hagamori';

        function checkPassword() {
            const input = document.getElementById('authPassword').value;
            if (input === TEAM_PASSWORD) {
                sessionStorage.setItem('salesTracker_auth_personal', 'true');
                document.getElementById('authModal').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                initApp();
            } else {
                document.getElementById('authError').style.display = 'block';
                document.getElementById('authPassword').value = '';
            }
        }

        async function initApp() {
            loadData();
            setupFirebaseListener();
            updateWeekLabel();
            updateSyncStatus();
            renderAll();
            applySeasonalBackground();
        }

        function checkAuth() {
            // ã“ã®ãƒãƒ¼ãƒ ã®èªè¨¼ã‚­ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
            if (sessionStorage.getItem('salesTracker_auth_personal') === 'true') {
                document.getElementById('authModal').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                return true;
            } else {
                // èªè¨¼ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                document.getElementById('authModal').style.display = 'flex';
                document.getElementById('mainContainer').style.display = 'none';
                document.getElementById('authPassword').focus();
                return false;
            }
        }

        async function init() {
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã§èªè¨¼æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
            if (checkAuth()) {
                initApp();
            }
        }

        // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã§ãƒšãƒ¼ã‚¸ã«æˆ»ã£ãŸæ™‚ã‚‚èªè¨¼ã‚’å†ãƒã‚§ãƒƒã‚¯
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                // bfcacheã‹ã‚‰å¾©å…ƒã•ã‚ŒãŸå ´åˆã€èªè¨¼ã‚’å†ãƒã‚§ãƒƒã‚¯
                checkAuth();
            }
        });

        function applySeasonalBackground() {
            // ç¾åœ¨ã®æœˆã«åŸºã¥ã„ã¦å­£ç¯€ã®èƒŒæ™¯ã‚’é©ç”¨
            const month = currentMonth;
            document.body.className = `season-${month}`;

            // æ—¢å­˜ã®è£…é£¾ã‚’å‰Šé™¤
            document.querySelectorAll('.seasonal-deco, .seasonal-banner').forEach(el => el.remove());

            // å­£ç¯€ãƒãƒŠãƒ¼ã‚’è¿½åŠ 
            const banner = document.createElement('div');
            banner.className = 'seasonal-banner';
            document.body.appendChild(banner);

            // æœˆã”ã¨ã®çµµæ–‡å­—ã¨é…ç½®
            const seasonConfig = {
                1: { emojis: ['â›„', 'â„ï¸', 'ğŸ', 'âœ¨', 'ğŸŒ¨ï¸'], name: 'å†¬' },
                2: { emojis: ['ğŸ’', 'ğŸ’•', 'ğŸ«', 'ğŸ’–', 'ğŸŒ¹'], name: 'ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³' },
                3: { emojis: ['ğŸŒ¸', 'ğŸ', 'ğŸŒ·', 'ğŸ', 'ğŸ¦‹'], name: 'æ˜¥' },
                4: { emojis: ['ğŸŒ¸', 'ğŸŒ·', 'ğŸ', 'ğŸ¦‹', 'ğŸŒ¼'], name: 'æ¡œ' },
                5: { emojis: ['ğŸŒ¿', 'ğŸƒ', 'ğŸŒ»', 'ğŸŒº', 'ğŸ'], name: 'æ–°ç·‘' },
                6: { emojis: ['â˜”', 'ğŸ¸', 'ğŸ’§', 'ğŸŒ§ï¸', 'â˜‚ï¸'], name: 'æ¢…é›¨' },
                7: { emojis: ['ğŸŒŠ', 'ğŸ‰', 'â›±ï¸', 'ğŸš', 'ğŸ¦€'], name: 'å¤' },
                8: { emojis: ['ğŸ†', 'ğŸ‡', 'ğŸ§', 'ğŸ', 'ğŸ¨'], name: 'å¤ç¥­ã‚Š' },
                9: { emojis: ['ğŸ‚', 'ğŸŒ¾', 'ğŸ‘', 'ğŸ', 'ğŸŒ°'], name: 'ç§‹' },
                10: { emojis: ['ğŸƒ', 'ğŸ‘»', 'ğŸ¦‡', 'ğŸ•·ï¸', 'ğŸ¬'], name: 'ãƒãƒ­ã‚¦ã‚£ãƒ³' },
                11: { emojis: ['ğŸ', 'ğŸ‚', 'ğŸ¦ƒ', 'ğŸŒ°', 'ğŸ„'], name: 'ç´…è‘‰' },
                12: { emojis: ['ğŸ„', 'â›„', 'ğŸ…', 'ğŸ', 'â­'], name: 'ã‚¯ãƒªã‚¹ãƒã‚¹' }
            };

            const config = seasonConfig[month] || { emojis: ['âœ¨'], name: '' };

            // è£…é£¾ã®é…ç½®ä½ç½®ï¼ˆç”»é¢ã®ç«¯ã«æ•£ã‚Šã°ã‚ã‚‹ï¼‰
            const positions = [
                { top: '80px', left: '15px', size: 'large' },
                { top: '120px', right: '20px', size: 'normal' },
                { top: '200px', left: '25px', size: 'small' },
                { top: '280px', right: '15px', size: 'normal' },
                { top: '380px', left: '10px', size: 'normal' },
                { top: '450px', right: '25px', size: 'small' },
                { top: '550px', left: '20px', size: 'small' },
                { bottom: '250px', right: '15px', size: 'normal' },
                { bottom: '150px', left: '15px', size: 'large' },
                { bottom: '80px', right: '20px', size: 'small' },
            ];

            positions.forEach((pos, i) => {
                const emoji = config.emojis[i % config.emojis.length];
                const deco = document.createElement('div');
                deco.className = `seasonal-deco ${pos.size === 'small' ? 'small' : pos.size === 'large' ? 'large' : ''}`;
                deco.textContent = emoji;
                if (pos.top) deco.style.top = pos.top;
                if (pos.bottom) deco.style.bottom = pos.bottom;
                if (pos.left) deco.style.left = pos.left;
                if (pos.right) deco.style.right = pos.right;
                deco.style.animationDelay = `${i * 0.3}s`;
                document.body.appendChild(deco);
            });
        }

        function getWeekKey() { return `${currentYear}-${currentMonth}-W${currentWeekNum}`; }

        function getWeekData() {
            const k = getWeekKey();
            if (!data.weeks[k]) {
                data.weeks[k] = {
                    daily: {},
                    review: {
                        mainIssue: '', mainCause: '',
                        causeActions: [
                            { cause: '', actions: [] },
                            { cause: '', actions: [] },
                            { cause: '', actions: [] },
                            { cause: '', actions: [] },
                            { cause: '', actions: [] }
                        ],
                        muchakuReasons: {},
                        muchakuOther: '',
                        ngReasons: {},
                        doinMuchakuList: [],
                        cases: [],
                        cancels: []
                    },
                    instagram: {},
                    nippo: {}
                };
            }
            if (!data.weeks[k].nippo) data.weeks[k].nippo = {};
            if (!data.weeks[k].instagram) data.weeks[k].instagram = {};
            if (!data.weeks[k].review) data.weeks[k].review = {
                mainIssue: '', mainCause: '',
                causeActions: [
                    { cause: '', actions: [] },
                    { cause: '', actions: [] },
                    { cause: '', actions: [] },
                    { cause: '', actions: [] },
                    { cause: '', actions: [] }
                ],
                muchakuReasons: {},
                muchakuOther: '',
                ngReasons: {},
                doinMuchakuList: [],
                cases: [],
                cancels: []
            };
            return data.weeks[k];
        }

        function getNippoData(memberId, dayIndex) {
            const w = getWeekData();
            const key = `${memberId}_${dayIndex}`;
            if (!w.nippo[key]) {
                w.nippo[key] = { videoUrl: '', output: '', gratitude: '' };
            }
            return w.nippo[key];
        }

        function getMonthVideos() {
            const monthKey = `${currentYear}-${currentMonth}`;
            if (!data.monthVideos) data.monthVideos = {};
            if (!data.monthVideos[monthKey]) data.monthVideos[monthKey] = {};
            return data.monthVideos[monthKey];
        }

        function getMemberDaily(memberId) {
            const w = getWeekData();
            if (!w.daily) w.daily = {};
            if (!w.daily[memberId]) {
                w.daily[memberId] = {};
                metrics.forEach(c => c.items.forEach(m => { w.daily[memberId][m.key] = [0,0,0,0,0,0,0]; }));
            }
            return w.daily[memberId];
        }

        function getAccountData(accountId) {
            const w = getWeekData();
            if (!w.instagram[accountId]) {
                w.instagram[accountId] = {
                    follow: [0,0,0,0,0,0,0], follower: [0,0,0,0,0,0,0],
                    followCut: [0,0,0,0,0,0,0], followerCut: [0,0,0,0,0,0,0],
                    dmSend: [0,0,0,0,0,0,0], dmReply: [0,0,0,0,0,0,0], dmOffer: [0,0,0,0,0,0,0],
                    apoGet: [0,0,0,0,0,0,0], apoExec: [0,0,0,0,0,0,0],
                    doinPlan: [0,0,0,0,0,0,0], doinExec: [0,0,0,0,0,0,0],
                    seiyaku: [0,0,0,0,0,0,0], blocked: [false,false,false,false,false,false,false]
                };
            }
            return w.instagram[accountId];
        }

        function getWeekDates() {
            const firstDayOfMonth = new Date(currentYear, currentMonth - 1, 1);
            const dow = (firstDayOfMonth.getDay() + 1) % 7;
            const weekStart = 1 - dow + (currentWeekNum - 1) * 7;
            const dates = [];
            for (let i = 0; i < 7; i++) {
                dates.push(new Date(currentYear, currentMonth - 1, weekStart + i));
            }
            return dates;
        }

        function updateWeekLabel() {
            const dates = getWeekDates();
            const startDate = dates[0];
            const endDate = dates[6];
            document.getElementById('weekLabel').textContent = `${startDate.getMonth()+1}/${startDate.getDate()}ã€œ${endDate.getMonth()+1}/${endDate.getDate()}ï¼ˆç¬¬${currentWeekNum}é€±ï¼‰`;
        }

        function updateMonthLabel() {
            const el = document.getElementById('monthLabel');
            if (el) el.textContent = `${currentYear}å¹´${currentMonth}æœˆ`;
        }

        function updateSyncStatus() {
            const dot = document.getElementById('syncDot');
            const text = document.getElementById('syncText');
            if (firebaseInitialized) {
                dot.className = 'sync-dot';
                text.textContent = 'ğŸ”¥ FirebaseåŒæœŸä¸­';
            } else {
                dot.className = 'sync-dot syncing';
                text.textContent = 'æ¥ç¶šä¸­...';
            }
        }

        function prevWeek() {
            saveAll();
            currentWeekNum--;
            if (currentWeekNum < 1) {
                currentMonth--;
                if (currentMonth < 1) { currentMonth = 12; currentYear--; }
                currentWeekNum = 5;
            }
            savePageState();
            updateWeekLabel(); renderAll(); applySeasonalBackground();
        }

        function nextWeek() {
            saveAll();
            currentWeekNum++;
            if (currentWeekNum > 5) {
                currentMonth++;
                if (currentMonth > 12) { currentMonth = 1; currentYear++; }
                currentWeekNum = 1;
            }
            savePageState();
            updateWeekLabel(); renderAll(); applySeasonalBackground();
        }

        function prevMonth() {
            saveAll();
            currentMonth--;
            if (currentMonth < 1) { currentMonth = 12; currentYear--; }
            currentWeekNum = 1;
            savePageState();
            updateMonthLabel(); renderAll(); applySeasonalBackground();
        }

        function nextMonth() {
            saveAll();
            currentMonth++;
            if (currentMonth > 12) { currentMonth = 1; currentYear++; }
            currentWeekNum = 1;
            savePageState();
            updateMonthLabel(); renderAll(); applySeasonalBackground();
        }

        function setViewPeriod(period) {
            viewPeriod = period;
            document.getElementById('btnWeek').className = 'period-btn' + (period === 'week' ? ' active' : '');
            document.getElementById('btnMonth').className = 'period-btn' + (period === 'month' ? ' active' : '');
            document.getElementById('weekNav').style.display = period === 'month' ? 'none' : 'flex';
            document.getElementById('monthSelector').style.display = period === 'month' ? 'flex' : 'none';
            savePageState();
            updateMonthLabel();
            renderAll();
        }

        function switchTab(id) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${id}')"]`).classList.add('active');
            document.getElementById(`tab-${id}`).classList.add('active');
            // è¨­å®šã‚¿ãƒ–ãŒé–‹ã‹ã‚ŒãŸã¨ãã«renderSettingsã‚’å†å‘¼ã³å‡ºã—
            if (id === 'settings') {
                renderSettings();
            }
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function onMemberChange() {
            selectedMember = document.getElementById('memberSelect').value;
            savePageState();
            // å…¨ã¦ã®ã‚¿ãƒ–ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            renderAll();
            // è¨­å®šã‚¿ãƒ–ã®ãƒ¡ãƒ³ãƒãƒ¼é¸æŠã‚‚åŒæœŸ
            settingsSelectedMember = selectedMember;
        }

        // ãƒãƒ£ãƒ¼ãƒˆãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
        function showChartTooltip(event) {
            const tooltip = document.getElementById('chartTooltip');
            const label = event.target.getAttribute('data-label');
            const value = event.target.getAttribute('data-value');
            const target = event.target.getAttribute('data-target');

            tooltip.innerHTML = `<strong>${label}</strong><br>å®Ÿç¸¾: ${value}<br>ç›®æ¨™: ${target}`;
            tooltip.classList.add('show');

            const rect = event.target.getBoundingClientRect();
            tooltip.style.left = (rect.left + window.scrollX - 30) + 'px';
            tooltip.style.top = (rect.top + window.scrollY - 60) + 'px';
        }

        function hideChartTooltip() {
            document.getElementById('chartTooltip').classList.remove('show');
        }

        function renderAll() {
            try { renderMemberSelect(); } catch(e) { console.error('renderMemberSelect:', e.message); }
            try { renderSummary(); } catch(e) { console.error('renderSummary:', e.message); }
            try { renderMemberTable(); } catch(e) { console.error('renderMemberTable:', e.message); }
            try { renderDailyInput(); } catch(e) { console.error('renderDailyInput:', e.message); }
            try { renderNippo(); } catch(e) { console.error('renderNippo:', e.message); }
            try { renderReview(); } catch(e) { console.error('renderReview:', e.message); }
            try { renderInstagram(); } catch(e) { console.error('renderInstagram:', e.message); }
            try { renderSettings(); } catch(e) { console.error('renderSettings:', e.message); }
        }

        function renderMemberSelect() {
            const sel = document.getElementById('memberSelect');
            sel.innerHTML = '<option value="all">å…¨ä½“</option>' + data.members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            sel.value = selectedMember;
        }

        function calcTotals() {
            const t = {};
            metrics.forEach(c => c.items.forEach(m => t[m.key] = 0));
            const members = selectedMember === 'all' ? data.members : data.members.filter(m => m.id === selectedMember);

            if (viewPeriod === 'month') {
                for (let w = 1; w <= 5; w++) {
                    const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                    if (data.weeks[weekKey]) {
                        members.forEach(m => {
                            const d = data.weeks[weekKey].daily[m.id];
                            if (d) {
                                metrics.forEach(c => c.items.forEach(met => {
                                    t[met.key] += (d[met.key] || [0,0,0,0,0,0,0]).reduce((a,b)=>a+b,0);
                                }));
                            }
                        });
                    }
                }
            } else {
                members.forEach(m => {
                    const d = getMemberDaily(m.id);
                    metrics.forEach(c => c.items.forEach(met => {
                        t[met.key] += (d[met.key] || [0,0,0,0,0,0,0]).reduce((a,b)=>a+b,0);
                    }));
                });
            }
            return t;
        }

        function calcMemberTotals(memberId) {
            const t = {};
            metrics.forEach(c => c.items.forEach(m => t[m.key] = 0));

            if (viewPeriod === 'month') {
                for (let w = 1; w <= 5; w++) {
                    const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                    if (data.weeks[weekKey] && data.weeks[weekKey].daily[memberId]) {
                        const d = data.weeks[weekKey].daily[memberId];
                        metrics.forEach(c => c.items.forEach(met => {
                            t[met.key] += (d[met.key] || [0,0,0,0,0,0,0]).reduce((a,b)=>a+b,0);
                        }));
                    }
                }
            } else {
                const d = getMemberDaily(memberId);
                metrics.forEach(c => c.items.forEach(met => {
                    t[met.key] += (d[met.key] || [0,0,0,0,0,0,0]).reduce((a,b)=>a+b,0);
                }));
            }
            return t;
        }

        function pct(a, b) { return b > 0 ? Math.round((a / b) * 100) + '%' : '-'; }
        function pctNum(a, b) { return b > 0 ? Math.round((a / b) * 100) : 0; }

        function setRateDisplay(rateId, barId, actual, goal) {
            const rate = pctNum(actual, goal);
            const cls = rate >= 100 ? 'good' : rate >= 70 ? 'warning' : 'danger';
            document.getElementById(rateId).textContent = rate + '%';
            document.getElementById(rateId).className = 'rate ' + cls;
            const bar = document.getElementById(barId);
            bar.style.width = Math.min(rate, 100) + '%';
            bar.className = 'fill ' + cls;
        }

        function renderSummary() {
            const t = calcTotals();

            // ãƒ¡ãƒ³ãƒãƒ¼åˆ¥ã®ç›®æ¨™ã‚’å–å¾—
            let g = {};
            if (selectedMember === 'all') {
                // å…¨ä½“é¸æŠæ™‚ï¼šå…¨ãƒ¡ãƒ³ãƒãƒ¼ã®ç›®æ¨™ã‚’åˆè¨ˆ
                data.members.forEach(m => {
                    const memberGoals = getMemberGoals(m.id);
                    g.post = (g.post || 0) + (memberGoals.post || 0);
                    g.apoGet = (g.apoGet || 0) + (memberGoals.apoGet || 0);
                    g.apoExec = (g.apoExec || 0) + (memberGoals.apoExec || 0);
                    g.doinGet = (g.doinGet || 0) + (memberGoals.doinGet || 0);
                    g.doinExec = (g.doinExec || 0) + (memberGoals.doinExec || 0);
                    g.mendan = (g.mendan || 0) + (memberGoals.mendan || 0);
                    g.mendanExec = (g.mendanExec || 0) + (memberGoals.mendanExec || 0);
                    g.seiyaku = (g.seiyaku || 0) + (memberGoals.seiyaku || 0);
                });
            } else {
                // å€‹åˆ¥ãƒ¡ãƒ³ãƒãƒ¼é¸æŠæ™‚ï¼šãã®ãƒ¡ãƒ³ãƒãƒ¼ã®ç›®æ¨™
                g = getMemberGoals(selectedMember);
            }
            console.log('ğŸ“Š renderSummary - selectedMember:', selectedMember, 'ç›®æ¨™:', JSON.stringify(g));

            // ä»Šæ—¥ã¾ã§ã«é”æˆã™ã¹ãç›®æ¨™ã‚’è¨ˆç®—
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const today = new Date();
            const currentDay = (today.getFullYear() === currentYear && today.getMonth() + 1 === currentMonth)
                ? today.getDate() : daysInMonth;

            // é€±æ¬¡è¡¨ç¤ºã®å ´åˆï¼šä»Šé€±ã®ä¸­ã§ä»Šæ—¥ãŒä½•æ—¥ç›®ã‹ã‚’è¨ˆç®—
            let targetMultiplier = 1;
            if (viewPeriod === 'week') {
                const dates = getWeekDates();
                const weekStart = dates[0];
                const weekEnd = dates[6];

                // ä»Šæ—¥ãŒã“ã®é€±ã®ç¯„å›²å†…ã«ã‚ã‚‹ã‹
                if (today >= weekStart && today <= weekEnd) {
                    // é€±ã®é–‹å§‹ã‹ã‚‰ä»Šæ—¥ã¾ã§ä½•æ—¥çµŒéã—ãŸã‹ï¼ˆ1ã€œ7ï¼‰
                    const daysSinceWeekStart = Math.floor((today - weekStart) / (1000 * 60 * 60 * 24)) + 1;
                    targetMultiplier = daysSinceWeekStart / 7;
                } else if (today > weekEnd) {
                    // éå»ã®é€±ãªã‚‰100%
                    targetMultiplier = 1;
                } else {
                    // æœªæ¥ã®é€±ãªã‚‰0%
                    targetMultiplier = 0;
                }
            }

            // ç›®æ¨™ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
            const getTarget = (monthlyGoal) => {
                if (viewPeriod === 'month') {
                    // æœˆæ¬¡ï¼šä»Šæ—¥ã¾ã§ã®æ—¥å‰²ã‚Šç›®æ¨™
                    return (monthlyGoal / daysInMonth) * currentDay;
                } else {
                    // é€±æ¬¡ï¼šé€±ã®ç›®æ¨™ Ã— é€±å†…ã®çµŒéæ—¥æ•°å‰²åˆ
                    const weeklyGoal = monthlyGoal / daysInMonth * 7;
                    return weeklyGoal * targetMultiplier;
                }
            };

            document.getElementById('sPost').textContent = t.post || 0;
            document.getElementById('sPostGoal').textContent = getTarget(g.post || 0).toFixed(1);
            setRateDisplay('sPostRate', 'sPostBar', t.post || 0, getTarget(g.post || 0));

            document.getElementById('sApoGet').textContent = t.apoGet;
            document.getElementById('sApoGetGoal').textContent = getTarget(g.apoGet).toFixed(1);
            setRateDisplay('sApoGetRate', 'sApoGetBar', t.apoGet, getTarget(g.apoGet));

            document.getElementById('sApoExec').textContent = t.apoExec;
            document.getElementById('sApoExecGoal').textContent = getTarget(g.apoExec).toFixed(1);
            setRateDisplay('sApoExecRate', 'sApoExecBar', t.apoExec, getTarget(g.apoExec));

            document.getElementById('sDoinGet').textContent = t.doinGet;
            document.getElementById('sDoinGetGoal').textContent = getTarget(g.doinGet).toFixed(1);
            setRateDisplay('sDoinGetRate', 'sDoinGetBar', t.doinGet, getTarget(g.doinGet));

            document.getElementById('sDoinExec').textContent = t.doinExec;
            document.getElementById('sDoinExecGoal').textContent = getTarget(g.doinExec).toFixed(1);
            setRateDisplay('sDoinExecRate', 'sDoinExecBar', t.doinExec, getTarget(g.doinExec));

            document.getElementById('sMendan').textContent = t.mendanGet;
            document.getElementById('sMendanGoal').textContent = getTarget(g.mendan).toFixed(1);
            setRateDisplay('sMendanRate', 'sMendanBar', t.mendanGet, getTarget(g.mendan));

            document.getElementById('sMendanExec').textContent = t.mendanExec;
            document.getElementById('sMendanExecGoal').textContent = getTarget(g.mendanExec || 0).toFixed(1);
            setRateDisplay('sMendanExecRate', 'sMendanExecBar', t.mendanExec, getTarget(g.mendanExec || 0));

            document.getElementById('sSeiyaku').textContent = t.seiyaku;
            document.getElementById('sSeiyakuGoal').textContent = getTarget(g.seiyaku).toFixed(1);
            setRateDisplay('sSeiyakuRate', 'sSeiyakuBar', t.seiyaku, getTarget(g.seiyaku));

            // KPIè‡ªå‹•è¨ˆç®—
            document.getElementById('kMuchaku').textContent = pct(t.muchaku, t.apoExec);
            document.getElementById('kTarget').textContent = pct(t.apoExec - t.ng, t.apoExec);
            document.getElementById('kNg').textContent = pct(t.ng, t.apoExec);
            document.getElementById('kTestClose').textContent = pct(t.testClose, t.apoExec);
            document.getElementById('kOffer').textContent = pct(t.offer, t.apoExec);

            // ç„¡ç€åœ°å†…è¨³ã‚’è¡¨ç¤º
            renderSummaryMuchakuBreakdown();
            // NGç†ç”±å†…è¨³ã‚’è¡¨ç¤º
            renderSummaryNgBreakdown();

            // æ®‹æ¡ˆä»¶ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»å‹•å“¡å¾Œç„¡ç€åœ°ã‚’è¡¨ç¤º
            renderSummaryCasesAndCancels();

            // ãƒãƒ£ãƒ¼ãƒˆã‚’æç”»
            renderLargeCharts();
        }

        function renderSummaryMuchakuBreakdown() {
            // ãƒ¡ãƒ³ãƒãƒ¼åˆ¥ã«æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é›†è¨ˆ
            const members = selectedMember === 'all' ? data.members : data.members.filter(m => m.id === selectedMember);
            const totals = {};
            muchakuReasonLabels.forEach((_, i) => totals[i] = 0);

            if (viewPeriod === 'month') {
                // æœˆå…¨ä½“ã®é›†è¨ˆ
                for (let w = 1; w <= 5; w++) {
                    const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                    if (data.weeks[weekKey]) {
                        members.forEach(member => {
                            const d = data.weeks[weekKey].daily[member.id];
                            if (d && d.muchakuReasonsByDay) {
                                for (let day = 0; day < 7; day++) {
                                    const dayData = d.muchakuReasonsByDay[day] || {};
                                    const counts = dayData.counts || [];
                                    counts.forEach((count, i) => {
                                        totals[i] = (totals[i] || 0) + (count || 0);
                                    });
                                }
                            }
                        });
                    }
                }
            } else {
                // é€±ã®é›†è¨ˆ
                members.forEach(member => {
                    const d = getMemberDaily(member.id);
                    const reasonsByDay = d.muchakuReasonsByDay || {};
                    for (let day = 0; day < 7; day++) {
                        const dayData = reasonsByDay[day] || {};
                        const counts = dayData.counts || [];
                        counts.forEach((count, i) => {
                            totals[i] = (totals[i] || 0) + (count || 0);
                        });
                    }
                });
            }

            let total = 0;
            let html = muchakuReasonLabels.map((label, i) => {
                const count = totals[i] || 0;
                total += count;
                const colorClass = count > 0 ? 'warning' : '';
                return `<div class="kpi-item"><div class="label" style="font-size:9px">${label}</div><div class="value ${colorClass}" style="font-size:18px">${count}</div></div>`;
            }).join('');

            document.getElementById('summaryMuchakuBreakdown').innerHTML = html;
            document.getElementById('sMuchakuTotal').textContent = `(${total}ä»¶)`;
        }

        function renderSummaryNgBreakdown() {
            // ãƒ¡ãƒ³ãƒãƒ¼åˆ¥ã«æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é›†è¨ˆ
            const members = selectedMember === 'all' ? data.members : data.members.filter(m => m.id === selectedMember);
            const totals = {};
            ngReasonLabels.forEach((_, i) => totals[i] = 0);

            if (viewPeriod === 'month') {
                // æœˆå…¨ä½“ã®é›†è¨ˆ
                for (let w = 1; w <= 5; w++) {
                    const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                    if (data.weeks[weekKey]) {
                        members.forEach(member => {
                            const d = data.weeks[weekKey].daily[member.id];
                            if (d && d.ngReasonsByDay) {
                                for (let day = 0; day < 7; day++) {
                                    const dayData = d.ngReasonsByDay[day] || {};
                                    const counts = dayData.counts || [];
                                    counts.forEach((count, i) => {
                                        totals[i] = (totals[i] || 0) + (count || 0);
                                    });
                                }
                            }
                        });
                    }
                }
            } else {
                // é€±ã®é›†è¨ˆ
                members.forEach(member => {
                    const d = getMemberDaily(member.id);
                    const reasonsByDay = d.ngReasonsByDay || {};
                    for (let day = 0; day < 7; day++) {
                        const dayData = reasonsByDay[day] || {};
                        const counts = dayData.counts || [];
                        counts.forEach((count, i) => {
                            totals[i] = (totals[i] || 0) + (count || 0);
                        });
                    }
                });
            }

            let total = 0;

            let html = ngReasonLabels.map((label, i) => {
                const count = totals[i] || 0;
                total += count;
                const colorClass = count > 0 ? 'danger' : '';
                return `<div class="kpi-item"><div class="label" style="font-size:9px">${label}</div><div class="value ${colorClass}" style="font-size:18px">${count}</div></div>`;
            }).join('');

            document.getElementById('summaryNgBreakdown').innerHTML = html;
            document.getElementById('sNgTotal').textContent = `(${total}ä»¶)`;
        }

        function renderSummaryCasesAndCancels() {
            // ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ç”¨ï¼ˆcaseList, cancelList, doinMuchakuListï¼‰
            // è¡¨ç¤ºã®ã¿ã®æ›´æ–°ã‚’ã“ã“ã§è¡Œã†
            renderCases();
            renderCancels();
            renderDoinMuchaku();

            // æ–½ç­–ã‚·ãƒ¼ãƒˆå†…ã®ã‚µãƒãƒªãƒ¼ã‚‚æ›´æ–°
            renderReviewSummary();
        }

        function renderReviewSummary() {
            const t = calcTotals();
            const r = getWeekData().review;

            // ãƒ¡ãƒ³ãƒãƒ¼åˆ¥ã®ç›®æ¨™ã‚’å–å¾—
            let g = {};
            if (selectedMember === 'all') {
                // å…¨ä½“é¸æŠæ™‚ï¼šå…¨ãƒ¡ãƒ³ãƒãƒ¼ã®ç›®æ¨™ã‚’åˆè¨ˆ
                data.members.forEach(m => {
                    const memberGoals = getMemberGoals(m.id);
                    g.post = (g.post || 0) + (memberGoals.post || 0);
                    g.apoGet = (g.apoGet || 0) + (memberGoals.apoGet || 0);
                    g.apoExec = (g.apoExec || 0) + (memberGoals.apoExec || 0);
                    g.doinGet = (g.doinGet || 0) + (memberGoals.doinGet || 0);
                    g.doinExec = (g.doinExec || 0) + (memberGoals.doinExec || 0);
                    g.mendan = (g.mendan || 0) + (memberGoals.mendan || 0);
                    g.mendanExec = (g.mendanExec || 0) + (memberGoals.mendanExec || 0);
                    g.seiyaku = (g.seiyaku || 0) + (memberGoals.seiyaku || 0);
                });
            } else {
                // å€‹åˆ¥ãƒ¡ãƒ³ãƒãƒ¼é¸æŠæ™‚ï¼šãã®ãƒ¡ãƒ³ãƒãƒ¼ã®ç›®æ¨™
                g = getMemberGoals(selectedMember);
            }

            // ç›®æ¨™è¨ˆç®—
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const today = new Date();
            const currentDay = (today.getFullYear() === currentYear && today.getMonth() + 1 === currentMonth)
                ? today.getDate() : daysInMonth;
            const getTarget = (monthlyGoal) => Math.ceil((monthlyGoal || 0) / daysInMonth * currentDay);

            // æ•°å­—ã¨ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
            const metrics = [
                { id: 'rsPost', key: 'post', goal: g.post },
                { id: 'rsApoGet', key: 'apoGet', goal: g.apoGet },
                { id: 'rsApoExec', key: 'apoExec', goal: g.apoExec },
                { id: 'rsDoinGet', key: 'doinGet', goal: g.doinGet },
                { id: 'rsDoinExec', key: 'doinExec', goal: g.doinExec },
                { id: 'rsMendanGet', key: 'mendanGet', goal: g.mendan },
                { id: 'rsMendanExec', key: 'mendanExec', goal: g.mendanExec },
                { id: 'rsSeiyaku', key: 'seiyaku', goal: g.seiyaku }
            ];

            metrics.forEach(m => {
                const actual = t[m.key] || 0;
                const target = getTarget(m.goal || 0);
                document.getElementById(m.id).textContent = actual;
                document.getElementById(m.id + 'Goal').textContent = target;
                setRateDisplay(m.id + 'Rate', m.id + 'Bar', actual, target);
            });

            // KPI
            document.getElementById('rsMuchaku').textContent = pct(t.muchaku, t.apoExec);
            document.getElementById('rsNg').textContent = pct(t.ng, t.apoExec);
            document.getElementById('rsTestClose').textContent = pct(t.testClose, t.apoExec);
            document.getElementById('rsOffer').textContent = pct(t.offer, t.apoExec);
            document.getElementById('rsDoinRate').textContent = pct(t.doinGet, t.apoExec);
            document.getElementById('rsSeiyakuRate').textContent = pct(t.seiyaku, t.doinExec);

            // ç„¡ç€åœ°å†…è¨³ï¼ˆãƒ¡ãƒ³ãƒãƒ¼åˆ¥ã«æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é›†è¨ˆï¼‰
            const members = selectedMember === 'all' ? data.members : data.members.filter(m => m.id === selectedMember);
            const muchakuTotals = {};
            muchakuReasonLabels.forEach((_, i) => muchakuTotals[i] = 0);

            if (viewPeriod === 'month') {
                for (let w = 1; w <= 5; w++) {
                    const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                    if (data.weeks[weekKey]) {
                        members.forEach(member => {
                            const d = data.weeks[weekKey].daily[member.id];
                            if (d && d.muchakuReasonsByDay) {
                                for (let day = 0; day < 7; day++) {
                                    const dayData = d.muchakuReasonsByDay[day] || {};
                                    const counts = dayData.counts || [];
                                    counts.forEach((count, i) => {
                                        muchakuTotals[i] = (muchakuTotals[i] || 0) + (count || 0);
                                    });
                                }
                            }
                        });
                    }
                }
            } else {
                members.forEach(member => {
                    const d = getMemberDaily(member.id);
                    const reasonsByDay = d.muchakuReasonsByDay || {};
                    for (let day = 0; day < 7; day++) {
                        const dayData = reasonsByDay[day] || {};
                        const counts = dayData.counts || [];
                        counts.forEach((count, i) => {
                            muchakuTotals[i] = (muchakuTotals[i] || 0) + (count || 0);
                        });
                    }
                });
            }

            let total = 0;
            let topReasonIndex = -1;
            let topReasonCount = 0;
            let breakdownHtml = muchakuReasonLabels.map((label, i) => {
                const count = muchakuTotals[i] || 0;
                total += count;
                if (count > topReasonCount) {
                    topReasonCount = count;
                    topReasonIndex = i;
                }
                return `<div style="padding:4px;background:#0f172a;border-radius:4px;display:flex;justify-content:space-between"><span>${label}</span><strong style="${count > 0 ? 'color:#eab308' : ''}">${count}</strong></div>`;
            }).join('');
            document.getElementById('rsMuchakuBreakdown').innerHTML = breakdownHtml;
            document.getElementById('rsMuchakuTotal').textContent = `(${total}ä»¶)`;

            // æœ€å¤šç†ç”±ã¨å¯¾ç­–
            const topReasonLabel = topReasonIndex >= 0 ? muchakuReasonLabels[topReasonIndex] : '-';
            document.getElementById('rsTopReason').textContent = topReasonCount > 0 ? `${topReasonLabel}ï¼ˆ${topReasonCount}ä»¶ï¼‰` : '-';
            document.getElementById('rsTopReasonAction').value = r.topReasonAction || '';

            // NGç†ç”±å†…è¨³ï¼ˆãƒ¡ãƒ³ãƒãƒ¼åˆ¥ã«æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é›†è¨ˆï¼‰
            const ngTotals = {};
            ngReasonLabels.forEach((_, i) => ngTotals[i] = 0);

            if (viewPeriod === 'month') {
                for (let w = 1; w <= 5; w++) {
                    const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                    if (data.weeks[weekKey]) {
                        members.forEach(member => {
                            const d = data.weeks[weekKey].daily[member.id];
                            if (d && d.ngReasonsByDay) {
                                for (let day = 0; day < 7; day++) {
                                    const dayData = d.ngReasonsByDay[day] || {};
                                    const counts = dayData.counts || [];
                                    counts.forEach((count, i) => {
                                        ngTotals[i] = (ngTotals[i] || 0) + (count || 0);
                                    });
                                }
                            }
                        });
                    }
                }
            } else {
                members.forEach(member => {
                    const d = getMemberDaily(member.id);
                    const reasonsByDay = d.ngReasonsByDay || {};
                    for (let day = 0; day < 7; day++) {
                        const dayData = reasonsByDay[day] || {};
                        const counts = dayData.counts || [];
                        counts.forEach((count, i) => {
                            ngTotals[i] = (ngTotals[i] || 0) + (count || 0);
                        });
                    }
                });
            }

            let ngTotal = 0;
            let ngBreakdownHtml = ngReasonLabels.map((label, i) => {
                const count = ngTotals[i] || 0;
                ngTotal += count;
                return `<div style="padding:4px;background:#0f172a;border-radius:4px;display:flex;justify-content:space-between"><span>${label}</span><strong style="${count > 0 ? 'color:#ef4444' : ''}">${count}</strong></div>`;
            }).join('');
            document.getElementById('rsNgBreakdown').innerHTML = ngBreakdownHtml;
            document.getElementById('rsNgTotal').textContent = `(${ngTotal}ä»¶)`;

            // æ®‹æ¡ˆä»¶ï¼ˆãƒ¡ãƒ³ãƒãƒ¼ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° + æœˆè¡¨ç¤ºå¯¾å¿œï¼‰
            let allCases = [];
            if (viewPeriod === 'month') {
                for (let w = 1; w <= 5; w++) {
                    const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                    if (data.weeks[weekKey] && data.weeks[weekKey].review && data.weeks[weekKey].review.cases) {
                        allCases = allCases.concat(data.weeks[weekKey].review.cases);
                    }
                }
            } else {
                allCases = r.cases || [];
            }
            const filteredCases = allCases.filter(c => selectedMember === 'all' || !c.memberId || c.memberId === selectedMember);
            document.getElementById('rsCasesCount').textContent = `(${filteredCases.length}ä»¶)`;
            document.getElementById('rsCasesList').innerHTML = filteredCases.length === 0 ? '<p style="color:#64748b">ãªã—</p>' :
                filteredCases.map(c => {
                    const memberName = selectedMember === 'all' && c.memberId ? (data.members.find(m => m.id === c.memberId)?.name || '') : '';
                    const badge = memberName ? `<span style="font-size:9px;background:#6366f1;padding:1px 4px;border-radius:3px;margin-right:4px">${memberName}</span>` : '';
                    return `<div style="padding:4px;background:#0f172a;border-radius:4px;margin-bottom:4px">${badge}${c.date || '-'} ${c.customer || 'æœªå…¥åŠ›'} <span style="color:#64748b;font-size:11px">${c.closer || ''}</span></div>`;
                }).join('');

            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆãƒ¡ãƒ³ãƒãƒ¼ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° + ç†ç”±è¡¨ç¤º + æœˆè¡¨ç¤ºå¯¾å¿œï¼‰
            let allCancels = [];
            if (viewPeriod === 'month') {
                for (let w = 1; w <= 5; w++) {
                    const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                    if (data.weeks[weekKey] && data.weeks[weekKey].review && data.weeks[weekKey].review.cancels) {
                        allCancels = allCancels.concat(data.weeks[weekKey].review.cancels);
                    }
                }
            } else {
                allCancels = r.cancels || [];
            }
            const filteredCancels = allCancels.filter(c => selectedMember === 'all' || !c.memberId || c.memberId === selectedMember);
            document.getElementById('rsCancelsCount').textContent = `(${filteredCancels.length}ä»¶)`;
            document.getElementById('rsCancelsList').innerHTML = filteredCancels.length === 0 ? '<p style="color:#64748b">ãªã—</p>' :
                filteredCancels.map(c => {
                    const memberName = selectedMember === 'all' && c.memberId ? (data.members.find(m => m.id === c.memberId)?.name || '') : '';
                    const badge = memberName ? `<span style="font-size:9px;background:#6366f1;padding:1px 4px;border-radius:3px;margin-right:4px">${memberName}</span>` : '';
                    const closerText = c.closer ? `<span style="color:#64748b;font-size:10px;margin-left:4px">[${c.closer}]</span>` : '';
                    return `<div style="padding:4px;background:#0f172a;border-radius:4px;margin-bottom:4px;border-left:2px solid #eab308">${badge}${c.date || '-'} ${c.customer || 'æœªå…¥åŠ›'}${closerText} <span style="color:#eab308;font-size:11px">${c.reason || ''}</span></div>`;
                }).join('');

            // å‹•å“¡å¾Œç„¡ç€åœ°ï¼ˆãƒ¡ãƒ³ãƒãƒ¼ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° + æœˆè¡¨ç¤ºå¯¾å¿œï¼‰
            let allDoinMuchaku = [];
            if (viewPeriod === 'month') {
                for (let w = 1; w <= 5; w++) {
                    const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                    if (data.weeks[weekKey] && data.weeks[weekKey].review && data.weeks[weekKey].review.doinMuchakuList) {
                        allDoinMuchaku = allDoinMuchaku.concat(data.weeks[weekKey].review.doinMuchakuList);
                    }
                }
            } else {
                allDoinMuchaku = r.doinMuchakuList || [];
            }
            const filteredDoinMuchaku = allDoinMuchaku.filter(item => selectedMember === 'all' || !item.memberId || item.memberId === selectedMember);
            document.getElementById('rsDoinMuchakuCount').textContent = `(${filteredDoinMuchaku.length}ä»¶)`;
            document.getElementById('rsDoinMuchakuList').innerHTML = filteredDoinMuchaku.length === 0 ? '<p style="color:#64748b">ãªã—</p>' :
                filteredDoinMuchaku.map(item => {
                    const memberName = selectedMember === 'all' && item.memberId ? (data.members.find(m => m.id === item.memberId)?.name || '') : '';
                    const badge = memberName ? `<span style="font-size:9px;background:#6366f1;padding:1px 4px;border-radius:3px;margin-right:4px">${memberName}</span>` : '';
                    const closerText = item.closer ? `<span style="color:#64748b;font-size:10px;margin-left:4px">[${item.closer}]</span>` : '';
                    return `<div style="padding:4px;background:#0f172a;border-radius:4px;margin-bottom:4px;border-left:2px solid #ef4444">${badge}${item.date || '-'} ${item.customer || 'æœªå…¥åŠ›'}${closerText} <span style="color:#ef4444">${item.reason || ''}</span></div>`;
                }).join('');

            // ã‚µã‚¤ãƒ‰ãƒãƒ¼ç”¨ã‚°ãƒ©ãƒ•ã‚’æç”»
            renderReviewCharts();
        }

        function renderMiniCharts() {
            const g = data.settings.monthly || {};
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();

            const chartConfigs = [
                { id: 'chartPost', key: 'post', goal: g.post || 0 },
                { id: 'chartApoGet', key: 'apoGet', goal: g.apoGet || 0 },
                { id: 'chartApoExec', key: 'apoExec', goal: g.apoExec || 0 },
                { id: 'chartDoinGet', key: 'doinGet', goal: g.doinGet || 0 },
                { id: 'chartDoinExec', key: 'doinExec', goal: g.doinExec || 0 },
                { id: 'chartMendan', key: 'mendanGet', goal: g.mendan || 0 },
                { id: 'chartMendanExec', key: 'mendanExec', goal: g.mendanExec || 0 },
                { id: 'chartSeiyaku', key: 'seiyaku', goal: g.seiyaku || 0 }
            ];

            chartConfigs.forEach(config => {
                const container = document.getElementById(config.id);
                if (!container) return;

                const { actualData, targetData, numDays } = getChartData(config.key, config.goal);
                const maxVal = Math.max(...actualData, ...targetData, 1);
                container.innerHTML = createMiniChartSVG(actualData, targetData, maxVal, numDays);
            });
        }

        function renderLargeCharts() {
            // ãƒ¡ãƒ³ãƒãƒ¼é¸æŠã«å¿œã˜ãŸç›®æ¨™ã‚’å–å¾—
            let g = {};
            if (selectedMember === 'all') {
                // å…¨ä½“é¸æŠæ™‚ï¼šå…¨ãƒ¡ãƒ³ãƒãƒ¼ã®ç›®æ¨™ã‚’åˆè¨ˆ
                data.members.forEach(m => {
                    const memberGoals = getMemberGoals(m.id);
                    g.post = (g.post || 0) + (memberGoals.post || 0);
                    g.apoGet = (g.apoGet || 0) + (memberGoals.apoGet || 0);
                    g.apoExec = (g.apoExec || 0) + (memberGoals.apoExec || 0);
                    g.doinGet = (g.doinGet || 0) + (memberGoals.doinGet || 0);
                    g.doinExec = (g.doinExec || 0) + (memberGoals.doinExec || 0);
                    g.mendan = (g.mendan || 0) + (memberGoals.mendan || 0);
                    g.mendanExec = (g.mendanExec || 0) + (memberGoals.mendanExec || 0);
                    g.seiyaku = (g.seiyaku || 0) + (memberGoals.seiyaku || 0);
                });
            } else {
                // ç‰¹å®šãƒ¡ãƒ³ãƒãƒ¼é¸æŠæ™‚ï¼šãã®ãƒ¡ãƒ³ãƒãƒ¼ã®ç›®æ¨™
                g = getMemberGoals(selectedMember);
            }
            const container = document.getElementById('chartsGrid');
            if (!container) return;

            const chartConfigs = [
                { label: 'æŠ•ç¨¿æ•°', key: 'post', goal: g.post || 0 },
                { label: 'ã‚¢ãƒç²å¾—', key: 'apoGet', goal: g.apoGet || 0 },
                { label: 'ã‚¢ãƒå®Ÿæ–½', key: 'apoExec', goal: g.apoExec || 0 },
                { label: 'å‹•å“¡ç›´ã‚¯ãƒ­ç²å¾—', key: 'doinGet', goal: g.doinGet || 0 },
                { label: 'å‹•å“¡ç›´ã‚¯ãƒ­å®Ÿæ–½', key: 'doinExec', goal: g.doinExec || 0 },
                { label: 'é¢è«‡ç²å¾—', key: 'mendanGet', goal: g.mendan || 0 },
                { label: 'é¢è«‡å®Ÿæ–½', key: 'mendanExec', goal: g.mendanExec || 0 },
                { label: 'æˆç´„', key: 'seiyaku', goal: g.seiyaku || 0 }
            ];

            container.innerHTML = chartConfigs.map(config => {
                const { actualData, targetData, numDays, labels } = getChartData(config.key, config.goal);
                const maxVal = Math.max(...actualData, ...targetData, 1);
                const svg = createLargeChartSVG(actualData, targetData, maxVal, numDays, labels);

                return `<div class="chart-card">
                    <h4>${config.label}</h4>
                    <div class="chart-container">${svg}</div>
                    <div class="chart-legend">
                        <span><div class="legend-line target"></div>ç›®æ¨™</span>
                        <span><div class="legend-line actual"></div>å®Ÿç¸¾</span>
                    </div>
                </div>`;
            }).join('');
        }

        function renderReviewCharts() {
            // ãƒ¡ãƒ³ãƒãƒ¼é¸æŠã«å¿œã˜ãŸç›®æ¨™ã‚’å–å¾—
            let g = {};
            if (selectedMember === 'all') {
                data.members.forEach(m => {
                    const memberGoals = getMemberGoals(m.id);
                    g.post = (g.post || 0) + (memberGoals.post || 0);
                    g.apoGet = (g.apoGet || 0) + (memberGoals.apoGet || 0);
                    g.apoExec = (g.apoExec || 0) + (memberGoals.apoExec || 0);
                    g.doinGet = (g.doinGet || 0) + (memberGoals.doinGet || 0);
                    g.doinExec = (g.doinExec || 0) + (memberGoals.doinExec || 0);
                    g.mendan = (g.mendan || 0) + (memberGoals.mendan || 0);
                    g.mendanExec = (g.mendanExec || 0) + (memberGoals.mendanExec || 0);
                    g.seiyaku = (g.seiyaku || 0) + (memberGoals.seiyaku || 0);
                });
            } else {
                g = getMemberGoals(selectedMember);
            }
            const container = document.getElementById('reviewChartsGrid');
            if (!container) return;

            const chartConfigs = [
                { label: 'æŠ•ç¨¿', key: 'post', goal: g.post || 0 },
                { label: 'ã‚¢ãƒç²', key: 'apoGet', goal: g.apoGet || 0 },
                { label: 'ã‚¢ãƒå®Ÿ', key: 'apoExec', goal: g.apoExec || 0 },
                { label: 'å‹•å“¡ç²', key: 'doinGet', goal: g.doinGet || 0 },
                { label: 'å‹•å“¡å®Ÿ', key: 'doinExec', goal: g.doinExec || 0 },
                { label: 'é¢è«‡ç²', key: 'mendanGet', goal: g.mendan || 0 },
                { label: 'é¢è«‡å®Ÿ', key: 'mendanExec', goal: g.mendanExec || 0 },
                { label: 'æˆç´„', key: 'seiyaku', goal: g.seiyaku || 0 }
            ];

            container.innerHTML = chartConfigs.map(config => {
                const { actualData, targetData, numDays } = getChartData(config.key, config.goal);
                const maxVal = Math.max(...actualData, ...targetData, 1);
                const svg = createCompactChartSVG(actualData, targetData, maxVal, numDays);

                return `<div style="background:#0f172a;border-radius:6px;padding:6px">
                    <div style="font-size:9px;color:#94a3b8;margin-bottom:4px">${config.label}</div>
                    <div style="height:40px">${svg}</div>
                </div>`;
            }).join('');
        }

        function createCompactChartSVG(actualData, targetData, maxVal, numDays) {
            const width = 140;
            const height = 40;
            const padding = 2;

            const xScale = (width - padding * 2) / (numDays - 1 || 1);
            const yScale = (height - padding * 2) / maxVal;

            const toPoint = (val, i) => {
                const x = padding + i * xScale;
                const y = height - padding - val * yScale;
                return `${x},${y}`;
            };

            const targetPoints = targetData.map((v, i) => toPoint(v, i)).join(' ');
            const actualPoints = actualData.map((v, i) => toPoint(v, i)).join(' ');

            return `<svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none" style="width:100%;height:100%">
                <polyline points="${targetPoints}" fill="none" stroke="#64748b" stroke-width="1" stroke-dasharray="2,2" />
                <polyline points="${actualPoints}" fill="none" stroke="#6366f1" stroke-width="1.5" />
            </svg>`;
        }

        function getChartData(metricKey, monthlyGoal) {
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            let actualData = [];
            let targetData = [];
            let labels = [];
            let numDays;

            if (viewPeriod === 'month') {
                numDays = daysInMonth;
                const dailyGoal = monthlyGoal / daysInMonth;

                let cumulative = 0;
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayValue = getDayValueForChart(metricKey, day);
                    cumulative += dayValue;
                    actualData.push(cumulative);
                    targetData.push(dailyGoal * day);
                    labels.push(day.toString());
                }
            } else {
                numDays = 7;
                const weeklyGoal = (monthlyGoal / daysInMonth) * 7;
                const dailyGoal = weeklyGoal / 7;
                const dates = getWeekDates();
                const dayNames = ['åœŸ','æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘'];

                let cumulative = 0;
                for (let i = 0; i < 7; i++) {
                    const dayValue = getWeekDayValueForChart(metricKey, i);
                    cumulative += dayValue;
                    actualData.push(cumulative);
                    targetData.push(dailyGoal * (i + 1));
                    labels.push(`${dates[i].getDate()}(${dayNames[i]})`);
                }
            }

            return { actualData, targetData, numDays, labels };
        }

        function getDayValueForChart(metricKey, day) {
            const date = new Date(currentYear, currentMonth - 1, day);
            if (date.getMonth() !== currentMonth - 1) return 0;

            const firstDay = new Date(currentYear, currentMonth - 1, 1);
            const dow = (firstDay.getDay() + 1) % 7;
            const weekNum = Math.ceil((day + dow) / 7);
            const dayOfWeek = (date.getDay() + 1) % 7;

            const weekKey = `${currentYear}-${currentMonth}-W${weekNum}`;
            const members = selectedMember === 'all' ? data.members : data.members.filter(m => m.id === selectedMember);

            let total = 0;
            members.forEach(m => {
                if (data.weeks[weekKey] && data.weeks[weekKey].daily[m.id]) {
                    total += (data.weeks[weekKey].daily[m.id][metricKey] || [0,0,0,0,0,0,0])[dayOfWeek] || 0;
                }
            });
            return total;
        }

        function getWeekDayValueForChart(metricKey, dayIndex) {
            const members = selectedMember === 'all' ? data.members : data.members.filter(m => m.id === selectedMember);
            let total = 0;
            members.forEach(m => {
                const d = getMemberDaily(m.id);
                total += (d[metricKey] || [0,0,0,0,0,0,0])[dayIndex] || 0;
            });
            return total;
        }

        function createMiniChartSVG(actualData, targetData, maxVal, numDays) {
            const width = 120;
            const height = 40;
            const padding = 2;

            const xScale = (width - padding * 2) / (numDays - 1 || 1);
            const yScale = (height - padding * 2) / maxVal;

            const toPoint = (val, i) => {
                const x = padding + i * xScale;
                const y = height - padding - val * yScale;
                return `${x},${y}`;
            };

            const targetPoints = targetData.map((v, i) => toPoint(v, i)).join(' ');
            const actualPoints = actualData.map((v, i) => toPoint(v, i)).join(' ');

            return `<svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
                <polyline points="${targetPoints}" fill="none" stroke="#64748b" stroke-width="1" stroke-dasharray="3,2" />
                <polyline points="${actualPoints}" fill="none" stroke="#6366f1" stroke-width="2" />
            </svg>`;
        }

        function createLargeChartSVG(actualData, targetData, maxVal, numDays, labels) {
            const width = 280;
            const height = 120;
            const paddingLeft = 30;
            const paddingRight = 10;
            const paddingTop = 10;
            const paddingBottom = 25;

            const chartWidth = width - paddingLeft - paddingRight;
            const chartHeight = height - paddingTop - paddingBottom;

            const xScale = chartWidth / (numDays - 1 || 1);
            const yScale = chartHeight / maxVal;

            const toX = (i) => paddingLeft + i * xScale;
            const toY = (val) => height - paddingBottom - val * yScale;

            const toPoint = (val, i) => `${toX(i)},${toY(val)}`;

            const targetPoints = targetData.map((v, i) => toPoint(v, i)).join(' ');
            const actualPoints = actualData.map((v, i) => toPoint(v, i)).join(' ');

            // Yè»¸ã®ã‚°ãƒªãƒƒãƒ‰ãƒ©ã‚¤ãƒ³
            const ySteps = 4;
            const yStep = maxVal / ySteps;
            let yAxisLabels = '';
            let gridLines = '';
            for (let i = 0; i <= ySteps; i++) {
                const val = Math.round(yStep * i);
                const y = toY(val);
                yAxisLabels += `<text x="${paddingLeft - 5}" y="${y + 3}" text-anchor="end" font-size="9" fill="#64748b">${val}</text>`;
                if (i > 0) {
                    gridLines += `<line x1="${paddingLeft}" y1="${y}" x2="${width - paddingRight}" y2="${y}" stroke="#334155" stroke-width="0.5" />`;
                }
            }

            // Xè»¸ã®ãƒ©ãƒ™ãƒ«ï¼ˆé–“å¼•ã„ã¦è¡¨ç¤ºï¼‰
            let xAxisLabels = '';
            const labelInterval = numDays <= 7 ? 1 : Math.ceil(numDays / 7);
            for (let i = 0; i < numDays; i += labelInterval) {
                const x = toX(i);
                xAxisLabels += `<text x="${x}" y="${height - 5}" text-anchor="middle" font-size="8" fill="#64748b">${labels[i]}</text>`;
            }

            // å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒã‚¤ãƒ³ãƒˆ
            let actualCircles = '';
            for (let i = 0; i < numDays; i++) {
                const x = toX(i);
                const y = toY(actualData[i]);
                actualCircles += `<circle cx="${x}" cy="${y}" r="4" fill="#6366f1" stroke="#1e293b" stroke-width="1"
                    data-label="${labels[i]}" data-value="${actualData[i]}" data-target="${targetData[i]}" class="chart-point"
                    onmouseenter="showChartTooltip(event)" onmouseleave="hideChartTooltip()" />`;
            }

            return `<svg viewBox="0 0 ${width} ${height}">
                ${gridLines}
                <line x1="${paddingLeft}" y1="${height - paddingBottom}" x2="${width - paddingRight}" y2="${height - paddingBottom}" stroke="#334155" stroke-width="1" />
                <line x1="${paddingLeft}" y1="${paddingTop}" x2="${paddingLeft}" y2="${height - paddingBottom}" stroke="#334155" stroke-width="1" />
                ${yAxisLabels}
                ${xAxisLabels}
                <polyline points="${targetPoints}" fill="none" stroke="#64748b" stroke-width="1.5" stroke-dasharray="4,3" />
                <polyline points="${actualPoints}" fill="none" stroke="#6366f1" stroke-width="2" />
                ${actualCircles}
            </svg>`;
        }

        function renderMemberTable() {
            document.getElementById('memberTable').innerHTML = data.members.map(m => {
                const t = calcMemberTotals(m.id);
                return `<tr>
                    <td><strong>${m.name}</strong></td>
                    <td>${t.post || 0}</td>
                    <td>${t.apoGet}</td><td>${t.apoExec}</td>
                    <td>${t.apoCxl}</td><td>${t.testClose}</td><td>${t.offer}</td>
                    <td>${t.ng}</td><td>${t.muchaku}</td><td>${t.doinGet}</td>
                    <td>${t.doinExec}</td><td>${t.mendanGet}</td><td>${t.mendanExec}</td><td>${t.seiyaku}</td>
                </tr>`;
            }).join('');
        }

        function renderDailyInput() {
            if (viewPeriod === 'month') {
                renderDailyInputMonth();
                return;
            }

            const currentUserId = data.settings.currentUserId;
            const dates = getWeekDates();
            const days = ['åœŸ','æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘'];

            // ãƒ˜ãƒƒãƒ€ãƒ¼
            let html = `<div class="daily-header"><div class="daily-cell header">é …ç›®</div>${dates.map((d, i) => `<div class="daily-cell header">${days[i]}<br>${d.getMonth()+1}/${d.getDate()}</div>`).join('')}<div class="daily-cell header">åˆè¨ˆ</div></div>`;

            const members = selectedMember === 'all' ? data.members : data.members.filter(m => m.id === selectedMember);
            members.forEach(member => {
                const isMyData = member.id === currentUserId;
                const disabledAttr = isMyData ? '' : 'disabled';
                const rowStyle = isMyData ? '' : 'opacity:0.6;';
                const lockIcon = isMyData ? '' : ' ğŸ”’';

                html += `<div class="daily-row" style="${rowStyle}"><div class="daily-cell category" style="grid-column:1/-1">${member.name}${lockIcon}</div></div>`;
                metrics.forEach(cat => {
                    html += `<div class="daily-row" style="${rowStyle}"><div class="daily-cell label" style="color:#94a3b8;font-size:11px">${cat.cat}</div><div style="grid-column:2/-1"></div></div>`;
                    cat.items.forEach(m => {
                        const d = getMemberDaily(member.id);
                        const arr = d[m.key] || [0,0,0,0,0,0,0];
                        const total = arr.reduce((a,b)=>a+b,0);

                        if (m.key === 'muchaku') {
                            // ç„¡ç€åœ°ã¯ç†ç”±ãƒœã‚¿ãƒ³ä»˜ã
                            html += `<div class="daily-row sub"><div class="daily-cell label">${m.label}</div>`;
                            html += [0,1,2,3,4,5,6].map(i => {
                                const dateLabel = `${dates[i].getMonth()+1}/${dates[i].getDate()}`;
                                const hasReasons = hasMuchakuReasons(member.id, i);
                                const btnStyle = arr[i] > 0 ? (hasReasons ? 'background:#22c55e;' : 'background:#eab308;') : 'background:#475569;opacity:0.5;';
                                return `<div class="daily-cell" style="display:flex;gap:2px;align-items:center;padding:2px">
                                    <input type="number" value="${arr[i]}" min="0" style="width:35px" ${disabledAttr} onchange="updateDaily('${member.id}','${m.key}',${i},this.value)">
                                    <button onclick="openMuchakuModal('${member.id}',${i},'${dateLabel}')" ${disabledAttr} style="padding:2px 6px;border:none;border-radius:4px;cursor:pointer;font-size:10px;color:white;${btnStyle}" title="ç†ç”±ã‚’è¨˜éŒ²">?</button>
                                </div>`;
                            }).join('');
                            html += `<div class="daily-cell total">${total}</div></div>`;
                        } else if (m.key === 'ng') {
                            // NGã¯ç†ç”±ãƒœã‚¿ãƒ³ä»˜ã
                            html += `<div class="daily-row sub"><div class="daily-cell label">${m.label}</div>`;
                            html += [0,1,2,3,4,5,6].map(i => {
                                const dateLabel = `${dates[i].getMonth()+1}/${dates[i].getDate()}`;
                                const hasReasons = hasNgReasons(member.id, i);
                                const btnStyle = arr[i] > 0 ? (hasReasons ? 'background:#22c55e;' : 'background:#eab308;') : 'background:#475569;opacity:0.5;';
                                return `<div class="daily-cell" style="display:flex;gap:2px;align-items:center;padding:2px">
                                    <input type="number" value="${arr[i]}" min="0" style="width:35px" ${disabledAttr} onchange="updateDaily('${member.id}','${m.key}',${i},this.value)">
                                    <button onclick="openNgModal('${member.id}',${i},'${dateLabel}')" ${disabledAttr} style="padding:2px 6px;border:none;border-radius:4px;cursor:pointer;font-size:10px;color:white;${btnStyle}" title="NGç†ç”±ã‚’è¨˜éŒ²">?</button>
                                </div>`;
                            }).join('');
                            html += `<div class="daily-cell total">${total}</div></div>`;
                        } else {
                            html += `<div class="daily-row sub"><div class="daily-cell label">${m.label}</div>${[0,1,2,3,4,5,6].map(i => `<div class="daily-cell"><input type="number" value="${arr[i]}" min="0" ${disabledAttr} onchange="updateDaily('${member.id}','${m.key}',${i},this.value)"></div>`).join('')}<div class="daily-cell total">${total}</div></div>`;
                        }
                    });
                });
            });
            document.getElementById('dailyInputArea').innerHTML = html;
        }

        function renderDailyInputMonth() {
            const currentUserId = data.settings.currentUserId;
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const members = selectedMember === 'all' ? data.members : data.members.filter(m => m.id === selectedMember);

            // æœˆæ¬¡è¡¨ç¤ºç”¨ã®ã‚°ãƒªãƒƒãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«
            const gridCols = `120px repeat(${daysInMonth}, 45px) 60px`;

            let html = `<div style="overflow-x:auto"><div style="min-width:${120 + daysInMonth * 49 + 60}px">`;

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            html += `<div style="display:grid;grid-template-columns:${gridCols};gap:2px;margin-bottom:4px;position:sticky;top:0;background:#1e293b;z-index:10;padding:8px 0">`;
            html += `<div class="daily-cell header">é …ç›®</div>`;
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(currentYear, currentMonth - 1, d);
                const dayName = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][date.getDay()];
                html += `<div class="daily-cell header" style="font-size:10px">${d}<br>${dayName}</div>`;
            }
            html += `<div class="daily-cell header">è¨ˆ</div></div>`;

            members.forEach(member => {
                const isMyData = member.id === currentUserId;
                const disabledAttr = isMyData ? '' : 'disabled';
                const rowStyle = isMyData ? '' : 'opacity:0.6;';
                const lockIcon = isMyData ? '' : ' ğŸ”’';

                html += `<div style="display:grid;grid-template-columns:${gridCols};gap:2px;margin-bottom:2px;${rowStyle}"><div class="daily-cell category" style="grid-column:1/-1">${member.name}${lockIcon}</div></div>`;

                metrics.forEach(cat => {
                    html += `<div style="display:grid;grid-template-columns:${gridCols};gap:2px;margin-bottom:2px;${rowStyle}"><div class="daily-cell label" style="color:#94a3b8;font-size:11px">${cat.cat}</div><div style="grid-column:2/-1"></div></div>`;

                    cat.items.forEach(m => {
                        let total = 0;
                        html += `<div style="display:grid;grid-template-columns:${gridCols};gap:2px;margin-bottom:2px;padding-left:20px;${rowStyle}">`;
                        html += `<div class="daily-cell label" style="width:100px">${m.label}</div>`;

                        for (let d = 1; d <= daysInMonth; d++) {
                            const val = getMonthDayValue(member.id, m.key, d);
                            total += val;
                            html += `<div class="daily-cell"><input type="number" value="${val}" min="0" style="width:100%;font-size:11px;padding:2px" ${disabledAttr} onchange="updateMonthDay('${member.id}','${m.key}',${d},this.value)"></div>`;
                        }

                        html += `<div class="daily-cell total">${total}</div></div>`;
                    });
                });
            });

            html += `</div></div>`;
            document.getElementById('dailyInputArea').innerHTML = html;
        }

        function getMonthDayValue(memberId, metricKey, day) {
            const date = new Date(currentYear, currentMonth - 1, day);
            const firstDay = new Date(currentYear, currentMonth - 1, 1);
            const dow = (firstDay.getDay() + 1) % 7;
            const weekNum = Math.ceil((day + dow) / 7);
            const dayOfWeek = (date.getDay() + 1) % 7;

            const weekKey = `${currentYear}-${currentMonth}-W${weekNum}`;
            if (data.weeks[weekKey] && data.weeks[weekKey].daily[memberId]) {
                return (data.weeks[weekKey].daily[memberId][metricKey] || [0,0,0,0,0,0,0])[dayOfWeek] || 0;
            }
            return 0;
        }

        function updateMonthDay(memberId, metricKey, day, value) {
            const date = new Date(currentYear, currentMonth - 1, day);
            const firstDay = new Date(currentYear, currentMonth - 1, 1);
            const dow = (firstDay.getDay() + 1) % 7;
            const weekNum = Math.ceil((day + dow) / 7);
            const dayOfWeek = (date.getDay() + 1) % 7;

            const weekKey = `${currentYear}-${currentMonth}-W${weekNum}`;
            if (!data.weeks[weekKey]) {
                data.weeks[weekKey] = {
                    daily: {}, review: { mainIssue: '', mainCause: '', causeActions: [{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]}], muchakuReasons: {}, muchakuOther: '', ngReasons: {}, doinMuchakuList: [], cases: [], cancels: [] },
                    instagram: {}, nippo: {}
                };
            }
            if (!data.weeks[weekKey].daily[memberId]) {
                data.weeks[weekKey].daily[memberId] = {};
                metrics.forEach(c => c.items.forEach(m => { data.weeks[weekKey].daily[memberId][m.key] = [0,0,0,0,0,0,0]; }));
            }

            data.weeks[weekKey].daily[memberId][metricKey][dayOfWeek] = parseInt(value) || 0;
            saveData();
            syncToCloud();
            renderSummary();
            renderMemberTable();
        }

        function updateDaily(memberId, key, idx, val) {
            getMemberDaily(memberId)[key][idx] = parseInt(val) || 0;
            saveData();
            syncToCloud();
            renderSummary();
            renderMemberTable();
            const total = getMemberDaily(memberId)[key].reduce((a,b) => a+b, 0);
            event.target.closest('.daily-row').querySelector('.total').textContent = total;
        }

        function renderReview() {
            const r = getWeekData().review;

            document.getElementById('mainIssue').value = r.mainIssue || '';
            document.getElementById('mainCause').value = r.mainCause || '';

            // ç„¡ç€åœ°ç†ç”±ï¼ˆUIå‰Šé™¤æ¸ˆã¿ï¼‰
            // document.getElementById('muchakuReasons').innerHTML = ...
            // document.getElementById('muchakuOther').value = r.muchakuOther || '';

            // NGç†ç”±ï¼ˆUIå‰Šé™¤æ¸ˆã¿ï¼‰
            // document.getElementById('ngReasons').innerHTML = ...

            renderCases();
            renderCancels();
            renderDoinMuchaku();
            renderCauseActions();
        }

        function saveReview() {
            const r = getWeekData().review;
            r.mainIssue = document.getElementById('mainIssue').value;
            r.mainCause = document.getElementById('mainCause').value;
            // r.muchakuOther = document.getElementById('muchakuOther').value; // UIå‰Šé™¤æ¸ˆã¿
            saveData();
            syncToCloud();
        }

        function saveTopReasonAction() {
            const r = getWeekData().review;
            r.topReasonAction = document.getElementById('rsTopReasonAction').value;
            saveData();
            syncToCloud();
        }

        function updateMuchakuReason(i, v) { getWeekData().review.muchakuReasons[i] = parseInt(v)||0; saveData(); syncToCloud(); }
        function updateNgReason(i, v) { getWeekData().review.ngReasons[i] = parseInt(v)||0; saveData(); syncToCloud(); }

        // æ—¥åˆ¥ç„¡ç€åœ°ç†ç”±ã®ç®¡ç†
        let currentMuchakuMember = null;
        let currentMuchakuDay = null;

        function getMemberMuchakuReasons(memberId) {
            const d = getMemberDaily(memberId);
            if (!d.muchakuReasonsByDay) d.muchakuReasonsByDay = {};
            return d.muchakuReasonsByDay;
        }

        function openMuchakuModal(memberId, dayIndex, dateLabel) {
            currentMuchakuMember = memberId;
            currentMuchakuDay = dayIndex;

            const memberData = getMemberDaily(memberId);
            const muchakuCount = (memberData.muchaku || [0,0,0,0,0,0,0])[dayIndex] || 0;

            document.getElementById('muchakuModalDate').textContent = `(${dateLabel})`;
            document.getElementById('muchakuTargetCount').textContent = muchakuCount;

            const reasons = getMemberMuchakuReasons(memberId)[dayIndex] || { counts: [0,0,0,0,0,0,0], otherNote: '' };

            let html = muchakuReasonLabels.map((label, i) =>
                `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#0f172a;border-radius:6px">
                    <span>${label}</span>
                    <input type="number" class="input-sm muchaku-reason-input" data-index="${i}" value="${reasons.counts[i] || 0}" min="0" style="width:60px" onchange="updateMuchakuReasonTotal()">
                </div>`
            ).join('');
            document.getElementById('muchakuReasonInputs').innerHTML = html;
            document.getElementById('muchakuOtherNote').value = reasons.otherNote || '';

            updateMuchakuReasonTotal();
            openModal('muchakuModal');
        }

        function updateMuchakuReasonTotal() {
            const inputs = document.querySelectorAll('.muchaku-reason-input');
            let total = 0;
            inputs.forEach(inp => { total += parseInt(inp.value) || 0; });
            document.getElementById('muchakuReasonTotal').textContent = total;

            const target = parseInt(document.getElementById('muchakuTargetCount').textContent) || 0;
            const totalEl = document.getElementById('muchakuReasonTotal');
            if (total === target) {
                totalEl.style.color = '#22c55e';
            } else if (total > target) {
                totalEl.style.color = '#ef4444';
            } else {
                totalEl.style.color = '#eab308';
            }
        }

        function saveMuchakuReasons() {
            const inputs = document.querySelectorAll('.muchaku-reason-input');
            const counts = [];
            inputs.forEach(inp => { counts.push(parseInt(inp.value) || 0); });
            const otherNote = document.getElementById('muchakuOtherNote').value;

            const reasons = getMemberMuchakuReasons(currentMuchakuMember);
            reasons[currentMuchakuDay] = { counts, otherNote };

            saveData();
            syncToCloud();
            closeModal('muchakuModal');
            renderDailyInput();

            // é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ç„¡ç€åœ°ç†ç”±ã‚‚è‡ªå‹•æ›´æ–°
            aggregateMuchakuReasons();
        }

        function aggregateMuchakuReasons() {
            // å…¨ãƒ¡ãƒ³ãƒãƒ¼ã®å…¨æ—¥ã®ç„¡ç€åœ°ç†ç”±ã‚’é›†è¨ˆã—ã¦é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«åæ˜ 
            const totals = [0,0,0,0,0,0,0];
            data.members.forEach(member => {
                const reasons = getMemberMuchakuReasons(member.id);
                for (let day = 0; day < 7; day++) {
                    if (reasons[day] && reasons[day].counts) {
                        reasons[day].counts.forEach((c, i) => {
                            totals[i] += c;
                        });
                    }
                }
            });
            const review = getWeekData().review;
            totals.forEach((t, i) => { review.muchakuReasons[i] = t; });
            saveData();
            renderReview();
        }

        function hasMuchakuReasons(memberId, dayIndex) {
            const reasons = getMemberMuchakuReasons(memberId)[dayIndex];
            if (!reasons) return false;
            return reasons.counts && reasons.counts.some(c => c > 0);
        }

        // æ—¥åˆ¥NGç†ç”±ã®ç®¡ç†
        let currentNgMember = null;
        let currentNgDay = null;

        function getMemberNgReasons(memberId) {
            const d = getMemberDaily(memberId);
            if (!d.ngReasonsByDay) d.ngReasonsByDay = {};
            return d.ngReasonsByDay;
        }

        function openNgModal(memberId, dayIndex, dateLabel) {
            currentNgMember = memberId;
            currentNgDay = dayIndex;

            const memberData = getMemberDaily(memberId);
            const ngCount = (memberData.ng || [0,0,0,0,0,0,0])[dayIndex] || 0;

            document.getElementById('ngModalDate').textContent = `(${dateLabel})`;
            document.getElementById('ngTargetCount').textContent = ngCount;

            const reasons = getMemberNgReasons(memberId)[dayIndex] || { counts: [0,0,0,0,0], otherNote: '' };

            let html = ngReasonLabels.map((label, i) =>
                `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#0f172a;border-radius:6px">
                    <span>${label}</span>
                    <input type="number" class="input-sm ng-reason-input" data-index="${i}" value="${reasons.counts[i] || 0}" min="0" style="width:60px" onchange="updateNgReasonTotal()">
                </div>`
            ).join('');
            document.getElementById('ngReasonInputs').innerHTML = html;
            document.getElementById('ngOtherNote').value = reasons.otherNote || '';

            updateNgReasonTotal();
            openModal('ngModal');
        }

        function updateNgReasonTotal() {
            const inputs = document.querySelectorAll('.ng-reason-input');
            let total = 0;
            inputs.forEach(inp => { total += parseInt(inp.value) || 0; });
            document.getElementById('ngReasonTotal').textContent = total;

            const target = parseInt(document.getElementById('ngTargetCount').textContent) || 0;
            const totalEl = document.getElementById('ngReasonTotal');
            if (total === target) {
                totalEl.style.color = '#22c55e';
            } else if (total > target) {
                totalEl.style.color = '#ef4444';
            } else {
                totalEl.style.color = '#eab308';
            }
        }

        function saveNgReasons() {
            const inputs = document.querySelectorAll('.ng-reason-input');
            const counts = [];
            inputs.forEach(inp => { counts.push(parseInt(inp.value) || 0); });
            const otherNote = document.getElementById('ngOtherNote').value;

            const reasons = getMemberNgReasons(currentNgMember);
            reasons[currentNgDay] = { counts, otherNote };

            saveData();
            syncToCloud();
            closeModal('ngModal');
            renderDailyInput();

            // é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®NGç†ç”±ã‚‚è‡ªå‹•æ›´æ–°
            aggregateNgReasons();
        }

        function aggregateNgReasons() {
            // å…¨ãƒ¡ãƒ³ãƒãƒ¼ã®å…¨æ—¥ã®NGç†ç”±ã‚’é›†è¨ˆã—ã¦é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«åæ˜ 
            const totals = [0,0,0,0,0];
            data.members.forEach(member => {
                const reasons = getMemberNgReasons(member.id);
                for (let day = 0; day < 7; day++) {
                    if (reasons[day] && reasons[day].counts) {
                        reasons[day].counts.forEach((c, i) => {
                            totals[i] += c;
                        });
                    }
                }
            });
            const review = getWeekData().review;
            if (!review.ngReasons) review.ngReasons = {};
            totals.forEach((t, i) => { review.ngReasons[i] = t; });
            saveData();
            renderReview();
        }

        function hasNgReasons(memberId, dayIndex) {
            const reasons = getMemberNgReasons(memberId)[dayIndex];
            if (!reasons) return false;
            return reasons.counts && reasons.counts.some(c => c > 0);
        }

        // æ®‹æ¡ˆä»¶
        function renderCases() {
            const allCases = getWeekData().review.cases || [];
            // ãƒ¡ãƒ³ãƒãƒ¼ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆå…ƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿æŒï¼‰
            const filteredCases = allCases.map((c, i) => ({...c, _idx: i}))
                .filter(c => selectedMember === 'all' || !c.memberId || c.memberId === selectedMember);
            document.getElementById('sCasesCount').textContent = `(${filteredCases.length}ä»¶)`;
            const currentUserId = data.settings.currentUserId;
            document.getElementById('caseList').innerHTML = filteredCases.length === 0 ? '<p style="color:#64748b;font-size:13px">æ®‹æ¡ˆä»¶ãªã—</p>' :
                filteredCases.map(c => {
                    const isEditable = !c.memberId || c.memberId === currentUserId;
                    const memberName = c.memberId ? (data.members.find(m => m.id === c.memberId)?.name || '') : '';
                    const memberBadge = selectedMember === 'all' && memberName ? `<span style="font-size:10px;background:#6366f1;padding:2px 6px;border-radius:4px;margin-right:4px">${memberName}</span>` : '';
                    return `<div class="case-item" style="${isEditable ? '' : 'opacity:0.6'}">${memberBadge}<input type="text" value="${c.date||''}" placeholder="æ—¥ä»˜" onchange="updateCase(${c._idx},'date',this.value)" ${isEditable ? '' : 'disabled'}><input type="text" value="${c.customer||''}" placeholder="é¡§å®¢å" onchange="updateCase(${c._idx},'customer',this.value)" ${isEditable ? '' : 'disabled'}><input type="text" value="${c.closer||''}" placeholder="ã‚¯ãƒ­ãƒ¼ã‚¶ãƒ¼" onchange="updateCase(${c._idx},'closer',this.value)" ${isEditable ? '' : 'disabled'}><button class="btn btn-danger btn-sm" onclick="deleteCase(${c._idx})" ${isEditable ? '' : 'disabled'}>Ã—</button></div>`;
                }).join('');
        }
        function addCase() {
            const currentUserId = data.settings.currentUserId;
            if (!currentUserId) { alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„'); return; }
            getWeekData().review.cases.push({ memberId: currentUserId });
            saveData(); renderCases(); syncToCloud();
        }
        function updateCase(i,k,v) { getWeekData().review.cases[i][k] = v; saveData(); syncToCloud(); }
        function deleteCase(i) { getWeekData().review.cases.splice(i,1); saveData(); renderCases(); syncToCloud(); }

        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function renderCancels() {
            const allCancels = getWeekData().review.cancels || [];
            // ãƒ¡ãƒ³ãƒãƒ¼ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆå…ƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿æŒï¼‰
            const filteredCancels = allCancels.map((c, i) => ({...c, _idx: i}))
                .filter(c => selectedMember === 'all' || !c.memberId || c.memberId === selectedMember);
            document.getElementById('sCancelsCount').textContent = `(${filteredCancels.length}ä»¶)`;
            const currentUserId = data.settings.currentUserId;
            document.getElementById('cancelList').innerHTML = filteredCancels.length === 0 ? '<p style="color:#64748b;font-size:13px">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãªã—</p>' :
                filteredCancels.map(c => {
                    const isEditable = !c.memberId || c.memberId === currentUserId;
                    const memberName = c.memberId ? (data.members.find(m => m.id === c.memberId)?.name || '') : '';
                    const memberBadge = selectedMember === 'all' && memberName ? `<span style="font-size:10px;background:#6366f1;padding:2px 6px;border-radius:4px;margin-right:4px">${memberName}</span>` : '';
                    return `
                    <div style="padding:10px;background:#0f172a;border-radius:6px;margin-bottom:8px;border-left:3px solid #eab308;${isEditable ? '' : 'opacity:0.6'}">
                        ${memberBadge}
                        <div style="display:grid;grid-template-columns:80px 1fr 80px 30px;gap:8px;align-items:center;margin-bottom:8px">
                            <input type="text" value="${c.date||''}" placeholder="æ—¥ä»˜" style="font-size:12px" onchange="updateCancel(${c._idx},'date',this.value)" ${isEditable ? '' : 'disabled'}>
                            <input type="text" value="${c.customer||''}" placeholder="é¡§å®¢å" style="font-size:12px" onchange="updateCancel(${c._idx},'customer',this.value)" ${isEditable ? '' : 'disabled'}>
                            <input type="text" value="${c.closer||''}" placeholder="ã‚¯ãƒ­ãƒ¼ã‚¶ãƒ¼" style="font-size:12px" onchange="updateCancel(${c._idx},'closer',this.value)" ${isEditable ? '' : 'disabled'}>
                            <button class="btn btn-danger btn-sm" onclick="deleteCancel(${c._idx})" ${isEditable ? '' : 'disabled'}>Ã—</button>
                        </div>
                        <input type="text" value="${c.reason||''}" placeholder="ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±..." style="width:100%;font-size:12px" onchange="updateCancel(${c._idx},'reason',this.value)" ${isEditable ? '' : 'disabled'}>
                    </div>
                `}).join('');
        }
        function addCancel() {
            const currentUserId = data.settings.currentUserId;
            if (!currentUserId) { alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„'); return; }
            getWeekData().review.cancels.push({ memberId: currentUserId });
            saveData(); renderCancels(); syncToCloud();
        }
        function updateCancel(i,k,v) { getWeekData().review.cancels[i][k] = v; saveData(); syncToCloud(); renderCancels(); }
        function deleteCancel(i) { getWeekData().review.cancels.splice(i,1); saveData(); renderCancels(); syncToCloud(); }

        // å‹•å“¡å¾Œç„¡ç€åœ°
        function renderDoinMuchaku() {
            const r = getWeekData().review;
            if (!r.doinMuchakuList) r.doinMuchakuList = [];
            const allList = r.doinMuchakuList;
            // ãƒ¡ãƒ³ãƒãƒ¼ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆå…ƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿æŒï¼‰
            const filteredList = allList.map((item, i) => ({...item, _idx: i}))
                .filter(item => selectedMember === 'all' || !item.memberId || item.memberId === selectedMember);
            document.getElementById('sDoinMuchakuLabel').textContent = `(${filteredList.length}ä»¶)`;
            const currentUserId = data.settings.currentUserId;
            document.getElementById('doinMuchakuList').innerHTML = filteredList.length === 0 ? '<p style="color:#64748b;font-size:13px">å‹•å“¡å¾Œç„¡ç€åœ°ãªã—</p>' :
                filteredList.map(item => {
                    const isEditable = !item.memberId || item.memberId === currentUserId;
                    const memberName = item.memberId ? (data.members.find(m => m.id === item.memberId)?.name || '') : '';
                    const memberBadge = selectedMember === 'all' && memberName ? `<span style="font-size:10px;background:#6366f1;padding:2px 6px;border-radius:4px;margin-right:4px">${memberName}</span>` : '';
                    return `
                    <div style="padding:10px;background:#0f172a;border-radius:6px;margin-bottom:8px;border-left:3px solid #ef4444;${isEditable ? '' : 'opacity:0.6'}">
                        ${memberBadge}
                        <div style="display:grid;grid-template-columns:80px 1fr 80px 30px;gap:8px;align-items:center;margin-bottom:8px">
                            <input type="text" value="${item.date || ''}" placeholder="æ—¥ä»˜" style="font-size:12px" onchange="updateDoinMuchaku(${item._idx},'date',this.value)" ${isEditable ? '' : 'disabled'}>
                            <input type="text" value="${item.customer || ''}" placeholder="é¡§å®¢å" style="font-size:12px" onchange="updateDoinMuchaku(${item._idx},'customer',this.value)" ${isEditable ? '' : 'disabled'}>
                            <input type="text" value="${item.closer || ''}" placeholder="ã‚¯ãƒ­ãƒ¼ã‚¶ãƒ¼" style="font-size:12px" onchange="updateDoinMuchaku(${item._idx},'closer',this.value)" ${isEditable ? '' : 'disabled'}>
                            <button class="btn btn-danger btn-sm" onclick="deleteDoinMuchaku(${item._idx})" ${isEditable ? '' : 'disabled'}>Ã—</button>
                        </div>
                        <input type="text" value="${item.reason || ''}" placeholder="ç„¡ç€åœ°ç†ç”±..." style="width:100%;font-size:12px" onchange="updateDoinMuchaku(${item._idx},'reason',this.value)" ${isEditable ? '' : 'disabled'}>
                    </div>
                `}).join('');
        }
        function addDoinMuchaku() {
            const currentUserId = data.settings.currentUserId;
            if (!currentUserId) { alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„'); return; }
            const r = getWeekData().review;
            if (!r.doinMuchakuList) r.doinMuchakuList = [];
            r.doinMuchakuList.push({ memberId: currentUserId });
            saveData();
            renderDoinMuchaku();
            syncToCloud();
        }
        function updateDoinMuchaku(i, k, v) {
            const r = getWeekData().review;
            if (!r.doinMuchakuList) r.doinMuchakuList = [];
            r.doinMuchakuList[i][k] = v;
            saveData();
            syncToCloud();
            renderDoinMuchaku();
            renderSummary();
        }
        function deleteDoinMuchaku(i) {
            const r = getWeekData().review;
            r.doinMuchakuList.splice(i, 1);
            saveData();
            renderDoinMuchaku();
            syncToCloud();
            renderSummary();
        }

        // åŸå› +æ–½ç­–
        function renderCauseActions() {
            const r = getWeekData().review;
            if (!r.causeActions) r.causeActions = [{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]}];
            document.getElementById('causeActionList').innerHTML = [0,1,2,3,4].map(i => {
                const ca = r.causeActions[i] || { cause: '', actions: [] };
                const actionsHtml = (ca.actions || []).map((a,j) => `
                    <div class="action-row ${a.done?'completed':''}">
                        <input type="text" value="${a.text||''}" placeholder="æ–½ç­–ã‚’å…¥åŠ›..." onchange="updateCauseAction(${i},${j},'text',this.value)">
                        <input type="text" value="${a.deadline||''}" placeholder="æœŸé™" onchange="updateCauseAction(${i},${j},'deadline',this.value)">
                        <select onchange="updateCauseAction(${i},${j},'method',this.value)">
                            <option value="">ç®¡ç†æ–¹æ³•</option>
                            ${['ãƒãƒ£ãƒƒãƒˆ','Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼','FB','éŒ²ç”»æŒ¯ã‚Šè¿”ã‚Š','ã‚¢ãƒ','ã‚¢ãƒ©ãƒ¼ãƒ '].map(m => `<option value="${m}" ${a.method===m?'selected':''}>${m}</option>`).join('')}
                        </select>
                        <input type="checkbox" ${a.done?'checked':''} onchange="toggleCauseAction(${i},${j})">
                    </div>
                `).join('');
                return `
                    <div class="cause-action-card ${i===0?'primary':''}">
                        <div class="cause-header">
                            <div class="cause-num ${i===0?'primary':''}">${i+1}</div>
                            <input type="text" class="cause-input" value="${ca.cause||''}" placeholder="åŸå› ${i+1}ã‚’å…¥åŠ›..." onchange="updateCause(${i},this.value)">
                        </div>
                        ${actionsHtml}
                        <button class="btn btn-secondary btn-sm" style="margin-top:8px" onclick="addCauseAction(${i})">+ æ–½ç­–è¿½åŠ </button>
                    </div>
                `;
            }).join('');
        }

        function updateCause(i, v) {
            const r = getWeekData().review;
            if (!r.causeActions[i]) r.causeActions[i] = { cause: '', actions: [] };
            r.causeActions[i].cause = v;
            saveData(); syncToCloud();
        }

        function addCauseAction(causeIdx) {
            const r = getWeekData().review;
            if (!r.causeActions[causeIdx].actions) r.causeActions[causeIdx].actions = [];
            r.causeActions[causeIdx].actions.push({ text: '', deadline: '', method: '', done: false });
            saveData(); renderCauseActions();
        }

        function updateCauseAction(causeIdx, actionIdx, key, value) {
            getWeekData().review.causeActions[causeIdx].actions[actionIdx][key] = value;
            saveData(); syncToCloud();
        }

        function toggleCauseAction(causeIdx, actionIdx) {
            const a = getWeekData().review.causeActions[causeIdx].actions[actionIdx];
            a.done = !a.done;
            saveData(); renderCauseActions(); syncToCloud();
        }

        // Instagram
        function renderInstagram() {
            const dates = getWeekDates();
            const days = ['åœŸ','æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘'];

            const myAccounts = getMyAccounts();

            // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
            const accountSelect = document.getElementById('igAccountSelect');
            if (accountSelect) {
                const currentSelection = selectedIgAccount;
                accountSelect.innerHTML = '<option value="all">å…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆè¨ˆ</option>' +
                    myAccounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join('');
                // é¸æŠã‚’å¾©å…ƒï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
                if (currentSelection !== 'all' && myAccounts.some(acc => acc.id === currentSelection)) {
                    accountSelect.value = currentSelection;
                } else {
                    selectedIgAccount = 'all';
                    accountSelect.value = 'all';
                }
            }

            const noAccountMsg = selectedMember === 'all'
                ? '<p style="color:#64748b">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>'
                : '<p style="color:#64748b">ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã«ã¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œ+ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¿½åŠ ã€ã§è¿½åŠ ã§ãã¾ã™ã€‚</p>';
            document.getElementById('accountList').innerHTML = myAccounts.length === 0 ? noAccountMsg :
                myAccounts.map(acc => {
                    const d = getAccountData(acc.id);
                    return `<div class="account-section"><div class="account-header" onclick="toggleAccount('${acc.id}')"><h4>${acc.name}</h4><span style="color:#64748b;font-size:12px">ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹</span></div><div class="account-body" id="acc-${acc.id}"><div style="overflow-x:auto"><table style="min-width:600px"><thead><tr><th>é …ç›®</th>${days.map((dy,i) => `<th>${dy}<br>${dates[i].getDate()}æ—¥</th>`).join('')}<th>åˆè¨ˆ</th></tr></thead><tbody>${renderIgRow(acc.id,'follow','ãƒ•ã‚©ãƒ­ãƒ¼',d)}${renderIgRow(acc.id,'follower','ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼',d)}${renderIgRow(acc.id,'followCut','ãƒ•ã‚©ãƒ­ãƒ¼å‰Šã‚Š',d)}${renderIgRow(acc.id,'followerCut','ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼å‰Šã‚Š',d)}${renderIgRow(acc.id,'dmSend','DMé€ä¿¡',d)}${renderIgRow(acc.id,'dmReply','DMè¿”ä¿¡',d)}${renderIgRow(acc.id,'dmOffer','ã‚ªãƒ•ã‚¡ãƒ¼',d)}${renderIgRow(acc.id,'apoGet','ã‚¢ãƒç²å¾—',d)}${renderIgRow(acc.id,'apoExec','ã‚¢ãƒå®Ÿæ–½',d)}${renderIgRow(acc.id,'doinPlan','å‹•å“¡äºˆå®š',d)}${renderIgRow(acc.id,'doinExec','å‹•å“¡å®Ÿæ–½',d)}${renderIgRow(acc.id,'seiyaku','æˆç´„',d)}</tbody></table></div><button class="btn btn-danger btn-sm" style="margin-top:12px" onclick="deleteAccount('${acc.id}')">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤</button></div></div>`;
                }).join('');

            // åˆ†æå¯¾è±¡ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æ±ºå®š
            const analysisAccounts = selectedIgAccount === 'all'
                ? myAccounts
                : myAccounts.filter(acc => acc.id === selectedIgAccount);

            // æœˆå…¨ä½“ã®ãƒˆãƒ¼ã‚¿ãƒ«ã‚’è¨ˆç®—ï¼ˆé¸æŠã—ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã¿ï¼‰
            let totals = { follow: 0, follower: 0, followCut: 0, followerCut: 0, send: 0, reply: 0, offer: 0, apoGet: 0, apoExec: 0, doinPlan: 0, doinExec: 0, seiyaku: 0 };
            for (let w = 1; w <= 5; w++) {
                const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                if (data.weeks[weekKey] && data.weeks[weekKey].instagram) {
                    analysisAccounts.forEach(acc => {
                        const d = data.weeks[weekKey].instagram[acc.id];
                        if (d) {
                            totals.follow += (d.follow || [0,0,0,0,0,0,0]).reduce((a,b) => a+b, 0);
                            totals.follower += (d.follower || [0,0,0,0,0,0,0]).reduce((a,b) => a+b, 0);
                            totals.followCut += (d.followCut || [0,0,0,0,0,0,0]).reduce((a,b) => a+b, 0);
                            totals.followerCut += (d.followerCut || [0,0,0,0,0,0,0]).reduce((a,b) => a+b, 0);
                            totals.send += (d.dmSend || [0,0,0,0,0,0,0]).reduce((a,b) => a+b, 0);
                            totals.reply += (d.dmReply || [0,0,0,0,0,0,0]).reduce((a,b) => a+b, 0);
                            totals.offer += (d.dmOffer || [0,0,0,0,0,0,0]).reduce((a,b) => a+b, 0);
                            totals.apoGet += (d.apoGet || [0,0,0,0,0,0,0]).reduce((a,b) => a+b, 0);
                            totals.apoExec += (d.apoExec || [0,0,0,0,0,0,0]).reduce((a,b) => a+b, 0);
                            totals.doinPlan += (d.doinPlan || [0,0,0,0,0,0,0]).reduce((a,b) => a+b, 0);
                            totals.doinExec += (d.doinExec || [0,0,0,0,0,0,0]).reduce((a,b) => a+b, 0);
                            totals.seiyaku += (d.seiyaku || [0,0,0,0,0,0,0]).reduce((a,b) => a+b, 0);
                        }
                    });
                }
            }

            // ä»Šæ—¥ã¾ã§ã®æ—¥å‰²ã‚Šç›®æ¨™ã‚’è¨ˆç®—
            const ig = data.settings.instagram || {};
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const today = new Date();
            const currentDay = (today.getFullYear() === currentYear && today.getMonth() + 1 === currentMonth)
                ? today.getDate() : daysInMonth;

            const proratedGoal = (goal) => Math.ceil((goal || 0) / daysInMonth * currentDay);

            // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ã®å€¤ã¨ç›®æ¨™ã‚’è¡¨ç¤º
            document.getElementById('igSend').textContent = totals.send;
            document.getElementById('igSendGoal').textContent = proratedGoal(ig.send);
            setRateDisplay('igSendRate', 'igSendBar', totals.send, proratedGoal(ig.send));

            document.getElementById('igReply').textContent = totals.reply;
            document.getElementById('igReplyGoal').textContent = proratedGoal(ig.reply);
            setRateDisplay('igReplyRate', 'igReplyBar', totals.reply, proratedGoal(ig.reply));

            document.getElementById('igOffer').textContent = totals.offer;
            document.getElementById('igOfferGoal').textContent = proratedGoal(ig.offer);
            setRateDisplay('igOfferRate', 'igOfferBar', totals.offer, proratedGoal(ig.offer));

            document.getElementById('igApoGet').textContent = totals.apoGet;
            document.getElementById('igApoGetGoal').textContent = proratedGoal(ig.apoGet);
            setRateDisplay('igApoGetRate', 'igApoGetBar', totals.apoGet, proratedGoal(ig.apoGet));

            document.getElementById('igApoExec').textContent = totals.apoExec;
            document.getElementById('igApoExecGoal').textContent = proratedGoal(ig.apoExec);
            setRateDisplay('igApoExecRate', 'igApoExecBar', totals.apoExec, proratedGoal(ig.apoExec));

            document.getElementById('igDoinExec').textContent = totals.doinExec;
            document.getElementById('igDoinExecGoal').textContent = proratedGoal(ig.doinExec);
            setRateDisplay('igDoinExecRate', 'igDoinExecBar', totals.doinExec, proratedGoal(ig.doinExec));

            document.getElementById('igSeiyaku').textContent = totals.seiyaku;
            document.getElementById('igSeiyakuGoal').textContent = proratedGoal(ig.seiyaku);
            setRateDisplay('igSeiyakuRate', 'igSeiyakuBar', totals.seiyaku, proratedGoal(ig.seiyaku));

            // KPIã‚’è¨ˆç®—ãƒ»è¡¨ç¤º
            document.getElementById('igKpiReply').textContent = pct(totals.reply, totals.send);
            document.getElementById('igKpiOfferReach').textContent = pct(totals.offer, totals.send);
            document.getElementById('igKpiOfferPass').textContent = pct(totals.apoGet, totals.offer);
            document.getElementById('igKpiApoGet').textContent = pct(totals.apoGet, totals.send);
            document.getElementById('igKpiApoExec').textContent = pct(totals.apoExec, totals.apoGet);
            document.getElementById('igKpiDoin').textContent = pct(totals.doinExec, totals.apoExec);
            document.getElementById('igKpiSeiyaku').textContent = pct(totals.seiyaku, totals.doinExec);

            // é€²æ—ã‚°ãƒ©ãƒ•ã‚’æç”»
            renderIgCharts(ig);

            // ãƒ•ã‚¡ãƒãƒ«åˆ†æã‚’æç”»
            renderIgFunnel(totals);

            // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ¥ã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
            renderIgAccountSummaryTable();
        }

        function renderIgCharts(ig) {
            const container = document.getElementById('igChartsGrid');
            if (!container) return;

            const chartConfigs = [
                { label: 'ãƒ•ã‚©ãƒ­ãƒ¼', key: 'igFollow', goal: ig.follow || 0 },
                { label: 'ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼', key: 'igFollower', goal: ig.follower || 0 },
                { label: 'ãƒ•ã‚©ãƒ­ãƒ¼å‰Šã‚Š', key: 'igFollowCut', goal: ig.followCut || 0 },
                { label: 'ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼å‰Šã‚Š', key: 'igFollowerCut', goal: ig.followerCut || 0 },
                { label: 'DMé€ä¿¡', key: 'igSend', goal: ig.send || 0 },
                { label: 'DMè¿”ä¿¡', key: 'igReply', goal: ig.reply || 0 },
                { label: 'ã‚ªãƒ•ã‚¡ãƒ¼', key: 'igOffer', goal: ig.offer || 0 },
                { label: 'ã‚¢ãƒç²å¾—', key: 'igApoGet', goal: ig.apoGet || 0 },
                { label: 'ã‚¢ãƒå®Ÿæ–½', key: 'igApoExec', goal: ig.apoExec || 0 },
                { label: 'å‹•å“¡äºˆå®š', key: 'igDoinPlan', goal: ig.doinPlan || 0 },
                { label: 'å‹•å“¡å®Ÿæ–½', key: 'igDoinExec', goal: ig.doinExec || 0 },
                { label: 'æˆç´„', key: 'igSeiyaku', goal: ig.seiyaku || 0 }
            ];

            container.innerHTML = chartConfigs.map(config => {
                const { actualData, targetData, numDays, labels } = getIgChartData(config.key, config.goal);
                const maxVal = Math.max(...actualData, ...targetData, 1);
                const svg = createLargeChartSVG(actualData, targetData, maxVal, numDays, labels);

                return `<div class="chart-card">
                    <h4>${config.label}</h4>
                    <div class="chart-container">${svg}</div>
                    <div class="chart-legend">
                        <span><div class="legend-line target"></div>ç›®æ¨™</span>
                        <span><div class="legend-line actual"></div>å®Ÿç¸¾</span>
                    </div>
                </div>`;
            }).join('');
        }

        function getIgChartData(metricKey, monthlyGoal) {
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            let actualData = [];
            let targetData = [];
            let labels = [];
            const numDays = daysInMonth;
            const dailyGoal = monthlyGoal / daysInMonth;

            const keyMap = {
                'igFollow': 'follow', 'igFollower': 'follower', 'igFollowCut': 'followCut', 'igFollowerCut': 'followerCut',
                'igSend': 'dmSend', 'igReply': 'dmReply', 'igOffer': 'dmOffer',
                'igApoGet': 'apoGet', 'igApoExec': 'apoExec', 'igDoinPlan': 'doinPlan', 'igDoinExec': 'doinExec', 'igSeiyaku': 'seiyaku'
            };
            const dataKey = keyMap[metricKey] || metricKey;

            let cumulative = 0;
            for (let day = 1; day <= daysInMonth; day++) {
                const dayValue = getIgDayValue(dataKey, day);
                cumulative += dayValue;
                actualData.push(cumulative);
                targetData.push(dailyGoal * day);
                labels.push(day.toString());
            }

            return { actualData, targetData, numDays, labels };
        }

        function getIgDayValue(dataKey, day) {
            const date = new Date(currentYear, currentMonth - 1, day);
            const firstDay = new Date(currentYear, currentMonth - 1, 1);
            const dow = (firstDay.getDay() + 1) % 7;
            const weekNum = Math.ceil((day + dow) / 7);
            const dayOfWeek = (date.getDay() + 1) % 7;

            const weekKey = `${currentYear}-${currentMonth}-W${weekNum}`;
            let total = 0;
            if (data.weeks[weekKey] && data.weeks[weekKey].instagram) {
                // é¸æŠã•ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼ãƒ»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const myAccounts = getMyAccounts();
                const analysisAccounts = selectedIgAccount === 'all'
                    ? myAccounts
                    : myAccounts.filter(acc => acc.id === selectedIgAccount);

                analysisAccounts.forEach(acc => {
                    const d = data.weeks[weekKey].instagram[acc.id];
                    if (d && d[dataKey]) {
                        total += d[dataKey][dayOfWeek] || 0;
                    }
                });
            }
            return total;
        }

        function renderIgFunnel(totals) {
            const container = document.getElementById('igFunnel');
            if (!container) return;

            const stages = [
                { label: 'ãƒ•ã‚©ãƒ­ãƒ¼', value: totals.follow, color: '#3b82f6' },
                { label: 'ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼', value: totals.follower, color: '#0ea5e9' },
                { label: 'ãƒ•ã‚©ãƒ­ãƒ¼å‰Šã‚Š', value: totals.followCut, color: '#06b6d4' },
                { label: 'ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼å‰Šã‚Š', value: totals.followerCut, color: '#14b8a6' },
                { label: 'DMé€ä¿¡', value: totals.send, color: '#6366f1' },
                { label: 'DMè¿”ä¿¡', value: totals.reply, color: '#8b5cf6' },
                { label: 'ã‚ªãƒ•ã‚¡ãƒ¼', value: totals.offer, color: '#a855f7' },
                { label: 'ã‚¢ãƒç²å¾—', value: totals.apoGet, color: '#d946ef' },
                { label: 'ã‚¢ãƒå®Ÿæ–½', value: totals.apoExec, color: '#ec4899' },
                { label: 'å‹•å“¡äºˆå®š', value: totals.doinPlan, color: '#f97316' },
                { label: 'å‹•å“¡å®Ÿæ–½', value: totals.doinExec, color: '#f43f5e' },
                { label: 'æˆç´„', value: totals.seiyaku, color: '#22c55e' }
            ];

            const maxValue = Math.max(...stages.map(s => s.value), 1);

            container.innerHTML = stages.map((stage, i) => {
                const widthPct = Math.max((stage.value / maxValue) * 100, 5);
                const convRate = i > 0 && stages[i-1].value > 0 ? Math.round((stage.value / stages[i-1].value) * 100) : 100;
                return `<div style="display:flex;align-items:center;gap:8px">
                    <div style="width:70px;font-size:11px;color:#94a3b8">${stage.label}</div>
                    <div style="flex:1;height:24px;background:#1e293b;border-radius:4px;overflow:hidden;position:relative">
                        <div style="width:${widthPct}%;height:100%;background:${stage.color};display:flex;align-items:center;justify-content:flex-end;padding-right:8px;font-size:11px;font-weight:600">${stage.value}</div>
                    </div>
                    <div style="width:40px;font-size:10px;color:${convRate >= 50 ? '#22c55e' : convRate >= 30 ? '#eab308' : '#ef4444'}">${i > 0 ? convRate + '%' : ''}</div>
                </div>`;
            }).join('');
        }

        function renderIgAccountSummaryTable() {
            const container = document.getElementById('igAccountSummaryTable');
            if (!container) return;

            const myAccounts = getMyAccounts();
            if (myAccounts.length === 0) {
                const msg = selectedMember === 'all'
                    ? 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„'
                    : 'ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã«ã¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“';
                container.innerHTML = `<tr><td colspan="10" style="text-align:center;color:#64748b">${msg}</td></tr>`;
                return;
            }

            container.innerHTML = myAccounts.map(acc => {
                // æœˆå…¨ä½“ã®ãƒˆãƒ¼ã‚¿ãƒ«ã‚’è¨ˆç®—
                let t = { send: 0, reply: 0, offer: 0, apoGet: 0, apoExec: 0, doinExec: 0, seiyaku: 0 };
                for (let w = 1; w <= 5; w++) {
                    const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                    if (data.weeks[weekKey] && data.weeks[weekKey].instagram && data.weeks[weekKey].instagram[acc.id]) {
                        const d = data.weeks[weekKey].instagram[acc.id];
                        t.send += (d.dmSend || [0,0,0,0,0,0,0]).reduce((a,b) => a+b, 0);
                        t.reply += (d.dmReply || [0,0,0,0,0,0,0]).reduce((a,b) => a+b, 0);
                        t.offer += (d.dmOffer || [0,0,0,0,0,0,0]).reduce((a,b) => a+b, 0);
                        t.apoGet += (d.apoGet || [0,0,0,0,0,0,0]).reduce((a,b) => a+b, 0);
                        t.apoExec += (d.apoExec || [0,0,0,0,0,0,0]).reduce((a,b) => a+b, 0);
                        t.doinExec += (d.doinExec || [0,0,0,0,0,0,0]).reduce((a,b) => a+b, 0);
                        t.seiyaku += (d.seiyaku || [0,0,0,0,0,0,0]).reduce((a,b) => a+b, 0);
                    }
                }
                const replyRate = t.send > 0 ? Math.round((t.reply / t.send) * 100) : 0;
                const seiyakuRate = t.doinExec > 0 ? Math.round((t.seiyaku / t.doinExec) * 100) : 0;

                return `<tr>
                    <td><strong>${acc.name}</strong></td>
                    <td>${t.send}</td>
                    <td>${t.reply}</td>
                    <td>${t.offer}</td>
                    <td>${t.apoGet}</td>
                    <td>${t.apoExec}</td>
                    <td>${t.doinExec}</td>
                    <td class="${t.seiyaku > 0 ? 'good' : ''}">${t.seiyaku}</td>
                    <td class="${replyRate >= 30 ? 'good' : replyRate >= 15 ? 'warning' : 'danger'}">${replyRate}%</td>
                    <td class="${seiyakuRate >= 50 ? 'good' : seiyakuRate >= 30 ? 'warning' : 'danger'}">${seiyakuRate}%</td>
                </tr>`;
            }).join('');
        }

        function renderIgRow(accId, key, label, d) {
            const arr = d[key] || [0,0,0,0,0,0,0];
            return `<tr><td>${label}</td>${[0,1,2,3,4,5,6].map(i => `<td><input type="number" class="input-sm" value="${arr[i]}" min="0" onchange="updateIg('${accId}','${key}',${i},this.value)"></td>`).join('')}<td><strong>${arr.reduce((a,b)=>a+b,0)}</strong></td></tr>`;
        }

        function changeIgAccount() {
            selectedIgAccount = document.getElementById('igAccountSelect').value;
            renderInstagram();
        }

        function updateIg(accId, key, idx, val) {
            // é–‹ã„ã¦ã„ã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨˜æ†¶
            const openAccounts = [];
            data.accounts.forEach(acc => {
                const el = document.getElementById('acc-' + acc.id);
                if (el && el.classList.contains('open')) {
                    openAccounts.push(acc.id);
                }
            });

            getAccountData(accId)[key][idx] = parseInt(val) || 0;
            saveData();
            syncToCloud();
            renderInstagram();

            // é–‹ã„ã¦ã„ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å¾©å…ƒ
            openAccounts.forEach(id => {
                const el = document.getElementById('acc-' + id);
                if (el) el.classList.add('open');
            });
        }

        // æ—¥å ±ï¼ˆNippoï¼‰æ©Ÿèƒ½
        function renderWeekTabs() {
            const html = [1,2,3,4,5].map(w =>
                `<button class="week-tab ${w === currentWeekNum ? 'active' : ''}" onclick="switchWeekTab(${w})">ç¬¬${w}é€±</button>`
            ).join('');
            document.getElementById('weekTabs').innerHTML = html;
        }

        function switchWeekTab(weekNum) {
            saveAll();
            currentWeekNum = weekNum;
            updateWeekLabel();
            renderAll();
        }

        function setNippoView(mode) {
            nippoViewMode = mode;
            const btnAll = document.getElementById('btnAllMembers');
            const btnSingle = document.getElementById('btnSingleMember');
            const memberSelect = document.getElementById('nippoMemberSelect');

            if (mode === 'all') {
                btnAll.className = 'btn btn-sm active';
                btnSingle.className = 'btn btn-sm btn-secondary';
                memberSelect.style.display = 'none';
            } else {
                btnAll.className = 'btn btn-sm btn-secondary';
                btnSingle.className = 'btn btn-sm active';
                memberSelect.style.display = 'block';
                if (!nippoSelectedMember && data.members.length > 0) {
                    nippoSelectedMember = data.members[0].id;
                }
                memberSelect.value = nippoSelectedMember;
            }
            renderNippo();
        }

        function renderNippo() {
            renderWeekTabs();

            const currentUserId = data.settings.currentUserId;
            const dates = getWeekDates();
            const days = ['åœŸ','æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘'];
            const monthVideos = getMonthVideos();

            let html = '';

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®selectedMemberã‚’ä½¿ç”¨
            const membersToShow = selectedMember === 'all' ? data.members :
                data.members.filter(m => m.id === selectedMember);

            if (membersToShow.length === 0) {
                html = '<p style="color:#64748b;text-align:center;padding:40px">ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¨­å®šã‚¿ãƒ–ã§è¿½åŠ ã—ã¦ãã ã•ã„</p>';
            } else {
                dates.forEach((date, dayIndex) => {
                    const dateStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
                    const videoUrl = monthVideos[dateStr] || '';

                    membersToShow.forEach(member => {
                        const nippoData = getNippoData(member.id, dayIndex);
                        const isMyData = member.id === currentUserId;
                        const disabledAttr = isMyData ? '' : 'disabled';
                        const cardStyle = isMyData ? '' : 'opacity:0.7;';
                        const lockIcon = isMyData ? '' : ' ğŸ”’';

                        html += `
                            <div class="nippo-day-card" style="${cardStyle}">
                                <div class="day-header">
                                    <div class="day-title">${days[dayIndex]}æ›œæ—¥ - ${date.getMonth()+1}/${date.getDate()}</div>
                                    <div class="member-name">${member.name}${lockIcon}</div>
                                </div>

                                <div class="nippo-block">
                                    <div class="nippo-block-label"><span class="icon">ğŸ¬</span> ã‚¤ãƒ³ãƒ—ãƒƒãƒˆå‹•ç”»</div>
                                    ${videoUrl ? `
                                        <div class="nippo-video-container">
                                            ${renderVideoEmbed(videoUrl)}
                                        </div>
                                    ` : `
                                        <p style="color:#64748b;font-size:13px;padding:12px;background:#1e293b;border-radius:8px">å‹•ç”»æœªè¨­å®šï¼ˆä¸Šéƒ¨ã®ã€Œå‹•ç”»ã‚’ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ã‹ã‚‰è¨­å®šï¼‰</p>
                                    `}
                                </div>

                                <div class="nippo-block">
                                    <div class="nippo-block-label"><span class="icon">ğŸ“</span> ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆï¼ˆå­¦ã‚“ã ã“ã¨ãƒ»æ°—ã¥ãï¼‰</div>
                                    <textarea class="nippo-textarea" placeholder="ä»Šæ—¥ã®å‹•ç”»ã‹ã‚‰å­¦ã‚“ã ã“ã¨ã‚’æ›¸ã„ã¦ãã ã•ã„..." ${disabledAttr} onchange="updateNippo('${member.id}',${dayIndex},'output',this.value)">${nippoData.output || ''}</textarea>
                                </div>

                                <div class="nippo-block">
                                    <div class="nippo-block-label"><span class="icon">ğŸ™</span> æ„Ÿè¬æ—¥è¨˜</div>
                                    <textarea class="nippo-textarea" placeholder="ä»Šæ—¥æ„Ÿè¬ã—ãŸã“ã¨ã‚’æ›¸ã„ã¦ãã ã•ã„..." ${disabledAttr} onchange="updateNippo('${member.id}',${dayIndex},'gratitude',this.value)">${nippoData.gratitude || ''}</textarea>
                                </div>
                            </div>
                        `;
                    });
                });
            }

            document.getElementById('nippoContent').innerHTML = html;
        }

        function renderVideoEmbed(url) {
            if (!url) return '';
            // YouTube
            const ytMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]+)/);
            if (ytMatch) {
                const videoId = ytMatch[1];
                const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                return `
                    <a href="https://www.youtube.com/watch?v=${videoId}" target="_blank"
                       style="display:block;width:100%;background:#0f172a;border-radius:8px;overflow:hidden;text-decoration:none;transition:transform 0.2s,box-shadow 0.2s;box-shadow:0 2px 8px rgba(0,0,0,0.3)"
                       onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(99,102,241,0.4)'"
                       onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 8px rgba(0,0,0,0.3)'">
                        <div style="position:relative;width:100%;height:200px;background:#000;overflow:hidden">
                            <img src="${thumbnailUrl}"
                                 style="width:100%;height:100%;object-fit:cover"
                                 onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
                            <div style="display:none;width:100%;height:100%;align-items:center;justify-content:center;background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%)">
                                <span style="font-size:48px">ğŸ¥</span>
                            </div>
                            <div style="position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.3)">
                                <div style="width:60px;height:60px;background:rgba(99,102,241,0.9);border-radius:50%;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)">
                                    <div style="width:0;height:0;border-left:20px solid white;border-top:12px solid transparent;border-bottom:12px solid transparent;margin-left:4px"></div>
                                </div>
                            </div>
                        </div>
                        <div style="padding:12px;background:#1e293b">
                            <div style="color:#e2e8f0;font-size:13px;font-weight:600;margin-bottom:4px">ğŸ“º ã‚¤ãƒ³ãƒ—ãƒƒãƒˆå‹•ç”»</div>
                            <div style="color:#94a3b8;font-size:11px">ã‚¯ãƒªãƒƒã‚¯ã—ã¦YouTubeã§è¦–è´</div>
                        </div>
                    </a>`;
            }
            // Vimeo
            const vimeoMatch = url.match(/vimeo\.com\/(\d+)/);
            if (vimeoMatch) {
                return `<iframe src="https://player.vimeo.com/video/${vimeoMatch[1]}" frameborder="0" allowfullscreen style="width:100%;height:200px;border-radius:6px"></iframe>`;
            }
            // Google Drive
            if (url.includes('drive.google.com')) {
                const driveMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
                if (driveMatch) {
                    const fileId = driveMatch[1];
                    return `
                        <a href="${url}" target="_blank"
                           style="display:block;width:100%;background:#0f172a;border-radius:8px;overflow:hidden;text-decoration:none;transition:transform 0.2s,box-shadow 0.2s;box-shadow:0 2px 8px rgba(0,0,0,0.3)"
                           onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(99,102,241,0.4)'"
                           onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 8px rgba(0,0,0,0.3)'">
                            <div style="position:relative;width:100%;height:200px;background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);display:flex;align-items:center;justify-content:center">
                                <div style="text-align:center">
                                    <div style="font-size:64px;margin-bottom:8px">ğŸ“</div>
                                    <div style="width:60px;height:60px;background:rgba(99,102,241,0.9);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto">
                                        <div style="width:0;height:0;border-left:20px solid white;border-top:12px solid transparent;border-bottom:12px solid transparent;margin-left:4px"></div>
                                    </div>
                                </div>
                            </div>
                            <div style="padding:12px;background:#1e293b">
                                <div style="color:#e2e8f0;font-size:13px;font-weight:600;margin-bottom:4px">ğŸ“ ã‚¤ãƒ³ãƒ—ãƒƒãƒˆå‹•ç”»</div>
                                <div style="color:#94a3b8;font-size:11px">ã‚¯ãƒªãƒƒã‚¯ã—ã¦Google Driveã§è¦–è´</div>
                            </div>
                        </a>`;
                }
            }
            // ç›´æ¥ãƒªãƒ³ã‚¯
            if (url.match(/\.(mp4|webm|ogg)$/i)) {
                return `<video controls src="${url}" style="width:100%;max-height:200px;border-radius:6px"></video>`;
            }
            // ãã®ä»–ã¯ãƒªãƒ³ã‚¯è¡¨ç¤º
            return `<a href="${url}" target="_blank" style="color:#6366f1;word-break:break-all">${url}</a>`;
        }

        function updateNippo(memberId, dayIndex, field, value) {
            const nippoData = getNippoData(memberId, dayIndex);
            nippoData[field] = value;
            saveData();
            syncToCloud();
        }

        function openVideoUploadModal() {
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const monthVideos = getMonthVideos();

            let html = `<p style="margin-bottom:12px;font-weight:600">${currentYear}å¹´${currentMonth}æœˆã®å‹•ç”»URL</p>`;

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const date = new Date(currentYear, currentMonth - 1, day);
                const dayOfWeek = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][date.getDay()];
                const videoUrl = monthVideos[dateStr] || '';

                html += `
                    <div class="video-upload-row">
                        <div class="date-label">${currentMonth}/${day}ï¼ˆ${dayOfWeek}ï¼‰</div>
                        <input type="text" class="nippo-video-url" id="video_${dateStr}" value="${videoUrl}" placeholder="å‹•ç”»URLï¼ˆYouTube, Vimeo, Google Driveç­‰ï¼‰">
                    </div>
                `;
            }

            document.getElementById('videoUploadList').innerHTML = html;
            openModal('videoUploadModal');
        }

        function saveVideoUrls() {
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const monthVideos = getMonthVideos();

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const input = document.getElementById(`video_${dateStr}`);
                if (input) {
                    monthVideos[dateStr] = input.value.trim();
                }
            }

            saveData();
            syncToCloud();
            closeModal('videoUploadModal');
            renderNippo();
        }

        function exportNippoCsv() {
            const dates = getWeekDates();
            const days = ['åœŸ','æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘'];
            const monthVideos = getMonthVideos();

            let csv = '\uFEFF'; // BOM for Excel
            csv += 'æ—¥ä»˜,æ›œæ—¥,ãƒ¡ãƒ³ãƒãƒ¼,å‹•ç”»URL,ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ,æ„Ÿè¬æ—¥è¨˜\n';

            dates.forEach((date, dayIndex) => {
                const dateStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
                const videoUrl = monthVideos[dateStr] || '';

                data.members.forEach(member => {
                    const nippoData = getNippoData(member.id, dayIndex);
                    const row = [
                        `${date.getMonth()+1}/${date.getDate()}`,
                        days[dayIndex],
                        member.name,
                        videoUrl,
                        (nippoData.output || '').replace(/"/g, '""').replace(/\n/g, ' '),
                        (nippoData.gratitude || '').replace(/"/g, '""').replace(/\n/g, ' ')
                    ].map(v => `"${v}"`).join(',');
                    csv += row + '\n';
                });
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `æ—¥å ±_${currentYear}å¹´${currentMonth}æœˆ_ç¬¬${currentWeekNum}é€±.csv`;
            a.click();
        }

        // å‹•ç”»URLå°‚ç”¨CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆæ—¥ä»˜,URLå½¢å¼ï¼‰
        function importVideoCsv(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());

                    if (lines.length < 2) {
                        alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                        return;
                    }

                    if (!data.monthVideos) data.monthVideos = {};
                    let importCount = 0;

                    for (let i = 1; i < lines.length; i++) {
                        const row = parseCSVRow(lines[i]);
                        if (row.length < 2) continue;

                        const dateStr = row[0].trim();
                        const videoUrl = row[1].trim();

                        if (!videoUrl) continue;

                        // æ—¥ä»˜å½¢å¼ã‚’åˆ¤å®šã—ã¦ã‚­ãƒ¼ã‚’ç”Ÿæˆ
                        let dateKey = '';
                        let year, month;
                        if (dateStr.includes('-')) {
                            // YYYY-MM-DDå½¢å¼
                            const parts = dateStr.split('-').map(Number);
                            year = parts[0];
                            month = parts[1];
                            dateKey = dateStr;
                        } else if (dateStr.includes('/')) {
                            // M/Då½¢å¼ â†’ ç¾åœ¨ã®å¹´ã§è£œå®Œ
                            const parts = dateStr.split('/').map(Number);
                            month = parts[0];
                            const d = parts[1];
                            year = currentYear;
                            dateKey = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                        }

                        if (dateKey && year && month) {
                            // è©²å½“å¹´æœˆã®monthVideosã«ä¿å­˜
                            const monthKey = `${year}-${month}`;
                            if (!data.monthVideos[monthKey]) data.monthVideos[monthKey] = {};
                            data.monthVideos[monthKey][dateKey] = videoUrl;
                            importCount++;
                        }
                    }

                    saveData();
                    syncToCloud();
                    renderNippo();
                    alert(`${importCount}ä»¶ã®å‹•ç”»URLã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);

                } catch (err) {
                    console.error(err);
                    alert('CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }

        // æ—¥ä»˜ã‹ã‚‰é€±æƒ…å ±ã‚’è¨ˆç®—
        function getWeekInfoFromDate(dateObj) {
            const year = dateObj.getFullYear();
            const dayOfWeek = dateObj.getDay(); // 0=æ—¥, 1=æœˆ, ..., 6=åœŸ
            const dayIndex = (dayOfWeek + 1) % 7; // åœŸ=0, æ—¥=1, æœˆ=2, ...

            // ã“ã®æ—¥ä»˜ãŒå«ã¾ã‚Œã‚‹é€±ã‚’æ¢ã™ï¼ˆç¿Œæœˆã‹ã‚‰æ¤œç´¢é–‹å§‹ - æœˆæœ«æ—¥ãŒç¿Œæœˆé€±1ã«å±ã™ã‚‹å ´åˆå¯¾å¿œï¼‰
            const startMonth = Math.min(dateObj.getMonth() + 2, 12);
            for (let month = startMonth; month >= 1; month--) {
                for (let weekNum = 1; weekNum <= 5; weekNum++) {
                    const firstDay = new Date(year, month - 1, 1);
                    const dow = (firstDay.getDay() + 1) % 7;
                    const weekStart = new Date(year, month - 1, 1 - dow + (weekNum - 1) * 7);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);

                    if (dateObj >= weekStart && dateObj <= weekEnd) {
                        return { year, month, weekNum, dayIndex };
                    }
                }
            }
            return null;
        }

        function importNippoCsv(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let text = e.target.result;
                    // BOMé™¤å»
                    if (text.charCodeAt(0) === 0xFEFF) {
                        text = text.slice(1);
                    }
                    const lines = text.split('\n').filter(line => line.trim());

                    if (lines.length < 2) {
                        alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                        return;
                    }

                    let importCount = 0;
                    let newMemberCount = 0;
                    const addedMembers = new Set();

                    for (let i = 1; i < lines.length; i++) {
                        const row = parseCSVRow(lines[i]);
                        if (row.length < 4) continue;

                        const [dateStr, dayName, memberName, videoUrl, output, gratitude] = row;
                        const trimmedName = (memberName || '').trim();
                        if (!trimmedName) continue;

                        // æ—¥ä»˜ã‚’ãƒ‘ãƒ¼ã‚¹ (M/Då½¢å¼)
                        const dateParts = (dateStr || '').trim().split('/');
                        if (dateParts.length !== 2) continue;
                        const month = parseInt(dateParts[0]);
                        const day = parseInt(dateParts[1]);
                        if (isNaN(month) || isNaN(day)) continue;

                        const dateObj = new Date(currentYear, month - 1, day);
                        const weekInfo = getWeekInfoFromDate(dateObj);
                        if (!weekInfo) continue;

                        // ãƒ¡ãƒ³ãƒãƒ¼ã‚’æ¤œç´¢ã€ãªã‘ã‚Œã°è‡ªå‹•è¿½åŠ 
                        let member = data.members.find(m => m.name === trimmedName);
                        if (!member) {
                            member = { id: 'member_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5), name: trimmedName };
                            data.members.push(member);
                            if (!addedMembers.has(trimmedName)) {
                                addedMembers.add(trimmedName);
                                newMemberCount++;
                            }
                        }

                        // è©²å½“é€±ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
                        const weekKey = `${weekInfo.year}-${weekInfo.month}-W${weekInfo.weekNum}`;
                        if (!data.weeks[weekKey]) {
                            data.weeks[weekKey] = { daily: {}, nippo: {}, review: { cases: [], cancels: [], doinMuchakuList: [] }, instagram: {} };
                        }
                        const weekData = data.weeks[weekKey];
                        if (!weekData.nippo) weekData.nippo = {};

                        // æ—¥å ±ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                        const nippoKey = `${member.id}_${weekInfo.dayIndex}`;
                        if (!weekData.nippo[nippoKey]) {
                            weekData.nippo[nippoKey] = { output: '', gratitude: '' };
                        }
                        if (output && output.trim()) weekData.nippo[nippoKey].output = output.trim();
                        if (gratitude && gratitude.trim()) weekData.nippo[nippoKey].gratitude = gratitude.trim();

                        // å‹•ç”»URLã‚‚æ›´æ–°ï¼ˆã‚ã‚Œã°ï¼‰
                        if (videoUrl && videoUrl.trim()) {
                            const dateKey = `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}-${String(dateObj.getDate()).padStart(2,'0')}`;
                            const monthKey = `${dateObj.getFullYear()}-${dateObj.getMonth()+1}`;
                            if (!data.monthVideos) data.monthVideos = {};
                            if (!data.monthVideos[monthKey]) data.monthVideos[monthKey] = {};
                            data.monthVideos[monthKey][dateKey] = videoUrl.trim();
                        }

                        importCount++;
                    }

                    saveData();
                    syncToCloud();
                    renderNippo();
                    renderAll();
                    let msg = `${importCount}ä»¶ã®æ—¥å ±ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`;
                    if (newMemberCount > 0) {
                        msg += `\næ–°è¦ãƒ¡ãƒ³ãƒãƒ¼ ${newMemberCount}åã‚’è¿½åŠ : ${Array.from(addedMembers).join(', ')}`;
                    }
                    alert(msg);

                } catch (err) {
                    console.error(err);
                    alert('CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }

        function parseCSVRow(row) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                if (char === '"') {
                    if (inQuotes && row[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // æ—¥åˆ¥æ•°å­—ã®CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportDailyCsv() {
            const dates = getWeekDates();
            const days = ['åœŸ','æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘'];

            let csv = '\uFEFF'; // BOM for Excel
            csv += 'ãƒ¡ãƒ³ãƒãƒ¼,ã‚«ãƒ†ã‚´ãƒª,é …ç›®,' + dates.map((d,i) => `${days[i]}(${d.getMonth()+1}/${d.getDate()})`).join(',') + ',åˆè¨ˆ\n';

            data.members.forEach(member => {
                const d = getMemberDaily(member.id);
                metrics.forEach(cat => {
                    cat.items.forEach(m => {
                        const arr = d[m.key] || [0,0,0,0,0,0,0];
                        const total = arr.reduce((a,b) => a+b, 0);
                        csv += `"${member.name}","${cat.cat}","${m.label}",${arr.join(',')},${total}\n`;
                    });
                });
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `æ—¥åˆ¥æ•°å­—_${currentYear}å¹´${currentMonth}æœˆ_ç¬¬${currentWeekNum}é€±.csv`;
            a.click();
        }

        // æœˆé–“CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆç‹¬ç«‹é¸æŠœæ•°å­—ã‚·ãƒ¼ãƒˆå½¢å¼ï¼‰
        // è¤‡æ•°è¡Œã«ã¾ãŸãŒã‚‹å¼•ç”¨ç¬¦ä»˜ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‡¦ç†ã—ã¦CSVè¡Œã‚’åˆ†å‰²
        function parseCSVLines(text) {
            const lines = [];
            let currentLine = '';
            let inQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                    currentLine += char;
                } else if ((char === '\n' || char === '\r') && !inQuotes) {
                    if (currentLine.trim()) {
                        lines.push(currentLine);
                    }
                    currentLine = '';
                    // Skip \r\n combination
                    if (char === '\r' && text[i + 1] === '\n') i++;
                } else {
                    currentLine += char;
                }
            }
            if (currentLine.trim()) {
                lines.push(currentLine);
            }
            return lines;
        }

        function importMonthCsv(event) {
            const file = event.target.files[0];
            if (!file) return;

            // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ãƒ¡ãƒ³ãƒãƒ¼åã‚’æŠ½å‡ºï¼ˆä¾‹: "1æœˆå‰ç”°ï¼ˆå…¨æ—¥ï¼‰"ï¼‰
            let memberNameFromFile = '';
            const fileMatch = file.name.match(/\d+æœˆ([^ï¼ˆ(]+)/);
            if (fileMatch) {
                memberNameFromFile = fileMatch[1].trim();
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = parseCSVLines(text);

                    // ãƒ¡ãƒ³ãƒãƒ¼ã‚’æ¤œç´¢ã¾ãŸã¯ä½œæˆ
                    let member = data.members.find(m => m.name === memberNameFromFile);
                    if (!member && memberNameFromFile) {
                        member = { id: 'mem_' + Date.now(), name: memberNameFromFile };
                        data.members.push(member);
                    }
                    if (!member) {
                        // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰å–å¾—ã§ããªã‹ã£ãŸå ´åˆã€å…¥åŠ›ã‚’æ±‚ã‚ã‚‹
                        const name = prompt('ãƒ¡ãƒ³ãƒãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
                        if (!name) { alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ'); return; }
                        member = data.members.find(m => m.name === name);
                        if (!member) {
                            member = { id: 'mem_' + Date.now(), name: name };
                            data.members.push(member);
                        }
                    }

                    // é …ç›®åã¨ã‚­ãƒ¼ã®ãƒãƒƒãƒ”ãƒ³ã‚°
                    const labelToKey = {
                        'æŠ•ç¨¿æ•°': 'post',
                        'æŠ•ç¨¿': 'post',
                        'ç²å¾—': 'apoGet',
                        'å®Ÿæ–½æ•°': 'apoExec',
                        'CXL': 'apoCxl',
                        'ãƒ†ã‚¹ã‚¯ãƒ­': 'testClose',
                        'ã‚ªãƒ•ã‚¡ãƒ¼': 'offer',
                        'NG': 'ng',
                        'ç„¡ç€åœ°': 'muchaku',
                        'å‹•å“¡ç²å¾—': 'doinGet',
                        'å‹•å“¡ç²å¾—å¾ŒCXL': 'doinGetCxl',
                        'å‹•å“¡å®Ÿæ–½': 'doinExec',
                        'å‹•å“¡å®Ÿæ–½å¾ŒCXL': 'doinExecCxl',
                        'é¢è«‡ç²å¾—': 'mendanGet',
                        'é¢è«‡ç²å¾—å¾ŒCXL': 'mendanGetCxl',
                        'é¢è«‡å®Ÿæ–½': 'mendanExec',
                        'é¢è«‡å®Ÿæ–½å¾ŒCXL': 'mendanExecCxl',
                        'æˆç´„': 'seiyaku',
                        'ã‚¯ãƒ¼ãƒªãƒ³ã‚°ã‚ªãƒ•': 'coolingOff'
                    };

                    // å¹´æœˆã‚’è¨­å®šï¼ˆç¾åœ¨ã®è¨­å®šã‚’ä½¿ç”¨ï¼‰
                    const year = currentYear;
                    const month = currentMonth;

                    let importCount = 0;

                    for (let i = 0; i < lines.length; i++) {
                        const row = parseCSVRow(lines[i]);
                        if (row.length < 34) continue;

                        // é …ç›®åï¼ˆ3åˆ—ç›®ï¼‰
                        const itemLabel = row[2].trim();
                        const metricKey = labelToKey[itemLabel];
                        if (!metricKey) continue;

                        // 1æ—¥ã€œ31æ—¥ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆ4åˆ—ç›®ã€œ34åˆ—ç›®ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹3ã€œ33ï¼‰
                        for (let day = 1; day <= 31; day++) {
                            const val = parseInt(row[2 + day]) || 0;

                            // ã“ã®æ—¥ä»˜ãŒä½•é€±ç›®ã‹è¨ˆç®—
                            const date = new Date(year, month - 1, day);
                            if (date.getMonth() !== month - 1) continue; // å­˜åœ¨ã—ãªã„æ—¥ä»˜ã‚’ã‚¹ã‚­ãƒƒãƒ—

                            const firstDay = new Date(year, month - 1, 1);
                            const dow = (firstDay.getDay() + 1) % 7; // åœŸæ›œå§‹ã¾ã‚Š
                            const weekNum = Math.ceil((day + dow) / 7);

                            // æ›œæ—¥ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆæœˆ=0, æ—¥=6ï¼‰
                            const dayOfWeek = (date.getDay() + 1) % 7;

                            // é€±ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ãƒ»è¨­å®š
                            const weekKey = `${year}-${month}-W${weekNum}`;
                            if (!data.weeks[weekKey]) {
                                data.weeks[weekKey] = {
                                    daily: {},
                                    review: {
                                        mainIssue: '', mainCause: '',
                                        causeActions: [{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]}],
                                        muchakuReasons: {}, muchakuOther: '', ngReasons: {}, doinMuchakuList: [], cases: [], cancels: []
                                    },
                                    instagram: {},
                                    nippo: {}
                                };
                            }
                            if (!data.weeks[weekKey].daily[member.id]) {
                                data.weeks[weekKey].daily[member.id] = {};
                                metrics.forEach(c => c.items.forEach(m => {
                                    data.weeks[weekKey].daily[member.id][m.key] = [0,0,0,0,0,0,0];
                                }));
                            }

                            data.weeks[weekKey].daily[member.id][metricKey][dayOfWeek] = val;
                            importCount++;
                        }
                    }

                    saveData();
                    syncToCloud();
                    renderAll();
                    alert(`${memberNameFromFile || member.name}ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸï¼ˆ${importCount}ä»¶ï¼‰`);

                } catch (err) {
                    console.error(err);
                    alert('CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }

        // æ—¥åˆ¥æ•°å­—ã®CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importDailyCsv(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let text = e.target.result;
                    // BOMé™¤å»
                    if (text.charCodeAt(0) === 0xFEFF) {
                        text = text.slice(1);
                    }
                    const lines = text.split('\n').filter(line => line.trim());

                    if (lines.length < 2) {
                        alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                        return;
                    }

                    // å…¨ãƒ¡ãƒˆãƒªãƒƒã‚¯ãƒ©ãƒ™ãƒ«ã®ãƒãƒƒãƒ—ã‚’ä½œæˆ
                    const labelToKey = {};
                    metrics.forEach(cat => {
                        cat.items.forEach(m => {
                            labelToKey[m.label] = m.key;
                        });
                    });

                    let importCount = 0;
                    let newMemberCount = 0;
                    let skippedLabels = new Set();
                    const addedMembers = new Set();

                    for (let i = 1; i < lines.length; i++) {
                        const row = parseCSVRow(lines[i]);
                        if (row.length < 10) continue;

                        const memberName = row[0].trim();
                        if (!memberName) continue;
                        const itemLabel = row[2].trim();

                        // ãƒ¡ãƒ³ãƒãƒ¼ã‚’æ¤œç´¢ã€ãªã‘ã‚Œã°è‡ªå‹•è¿½åŠ 
                        let member = data.members.find(m => m.name === memberName);
                        if (!member) {
                            member = { id: 'member_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5), name: memberName };
                            data.members.push(member);
                            if (!addedMembers.has(memberName)) {
                                addedMembers.add(memberName);
                                newMemberCount++;
                            }
                        }

                        // é …ç›®ã‚­ãƒ¼ã‚’æ¤œç´¢
                        const metricKey = labelToKey[itemLabel];
                        if (!metricKey) {
                            skippedLabels.add(itemLabel);
                            continue;
                        }

                        // æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                        const d = getMemberDaily(member.id);
                        for (let day = 0; day < 7; day++) {
                            const val = parseInt(row[3 + day]) || 0;
                            d[metricKey][day] = val;
                        }
                        importCount++;
                    }

                    saveData();
                    syncToCloud();
                    renderAll();
                    let msg = `${importCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`;
                    if (newMemberCount > 0) {
                        msg += `\næ–°è¦ãƒ¡ãƒ³ãƒãƒ¼ ${newMemberCount}åã‚’è¿½åŠ : ${Array.from(addedMembers).join(', ')}`;
                    }
                    if (skippedLabels.size > 0) {
                        msg += `\nâš ï¸ æœªå¯¾å¿œã®é …ç›®: ${Array.from(skippedLabels).join(', ')}`;
                    }
                    alert(msg);

                } catch (err) {
                    console.error(err);
                    alert('CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }
        function toggleAccount(id) { document.getElementById('acc-' + id).classList.toggle('open'); }
        function addAccount() { openModal('accountModal'); }
        function saveNewAccount() {
            const name = document.getElementById('newAccountName').value.trim();
            if (!name) { alert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã‚’å…¥åŠ›'); return; }
            if (selectedMember === 'all') { alert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆå…¨ä½“ã§ã¯ãªãç‰¹å®šã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠï¼‰'); return; }
            data.accounts.push({ id: 'acc_' + Date.now(), name, url: document.getElementById('newAccountUrl').value, ownerId: selectedMember });
            saveData(); closeModal('accountModal');
            document.getElementById('newAccountName').value = '';
            document.getElementById('newAccountUrl').value = '';
            renderInstagram(); syncToCloud();
        }

        // Instagram CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importInstagramCsv(file) {
            if (!file) return;

            // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰å¹´æœˆé€±ã‚’å–å¾— (ä¾‹: instagram-2026-1-W4.csv)
            const match = file.name.match(/instagram-(\d+)-(\d+)-W(\d+)/i);
            if (!match) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«åã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚\nä¾‹: instagram-2026-1-W4.csv');
                return;
            }
            const [, fileYear, fileMonth, fileWeek] = match.map(Number);
            const weekKey = `${fileYear}-${fileMonth}-W${fileWeek}`;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim() && !line.startsWith('---'));

                    // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—
                    const dataLines = lines.slice(1).filter(line => {
                        const first = line.split(',')[0];
                        return first && !first.includes('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå') && first.trim() !== '';
                    });

                    // æ›œæ—¥ãƒãƒƒãƒ”ãƒ³ã‚° (åœŸæ›œå§‹ã¾ã‚Š)
                    const dayMap = { 'åœŸ': 0, 'æ—¥': 1, 'æœˆ': 2, 'ç«': 3, 'æ°´': 4, 'æœ¨': 5, 'é‡‘': 6 };

                    // ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†
                    const accountData = {};
                    dataLines.forEach(line => {
                        // CSVè§£æï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰
                        const cols = line.match(/(".*?"|[^,]+)/g)?.map(c => c.replace(/^"|"$/g, '').trim()) || [];
                        if (cols.length < 14) return;

                        const accName = cols[0];
                        const dayName = cols[1];
                        const dayIndex = dayMap[dayName];

                        if (accName && dayIndex !== undefined) {
                            if (!accountData[accName]) {
                                accountData[accName] = {
                                    follow: [0,0,0,0,0,0,0],
                                    follower: [0,0,0,0,0,0,0],
                                    followCut: [0,0,0,0,0,0,0],
                                    followerCut: [0,0,0,0,0,0,0],
                                    dmSend: [0,0,0,0,0,0,0],
                                    dmReply: [0,0,0,0,0,0,0],
                                    dmOffer: [0,0,0,0,0,0,0],
                                    apoGet: [0,0,0,0,0,0,0],
                                    apoExec: [0,0,0,0,0,0,0],
                                    doinPlan: [0,0,0,0,0,0,0],
                                    doinExec: [0,0,0,0,0,0,0],
                                    seiyaku: [0,0,0,0,0,0,0]
                                };
                            }
                            accountData[accName].follow[dayIndex] = parseInt(cols[2]) || 0;
                            accountData[accName].follower[dayIndex] = parseInt(cols[3]) || 0;
                            accountData[accName].followCut[dayIndex] = parseInt(cols[4]) || 0;
                            accountData[accName].followerCut[dayIndex] = parseInt(cols[5]) || 0;
                            accountData[accName].dmSend[dayIndex] = parseInt(cols[6]) || 0;
                            accountData[accName].dmReply[dayIndex] = parseInt(cols[7]) || 0;
                            accountData[accName].dmOffer[dayIndex] = parseInt(cols[8]) || 0;
                            accountData[accName].apoGet[dayIndex] = parseInt(cols[9]) || 0;
                            accountData[accName].apoExec[dayIndex] = parseInt(cols[10]) || 0;
                            accountData[accName].doinPlan[dayIndex] = parseInt(cols[11]) || 0;
                            accountData[accName].doinExec[dayIndex] = parseInt(cols[12]) || 0;
                            accountData[accName].seiyaku[dayIndex] = parseInt(cols[13]) || 0;
                        }
                    });

                    // é€±ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºä¿
                    if (!data.weeks[weekKey]) {
                        data.weeks[weekKey] = { daily: {}, review: {}, instagram: {}, nippo: {} };
                    }
                    if (!data.weeks[weekKey].instagram) {
                        data.weeks[weekKey].instagram = {};
                    }

                    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    let importedCount = 0;
                    const currentOwnerId = selectedMember === 'all' ? (data.members[0]?.id || 'default') : selectedMember;

                    Object.keys(accountData).forEach(accName => {
                        // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã‘ã‚Œã°ä½œæˆ
                        let acc = data.accounts.find(a => a.name === accName);
                        if (!acc) {
                            acc = { id: 'acc_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5), name: accName, url: '', ownerId: currentOwnerId };
                            data.accounts.push(acc);
                        }

                        // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
                        data.weeks[weekKey].instagram[acc.id] = accountData[accName];
                        importedCount++;
                    });

                    saveData();
                    syncToCloud();

                    // ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ˆã®é€±ã«ç§»å‹•
                    currentYear = fileYear;
                    currentMonth = fileMonth;
                    currentWeekNum = fileWeek;
                    updateWeekLabel();
                    renderAll();

                    alert(`${importedCount}ä»¶ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚\n(${fileYear}å¹´${fileMonth}æœˆ ç¬¬${fileWeek}é€±)`);

                } catch (err) {
                    console.error('CSV import error:', err);
                    alert('CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
                }
            };
            reader.readAsText(file, 'UTF-8');

            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('igCsvImport').value = '';
        }

        // é¸æŠã•ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å–å¾—
        function getMyAccounts() {
            console.log('ğŸ” getMyAccounts - selectedMember:', selectedMember);
            console.log('ğŸ” å…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ:', data.accounts.map(a => ({name: a.name, ownerId: a.ownerId})));

            // ã€Œå…¨ä½“ã€é¸æŠæ™‚ã¯å…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º
            if (selectedMember === 'all') {
                console.log('ğŸ” å…¨ä½“é¸æŠ - å…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º');
                return data.accounts;
            }

            // ç‰¹å®šãƒ¡ãƒ³ãƒãƒ¼é¸æŠæ™‚ã¯ãã®ãƒ¡ãƒ³ãƒãƒ¼ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã¿
            const filtered = data.accounts.filter(acc => acc.ownerId === selectedMember);
            console.log('ğŸ” ãƒ•ã‚£ãƒ«ã‚¿å¾Œ:', filtered.map(a => a.name));
            return filtered;
        }

        // ãƒ¡ãƒ³ãƒãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        function isUserSelected() {
            // ã€Œå…¨ä½“ã€ã¾ãŸã¯ç‰¹å®šãƒ¡ãƒ³ãƒãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã‚Œã°OK
            return true;
        }
        function deleteAccount(id) { if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; data.accounts = data.accounts.filter(a => a.id !== id); saveData(); renderInstagram(); syncToCloud(); }

        // è¨­å®š
        let settingsSelectedMember = 'all';

        function renderSettings() {
            console.log('=== renderSettingsé–‹å§‹ ===');
            console.log('ãƒ¡ãƒ³ãƒãƒ¼æ•°:', data.members.length);

            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æœ€åˆã«æ›´æ–°ï¼ˆä»–ã®ã‚¨ãƒ©ãƒ¼ã«å½±éŸ¿ã•ã‚Œãªã„ã‚ˆã†ã«ï¼‰
            try {
                const currentUserSelect = document.getElementById('currentUserSelect');
                if (currentUserSelect) {
                    const optionsHtml = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>' +
                        data.members.map(m => `<option value="${m.id}" ${data.settings.currentUserId === m.id ? 'selected' : ''}>${m.name}</option>`).join('');
                    currentUserSelect.innerHTML = optionsHtml;
                    console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³æ›´æ–°å®Œäº†, ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ•°:', currentUserSelect.options.length);
                }
                const warning = document.getElementById('currentUserWarning');
                if (warning) {
                    warning.style.display = data.settings.currentUserId ? 'none' : 'block';
                }
            } catch (e) {
                console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠæ›´æ–°ã‚¨ãƒ©ãƒ¼:', e);
            }

            // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆ
            try {
                document.getElementById('memberList').innerHTML = data.members.length === 0 ? '<p style="color:#64748b">ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>' :
                    data.members.map(m => `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#0f172a;border-radius:6px;margin-bottom:6px"><span>${m.name}</span><button class="btn btn-danger btn-sm" onclick="deleteMember('${m.id}')">å‰Šé™¤</button></div>`).join('');
                console.log('âœ… ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆæ›´æ–°å®Œäº†');
            } catch (e) {
                console.error('âŒ ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', e);
            }

            // ãƒ’ãƒ³ãƒˆãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            try {
                const hintEl = document.getElementById('settingsHint');
                const currentUserId = data.settings.currentUserId;
                const isMySettings = selectedMember === currentUserId;

                if (selectedMember === 'all') {
                    if (hintEl) {
                        hintEl.innerHTML = 'â€» <strong style="color:#f59e0b">ã€Œå…¨ä½“ã€é¸æŠæ™‚ã¯é–²è¦§ã®ã¿</strong> - å„ãƒ¡ãƒ³ãƒãƒ¼ã®ç›®æ¨™åˆè¨ˆã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚ç·¨é›†ã™ã‚‹ã«ã¯å€‹åˆ¥ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
                    }
                    displayTeamTotals();
                    disableInputs(true);
                } else if (!isMySettings) {
                    const memberName = data.members.find(m => m.id === selectedMember)?.name || '';
                    if (hintEl) {
                        hintEl.innerHTML = `â€» <strong style="color:#ef4444">ğŸ”’ ã€Œ${memberName}ã€ã•ã‚“ã®è¨­å®šã¯é–²è¦§ã®ã¿</strong> - ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã®è¨­å®šã¯ç·¨é›†ã§ãã¾ã›ã‚“ã€‚`;
                    }
                    loadMemberSettings(selectedMember);
                    disableInputs(true);
                } else {
                    if (hintEl) {
                        const memberName = data.members.find(m => m.id === selectedMember)?.name || '';
                        hintEl.innerHTML = `â€» ç¾åœ¨ã€Œ<strong style="color:#6366f1">${memberName}</strong>ã€ã•ã‚“å€‹äººã®ç›®æ¨™ã‚’è¨­å®šä¸­`;
                    }
                    disableInputs(false);
                    loadMemberSettings(selectedMember);
                }
            } catch (e) {
                console.error('âŒ è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
            }
        }

        function onSettingsMemberChange() {
            const selectEl = document.getElementById('settingsMemberSelect');
            if (!selectEl) {
                console.error('settingsMemberSelectè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            settingsSelectedMember = selectEl.value;
            console.log('=== ãƒ¡ãƒ³ãƒãƒ¼å¤‰æ›´ ===');
            console.log('é¸æŠã•ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼ID:', settingsSelectedMember);

            // è¨­å®šã‚’èª­ã¿è¾¼ã¿
            loadMemberSettings(settingsSelectedMember);

            // é¸æŠã—ãŸãƒ¡ãƒ³ãƒãƒ¼ã®åå‰ã‚’è¡¨ç¤º
            const hintEl = document.getElementById('settingsHint');
            if (hintEl) {
                if (settingsSelectedMember === 'all') {
                    hintEl.innerHTML = 'â€»ã€Œå…¨ä½“ã€ã‚’é¸æŠä¸­ - ãƒãƒ¼ãƒ å…¨ä½“ã®ç›®æ¨™åˆè¨ˆå€¤ã‚’è¨­å®š <span style="color:#22c55e">âœ“ èª­ã¿è¾¼ã¿å®Œäº†</span>';
                } else {
                    const memberName = data.members.find(m => m.id === settingsSelectedMember)?.name || '';
                    hintEl.innerHTML = `â€»<strong style="color:#6366f1">${memberName}</strong>ã•ã‚“å€‹äººã®ç›®æ¨™ã‚’è¨­å®šä¸­ <span style="color:#22c55e">âœ“ èª­ã¿è¾¼ã¿å®Œäº†</span>`;
                }
                // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æ•°ç§’å¾Œã«æ¶ˆã™
                setTimeout(() => {
                    if (settingsSelectedMember === 'all') {
                        hintEl.innerHTML = 'â€»ã€Œå…¨ä½“ã€ã‚’é¸æŠä¸­ - ãƒãƒ¼ãƒ å…¨ä½“ã®ç›®æ¨™åˆè¨ˆå€¤ã‚’è¨­å®š';
                    } else {
                        const memberName = data.members.find(m => m.id === settingsSelectedMember)?.name || '';
                        hintEl.innerHTML = `â€»<strong style="color:#6366f1">${memberName}</strong>ã•ã‚“å€‹äººã®ç›®æ¨™ã‚’è¨­å®šä¸­`;
                    }
                }, 2000);
            }
        }

        function disableInputs(disabled) {
            const inputIds = ['bPost', 'bApoGet', 'bApoExec', 'bDoinGet', 'bDoinExec', 'bMendan', 'bSeiyaku',
                'mPost', 'mApoGet', 'mApoExec', 'mDoinGet', 'mDoinExec', 'mMendan', 'mMendanExec', 'mSeiyaku',
                'igGoalSend', 'igGoalReply', 'igGoalOffer', 'igGoalApoGet', 'igGoalApoExec', 'igGoalDoinExec', 'igGoalSeiyaku'];
            inputIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.disabled = disabled;
                    el.style.opacity = disabled ? '0.5' : '1';
                    el.style.cursor = disabled ? 'not-allowed' : 'text';
                }
            });
        }

        function displayTeamTotals() {
            // å…¨ãƒ¡ãƒ³ãƒãƒ¼ã®è¨­å®šã‚’åˆè¨ˆ
            let budgetTotal = { post: 0, apoGet: 0, apoExec: 0, doinGet: 0, doinExec: 0, mendan: 0, seiyaku: 0 };
            let monthlyTotal = { post: 0, apoGet: 0, apoExec: 0, doinGet: 0, doinExec: 0, mendan: 0, mendanExec: 0, seiyaku: 0 };
            let igTotal = { send: 0, reply: 0, offer: 0, apoGet: 0, apoExec: 0, doinExec: 0, seiyaku: 0 };

            const monthKey = getMonthKey();
            data.members.forEach(member => {
                if (data.settings.memberSettings && data.settings.memberSettings[member.id] && data.settings.memberSettings[member.id][monthKey]) {
                    const mb = data.settings.memberSettings[member.id][monthKey].budget || {};
                    const mm = data.settings.memberSettings[member.id][monthKey].monthly || {};
                    const mig = data.settings.memberSettings[member.id][monthKey].instagram || {};

                    budgetTotal.post += mb.post || 0;
                    budgetTotal.apoGet += mb.apoGet || 0;
                    budgetTotal.apoExec += mb.apoExec || 0;
                    budgetTotal.doinGet += mb.doinGet || 0;
                    budgetTotal.doinExec += mb.doinExec || 0;
                    budgetTotal.mendan += mb.mendan || 0;
                    budgetTotal.seiyaku += mb.seiyaku || 0;

                    monthlyTotal.post += mm.post || 0;
                    monthlyTotal.apoGet += mm.apoGet || 0;
                    monthlyTotal.apoExec += mm.apoExec || 0;
                    monthlyTotal.doinGet += mm.doinGet || 0;
                    monthlyTotal.doinExec += mm.doinExec || 0;
                    monthlyTotal.mendan += mm.mendan || 0;
                    monthlyTotal.mendanExec += mm.mendanExec || 0;
                    monthlyTotal.seiyaku += mm.seiyaku || 0;

                    igTotal.send += mig.send || 0;
                    igTotal.reply += mig.reply || 0;
                    igTotal.offer += mig.offer || 0;
                    igTotal.apoGet += mig.apoGet || 0;
                    igTotal.apoExec += mig.apoExec || 0;
                    igTotal.doinExec += mig.doinExec || 0;
                    igTotal.seiyaku += mig.seiyaku || 0;
                }
            });

            // åˆè¨ˆå€¤ã‚’è¡¨ç¤ºï¼ˆè¦ç´ ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
            const setValueSafe = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.value = val;
            };
            setValueSafe('bPost', budgetTotal.post);
            setValueSafe('bApoGet', budgetTotal.apoGet);
            setValueSafe('bApoExec', budgetTotal.apoExec);
            setValueSafe('bDoinGet', budgetTotal.doinGet);
            setValueSafe('bDoinExec', budgetTotal.doinExec);
            setValueSafe('bMendan', budgetTotal.mendan);
            setValueSafe('bSeiyaku', budgetTotal.seiyaku);

            setValueSafe('mPost', monthlyTotal.post);
            setValueSafe('mApoGet', monthlyTotal.apoGet);
            setValueSafe('mApoExec', monthlyTotal.apoExec);
            setValueSafe('mDoinGet', monthlyTotal.doinGet);
            setValueSafe('mDoinExec', monthlyTotal.doinExec);
            setValueSafe('mMendan', monthlyTotal.mendan);
            setValueSafe('mMendanExec', monthlyTotal.mendanExec);
            setValueSafe('mSeiyaku', monthlyTotal.seiyaku);

            // ã‚¤ãƒ³ã‚¹ã‚¿ç›®æ¨™ã®åˆè¨ˆã‚’è¡¨ç¤º
            setValueSafe('igGoalSend', igTotal.send);
            setValueSafe('igGoalReply', igTotal.reply);
            setValueSafe('igGoalOffer', igTotal.offer);
            setValueSafe('igGoalApoGet', igTotal.apoGet);
            setValueSafe('igGoalApoExec', igTotal.apoExec);
            setValueSafe('igGoalDoinExec', igTotal.doinExec);
            setValueSafe('igGoalSeiyaku', igTotal.seiyaku);
        }

        function loadMemberSettings(memberId) {
            console.log('loadMemberSettingså‘¼ã³å‡ºã—:', memberId);
            let b, mo, ig;
            if (memberId === 'all') {
                b = data.settings.budget || {};
                mo = data.settings.monthly || {};
                ig = {}; // å…¨ä½“é¸æŠæ™‚ã¯ã‚¤ãƒ³ã‚¹ã‚¿ç›®æ¨™ã¯ç©º
                console.log('å…¨ä½“è¨­å®šã‚’èª­ã¿è¾¼ã¿');
            } else {
                const monthKey = getMonthKey();
                if (!data.settings.memberSettings) data.settings.memberSettings = {};
                if (!data.settings.memberSettings[memberId]) {
                    data.settings.memberSettings[memberId] = {};
                }
                if (!data.settings.memberSettings[memberId][monthKey]) {
                    data.settings.memberSettings[memberId][monthKey] = { budget: {}, monthly: {}, instagram: {} };
                }
                b = data.settings.memberSettings[memberId][monthKey].budget || {};
                mo = data.settings.memberSettings[memberId][monthKey].monthly || {};
                ig = data.settings.memberSettings[memberId][monthKey].instagram || {};
                console.log('ãƒ¡ãƒ³ãƒãƒ¼å€‹åˆ¥è¨­å®šã‚’èª­ã¿è¾¼ã¿:', memberId, 'æœˆ:', monthKey);
            }
            console.log('budget:', JSON.stringify(b));
            console.log('monthly:', JSON.stringify(mo));
            console.log('instagram:', JSON.stringify(ig));

            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®š
            const fields = [
                ['bPost', b.post],
                ['bApoGet', b.apoGet],
                ['bApoExec', b.apoExec],
                ['bDoinGet', b.doinGet],
                ['bDoinExec', b.doinExec],
                ['bMendan', b.mendan],
                ['bSeiyaku', b.seiyaku],
                ['mPost', mo.post],
                ['mApoGet', mo.apoGet],
                ['mApoExec', mo.apoExec],
                ['mDoinGet', mo.doinGet],
                ['mDoinExec', mo.doinExec],
                ['mMendan', mo.mendan],
                ['mMendanExec', mo.mendanExec],
                ['mSeiyaku', mo.seiyaku],
                ['igGoalSend', ig.send],
                ['igGoalReply', ig.reply],
                ['igGoalOffer', ig.offer],
                ['igGoalApoGet', ig.apoGet],
                ['igGoalApoExec', ig.apoExec],
                ['igGoalDoinExec', ig.doinExec],
                ['igGoalSeiyaku', ig.seiyaku]
            ];

            fields.forEach(([id, val]) => {
                const el = document.getElementById(id);
                if (el) {
                    const newVal = val || 0;
                    const oldVal = el.value;
                    console.log(`${id}: ${oldVal} â†’ ${newVal}`);
                    el.value = newVal;
                    // å€¤ãŒå¤‰ã‚ã£ãŸå ´åˆã¯ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    if (String(oldVal) !== String(newVal)) {
                        el.classList.remove('settings-updated');
                        void el.offsetWidth; // reflow
                        el.classList.add('settings-updated');
                    }
                } else {
                    console.error(`è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${id}`);
                }
            });
            console.log('=== è¨­å®šèª­ã¿è¾¼ã¿å®Œäº† ===');
        }

        function saveSettings() {
            // è¨­å®šã‚¿ãƒ–ã§é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ã‚’ä½¿ç”¨
            const targetMember = settingsSelectedMember || selectedMember;

            // å…¨ä½“é¸æŠæ™‚ã¯ä¿å­˜ä¸å¯
            if (targetMember === 'all') {
                console.log('å…¨ä½“é¸æŠæ™‚ã¯ä¿å­˜ã§ãã¾ã›ã‚“');
                return;
            }

            console.log('=== è¨­å®šä¿å­˜ ===');
            console.log('ä¿å­˜å…ˆ:', targetMember);

            const budgetData = {
                post: parseInt(document.getElementById('bPost').value) || 0,
                apoGet: parseInt(document.getElementById('bApoGet').value) || 0,
                apoExec: parseInt(document.getElementById('bApoExec').value) || 0,
                doinGet: parseInt(document.getElementById('bDoinGet').value) || 0,
                doinExec: parseInt(document.getElementById('bDoinExec').value) || 0,
                mendan: parseInt(document.getElementById('bMendan').value) || 0,
                seiyaku: parseInt(document.getElementById('bSeiyaku').value) || 0
            };
            const monthlyData = {
                post: parseInt(document.getElementById('mPost').value) || 0,
                apoGet: parseInt(document.getElementById('mApoGet').value) || 0,
                apoExec: parseInt(document.getElementById('mApoExec').value) || 0,
                doinGet: parseInt(document.getElementById('mDoinGet').value) || 0,
                doinExec: parseInt(document.getElementById('mDoinExec').value) || 0,
                mendan: parseInt(document.getElementById('mMendan').value) || 0,
                mendanExec: parseInt(document.getElementById('mMendanExec').value) || 0,
                seiyaku: parseInt(document.getElementById('mSeiyaku').value) || 0
            };

            console.log('ä¿å­˜ã™ã‚‹budget:', JSON.stringify(budgetData));
            console.log('ä¿å­˜ã™ã‚‹monthly:', JSON.stringify(monthlyData));

            // å€‹åˆ¥ãƒ¡ãƒ³ãƒãƒ¼ã®è¨­å®šã¨ã—ã¦ä¿å­˜ï¼ˆæœˆã”ã¨ï¼‰
            const monthKey = getMonthKey();
            if (!data.settings.memberSettings) data.settings.memberSettings = {};
            if (!data.settings.memberSettings[targetMember]) {
                data.settings.memberSettings[targetMember] = {};
            }
            if (!data.settings.memberSettings[targetMember][monthKey]) {
                data.settings.memberSettings[targetMember][monthKey] = {};
            }
            data.settings.memberSettings[targetMember][monthKey].budget = budgetData;
            data.settings.memberSettings[targetMember][monthKey].monthly = monthlyData;

            // ã‚¤ãƒ³ã‚¹ã‚¿æœˆé–“ç›®æ¨™ã‚‚ãƒ¡ãƒ³ãƒãƒ¼ã”ã¨ã«ä¿å­˜
            data.settings.memberSettings[targetMember][monthKey].instagram = {
                send: parseInt(document.getElementById('igGoalSend').value) || 0,
                reply: parseInt(document.getElementById('igGoalReply').value) || 0,
                offer: parseInt(document.getElementById('igGoalOffer').value) || 0,
                apoGet: parseInt(document.getElementById('igGoalApoGet').value) || 0,
                apoExec: parseInt(document.getElementById('igGoalApoExec').value) || 0,
                doinExec: parseInt(document.getElementById('igGoalDoinExec').value) || 0,
                seiyaku: parseInt(document.getElementById('igGoalSeiyaku').value) || 0
            };
            console.log('ãƒ¡ãƒ³ãƒãƒ¼å€‹åˆ¥è¨­å®šã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ:', targetMember, 'æœˆ:', monthKey);

            saveData(); renderSummary(); renderReview(); renderInstagram(); syncToCloud();
        }

        // ãƒ¡ãƒ³ãƒãƒ¼ã®ç›®æ¨™ã‚’å–å¾—ï¼ˆå€‹äººè¨­å®šãŒã‚ã‚Œã°å€‹äººã€ãªã‘ã‚Œã°0ï¼‰
        function getMemberGoals(memberId) {
            const memberSettings = data.settings.memberSettings;
            const monthKey = getMonthKey();

            // ãƒ¡ãƒ³ãƒãƒ¼ã®å€‹äººè¨­å®šãŒã‚ã‚Œã°ï¼ˆ0ã§ã‚‚ï¼‰ãã‚Œã‚’ä½¿ç”¨
            if (memberSettings && memberSettings[memberId] && memberSettings[memberId][monthKey] && memberSettings[memberId][monthKey].monthly) {
                const monthly = memberSettings[memberId][monthKey].monthly;
                return {
                    post: monthly.post || 0,
                    apoGet: monthly.apoGet || 0,
                    apoExec: monthly.apoExec || 0,
                    doinGet: monthly.doinGet || 0,
                    doinExec: monthly.doinExec || 0,
                    mendan: monthly.mendan || 0,
                    mendanExec: monthly.mendanExec || 0,
                    seiyaku: monthly.seiyaku || 0
                };
            }

            // å€‹äººè¨­å®šãŒãªã„å ´åˆã¯0ã‚’è¿”ã™ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ãªã„ï¼‰
            return {
                post: 0,
                apoGet: 0,
                apoExec: 0,
                doinGet: 0,
                doinExec: 0,
                mendan: 0,
                mendanExec: 0,
                seiyaku: 0
            };
        }

        // ãƒ‡ãƒãƒƒã‚°ç”¨: ãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹ã‚’ç¢ºèª
        function debugShowSettings() {
            const ms = data.settings.memberSettings || {};
            const memberList = data.members.map(m => `${m.name}(${m.id})`).join(', ');
            const currentMemberId = selectedMember;
            const currentMemberName = data.members.find(m => m.id === currentMemberId)?.name || '(å…¨ä½“)';

            let msg = `ã€ãƒ‡ãƒ¼ã‚¿ç¢ºèªã€‘\n\n`;
            msg += `â–  ç¾åœ¨é¸æŠä¸­: ${currentMemberName} (${currentMemberId})\n\n`;
            msg += `â–  ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§: ${memberList}\n\n`;
            msg += `â–  memberSettings:\n`;

            for (const memberId in ms) {
                const memberName = data.members.find(m => m.id === memberId)?.name || 'ä¸æ˜';
                const monthly = ms[memberId]?.monthly || {};
                const hasValue = Object.values(monthly).some(v => v > 0);
                msg += `  ${memberName}: post=${monthly.post || 0}, apoGet=${monthly.apoGet || 0}, seiyaku=${monthly.seiyaku || 0} [${hasValue ? 'å€¤ã‚ã‚Š' : 'å€¤ãªã—'}]\n`;
            }

            msg += `\nâ–  getMemberGoals('${currentMemberId}')ã®çµæœ:\n`;
            const goals = getMemberGoals(currentMemberId);
            msg += `  post=${goals.post}, apoGet=${goals.apoGet}, seiyaku=${goals.seiyaku}\n`;

            alert(msg);
        }

        // ãƒ‡ãƒãƒƒã‚°ç”¨: NGãƒ‡ãƒ¼ã‚¿ç¢ºèª
        function debugNgData() {
            const members = selectedMember === 'all' ? data.members : data.members.filter(m => m.id === selectedMember);
            const weekKey = `${currentYear}-${currentMonth}-W${currentWeekNum}`;

            let msg = `ã€NGãƒ‡ãƒ¼ã‚¿ ãƒ‡ãƒãƒƒã‚°ã€‘\n\n`;
            msg += `â–  è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰: ${viewPeriod === 'month' ? 'æœˆæ¬¡' : 'é€±æ¬¡'}\n`;
            msg += `â–  é¸æŠãƒ¡ãƒ³ãƒãƒ¼: ${selectedMember === 'all' ? 'å…¨ä½“' : data.members.find(m => m.id === selectedMember)?.name || selectedMember}\n`;
            msg += `â–  ç¾åœ¨ã®é€±: ${weekKey}\n\n`;

            if (viewPeriod === 'month') {
                msg += `â–  æœˆæ¬¡ãƒ¢ãƒ¼ãƒ‰: W1ã€œW5ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ\n\n`;
                for (let w = 1; w <= 5; w++) {
                    const wk = `${currentYear}-${currentMonth}-W${w}`;
                    if (data.weeks[wk]) {
                        members.forEach(member => {
                            const d = data.weeks[wk].daily[member.id];
                            if (d && d.ngReasonsByDay) {
                                for (let day = 0; day < 7; day++) {
                                    const dayData = d.ngReasonsByDay[day];
                                    if (dayData && dayData.counts && dayData.counts.some(c => c > 0)) {
                                        msg += `${wk} ${member.name} Day${day}: ${JSON.stringify(dayData.counts)}\n`;
                                    }
                                }
                            }
                        });
                    }
                }
            } else {
                msg += `â–  é€±æ¬¡ãƒ¢ãƒ¼ãƒ‰: ç¾åœ¨ã®é€±ã®ã¿\n\n`;
                members.forEach(member => {
                    const d = getMemberDaily(member.id);
                    const reasonsByDay = d.ngReasonsByDay || {};
                    msg += `${member.name}:\n`;
                    let hasData = false;
                    for (let day = 0; day < 7; day++) {
                        const dayData = reasonsByDay[day];
                        if (dayData && dayData.counts && dayData.counts.some(c => c > 0)) {
                            msg += `  Day${day}: ${JSON.stringify(dayData.counts)}\n`;
                            hasData = true;
                        }
                    }
                    if (!hasData) {
                        msg += `  (NGãƒ‡ãƒ¼ã‚¿ãªã—)\n`;
                    }
                });
            }

            alert(msg);
        }

        function saveCurrentUser() {
            const selectedUserId = document.getElementById('currentUserSelect').value;
            data.settings.currentUserId = selectedUserId || null;
            saveData();

            // ä¸Šéƒ¨ã®ãƒ¡ãƒ³ãƒãƒ¼è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆã‚‚è‡ªå‹•çš„ã«åˆ‡ã‚Šæ›¿ãˆ
            if (selectedUserId) {
                selectedMember = selectedUserId;
                document.getElementById('memberSelect').value = selectedUserId;
                const memberName = data.members.find(m => m.id === selectedUserId)?.name || '';
                console.log('ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¨­å®š:', selectedUserId, 'è¡¨ç¤ºã‚‚åˆ‡ã‚Šæ›¿ãˆ');

                // å…¨ç”»é¢ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                renderAll();

                alert(`âœ… è¨­å®šå®Œäº†\n\nç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${memberName}\n\nè¡¨ç¤ºãŒ${memberName}ã•ã‚“ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã—ãŸã€‚\nåŒæœŸæ™‚ã«${memberName}ã•ã‚“ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿æ›´æ–°ã•ã‚Œã¾ã™ã€‚`);
            } else {
                renderSettings(); // è­¦å‘Šè¡¨ç¤ºã‚’æ›´æ–°
            }
        }

        function addMember() {
            try {
                console.log('=== addMemberé–‹å§‹ ===');
                const name = document.getElementById('newMemberName').value.trim();
                console.log('å…¥åŠ›ã•ã‚ŒãŸåå‰:', name);
                if (!name) { alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

                const newMember = { id: 'mem_' + Date.now(), name };
                console.log('æ–°ã—ã„ãƒ¡ãƒ³ãƒãƒ¼:', newMember);
                data.members.push(newMember);
                console.log('ç¾åœ¨ã®ãƒ¡ãƒ³ãƒãƒ¼æ•°:', data.members.length);

                saveData();
                closeModal('memberModal');
                document.getElementById('newMemberName').value = '';

                console.log('renderAll()ã‚’å‘¼ã³å‡ºã—ã¾ã™');
                renderAll();

                console.log('åŒæœŸé–‹å§‹');
                syncToCloud();

                console.log('âœ… ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ å®Œäº†');
            } catch (e) {
                console.error('âŒ ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ ã‚¨ãƒ©ãƒ¼:', e);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
            }
        }

        function deleteMember(id) {
            if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            data.members = data.members.filter(m => m.id !== id);
            // å‰Šé™¤ã•ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼IDã‚’è¿½è·¡ãƒªã‚¹ãƒˆã«è¿½åŠ 
            if (!data.deletedMembers) data.deletedMembers = [];
            if (!data.deletedMembers.includes(id)) {
                data.deletedMembers.push(id);
            }
            saveData();
            renderAll();
            syncToCloud();
        }

        // ãƒ‡ãƒ¼ã‚¿
        let firebaseInitialized = false;

        function saveData() {
            localStorage.setItem('salesPro_core', JSON.stringify(data));
            saveToFirebase();
        }

        function saveToFirebase() {
            if (!firebaseInitialized) return;
            const saveData = JSON.parse(JSON.stringify(data));
            database.ref('teams/' + TEAM_ID).set(saveData)
                .then(() => {
                    console.log('ğŸ”¥ Firebaseä¿å­˜å®Œäº†');
                    updateSyncStatus();
                })
                .catch(err => console.error('Firebaseä¿å­˜ã‚¨ãƒ©ãƒ¼:', err));
        }

        function loadData() {
            const s = localStorage.getItem('salesPro_core');
            if (s) {
                data = JSON.parse(s);
                if (!data.monthVideos) data.monthVideos = {};
                if (!data.settings.budget) {
                    data.settings.budget = data.settings.weekly || { post: 56, apoGet: 50, apoExec: 46, doinGet: 7, doinExec: 4, mendan: 2, seiyaku: 1 };
                }
                if (!data.settings.currentUserId) data.settings.currentUserId = null;
                if (!data.lastUpdated) data.lastUpdated = null;
                if (!data.deletedMembers) data.deletedMembers = [];
                // membersãŒé…åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
                if (data.members && !Array.isArray(data.members)) {
                    data.members = Object.values(data.members);
                    console.log('âš ï¸ loadData: membersã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰é…åˆ—ã«å¤‰æ›ã—ã¾ã—ãŸ');
                }
                if (!data.members) {
                    data.members = [];
                }
                if (data.weeks) {
                    for (const weekKey in data.weeks) {
                        if (data.weeks[weekKey].review && !data.weeks[weekKey].review.ngReasons) {
                            data.weeks[weekKey].review.ngReasons = {};
                        }
                    }
                }
            }
        }

        function setupFirebaseListener() {
            database.ref('teams/' + TEAM_ID).on('value', (snapshot) => {
                const firebaseData = snapshot.val();
                if (firebaseData) {
                    data = { ...data, ...firebaseData };

                    // membersãŒé…åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆFirebaseãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã™ã‚‹å ´åˆãŒã‚ã‚‹ï¼‰
                    if (data.members && !Array.isArray(data.members)) {
                        data.members = Object.values(data.members);
                        console.log('âš ï¸ membersã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰é…åˆ—ã«å¤‰æ›ã—ã¾ã—ãŸ');
                    }
                    if (!data.members) {
                        data.members = [];
                    }

                    // Firebaseã®è¨­å®šã‚’å„ªå…ˆï¼ˆä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒå…¥åŠ›ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’æ­£ã—ãåæ˜ ï¼‰
                    if (firebaseData.settings) {
                        data.settings = firebaseData.settings;
                    }
                    localStorage.setItem('salesPro_personal', JSON.stringify(data));
                    renderAll();
                    console.log('ğŸ”¥ Firebaseã‹ã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°, ãƒ¡ãƒ³ãƒãƒ¼æ•°:', data.members.length);
                }
            });
            firebaseInitialized = true;
            console.log('ğŸ”¥ Firebaseãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
        }

        function saveAll() { saveReview(); saveData(); }

        // ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸï¼ˆFirebaseç‰ˆï¼‰
        async function syncToCloud() {
            saveToFirebase();
        }

        async function loadFromCloud() {
            console.log('ğŸ”¥ Firebaseãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸä¸­...');
            return true;
        }

        function exportData() {
            saveAll();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `sales-data-${getWeekKey()}.json`;
            a.click();
        }

        function importData(e) {
            const f = e.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = ev => { try { data = JSON.parse(ev.target.result); saveData(); renderAll(); alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†'); } catch { alert('èª­ã¿è¾¼ã¿å¤±æ•—'); } };
            r.readAsText(f);
            e.target.value = '';
        }

        function exportInstagramCSV() {
            const weekKey = getWeekKey();
            const weekData = data.weeks[weekKey];
            if (!weekData || !weekData.instagram) {
                alert('ã“ã®é€±ã®Instagramãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
            const headers = ['ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå', 'æ—¥ä»˜', 'ãƒ•ã‚©ãƒ­ãƒ¼', 'ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼', 'ãƒ•ã‚©ãƒ­ãƒ¼è§£é™¤', 'ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼è§£é™¤', 'DMé€ä¿¡', 'DMè¿”ä¿¡', 'DMã‚ªãƒ•ã‚¡ãƒ¼', 'ã‚¢ãƒç²å¾—', 'ã‚¢ãƒå®Ÿæ–½', 'å‹•å“¡äºˆå®š', 'å‹•å“¡å®Ÿæ–½', 'æˆç´„', 'ãƒ–ãƒ­ãƒƒã‚¯'];

            let csv = headers.join(',') + '\n';

            data.accounts.forEach(account => {
                const igData = weekData.instagram[account.id];
                if (!igData) return;

                for (let i = 0; i < 7; i++) {
                    const row = [
                        `"${account.name}"`,
                        days[i],
                        igData.follow?.[i] || 0,
                        igData.follower?.[i] || 0,
                        igData.followCut?.[i] || 0,
                        igData.followerCut?.[i] || 0,
                        igData.dmSend?.[i] || 0,
                        igData.dmReply?.[i] || 0,
                        igData.dmOffer?.[i] || 0,
                        igData.apoGet?.[i] || 0,
                        igData.apoExec?.[i] || 0,
                        igData.doinPlan?.[i] || 0,
                        igData.doinExec?.[i] || 0,
                        igData.seiyaku?.[i] || 0,
                        igData.blocked?.[i] ? 'ã¯ã„' : 'ã„ã„ãˆ'
                    ];
                    csv += row.join(',') + '\n';
                }
            });

            csv += '\n--- é€±åˆ¥åˆè¨ˆ ---\n';
            csv += 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå,ãƒ•ã‚©ãƒ­ãƒ¼è¨ˆ,ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼è¨ˆ,DMé€ä¿¡è¨ˆ,DMè¿”ä¿¡è¨ˆ,DMã‚ªãƒ•ã‚¡ãƒ¼è¨ˆ,ã‚¢ãƒç²å¾—è¨ˆ,ã‚¢ãƒå®Ÿæ–½è¨ˆ,å‹•å“¡å®Ÿæ–½è¨ˆ,æˆç´„è¨ˆ\n';

            data.accounts.forEach(account => {
                const igData = weekData.instagram[account.id];
                if (!igData) return;

                const sum = (arr) => (arr || []).reduce((a, b) => a + (b || 0), 0);
                const row = [
                    `"${account.name}"`,
                    sum(igData.follow),
                    sum(igData.follower),
                    sum(igData.dmSend),
                    sum(igData.dmReply),
                    sum(igData.dmOffer),
                    sum(igData.apoGet),
                    sum(igData.apoExec),
                    sum(igData.doinExec),
                    sum(igData.seiyaku)
                ];
                csv += row.join(',') + '\n';
            });

            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csv], { type: 'text/csv;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `instagram-${weekKey}.csv`;
            a.click();
        }

        function clearData() { if (!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; localStorage.removeItem('salesPro_core'); location.reload(); }

        function resetLocalOnly() {
            const msg = `ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚»ãƒƒãƒˆã€‘

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ï¼š
âœ… ã‚ãªãŸã®ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ¼ã‚¿ã ã‘ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™
âœ… Firebaseã®ãƒ‡ãƒ¼ã‚¿ã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“
âœ… ãƒªã‚»ãƒƒãƒˆå¾Œã€Firebaseã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™

ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`;
            if (!confirm(msg)) return;

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            localStorage.removeItem('salesPro_core');

            alert('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚\n\nãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚');
            location.reload();
        }

        init();
    </script>
</body>
</html>
