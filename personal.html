<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éë„Éº„ÇΩ„Éä„É´ÊñΩÁ≠ñ„ÉÑ„Éº„É´</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script>
        // FirebaseË®≠ÂÆö
        const firebaseConfig = {
            apiKey: "AIzaSyDky9IIUZNbgFvv5kQFKFyFIMddTBYMBOE",
            authDomain: "sales-tracker-1e15a.firebaseapp.com",
            databaseURL: "https://sales-tracker-1e15a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sales-tracker-1e15a",
            storageBucket: "sales-tracker-1e15a.firebasestorage.app",
            messagingSenderId: "342349456010",
            appId: "1:342349456010:web:a6c08087598bdbccf10373"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const TEAM_ID = 'personal';
    </script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', 'Meiryo', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            line-height: 1.5;
            min-height: 100vh;
            position: relative;
        }
        /* Â≠£ÁØÄ„ÅÆËÉåÊôØ - „ÅØ„Å£„Åç„ÇäË¶ã„Åà„ÇãÂ≠£ÁØÄ„ÉÜ„Éº„Éû */
        body.season-1 { background: linear-gradient(180deg, #1a3a5a 0%, #0f172a 30%, #0f172a 100%); } /* 1ÊúàÔºöÂÜ¨ */
        body.season-2 { background: linear-gradient(180deg, #4a2040 0%, #0f172a 30%, #0f172a 100%); } /* 2ÊúàÔºö„Éê„É¨„É≥„Çø„Ç§„É≥ */
        body.season-3 { background: linear-gradient(180deg, #2a4a3a 0%, #0f172a 30%, #0f172a 100%); } /* 3ÊúàÔºöÊò• */
        body.season-4 { background: linear-gradient(180deg, #4a3045 0%, #0f172a 30%, #0f172a 100%); } /* 4ÊúàÔºöÊ°ú */
        body.season-5 { background: linear-gradient(180deg, #2a4a2a 0%, #0f172a 30%, #0f172a 100%); } /* 5ÊúàÔºöÊñ∞Á∑ë */
        body.season-6 { background: linear-gradient(180deg, #2a3a5a 0%, #0f172a 30%, #0f172a 100%); } /* 6ÊúàÔºöÊ¢ÖÈõ® */
        body.season-7 { background: linear-gradient(180deg, #2a4a5a 0%, #0f172a 30%, #0f172a 100%); } /* 7ÊúàÔºöÂ§è */
        body.season-8 { background: linear-gradient(180deg, #3a3a5a 0%, #0f172a 30%, #0f172a 100%); } /* 8ÊúàÔºöÂ§èÁ•≠„Çä */
        body.season-9 { background: linear-gradient(180deg, #4a3a2a 0%, #0f172a 30%, #0f172a 100%); } /* 9ÊúàÔºöÁßã */
        body.season-10 { background: linear-gradient(180deg, #4a2a1a 0%, #0f172a 30%, #0f172a 100%); } /* 10ÊúàÔºö„Éè„É≠„Ç¶„Ç£„É≥ */
        body.season-11 { background: linear-gradient(180deg, #4a3520 0%, #0f172a 30%, #0f172a 100%); } /* 11ÊúàÔºöÁ¥ÖËëâ */
        body.season-12 { background: linear-gradient(180deg, #2a3550 0%, #0f172a 30%, #0f172a 100%); } /* 12ÊúàÔºö„ÇØ„É™„Çπ„Éû„Çπ */

        .seasonal-deco {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            font-size: 32px;
            opacity: 0.8;
            text-shadow: 0 2px 12px rgba(0,0,0,0.5);
            animation: float 6s ease-in-out infinite;
        }
        .seasonal-deco:nth-child(odd) { animation-delay: -3s; }
        .seasonal-deco.small { font-size: 22px; opacity: 0.6; }
        .seasonal-deco.large { font-size: 48px; opacity: 0.7; }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }

        .seasonal-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            z-index: 10000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        body.season-1 .seasonal-banner { background: linear-gradient(90deg, #60a5fa, #e0f2fe, #60a5fa); }
        body.season-2 .seasonal-banner { background: linear-gradient(90deg, #f472b6, #fce7f3, #f472b6); }
        body.season-3 .seasonal-banner { background: linear-gradient(90deg, #86efac, #fef3c7, #86efac); }
        body.season-4 .seasonal-banner { background: linear-gradient(90deg, #fbcfe8, #fce7f3, #fbcfe8); }
        body.season-5 .seasonal-banner { background: linear-gradient(90deg, #86efac, #bbf7d0, #86efac); }
        body.season-6 .seasonal-banner { background: linear-gradient(90deg, #93c5fd, #c7d2fe, #93c5fd); }
        body.season-7 .seasonal-banner { background: linear-gradient(90deg, #38bdf8, #67e8f9, #38bdf8); }
        body.season-8 .seasonal-banner { background: linear-gradient(90deg, #c084fc, #fbbf24, #c084fc); }
        body.season-9 .seasonal-banner { background: linear-gradient(90deg, #fb923c, #fcd34d, #fb923c); }
        body.season-10 .seasonal-banner { background: linear-gradient(90deg, #f97316, #a855f7, #f97316); }
        body.season-11 .seasonal-banner { background: linear-gradient(90deg, #f59e0b, #dc2626, #f59e0b); }
        body.season-12 .seasonal-banner { background: linear-gradient(90deg, #ef4444, #22c55e, #ef4444); }

        /* Â≠£ÁØÄ„Åî„Å®„ÅÆ„Éò„ÉÉ„ÉÄ„Éº„Ç´„É©„Éº */
        body.season-1 header { background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); }
        body.season-2 header { background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); }
        body.season-3 header { background: linear-gradient(135deg, #10b981 0%, #6ee7b7 100%); }
        body.season-4 header { background: linear-gradient(135deg, #ec4899 0%, #fbcfe8 100%); }
        body.season-5 header { background: linear-gradient(135deg, #22c55e 0%, #86efac 100%); }
        body.season-6 header { background: linear-gradient(135deg, #6366f1 0%, #a5b4fc 100%); }
        body.season-7 header { background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%); }
        body.season-8 header { background: linear-gradient(135deg, #8b5cf6 0%, #fbbf24 100%); }
        body.season-9 header { background: linear-gradient(135deg, #f97316 0%, #fbbf24 100%); }
        body.season-10 header { background: linear-gradient(135deg, #f97316 0%, #a855f7 100%); }
        body.season-11 header { background: linear-gradient(135deg, #dc2626 0%, #f59e0b 100%); }
        body.season-12 header { background: linear-gradient(135deg, #dc2626 0%, #22c55e 100%); }

        .container { max-width: 1800px; margin: 0 auto; padding: 16px; position: relative; z-index: 1; }

        header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            padding: 20px 24px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        header h1 { font-size: 22px; font-weight: 700; }
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 6px;
        }
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
        }
        .sync-dot.offline { background: #ef4444; }
        .sync-dot.syncing { background: #eab308; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .header-controls { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }

        .member-selector {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 8px;
        }
        .member-selector select {
            background: transparent;
            border: none;
            color: white;
            font-size: 14px;
            font-weight: 600;
            padding: 6px 24px 6px 8px;
            cursor: pointer;
            min-width: 120px;
        }
        .member-selector select option {
            background: #1e293b;
            color: white;
        }

        .period-toggle {
            display: flex;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            overflow: hidden;
        }
        .period-btn {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.7);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }
        .period-btn:hover { color: white; }
        .period-btn.active {
            background: rgba(255,255,255,0.25);
            color: white;
        }

        .week-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.15);
            padding: 6px 14px;
            border-radius: 8px;
        }
        .week-nav.hidden { display: none; }
        .week-nav button {
            background: none; border: none; color: white;
            font-size: 18px; cursor: pointer; padding: 4px 8px;
        }
        .week-nav span { font-size: 14px; font-weight: 600; min-width: 200px; text-align: center; }

        select, input[type="text"], input[type="number"], input[type="date"] {
            background: #1e293b;
            border: 1px solid #334155;
            color: #e2e8f0;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 13px;
        }
        select:focus, input:focus, textarea:focus { outline: none; border-color: #6366f1; }
        textarea {
            background: #1e293b;
            border: 1px solid #334155;
            color: #e2e8f0;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 13px;
            resize: vertical;
            font-family: inherit;
        }

        .tabs {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            background: #0f172a;
            padding: 6px;
            border-radius: 12px;
            border: 1px solid #334155;
        }
        .tab {
            flex: 1;
            min-width: 100px;
            padding: 16px 20px;
            background: transparent;
            border: none;
            color: #94a3b8;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            white-space: nowrap;
            transition: all 0.2s;
            text-align: center;
        }
        .tab:hover { background: #1e293b; color: #e2e8f0; }
        .tab.active { background: #6366f1; color: white; box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .section {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid #334155;
        }
        .section h2 { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
        .section h3 { font-size: 14px; font-weight: 600; color: #94a3b8; margin: 16px 0 12px; }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        .summary-card {
            background: #0f172a;
            border-radius: 10px;
            padding: 14px;
            border: 1px solid #334155;
        }
        .summary-card h4 {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .summary-card .value { font-size: 26px; font-weight: 700; }
        .summary-card .sub { font-size: 12px; color: #64748b; margin-top: 2px; }
        .summary-card .rate { font-size: 14px; font-weight: 600; }

        .good { color: #22c55e; }
        .warning { color: #eab308; }
        .danger { color: #ef4444; }
        .info { color: #6366f1; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #334155; }
        th {
            background: #0f172a;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            position: sticky;
            top: 0;
        }
        tr:hover { background: rgba(99, 102, 241, 0.08); }
        .table-scroll { overflow-x: auto; max-height: 500px; overflow-y: auto; }

        .input-sm { width: 60px; text-align: center; padding: 4px 6px; font-size: 13px; }
        .input-md { width: 100px; }
        .input-lg { width: 100%; }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary { background: #6366f1; color: white; }
        .btn-primary:hover { background: #4f46e5; }
        .btn-secondary { background: #334155; color: #e2e8f0; }
        .btn-secondary:hover { background: #475569; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }

        .progress-bar {
            width: 100%;
            height: 5px;
            background: #334155;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 4px;
        }
        .progress-bar .fill { height: 100%; border-radius: 3px; }
        .progress-bar .fill.good { background: #22c55e; }
        .progress-bar .fill.warning { background: #eab308; }
        .progress-bar .fill.danger { background: #ef4444; }

        .mini-chart {
            margin-top: 8px;
            height: 40px;
            width: 100%;
        }
        .mini-chart svg {
            width: 100%;
            height: 100%;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }
        .chart-card {
            background: #0f172a;
            border-radius: 10px;
            padding: 14px;
            border: 1px solid #334155;
        }
        .chart-card h4 {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 10px;
        }
        .chart-container {
            position: relative;
            height: 120px;
        }
        .chart-container svg {
            width: 100%;
            height: 100%;
        }
        .chart-legend {
            display: flex;
            gap: 16px;
            margin-top: 8px;
            font-size: 11px;
            color: #64748b;
        }
        .chart-legend span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .legend-line {
            width: 16px;
            height: 2px;
        }
        .legend-line.target {
            background: #64748b;
            background: repeating-linear-gradient(90deg, #64748b 0, #64748b 4px, transparent 4px, transparent 7px);
        }
        .legend-line.actual {
            background: #6366f1;
        }

        .chart-tooltip {
            position: absolute;
            background: #1e293b;
            border: 1px solid #6366f1;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 11px;
            color: #e2e8f0;
            pointer-events: none;
            z-index: 100;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
        }
        .chart-tooltip.show {
            display: block;
        }
        .chart-container svg circle {
            cursor: pointer;
        }

        .daily-header {
            display: grid;
            grid-template-columns: 120px repeat(7, 1fr) 80px;
            gap: 4px;
            margin-bottom: 4px;
            position: sticky;
            top: 0;
            background: #1e293b;
            z-index: 10;
            padding: 8px 0;
        }
        .daily-row {
            display: grid;
            grid-template-columns: 120px repeat(7, 1fr) 80px;
            gap: 4px;
            margin-bottom: 2px;
        }
        .daily-row.sub { padding-left: 20px; grid-template-columns: 100px repeat(7, 1fr) 80px; }
        .daily-cell {
            background: #0f172a;
            border-radius: 4px;
            padding: 6px;
            text-align: center;
            font-size: 12px;
        }
        .daily-cell.header { background: transparent; font-weight: 600; color: #64748b; }
        .daily-cell.label { text-align: left; font-weight: 500; display: flex; align-items: center; }
        .daily-cell.category { background: #334155; font-weight: 600; color: #e2e8f0; }
        .daily-cell.total { background: #334155; font-weight: 600; }
        .daily-cell input {
            width: 100%;
            background: transparent;
            border: 1px solid transparent;
            color: #e2e8f0;
            text-align: center;
            padding: 4px;
            border-radius: 4px;
            font-size: 13px;
        }
        .daily-cell input:hover { border-color: #475569; }
        .daily-cell input:focus { border-color: #6366f1; background: #1e293b; }
        .muchaku-btn {
            padding: 2px 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            color: white;
            transition: opacity 0.2s;
        }
        .muchaku-btn:hover { opacity: 0.8; }
        .muchaku-btn.empty { background: #475569; opacity: 0.5; }
        .muchaku-btn.pending { background: #eab308; }
        .muchaku-btn.done { background: #22c55e; }

        .issue-box {
            background: #0f172a;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 12px;
            border-left: 3px solid #ef4444;
        }
        .issue-box.cause { border-left-color: #eab308; }
        .issue-box label {
            display: block;
            font-size: 11px;
            color: #ef4444;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .issue-box.cause label { color: #eab308; }
        .issue-box input, .issue-box textarea {
            width: 100%;
            background: transparent;
            border: none;
            color: #e2e8f0;
            font-size: 14px;
            padding: 4px 0;
        }

        .cause-action-card {
            background: #0f172a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #334155;
        }
        .cause-action-card.primary { border-color: #eab308; }
        .cause-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .cause-num {
            background: #475569;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }
        .cause-num.primary { background: #eab308; color: #0f172a; }
        .cause-input {
            flex: 1;
            background: transparent;
            border: none;
            border-bottom: 1px solid #334155;
            color: #e2e8f0;
            font-size: 14px;
            padding: 4px 0;
        }
        .cause-input:focus { outline: none; border-bottom-color: #6366f1; }
        .action-row {
            display: grid;
            grid-template-columns: 1fr 100px 120px 30px;
            gap: 8px;
            align-items: center;
            padding: 8px;
            background: #1e293b;
            border-radius: 6px;
            margin-top: 8px;
        }
        .action-row.completed { opacity: 0.5; }
        .action-row input[type="text"] { background: transparent; border: none; color: #e2e8f0; }
        .action-row input[type="checkbox"] { width: 16px; height: 16px; accent-color: #22c55e; }

        .reason-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }
        .reason-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #0f172a;
            border-radius: 6px;
        }
        .reason-item label { font-size: 13px; }
        .reason-item input { width: 50px; text-align: center; }

        .case-item {
            display: grid;
            grid-template-columns: 80px 1fr 1fr 40px;
            gap: 10px;
            padding: 10px;
            background: #0f172a;
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        .kpi-item {
            background: #0f172a;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }
        .kpi-item .label { font-size: 10px; color: #64748b; text-transform: uppercase; margin-bottom: 4px; }
        .kpi-item .value { font-size: 20px; font-weight: 700; }

        .account-section {
            border: 1px solid #334155;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .account-header {
            background: #334155;
            padding: 10px 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .account-header h4 { font-size: 14px; font-weight: 600; }
        .account-body { padding: 14px; display: none; }
        .account-body.open { display: block; }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #334155;
        }
        .modal h3 { font-size: 18px; margin-bottom: 16px; }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; font-size: 13px; color: #94a3b8; margin-bottom: 4px; }
        .form-group input, .form-group select { width: 100%; }
        @keyframes settingsHighlight {
            0% { background: #6366f1; }
            100% { background: #0f172a; }
        }
        .settings-updated {
            animation: settingsHighlight 0.5s ease-out;
        }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

        .goal-table { margin-top: 12px; }
        .goal-row {
            display: grid;
            grid-template-columns: 150px repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 6px;
        }
        .goal-row.header { font-weight: 600; color: #64748b; font-size: 12px; }
        .goal-cell { padding: 8px; background: #0f172a; border-radius: 4px; text-align: center; }
        .goal-cell.label { text-align: left; background: transparent; }

        .setup-guide {
            background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%);
            border: 1px solid #3b82f6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .setup-guide h3 { color: #60a5fa; margin-bottom: 12px; }
        .setup-guide ol { margin-left: 20px; }
        .setup-guide li { margin-bottom: 8px; }
        .setup-guide code {
            background: #0f172a;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .daily-header, .daily-row { grid-template-columns: 100px repeat(7, 50px) 60px; overflow-x: auto; }
        }

        .week-tabs {
            display: flex;
            gap: 4px;
            background: #0f172a;
            padding: 4px;
            border-radius: 8px;
        }
        .week-tab {
            padding: 6px 12px;
            background: transparent;
            border: none;
            color: #64748b;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            white-space: nowrap;
        }
        .week-tab:hover { color: #e2e8f0; background: #334155; }
        .week-tab.active { background: #6366f1; color: white; }

        .display-toggle {
            display: flex;
            gap: 4px;
            background: #0f172a;
            padding: 4px;
            border-radius: 8px;
        }
        .display-toggle .btn { border-radius: 6px; }
        .display-toggle .btn.active { background: #6366f1; color: white; }

        .nippo-day-card {
            background: #0f172a;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #334155;
        }
        .nippo-day-card .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #334155;
        }
        .nippo-day-card .day-title {
            font-size: 16px;
            font-weight: 600;
            color: #e2e8f0;
        }
        .nippo-day-card .member-name {
            font-size: 13px;
            color: #6366f1;
            background: rgba(99,102,241,0.15);
            padding: 4px 10px;
            border-radius: 4px;
        }
        .nippo-block {
            margin-bottom: 16px;
        }
        .nippo-block:last-child { margin-bottom: 0; }
        .nippo-block-label {
            font-size: 12px;
            font-weight: 600;
            color: #94a3b8;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .nippo-block-label .icon { font-size: 14px; }
        .nippo-video-container {
            background: #1e293b;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }
        .nippo-video-container video, .nippo-video-container iframe {
            width: 100%;
            max-height: 200px;
            border-radius: 6px;
        }
        .nippo-video-url {
            width: 100%;
            background: #1e293b;
            border: 1px solid #334155;
            color: #e2e8f0;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 13px;
        }
        .nippo-textarea {
            width: 100%;
            min-height: 80px;
            background: #1e293b;
            border: 1px solid #334155;
            color: #e2e8f0;
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
            resize: vertical;
            font-family: inherit;
        }
        .nippo-textarea:focus { border-color: #6366f1; outline: none; }
        .video-upload-row {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 10px;
            align-items: center;
            padding: 8px;
            background: #0f172a;
            border-radius: 6px;
            margin-bottom: 6px;
        }
        .video-upload-row .date-label {
            font-weight: 500;
            font-size: 13px;
        }
    </style>
    <script>
    // === SupabaseÈÄ£Êê∫Ôºàappointment-managerÔºâ ===
    const SUPABASE_URL = 'https://pbctrjnnrvssdyywgtdx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBiY3Ryam5ucnZzc2R5eXdndGR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5ODA2MDgsImV4cCI6MjA4NTU1NjYwOH0.MTOIZ9enImEiakaxyNb-SGw6QFeYFia83cmOk5TSnq4';

    // ÊÆãÊ°à‰ª∂„Çπ„ÉÜ„Éº„Çø„Çπ
    const SUPABASE_ACTIVE_STATUSES = [
        'Áõ∏Ë´á‰ºöÂãïÂì°','Áõ¥„ÇØ„É≠ÂãïÂì°','Êó•Á®ãË™øÊï¥‰∏≠',
        'Áõ¥„ÇØ„É≠„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó','Áõ¥„ÇØ„É≠„Éï„Ç©„É≠„Éº',
        '„É©„Ç§„É≥‰∫§Êèõ',
        'ÂÜç„ÇØ„É≠„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó','ÂÜç„ÇØ„É≠„Éï„Ç©„É≠„Éº',
        'ÂÜç„ÄÖ„ÇØ„É≠„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó','ÂÜç„ÄÖ„ÇØ„É≠„Éï„Ç©„É≠„Éº',
        'Èù¢Ë´á„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó','Èù¢Ë´á„Éï„Ç©„É≠„Éº','Èù¢Ë´áÁùÄÂú∞',
        'ÊïôËÇ≤‰∏≠'
    ];

    // ÂãïÂì°„Ç≠„É£„É≥„Çª„É´„Çπ„ÉÜ„Éº„Çø„Çπ
    const SUPABASE_CANCEL_STATUSES = ['ÂãïÂì°„Ç≠„É£„É≥„Çª„É´'];
    // ÂãïÂì°ÂæåÁÑ°ÁùÄÂú∞„Çπ„ÉÜ„Éº„Çø„Çπ
    const SUPABASE_POST_MOB_STATUSES = ['ÂãïÂì°ÂæåÁÑ°ÁùÄÂú∞'];

    // Supabase„Åã„Çâ„Éá„Éº„ÇøÂèñÂæó
    async function fetchSupabaseActiveCases() {
        try {
            const statusFilter = SUPABASE_ACTIVE_STATUSES.map(s => encodeURIComponent(s)).join(',');
            const url = `${SUPABASE_URL}/rest/v1/appointments?status=in.(${statusFilter})&is_deleted=eq.false&select=id,status,created_at,closer_id,notes,customer:customers!inner(name,cloudworks_url),user:profiles!appointments_user_id_fkey(id,name),closer:profiles!appointments_closer_id_fkey(id,name)&order=created_at.desc`;
            const res = await fetch(url, {
                headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
            });
            if (!res.ok) return [];
            return await res.json();
        } catch (e) { console.error('SupabaseÊÆãÊ°à‰ª∂ÂèñÂæó„Ç®„É©„Éº:', e); return []; }
    }

    async function fetchSupabaseCancels() {
        try {
            const url = `${SUPABASE_URL}/rest/v1/appointments?status=eq.ÂãïÂì°„Ç≠„É£„É≥„Çª„É´&is_deleted=eq.false&select=id,status,cancel_reason,created_at,customer:customers!inner(name),user:profiles!appointments_user_id_fkey(id,name),closer:profiles!appointments_closer_id_fkey(id,name)&order=created_at.desc`;
            const res = await fetch(url, {
                headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
            });
            if (!res.ok) return [];
            return await res.json();
        } catch (e) { console.error('Supabase„Ç≠„É£„É≥„Çª„É´ÂèñÂæó„Ç®„É©„Éº:', e); return []; }
    }

    async function fetchSupabasePostMob() {
        try {
            const url = `${SUPABASE_URL}/rest/v1/appointments?status=eq.ÂãïÂì°ÂæåÁÑ°ÁùÄÂú∞&is_deleted=eq.false&select=id,status,post_mobilization_reason,created_at,customer:customers!inner(name),user:profiles!appointments_user_id_fkey(id,name)&order=created_at.desc`;
            const res = await fetch(url, {
                headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
            });
            if (!res.ok) return [];
            return await res.json();
        } catch (e) { console.error('SupabaseÂãïÂì°ÂæåÁÑ°ÁùÄÂú∞ÂèñÂæó„Ç®„É©„Éº:', e); return []; }
    }

    // „Çπ„ÉÜ„Éº„Çø„ÇπÁü≠Á∏ÆÂêç
    const STATUS_SHORT_MAP = {
        'Áõ∏Ë´á‰ºöÂãïÂì°':'Áõ∏Ë´á‰ºö','Áõ¥„ÇØ„É≠ÂãïÂì°':'Áõ¥„ÇØ„É≠ÂãïÂì°','Êó•Á®ãË™øÊï¥‰∏≠':'Êó•Á®ãË™øÊï¥',
        'Áõ¥„ÇØ„É≠„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó':'Áõ¥„ÇØ„É≠SU','Áõ¥„ÇØ„É≠„Éï„Ç©„É≠„Éº':'Áõ¥„ÇØ„É≠F',
        '„É©„Ç§„É≥‰∫§Êèõ':'LINE',
        'ÂÜç„ÇØ„É≠„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó':'ÂÜç„ÇØ„É≠SU','ÂÜç„ÇØ„É≠„Éï„Ç©„É≠„Éº':'ÂÜç„ÇØ„É≠F',
        'ÂÜç„ÄÖ„ÇØ„É≠„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó':'ÂÜç„ÄÖ„ÇØ„É≠SU','ÂÜç„ÄÖ„ÇØ„É≠„Éï„Ç©„É≠„Éº':'ÂÜç„ÄÖ„ÇØ„É≠F',
        'Èù¢Ë´á„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó':'Èù¢Ë´áSU','Èù¢Ë´á„Éï„Ç©„É≠„Éº':'Èù¢Ë´áF','Èù¢Ë´áÁùÄÂú∞':'Èù¢Ë´áÁùÄÂú∞',
        'ÊïôËÇ≤‰∏≠':'ÊïôËÇ≤‰∏≠'
    };

    // SupabaseÊÆãÊ°à‰ª∂„Çí„Çµ„Éû„É™„Éº„Å´ÊèèÁîª
    let supabaseCasesCache = [];
    let supabaseCancelsCache = [];
    let supabasePostMobCache = [];

    // „É°„Éº„É´„Éû„ÉÉ„Éî„É≥„Ç∞: Supabase user_id ‚Üí email
    let supabaseEmailMap = {}; // { supabase_user_id: email }

    // „Ç¢„ÉùÁÆ°ÁêÜ„ÉÑ„Éº„É´„Åã„Çâ„É°„Éº„É´„Éû„ÉÉ„Éî„É≥„Ç∞„ÇíÂèñÂæó
    const APPOINTMENT_MANAGER_URL = 'http://localhost:3000';
    async function fetchEmailMapping() {
        try {
            const res = await fetch(`${APPOINTMENT_MANAGER_URL}/api/email-mapping`);
            if (!res.ok) return;
            const mapping = await res.json();
            // { supabase_user_id: email } „ÅÆ„Éû„ÉÉ„Éó„ÇíÊßãÁØâ
            supabaseEmailMap = {};
            mapping.forEach(u => { supabaseEmailMap[u.id] = u.email; });
            console.log('Supabase„É°„Éº„É´„Éû„ÉÉ„Éî„É≥„Ç∞ÂèñÂæó:', Object.keys(supabaseEmailMap).length, '‰ª∂');
        } catch (e) {
            console.warn('„É°„Éº„É´„Éû„ÉÉ„Éî„É≥„Ç∞ÂèñÂæóÂ§±ÊïóÔºàÂêçÂâç„Éô„Éº„Çπ„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ:', e.message);
        }
    }

    // Supabase„É¶„Éº„Ç∂„Éº„Åã„ÇâÊñΩÁ≠ñ„ÉÑ„Éº„É´„ÅÆmemberId„ÇíÈÄÜÂºï„ÅçÔºà„É°„Éº„É´ÂÑ™ÂÖà„ÄÅÂêçÂâç„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
    function supabaseUserToMemberId(user) {
        if (!user || typeof data === 'undefined' || !data.members) return null;

        // ÊñπÊ≥ï1: „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åß„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÔºàFirebase userMapÁµåÁî±Ôºâ
        if (typeof userMap !== 'undefined' && user.id && supabaseEmailMap[user.id]) {
            const supabaseEmail = supabaseEmailMap[user.id];
            for (const uid in userMap) {
                if (userMap[uid].email === supabaseEmail && userMap[uid].memberId) {
                    return userMap[uid].memberId;
                }
            }
        }

        // ÊñπÊ≥ï2: ÂêçÂâç„Åß„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        if (user.name) {
            const match = data.members.find(m => m.name === user.name);
            if (match) return match.id;
        }

        return null;
    }

    // ÊñΩÁ≠ñ„ÉÑ„Éº„É´„ÅÆ„É°„É≥„Éê„Éº„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®
    function filterBySelectedMember(items) {
        if (typeof selectedMember === 'undefined' || selectedMember === 'all') return items;
        return items.filter(item => {
            const memberId = supabaseUserToMemberId(item.user);
            return memberId === selectedMember;
        });
    }

    async function syncSupabaseCases() {
        // „É°„Éº„É´„Éû„ÉÉ„Éî„É≥„Ç∞„ÇíÂÖà„Å´ÂèñÂæó
        await fetchEmailMapping();
        const [cases, cancels, postMob] = await Promise.all([
            fetchSupabaseActiveCases(),
            fetchSupabaseCancels(),
            fetchSupabasePostMob()
        ]);
        supabaseCasesCache = cases;
        supabaseCancelsCache = cancels;
        supabasePostMobCache = postMob;
        renderSupabaseSummary();
        renderSupabaseInputSection();
    }

    function renderSupabaseSummary() {
        // „Çµ„Éû„É™„Éº„ÅÆÊÆãÊ°à‰ª∂
        const el = document.getElementById('rsCasesList');
        const countEl = document.getElementById('rsCasesCount');
        if (!el || !countEl) return;

        const cases = filterBySelectedMember(supabaseCasesCache);
        countEl.textContent = `(${cases.length}‰ª∂ - „Ç¢„ÉùÁÆ°ÁêÜÈÄ£Êê∫)`;
        el.innerHTML = cases.length === 0
            ? '<p style="color:#64748b">ÊÆãÊ°à‰ª∂„Å™„Åó</p>'
            : cases.map(c => {
                const st = STATUS_SHORT_MAP[c.status] || c.status;
                const closer = c.closer ? c.closer.name : '';
                return `<div style="padding:4px;background:#0f172a;border-radius:4px;margin-bottom:4px">
                    <span style="font-size:9px;background:#3b82f6;padding:1px 4px;border-radius:3px;margin-right:4px">${st}</span>
                    ${c.customer?.name || '‰∏çÊòé'}
                    <span style="color:#64748b;font-size:10px;margin-left:4px">${c.user?.name || ''}</span>
                    ${closer ? `<span style="color:#64748b;font-size:10px"> / ${closer}</span>` : ''}
                </div>`;
            }).join('');

        // „Çµ„Éû„É™„Éº„ÅÆ„Ç≠„É£„É≥„Çª„É´
        const cancelEl = document.getElementById('rsCancelsList');
        const cancelCountEl = document.getElementById('rsCancelsCount');
        if (cancelEl && cancelCountEl) {
            const cancels = filterBySelectedMember(supabaseCancelsCache);
            cancelCountEl.textContent = `(${cancels.length}‰ª∂)`;
            cancelEl.innerHTML = cancels.length === 0
                ? '<p style="color:#64748b">„Å™„Åó</p>'
                : cancels.map(c => `<div style="padding:4px;background:#0f172a;border-radius:4px;margin-bottom:4px;border-left:2px solid #eab308">
                    ${c.customer?.name || '‰∏çÊòé'}
                    <span style="color:#eab308;font-size:11px">${c.cancel_reason || ''}</span>
                </div>`).join('');
        }

        // „Çµ„Éû„É™„Éº„ÅÆÂãïÂì°ÂæåÁÑ°ÁùÄÂú∞
        const postEl = document.getElementById('rsDoinMuchakuList');
        const postCountEl = document.getElementById('rsDoinMuchakuCount');
        if (postEl && postCountEl) {
            const postMob = filterBySelectedMember(supabasePostMobCache);
            postCountEl.textContent = `(${postMob.length}‰ª∂)`;
            postEl.innerHTML = postMob.length === 0
                ? '<p style="color:#64748b">„Å™„Åó</p>'
                : postMob.map(c => `<div style="padding:4px;background:#0f172a;border-radius:4px;margin-bottom:4px;border-left:2px solid #ef4444">
                    ${c.customer?.name || '‰∏çÊòé'}
                    <span style="color:#ef4444;font-size:11px">${c.post_mobilization_reason || ''}</span>
                </div>`).join('');
        }
    }

    function renderSupabaseInputSection() {
        // ÂÖ•Âäõ„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆÊÆãÊ°à‰ª∂„É™„Çπ„Éà
        const el = document.getElementById('caseList');
        const countEl = document.getElementById('sCasesCount');
        if (!el || !countEl) return;

        const cases = filterBySelectedMember(supabaseCasesCache);
        countEl.textContent = `(${cases.length}‰ª∂ - „Ç¢„ÉùÁÆ°ÁêÜÈÄ£Êê∫)`;
        el.innerHTML = cases.length === 0
            ? '<p style="color:#64748b;font-size:13px">ÊÆãÊ°à‰ª∂„Å™„Åó</p>'
            : cases.map(c => {
                const st = STATUS_SHORT_MAP[c.status] || c.status;
                const date = new Date(c.created_at).toLocaleDateString('ja-JP', {month:'short',day:'numeric'});
                const closer = c.closer ? c.closer.name : '';
                return `<div class="case-item" style="opacity:0.85">
                    <span style="font-size:10px;background:#3b82f6;color:white;padding:1px 6px;border-radius:4px;margin-right:4px;white-space:nowrap">${st}</span>
                    <span style="flex:1;font-size:12px">${c.customer?.name || '‰∏çÊòé'}</span>
                    <span style="font-size:11px;color:#64748b">${c.user?.name || ''}</span>
                    ${closer ? `<span style="font-size:11px;color:#64748b"> / ${closer}</span>` : ''}
                    <span style="font-size:10px;color:#475569">${date}</span>
                </div>`;
            }).join('');
    }
    </script>
</head>
<body>
    <!-- FirebaseË™çË®º„É¢„Éº„ÉÄ„É´ -->
    <div id="authModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:99999;display:flex;align-items:center;justify-content:center">
        <div style="background:#1e293b;padding:40px;border-radius:16px;text-align:center;max-width:420px;width:90%">
            <h2 style="color:#6366f1;margin-bottom:8px">üîê „Éë„Éº„ÇΩ„Éä„É´ÊñΩÁ≠ñ„ÉÑ„Éº„É´</h2>
            <p style="color:#94a3b8;font-size:14px;margin-bottom:24px">„ÉÅ„Éº„É†„É°„É≥„Éê„ÉºÂ∞ÇÁî®„Éö„Éº„Ç∏„Åß„Åô</p>

            <!-- „É≠„Ç∞„Ç§„É≥„Éï„Ç©„Éº„É† -->
            <div id="loginForm">
                <input type="email" id="loginEmail" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ"
                       style="width:100%;padding:12px 16px;font-size:15px;background:#0f172a;border:2px solid #334155;color:#e2e8f0;border-radius:8px;margin-bottom:10px"
                       onkeypress="if(event.key==='Enter')document.getElementById('loginPassword').focus()">
                <input type="password" id="loginPassword" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ"
                       style="width:100%;padding:12px 16px;font-size:15px;background:#0f172a;border:2px solid #334155;color:#e2e8f0;border-radius:8px;margin-bottom:16px"
                       onkeypress="if(event.key==='Enter')handleEmailLogin()">
                <button onclick="handleEmailLogin()" id="loginBtn"
                        style="width:100%;padding:12px;font-size:16px;background:#6366f1;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600">
                    „É≠„Ç∞„Ç§„É≥
                </button>
                <p style="color:#94a3b8;font-size:13px;margin-top:16px">
                    „Ç¢„Ç´„Ç¶„É≥„Éà„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ
                    <a href="#" onclick="showSignupForm();return false" style="color:#6366f1;text-decoration:underline">Êñ∞Ë¶èÁôªÈå≤</a>
                </p>
            </div>

            <!-- Êñ∞Ë¶èÁôªÈå≤„Éï„Ç©„Éº„É† -->
            <div id="signupForm" style="display:none">
                <input type="email" id="signupEmail" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ"
                       style="width:100%;padding:12px 16px;font-size:15px;background:#0f172a;border:2px solid #334155;color:#e2e8f0;border-radius:8px;margin-bottom:10px">
                <input type="password" id="signupPassword" placeholder="„Éë„Çπ„ÉØ„Éº„ÉâÔºà6ÊñáÂ≠ó‰ª•‰∏äÔºâ"
                       style="width:100%;padding:12px 16px;font-size:15px;background:#0f172a;border:2px solid #334155;color:#e2e8f0;border-radius:8px;margin-bottom:10px">
                <input type="password" id="teamPasswordInput" placeholder="„ÉÅ„Éº„É†„Éë„Çπ„ÉØ„Éº„Éâ"
                       style="width:100%;padding:12px 16px;font-size:15px;background:#0f172a;border:2px solid #334155;color:#e2e8f0;border-radius:8px;margin-bottom:16px"
                       onkeypress="if(event.key==='Enter')handleSignup()">
                <button onclick="handleSignup()" id="signupBtn"
                        style="width:100%;padding:12px;font-size:16px;background:#22c55e;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600">
                    Êñ∞Ë¶èÁôªÈå≤
                </button>
                <p style="color:#94a3b8;font-size:13px;margin-top:16px">
                    Êó¢„Å´„Ç¢„Ç´„Ç¶„É≥„Éà„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ
                    <a href="#" onclick="showLoginForm();return false" style="color:#6366f1;text-decoration:underline">„É≠„Ç∞„Ç§„É≥</a>
                </p>
            </div>

            <!-- „É°„É≥„Éê„ÉºÁ¥ê‰ªò„Åë„Éï„Ç©„Éº„É† -->
            <div id="memberLinkForm" style="display:none">
                <p style="color:#e2e8f0;font-size:15px;margin-bottom:16px">„ÅÇ„Å™„Åü„ÅÆ„É°„É≥„Éê„Éº„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                <!-- Êó¢Â≠ò„É°„É≥„Éê„Éº„Åã„ÇâÈÅ∏Êäû -->
                <div id="linkExistingSection">
                    <p style="color:#94a3b8;font-size:13px;margin-bottom:8px">Êó¢Â≠ò„É°„É≥„Éê„Éº„Åã„ÇâÈÅ∏Êäû:</p>
                    <select id="memberLinkSelect"
                            style="width:100%;padding:12px 16px;font-size:15px;background:#0f172a;border:2px solid #334155;color:#e2e8f0;border-radius:8px;margin-bottom:12px">
                        <option value="">-- „É°„É≥„Éê„Éº„ÇíÈÅ∏Êäû --</option>
                    </select>
                </div>
                <!-- Âå∫Âàá„Çä -->
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <div style="flex:1;height:1px;background:#334155"></div>
                    <span style="color:#64748b;font-size:13px">„Åæ„Åü„ÅØ</span>
                    <div style="flex:1;height:1px;background:#334155"></div>
                </div>
                <!-- Êñ∞„Åó„ÅÑÂêçÂâç„ÅßÁôªÈå≤ -->
                <p style="color:#94a3b8;font-size:13px;margin-bottom:8px">Êñ∞„Åó„ÅÑÂêçÂâç„ÅßÂèÇÂä†:</p>
                <input type="text" id="newMemberNameInput" placeholder="„ÅÇ„Å™„Åü„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ"
                       style="width:100%;padding:12px 16px;font-size:15px;background:#0f172a;border:2px solid #334155;color:#e2e8f0;border-radius:8px;margin-bottom:16px">
                <button onclick="linkMember()" id="linkBtn"
                        style="width:100%;padding:12px;font-size:16px;background:#6366f1;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600">
                    ÈñãÂßã
                </button>
            </div>

            <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ -->
            <div id="authLoading" style="display:none">
                <div style="color:#94a3b8;font-size:14px;padding:20px">
                    <div style="margin-bottom:12px">‚è≥</div>
                    Ë™çË®º‰∏≠...
                </div>
            </div>

            <!-- „Ç®„É©„ÉºË°®Á§∫ -->
            <p id="authError" style="color:#ef4444;margin-top:12px;font-size:13px;display:none"></p>
        </div>
    </div>

    <div class="chart-tooltip" id="chartTooltip"></div>
    <div class="container" id="mainContainer" style="display:none">
        <header>
            <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
                <h1>„Éë„Éº„ÇΩ„Éä„É´ÊñΩÁ≠ñ„ÉÑ„Éº„É´</h1>
                <span style="font-size:10px;color:#64748b;margin-left:-12px">v2.2</span>
                <div class="sync-status">
                    <div class="sync-dot" id="syncDot"></div>
                    <span id="syncText">„É≠„Éº„Ç´„É´‰øùÂ≠ò</span>
                </div>
                <div id="debugPanel" style="font-size:10px;color:#94a3b8;background:#1e293b;padding:4px 8px;border-radius:4px;display:none">
                    <span id="debugLastSync">ÂêåÊúü: --</span> | <span id="debugListenerCount">Âèó‰ø°: 0Âõû</span> | <span id="debugSaveCount">ÈÄÅ‰ø°: 0Âõû</span>
                    <button onclick="forceReload()" style="font-size:10px;margin-left:8px;padding:2px 6px;background:#334155;color:#e2e8f0;border:none;border-radius:3px;cursor:pointer">Âº∑Âà∂ÂÜçË™≠Ëæº</button>
                </div>
                <div id="headerUserInfo" style="display:none;align-items:center;gap:8px;margin-left:auto;font-size:13px">
                    <span id="headerUserName" style="color:#e2e8f0"></span>
                    <span id="headerAdminBadge" style="display:none;background:#f59e0b;color:#000;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600">ÁÆ°ÁêÜËÄÖ</span>
                    <button id="headerAdminEditBtn" style="display:none;padding:4px 10px;font-size:11px;background:#334155;color:#e2e8f0;border:1px solid #475569;border-radius:6px;cursor:pointer" onclick="toggleAdminEdit()">ÁÆ°ÁêÜËÄÖÁ∑®ÈõÜ: OFF</button>
                    <button onclick="handleLogout()" style="padding:4px 10px;font-size:11px;background:#475569;color:#e2e8f0;border:none;border-radius:6px;cursor:pointer">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                </div>
            </div>
            <div class="header-controls">
                <div class="member-selector">
                    <span style="font-size:12px;color:#94a3b8;margin-right:8px">„É°„É≥„Éê„Éº:</span>
                    <select id="memberSelect" onchange="onMemberChange()">
                        <option value="all">ÂÖ®‰Ωì</option>
                    </select>
                </div>
                <div class="period-toggle">
                    <button class="period-btn active" id="btnWeek" onclick="setViewPeriod('week')">ÈÄ±Ê¨°</button>
                    <button class="period-btn" id="btnMonth" onclick="setViewPeriod('month')">ÂÖ®Êó•</button>
                </div>
                <div class="week-nav" id="weekNav">
                    <button onclick="prevWeek()">‚óÄ</button>
                    <span id="weekLabel">1/17„Äú1/23ÔºàÁ¨¨3ÈÄ±Ôºâ</span>
                    <button onclick="nextWeek()">‚ñ∂</button>
                </div>
                <div class="week-nav" id="monthSelector" style="display:none;">
                    <button onclick="prevMonth()">‚óÄ</button>
                    <span id="monthLabel">2026Âπ¥1Êúà</span>
                    <button onclick="nextMonth()">‚ñ∂</button>
                </div>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('summary')">„Çµ„Éû„É™„Éº</button>
            <button class="tab" onclick="switchTab('daily')">Êó•Âà•Êï∞Â≠ó</button>
            <button class="tab" onclick="switchTab('nippo')">Êó•Â†±</button>
            <button class="tab" onclick="switchTab('review')">ÊñΩÁ≠ñ„Ç∑„Éº„Éà</button>
            <button class="tab" onclick="switchTab('instagram')">„Ç§„É≥„Çπ„Çø</button>
            <button class="tab" onclick="switchTab('settings')">Ë®≠ÂÆö</button>
        </div>

        <!-- „Çµ„Éû„É™„Éº„Çø„Éñ -->
        <div id="tab-summary" class="tab-content active">
            <div class="summary-grid">
                <div class="summary-card">
                    <h4>ÊäïÁ®øÊï∞</h4>
                    <div class="value" id="sPost">0</div>
                    <div class="sub">ÁõÆÊ®ô: <span id="sPostGoal">0</span></div>
                    <div class="rate" id="sPostRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="sPostBar"></div></div>
                    <div class="sub" style="margin-top:4px;color:#f59e0b" id="sPostDaily"></div>
                </div>
                <div class="summary-card">
                    <h4>„Ç¢„ÉùÁç≤Âæó</h4>
                    <div class="value" id="sApoGet">0</div>
                    <div class="sub">ÁõÆÊ®ô: <span id="sApoGetGoal">0</span></div>
                    <div class="rate" id="sApoGetRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="sApoGetBar"></div></div>
                    <div class="sub" style="margin-top:4px;color:#f59e0b" id="sApoGetDaily"></div>
                </div>
                <div class="summary-card">
                    <h4>„Ç¢„ÉùÂÆüÊñΩ</h4>
                    <div class="value" id="sApoExec">0</div>
                    <div class="sub">ÁõÆÊ®ô: <span id="sApoExecGoal">0</span></div>
                    <div class="rate" id="sApoExecRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="sApoExecBar"></div></div>
                    <div class="sub" style="margin-top:4px;color:#f59e0b" id="sApoExecDaily"></div>
                </div>
                <div class="summary-card">
                    <h4>ÂãïÂì°Áõ¥„ÇØ„É≠Áç≤Âæó</h4>
                    <div class="value" id="sDoinGet">0</div>
                    <div class="sub">ÁõÆÊ®ô: <span id="sDoinGetGoal">0</span></div>
                    <div class="rate" id="sDoinGetRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="sDoinGetBar"></div></div>
                    <div class="sub" style="margin-top:4px;color:#f59e0b" id="sDoinGetDaily"></div>
                </div>
                <div class="summary-card">
                    <h4>ÂãïÂì°Áõ¥„ÇØ„É≠ÂÆüÊñΩ</h4>
                    <div class="value" id="sDoinExec">0</div>
                    <div class="sub">ÁõÆÊ®ô: <span id="sDoinExecGoal">0</span></div>
                    <div class="rate" id="sDoinExecRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="sDoinExecBar"></div></div>
                    <div class="sub" style="margin-top:4px;color:#f59e0b" id="sDoinExecDaily"></div>
                </div>
                <div class="summary-card">
                    <h4>Èù¢Ë´áÁç≤Âæó</h4>
                    <div class="value" id="sMendan">0</div>
                    <div class="sub">ÁõÆÊ®ô: <span id="sMendanGoal">0</span></div>
                    <div class="rate" id="sMendanRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="sMendanBar"></div></div>
                    <div class="sub" style="margin-top:4px;color:#f59e0b" id="sMendanDaily"></div>
                </div>
                <div class="summary-card">
                    <h4>Èù¢Ë´áÂÆüÊñΩ</h4>
                    <div class="value" id="sMendanExec">0</div>
                    <div class="sub">ÁõÆÊ®ô: <span id="sMendanExecGoal">0</span></div>
                    <div class="rate" id="sMendanExecRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="sMendanExecBar"></div></div>
                    <div class="sub" style="margin-top:4px;color:#f59e0b" id="sMendanExecDaily"></div>
                </div>
                <div class="summary-card">
                    <h4>ÊàêÁ¥Ñ</h4>
                    <div class="value" id="sSeiyaku">0</div>
                    <div class="sub">ÁõÆÊ®ô: <span id="sSeiyakuGoal">0</span></div>
                    <div class="rate" id="sSeiyakuRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="sSeiyakuBar"></div></div>
                    <div class="sub" style="margin-top:4px;color:#f59e0b" id="sSeiyakuDaily"></div>
                </div>
            </div>

            <div class="section">
                <h2>ÈÄ≤Êçó„Ç∞„É©„Éï</h2>
                <div class="charts-grid" id="chartsGrid"></div>
            </div>

            <div class="section">
                <h2>Á¢∫Ë™çÊï∞Â≠ó„ÉªÈ†ÖÁõÆÔºàËá™ÂãïË®àÁÆóÔºâ</h2>
                <div class="kpi-grid">
                    <div class="kpi-item"><div class="label">ÁÑ°ÁùÄÂú∞Áéá</div><div class="value" id="kMuchaku">0%</div></div>
                    <div class="kpi-item"><div class="label">„Çø„Éº„Ç≤„ÉÉ„ÉàÂà∞ÈÅîÁéá</div><div class="value" id="kTarget">0%</div></div>
                    <div class="kpi-item"><div class="label">NGÁéá</div><div class="value" id="kNg">0%</div></div>
                    <div class="kpi-item"><div class="label">„ÉÜ„Çπ„ÇØ„É≠Áéá</div><div class="value" id="kTestClose">0%</div></div>
                    <div class="kpi-item"><div class="label">„Ç™„Éï„Ç°„ÉºÁéá</div><div class="value" id="kOffer">0%</div></div>
                    <div class="kpi-item"><div class="label">ÂãïÂì°Áç≤ÂæóÁéá</div><div class="value" id="kDoinGetRate">0%</div></div>
                    <div class="kpi-item"><div class="label">ÂãïÂì°ÂÆüÊñΩÁéá</div><div class="value" id="kDoinExecRate">0%</div></div>
                    <div class="kpi-item"><div class="label">ÊàêÁ¥ÑÁéá</div><div class="value" id="kSeiyakuRate">0%</div></div>
                </div>
            </div>

            <!-- ÁÑ°ÁùÄÂú∞ÂÜÖË®≥ -->
            <div class="section">
                <h2>ÁÑ°ÁùÄÂú∞ÂÜÖË®≥ <span id="sMuchakuTotal" style="font-size:14px;color:#94a3b8">(0‰ª∂)</span></h2>
                <div id="summaryMuchakuBreakdown" class="kpi-grid" style="grid-template-columns:repeat(auto-fit,minmax(100px,1fr))"></div>
            </div>

            <!-- NGÁêÜÁî±ÂÜÖË®≥ -->
            <div class="section">
                <h2>NGÁêÜÁî±ÂÜÖË®≥ <span id="sNgTotal" style="font-size:14px;color:#94a3b8">(0‰ª∂)</span> <button onclick="debugNgData()" style="font-size:10px;padding:2px 6px;background:#ef4444;border:none;color:white;border-radius:4px;cursor:pointer">„Éá„Éê„ÉÉ„Ç∞</button></h2>
                <div id="summaryNgBreakdown" class="kpi-grid" style="grid-template-columns:repeat(auto-fit,minmax(120px,1fr))"></div>
            </div>

            <!-- ÊÆãÊ°à‰ª∂„ÉªÂãïÂì°„Ç≠„É£„É≥„Çª„É´„ÉªÂãïÂì°ÂæåÁÑ°ÁùÄÂú∞ÔºàÂÖ•Âäõ„Éï„Ç©„Éº„É†Ôºâ -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:16px;margin-bottom:16px">
                <div class="section" style="margin-bottom:0">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                        <h2>ÊÆãÊ°à‰ª∂ <span id="sCasesCount" style="font-size:14px;color:#94a3b8">(0‰ª∂)</span></h2>
                        <button class="btn btn-primary btn-sm" onclick="addCase()">+ ËøΩÂä†</button>
                    </div>
                    <div id="caseList" style="max-height:200px;overflow-y:auto"></div>
                </div>
                <div class="section" style="margin-bottom:0">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                        <h2>ÂãïÂì°„Ç≠„É£„É≥„Çª„É´ <span id="sCancelsCount" style="font-size:14px;color:#94a3b8">(0‰ª∂)</span></h2>
                        <button class="btn btn-primary btn-sm" onclick="addCancel()">+ ËøΩÂä†</button>
                    </div>
                    <div id="cancelList" style="max-height:200px;overflow-y:auto"></div>
                </div>
            </div>

            <div class="section">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <h2>ÂãïÂì°ÂæåÁÑ°ÁùÄÂú∞ <span id="sDoinMuchakuLabel" style="font-size:14px;color:#94a3b8"></span></h2>
                    <button class="btn btn-primary btn-sm" onclick="addDoinMuchaku()">+ ËøΩÂä†</button>
                </div>
                <div id="doinMuchakuList" style="max-height:250px;overflow-y:auto"></div>
            </div>

            <div class="section">
                <h2>„É°„É≥„Éê„ÉºÂà•„Çµ„Éû„É™„Éº</h2>
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th>ÂêçÂâç</th>
                                <th>ÊäïÁ®ø</th>
                                <th>„Ç¢„ÉùÁç≤Âæó</th>
                                <th>„Ç¢„ÉùÂÆüÊñΩ</th>
                                <th>CXL</th>
                                <th>„ÉÜ„Çπ„ÇØ„É≠</th>
                                <th>„Ç™„Éï„Ç°„Éº</th>
                                <th>NG</th>
                                <th>ÁÑ°ÁùÄÂú∞</th>
                                <th>ÂãïÂì°Áç≤</th>
                                <th>ÂãïÂì°ÂÆü</th>
                                <th>Èù¢Ë´áÁç≤</th>
                                <th>Èù¢Ë´áÂÆü</th>
                                <th>ÊàêÁ¥Ñ</th>
                            </tr>
                        </thead>
                        <tbody id="memberTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Êó•Âà•Êï∞Â≠ó„Çø„Éñ -->
        <div id="tab-daily" class="tab-content">
            <div class="section">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px">
                    <h2>Êó•Âà•ÂÖ•Âäõ</h2>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        <button class="btn btn-secondary btn-sm" onclick="exportDailyCsv()">CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('dailyCsvImport').click()">CSV„Ç§„É≥„Éù„Éº„Éà</button>
                        <input type="file" id="dailyCsvImport" accept=".csv" style="display:none" onchange="importDailyCsv(event)">
                        <button class="btn btn-primary btn-sm" onclick="document.getElementById('monthCsvImport').click()">ÊúàÈñìCSVÂèñËæº</button>
                        <input type="file" id="monthCsvImport" accept=".csv" style="display:none" onchange="importMonthCsv(event)">
                    </div>
                </div>
                <div class="table-scroll" style="max-height:none">
                    <div id="dailyInputArea"></div>
                </div>
            </div>
        </div>

        <!-- Êó•Â†±„Çø„Éñ -->
        <div id="tab-nippo" class="tab-content">
            <div class="section">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px">
                    <h2>Êó•Â†±Ôºà„Ç§„É≥„Éó„ÉÉ„ÉàÂãïÁîª + „Ç¢„Ç¶„Éà„Éó„ÉÉ„Éà + ÊÑüË¨ùÊó•Ë®òÔºâ</h2>
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                        <div class="week-tabs" id="weekTabs"></div>
                        <p style="font-size:12px;color:#94a3b8;margin:0">‚Äª ‰∏äÈÉ®„ÅÆ„É°„É≥„Éê„ÉºÈÅ∏Êäû„ÅßË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà</p>
                    </div>
                </div>
                <div style="margin-bottom:16px;display:flex;gap:8px;flex-wrap:wrap">
                    <button class="btn btn-primary btn-sm" onclick="openVideoUploadModal()">ÂãïÁîª„Çí‰∏ÄÊã¨„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÔºà1„É∂ÊúàÂàÜÔºâ</button>
                    <button class="btn btn-primary btn-sm" onclick="document.getElementById('videoCsvImport').click()">ÂãïÁîªCSV„Ç§„É≥„Éù„Éº„Éà</button>
                    <input type="file" id="videoCsvImport" accept=".csv" style="display:none" onchange="importVideoCsv(event)">
                    <button class="btn btn-secondary btn-sm" onclick="exportNippoCsv()">CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                    <button class="btn btn-secondary btn-sm" onclick="document.getElementById('nippoCsvImport').click()">CSV„Ç§„É≥„Éù„Éº„Éà</button>
                    <input type="file" id="nippoCsvImport" accept=".csv" style="display:none" onchange="importNippoCsv(event)">
                </div>
                <div id="nippoContent"></div>
            </div>
        </div>

        <!-- ÊñΩÁ≠ñ„Ç∑„Éº„Éà„Çø„Éñ -->
        <div id="tab-review" class="tab-content">
            <div style="display:grid;grid-template-columns:350px 1fr;gap:16px;align-items:start">
                <!-- Â∑¶ÂÅ¥Ôºö„Çµ„Éû„É™„ÉºÊÉÖÂ†±ÔºàÂõ∫ÂÆöÔºâ -->
                <div style="position:sticky;top:16px;max-height:calc(100vh - 120px);overflow-y:auto">
                    <div class="section" style="margin-bottom:12px;background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);border:1px solid #6366f1">
                        <h2 style="font-size:14px;margin-bottom:12px">Êï∞Â≠ó„Çµ„Éû„É™„Éº</h2>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
                            <div class="summary-card" style="padding:8px">
                                <h4 style="font-size:9px">ÊäïÁ®øÊï∞</h4>
                                <div class="value" id="rsPost" style="font-size:16px">0</div>
                                <div class="sub" style="font-size:9px">ÁõÆÊ®ô: <span id="rsPostGoal">0</span> <span class="rate" id="rsPostRate" style="font-size:10px"></span></div>
                                <div class="progress-bar" style="height:3px"><div class="fill" id="rsPostBar"></div></div>
                            </div>
                            <div class="summary-card" style="padding:8px">
                                <h4 style="font-size:9px">„Ç¢„ÉùÁç≤Âæó</h4>
                                <div class="value" id="rsApoGet" style="font-size:16px">0</div>
                                <div class="sub" style="font-size:9px">ÁõÆÊ®ô: <span id="rsApoGetGoal">0</span> <span class="rate" id="rsApoGetRate" style="font-size:10px"></span></div>
                                <div class="progress-bar" style="height:3px"><div class="fill" id="rsApoGetBar"></div></div>
                            </div>
                            <div class="summary-card" style="padding:8px">
                                <h4 style="font-size:9px">„Ç¢„ÉùÂÆüÊñΩ</h4>
                                <div class="value" id="rsApoExec" style="font-size:16px">0</div>
                                <div class="sub" style="font-size:9px">ÁõÆÊ®ô: <span id="rsApoExecGoal">0</span> <span class="rate" id="rsApoExecRate" style="font-size:10px"></span></div>
                                <div class="progress-bar" style="height:3px"><div class="fill" id="rsApoExecBar"></div></div>
                            </div>
                            <div class="summary-card" style="padding:8px">
                                <h4 style="font-size:9px">ÂãïÂì°Áç≤Âæó</h4>
                                <div class="value" id="rsDoinGet" style="font-size:16px">0</div>
                                <div class="sub" style="font-size:9px">ÁõÆÊ®ô: <span id="rsDoinGetGoal">0</span> <span class="rate" id="rsDoinGetRate" style="font-size:10px"></span></div>
                                <div class="progress-bar" style="height:3px"><div class="fill" id="rsDoinGetBar"></div></div>
                            </div>
                            <div class="summary-card" style="padding:8px">
                                <h4 style="font-size:9px">ÂãïÂì°ÂÆüÊñΩ</h4>
                                <div class="value" id="rsDoinExec" style="font-size:16px">0</div>
                                <div class="sub" style="font-size:9px">ÁõÆÊ®ô: <span id="rsDoinExecGoal">0</span> <span class="rate" id="rsDoinExecRate" style="font-size:10px"></span></div>
                                <div class="progress-bar" style="height:3px"><div class="fill" id="rsDoinExecBar"></div></div>
                            </div>
                            <div class="summary-card" style="padding:8px">
                                <h4 style="font-size:9px">Èù¢Ë´áÁç≤Âæó</h4>
                                <div class="value" id="rsMendanGet" style="font-size:16px">0</div>
                                <div class="sub" style="font-size:9px">ÁõÆÊ®ô: <span id="rsMendanGetGoal">0</span> <span class="rate" id="rsMendanGetRate" style="font-size:10px"></span></div>
                                <div class="progress-bar" style="height:3px"><div class="fill" id="rsMendanGetBar"></div></div>
                            </div>
                            <div class="summary-card" style="padding:8px">
                                <h4 style="font-size:9px">Èù¢Ë´áÂÆüÊñΩ</h4>
                                <div class="value" id="rsMendanExec" style="font-size:16px">0</div>
                                <div class="sub" style="font-size:9px">ÁõÆÊ®ô: <span id="rsMendanExecGoal">0</span> <span class="rate" id="rsMendanExecRate" style="font-size:10px"></span></div>
                                <div class="progress-bar" style="height:3px"><div class="fill" id="rsMendanExecBar"></div></div>
                            </div>
                            <div class="summary-card" style="padding:8px">
                                <h4 style="font-size:9px">ÊàêÁ¥Ñ</h4>
                                <div class="value" id="rsSeiyaku" style="font-size:16px">0</div>
                                <div class="sub" style="font-size:9px">ÁõÆÊ®ô: <span id="rsSeiyakuGoal">0</span> <span class="rate" id="rsSeiyakuRate" style="font-size:10px"></span></div>
                                <div class="progress-bar" style="height:3px"><div class="fill" id="rsSeiyakuBar"></div></div>
                            </div>
                        </div>
                        <div class="kpi-grid" style="grid-template-columns:repeat(2,1fr);gap:6px">
                            <div class="kpi-item" style="padding:6px"><div class="label" style="font-size:8px">ÁÑ°ÁùÄÂú∞Áéá</div><div class="value" id="rsMuchaku" style="font-size:13px">0%</div></div>
                            <div class="kpi-item" style="padding:6px"><div class="label" style="font-size:8px">NGÁéá</div><div class="value" id="rsNg" style="font-size:13px">0%</div></div>
                            <div class="kpi-item" style="padding:6px"><div class="label" style="font-size:8px">„ÉÜ„Çπ„ÇØ„É≠Áéá</div><div class="value" id="rsTestClose" style="font-size:13px">0%</div></div>
                            <div class="kpi-item" style="padding:6px"><div class="label" style="font-size:8px">„Ç™„Éï„Ç°„ÉºÁéá</div><div class="value" id="rsOffer" style="font-size:13px">0%</div></div>
                            <div class="kpi-item" style="padding:6px"><div class="label" style="font-size:8px">ÂãïÂì°Áéá</div><div class="value" id="rsDoinRate" style="font-size:13px">0%</div></div>
                            <div class="kpi-item" style="padding:6px"><div class="label" style="font-size:8px">ÊàêÁ¥ÑÁéá</div><div class="value" id="rsSeiyakuRate" style="font-size:13px">0%</div></div>
                        </div>
                    </div>

                    <!-- „Çµ„Ç§„Éâ„Éê„ÉºÁî®„Ç∞„É©„Éï -->
                    <div class="section" style="margin-bottom:12px;padding:12px">
                        <h2 style="font-size:13px;margin-bottom:8px">ÈÄ≤Êçó„Ç∞„É©„Éï</h2>
                        <div id="reviewChartsGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px"></div>
                    </div>

                    <div class="section" style="margin-bottom:12px;padding:12px">
                        <h2 style="font-size:13px;margin-bottom:8px">ÁÑ°ÁùÄÂú∞ÂÜÖË®≥ <span id="rsMuchakuTotal" style="font-size:11px;color:#94a3b8"></span></h2>
                        <div id="rsMuchakuBreakdown" style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:11px;margin-bottom:10px"></div>
                        <div style="background:#0f172a;border-radius:6px;padding:8px;border-left:3px solid #eab308">
                            <div style="font-size:10px;color:#eab308;margin-bottom:4px">ÊúÄÂ§öÁêÜÁî±: <strong id="rsTopReason">-</strong></div>
                            <div style="font-size:10px;color:#94a3b8;margin-bottom:4px">ÂØæÁ≠ñ:</div>
                            <textarea id="rsTopReasonAction" placeholder="„Åì„ÅÆÁêÜÁî±„Å´ÂØæ„Åô„ÇãÂØæÁ≠ñ..." style="width:100%;height:50px;font-size:11px;resize:none" onchange="saveTopReasonAction()"></textarea>
                        </div>
                    </div>

                    <div class="section" style="margin-bottom:12px;padding:12px">
                        <h2 style="font-size:13px;margin-bottom:8px">NGÁêÜÁî±ÂÜÖË®≥ <span id="rsNgTotal" style="font-size:11px;color:#94a3b8"></span></h2>
                        <div id="rsNgBreakdown" style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:11px"></div>
                    </div>

                    <div class="section" style="margin-bottom:12px;padding:12px">
                        <h2 style="font-size:13px;margin-bottom:8px">ÊÆãÊ°à‰ª∂ <span id="rsCasesCount" style="font-size:11px;color:#94a3b8"></span></h2>
                        <div id="rsCasesList" style="max-height:100px;overflow-y:auto;font-size:11px"></div>
                    </div>

                    <div class="section" style="margin-bottom:12px;padding:12px">
                        <h2 style="font-size:13px;margin-bottom:8px">ÂãïÂì°„Ç≠„É£„É≥„Çª„É´ <span id="rsCancelsCount" style="font-size:11px;color:#94a3b8"></span></h2>
                        <div id="rsCancelsList" style="max-height:100px;overflow-y:auto;font-size:11px"></div>
                    </div>

                    <div class="section" style="padding:12px">
                        <h2 style="font-size:13px;margin-bottom:8px">ÂãïÂì°ÂæåÁÑ°ÁùÄÂú∞ <span id="rsDoinMuchakuCount" style="font-size:11px;color:#94a3b8"></span></h2>
                        <div id="rsDoinMuchakuList" style="max-height:100px;overflow-y:auto;font-size:11px"></div>
                    </div>
                </div>

                <!-- Âè≥ÂÅ¥ÔºöÂÖ•Âäõ„Éï„Ç©„Éº„É† -->
                <div>
                    <div class="section">
                        <h2>1Áï™„ÅÆÊï∞Â≠óË™≤È°å</h2>
                        <div class="issue-box">
                            <label>Êï∞Â≠óË™≤È°å</label>
                            <input type="text" id="mainIssue" placeholder="‰æã: ÂãïÂì°Áõ¥„ÇØ„É≠Áç≤Âæó„Å´Èñ¢„Åó„Å¶„ÄÅÊó•‰∫àÁÆó„Å´ÂØæ„Åô„ÇãÊó•ÁµêÊûú„ÅÆÈÅîÊàêÁéá„Åå25%„Å®‰Ωé„ÅÑ" onchange="saveReview()">
                        </div>
                        <div class="issue-box cause">
                            <label>ÂéüÂõ†</label>
                            <input type="text" id="mainCause" placeholder="‰æã: „ÉÜ„Çπ„ÇØ„É≠ÁéáÔºö40%„ÄÅ„Ç™„Éï„Ç°„ÉºÁéá9%„Å®‰Ωé„ÅÑ" onchange="saveReview()">
                        </div>
                    </div>

                    <div class="section">
                        <h2>1Áï™„ÅÆÂéüÂõ†5„Å§„Å®ÊñΩÁ≠ñÔºà1Áï™„Å´ÈªÑËâ≤Ôºâ</h2>
                        <div id="causeActionList"></div>
                    </div>
                </div><!-- Âè≥ÂÅ¥ÁµÇ‰∫Ü -->
            </div><!-- „Ç∞„É™„ÉÉ„ÉâÁµÇ‰∫Ü -->
        </div><!-- ÊñΩÁ≠ñ„Ç∑„Éº„Éà„Çø„ÉñÁµÇ‰∫Ü -->

        <!-- „Ç§„É≥„Çπ„Çø„Çø„Éñ -->
        <div id="tab-instagram" class="tab-content">
            <!-- „Ç¢„Ç´„Ç¶„É≥„ÉàÈÅ∏Êäû -->
            <div class="section" style="padding: 12px 16px; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <label style="font-size: 14px; font-weight: 600;">ÂàÜÊûêÂØæË±°:</label>
                        <select id="igAccountSelect" onchange="changeIgAccount()" style="min-width: 200px; padding: 8px 12px;">
                            <option value="all">ÂÖ®„Ç¢„Ç´„Ç¶„É≥„ÉàÂêàË®à</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="exportInstagramCSV()">üìä CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                </div>
            </div>
            <!-- „Çµ„Éû„É™„Éº„Ç´„Éº„Éâ -->
            <div class="summary-grid">
                <div class="summary-card">
                    <h4>DMÈÄÅ‰ø°Êï∞</h4>
                    <div class="value" id="igSend">0</div>
                    <div class="sub">ÁõÆÊ®ô: <span id="igSendGoal">0</span></div>
                    <div class="rate" id="igSendRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="igSendBar"></div></div>
                </div>
                <div class="summary-card">
                    <h4>DMËøî‰ø°Êï∞</h4>
                    <div class="value" id="igReply">0</div>
                    <div class="sub">ÁõÆÊ®ô: <span id="igReplyGoal">0</span></div>
                    <div class="rate" id="igReplyRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="igReplyBar"></div></div>
                </div>
                <div class="summary-card">
                    <h4>„Ç™„Éï„Ç°„ÉºÊï∞</h4>
                    <div class="value" id="igOffer">0</div>
                    <div class="sub">ÁõÆÊ®ô: <span id="igOfferGoal">0</span></div>
                    <div class="rate" id="igOfferRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="igOfferBar"></div></div>
                </div>
                <div class="summary-card">
                    <h4>„Ç¢„ÉùÁç≤Âæó</h4>
                    <div class="value" id="igApoGet">0</div>
                    <div class="sub">ÁõÆÊ®ô: <span id="igApoGetGoal">0</span></div>
                    <div class="rate" id="igApoGetRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="igApoGetBar"></div></div>
                </div>
                <div class="summary-card">
                    <h4>„Ç¢„ÉùÂÆüÊñΩ</h4>
                    <div class="value" id="igApoExec">0</div>
                    <div class="sub">ÁõÆÊ®ô: <span id="igApoExecGoal">0</span></div>
                    <div class="rate" id="igApoExecRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="igApoExecBar"></div></div>
                </div>
                <div class="summary-card">
                    <h4>ÂãïÂì°ÂÆüÊñΩ</h4>
                    <div class="value" id="igDoinExec">0</div>
                    <div class="sub">ÁõÆÊ®ô: <span id="igDoinExecGoal">0</span></div>
                    <div class="rate" id="igDoinExecRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="igDoinExecBar"></div></div>
                </div>
                <div class="summary-card">
                    <h4>ÊàêÁ¥Ñ</h4>
                    <div class="value" id="igSeiyaku">0</div>
                    <div class="sub">ÁõÆÊ®ô: <span id="igSeiyakuGoal">0</span></div>
                    <div class="rate" id="igSeiyakuRate">0%</div>
                    <div class="progress-bar"><div class="fill" id="igSeiyakuBar"></div></div>
                </div>
            </div>

            <!-- ÈÄ≤Êçó„Ç∞„É©„Éï -->
            <div class="section">
                <h2>ÈÄ≤Êçó„Ç∞„É©„Éï</h2>
                <div class="charts-grid" id="igChartsGrid"></div>
            </div>

            <!-- KPI„Éª„Éï„Ç°„Éç„É´ÂàÜÊûê -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                <div class="section">
                    <h2>Á¢∫Ë™çÊï∞Â≠óÔºàËá™ÂãïË®àÁÆóÔºâ</h2>
                    <div class="kpi-grid" style="grid-template-columns:1fr 1fr">
                        <div class="kpi-item"><div class="label">Ëøî‰ø°Áéá</div><div class="value" id="igKpiReply">0%</div></div>
                        <div class="kpi-item"><div class="label">„Ç™„Éï„Ç°„ÉºÂà∞ÈÅîÁéá</div><div class="value" id="igKpiOfferReach">0%</div></div>
                        <div class="kpi-item"><div class="label">„Ç™„Éï„Ç°„ÉºÈÄöÈÅéÁéá</div><div class="value" id="igKpiOfferPass">0%</div></div>
                        <div class="kpi-item"><div class="label">„Ç¢„ÉùÁç≤ÂæóÁéá</div><div class="value" id="igKpiApoGet">0%</div></div>
                        <div class="kpi-item"><div class="label">„Ç¢„ÉùÂÆüÊñΩÁéá</div><div class="value" id="igKpiApoExec">0%</div></div>
                        <div class="kpi-item"><div class="label">ÂãïÂì°Áéá</div><div class="value" id="igKpiDoin">0%</div></div>
                        <div class="kpi-item"><div class="label">ÊàêÁ¥ÑÁéá</div><div class="value" id="igKpiSeiyaku">0%</div></div>
                    </div>
                </div>

                <div class="section">
                    <h2>„Éï„Ç°„Éç„É´ÂàÜÊûê</h2>
                    <div id="igFunnel" style="display:flex;flex-direction:column;gap:4px"></div>
                </div>
            </div>

            <!-- „Ç¢„Ç´„Ç¶„É≥„ÉàÂà•„Çµ„Éû„É™„Éº -->
            <div class="section">
                <h2>„Ç¢„Ç´„Ç¶„É≥„ÉàÂà•„Çµ„Éû„É™„Éº</h2>
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th>„Ç¢„Ç´„Ç¶„É≥„Éà</th>
                                <th>DMÈÄÅ‰ø°</th>
                                <th>Ëøî‰ø°</th>
                                <th>„Ç™„Éï„Ç°„Éº</th>
                                <th>„Ç¢„ÉùÁç≤</th>
                                <th>„Ç¢„ÉùÂÆü</th>
                                <th>ÂãïÂì°</th>
                                <th>ÊàêÁ¥Ñ</th>
                                <th>Ëøî‰ø°Áéá</th>
                                <th>ÊàêÁ¥ÑÁéá</th>
                            </tr>
                        </thead>
                        <tbody id="igAccountSummaryTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- „Ç¢„Ç´„Ç¶„É≥„ÉàÂà•„Éá„Éº„ÇøÂÖ•Âäõ -->
            <div class="section">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                    <h2>„Ç¢„Ç´„Ç¶„É≥„ÉàÂà•„Éá„Éº„ÇøÂÖ•Âäõ</h2>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn-sm" onclick="document.getElementById('igCsvImport').click()" style="background:#059669">üì• CSV„Ç§„É≥„Éù„Éº„Éà</button>
                        <input type="file" id="igCsvImport" accept=".csv" style="display:none" onchange="importInstagramCsv(this.files[0])">
                        <button class="btn btn-primary btn-sm" onclick="addAccount()">+ „Ç¢„Ç´„Ç¶„É≥„ÉàËøΩÂä†</button>
                    </div>
                </div>
                <div id="accountList"></div>
            </div>
        </div>

        <!-- Ë®≠ÂÆö„Çø„Éñ -->
        <div id="tab-settings" class="tab-content">
            <div class="setup-guide" id="setupGuide">
                <h3>üî• Firebase „ÇØ„É©„Ç¶„ÉâÂêåÊúü</h3>
                <p style="margin-bottom:12px">„Éá„Éº„Çø„ÅØËá™ÂãïÁöÑ„Å´Firebase„Å´‰øùÂ≠ò„ÉªÂêåÊúü„Åï„Çå„Åæ„Åô„ÄÇ</p>
                <div id="firebaseStatus" style="padding:12px;background:#1e3a2f;border-radius:8px;margin-top:12px">
                    <div style="display:flex;align-items:center;gap:8px">
                        <span style="color:#22c55e">‚óè</span>
                        <span>FirebaseÊé•Á∂ö‰∏≠...</span>
                    </div>
                </div>
            </div>

            <div class="section" style="background:#1e293b;border:2px solid #3b82f6;padding:20px;border-radius:12px">
                <h2 style="color:#3b82f6">üë§ „É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±</h2>
                <div id="authInfoDisplay" style="margin-top:12px">
                    <div style="display:grid;grid-template-columns:100px 1fr;gap:8px;font-size:14px">
                        <span style="color:#94a3b8">„É¶„Éº„Ç∂„ÉºÂêç:</span>
                        <span id="settingsUserName" style="color:#e2e8f0;font-weight:600"></span>
                        <span style="color:#94a3b8">„É°„Éº„É´:</span>
                        <span id="settingsUserEmail" style="color:#e2e8f0"></span>
                        <span style="color:#94a3b8">Ê®©Èôê:</span>
                        <span id="settingsUserRole" style="color:#e2e8f0"></span>
                    </div>
                </div>
                <!-- ÁÆ°ÁêÜËÄÖ„É°„Éã„É•„Éº -->
                <div id="adminMenu" style="display:none;margin-top:16px;padding:16px;background:#0f172a;border-radius:8px;border:1px solid #334155">
                    <h3 style="color:#f59e0b;font-size:14px;margin-bottom:12px">ÁÆ°ÁêÜËÄÖ„É°„Éã„É•„Éº</h3>
                    <div id="userMapList" style="margin-bottom:12px"></div>
                    <button class="btn" style="background:#f59e0b;color:#000;font-size:12px;margin-right:8px" onclick="renderUserMapAdmin()">„É¶„Éº„Ç∂„ÉºÁ¥ê‰ªò„Åë‰∏ÄË¶ß„ÇíÊõ¥Êñ∞</button>
                    <button class="btn" style="background:#6366f1;font-size:12px;margin-right:8px" onclick="showRelinkForm()">Ëá™ÂàÜ„ÅÆ„É°„É≥„Éê„Éº„ÇíÂÜçÁ¥ê‰ªò„Åë</button>
                    <div id="relinkForm" style="display:none;margin-top:12px;padding:12px;background:#1e293b;border-radius:8px">
                        <label style="font-size:13px;color:#94a3b8">Á¥ê‰ªò„Åë„Çã„É°„É≥„Éê„Éº„ÇíÈÅ∏Êäû:</label>
                        <select id="relinkSelect" style="width:100%;padding:8px;margin:8px 0;background:#0f172a;border:1px solid #334155;color:#e2e8f0;border-radius:6px"></select>
                        <button class="btn" style="background:#22c55e;font-size:12px" onclick="relinkMember()">Á¥ê‰ªò„Åë„ÇíÊõ¥Êñ∞</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>„É°„É≥„Éê„ÉºÁÆ°ÁêÜ</h2>
                <div id="memberList" style="margin-top:12px"></div>
                <button class="btn btn-primary" style="margin-top:12px" onclick="openModal('memberModal')">+ „É°„É≥„Éê„ÉºËøΩÂä†</button>
            </div>

            <div class="section">
                <h2>„É°„É≥„Éê„ÉºÂà• ÊúàÈñì‰∫àÁÆó„ÉªÁõÆÊ®ôË®≠ÂÆö</h2>
                <p style="font-size:12px;color:#94a3b8;margin-bottom:12px" id="settingsHint">‚Äª ‰∏äÈÉ®„ÅÆ„É°„É≥„Éê„ÉºÈÅ∏Êäû„ÅßË®≠ÂÆöÂØæË±°„ÇíÂàá„ÇäÊõø„Åà„Çâ„Çå„Åæ„Åô</p>
                <button class="btn" style="background:#6366f1;margin-bottom:12px;font-size:11px" onclick="debugShowSettings()">üîç „Éá„Éê„ÉÉ„Ç∞: „Éá„Éº„ÇøÁ¢∫Ë™ç</button>

                <div id="settingsEditableArea">
                    <h3 style="font-size:14px;color:#94a3b8;margin-bottom:8px">ÊúàÈñì‰∫àÁÆó</h3>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:8px">
                        <div class="form-group"><label>ÂøÖË¶ÅÊäïÁ®øÊï∞</label><input type="number" id="bPost" onchange="saveSettings()"></div>
                        <div class="form-group"><label>„Ç¢„ÉùÁç≤Âæó</label><input type="number" id="bApoGet" onchange="saveSettings()"></div>
                        <div class="form-group"><label>„Ç¢„ÉùÂÆüÊñΩ</label><input type="number" id="bApoExec" onchange="saveSettings()"></div>
                        <div class="form-group"><label>ÂãïÂì°Áõ¥„ÇØ„É≠Áç≤Âæó</label><input type="number" id="bDoinGet" onchange="saveSettings()"></div>
                        <div class="form-group"><label>ÂãïÂì°Áõ¥„ÇØ„É≠ÂÆüÊñΩ</label><input type="number" id="bDoinExec" onchange="saveSettings()"></div>
                        <div class="form-group"><label>Èù¢Ë´áÁç≤Âæó</label><input type="number" id="bMendan" onchange="saveSettings()"></div>
                        <div class="form-group"><label>ÊàêÁ¥Ñ</label><input type="number" id="bSeiyaku" onchange="saveSettings()"></div>
                    </div>
                    <div style="margin-bottom:16px">
                        <button class="btn" style="background:#3b82f6;font-size:12px" onclick="autoCalcGoals()">‰∫àÁÆó„Åã„ÇâËá™ÂãïË®àÁÆó (x1.2)</button>
                        <span style="font-size:11px;color:#64748b;margin-left:8px">‰∫àÁÆó x 1.2 „ÇíÁõÆÊ®ô„Å´Ëá™ÂãïË®≠ÂÆöÔºàÂ∞èÊï∞ÁÇπ„ÅØÂàá„Çä‰∏ä„ÅíÔºâ</span>
                    </div>

                    <h3 style="font-size:14px;color:#94a3b8;margin-bottom:8px">ÊúàÈñìÁõÆÊ®ô</h3>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
                        <div class="form-group"><label>ÂøÖË¶ÅÊäïÁ®øÊï∞</label><input type="number" id="mPost" onchange="saveSettings()"></div>
                        <div class="form-group"><label>„Ç¢„ÉùÁç≤Âæó</label><input type="number" id="mApoGet" onchange="saveSettings()"></div>
                        <div class="form-group"><label>„Ç¢„ÉùÂÆüÊñΩ</label><input type="number" id="mApoExec" onchange="saveSettings()"></div>
                        <div class="form-group"><label>ÂãïÂì°Áõ¥„ÇØ„É≠Áç≤Âæó</label><input type="number" id="mDoinGet" onchange="saveSettings()"></div>
                        <div class="form-group"><label>ÂãïÂì°Áõ¥„ÇØ„É≠ÂÆüÊñΩ</label><input type="number" id="mDoinExec" onchange="saveSettings()"></div>
                        <div class="form-group"><label>Èù¢Ë´áÁç≤Âæó</label><input type="number" id="mMendan" onchange="saveSettings()"></div>
                        <div class="form-group"><label>Èù¢Ë´áÂÆüÊñΩ</label><input type="number" id="mMendanExec" onchange="saveSettings()"></div>
                        <div class="form-group"><label>ÊàêÁ¥Ñ</label><input type="number" id="mSeiyaku" onchange="saveSettings()"></div>
                    </div>
                    <div style="margin-top:8px;margin-bottom:8px">
                        <button class="btn" style="background:#8b5cf6;font-size:12px" onclick="autoSetTargetsFromRatesUI()">ÈÅéÂéªÂÆüÁ∏æ„Åã„ÇâÁõÆÊ®ôËá™ÂãïË®≠ÂÆö</button>
                        <span style="font-size:11px;color:#64748b;margin-left:8px">ÈÅéÂéª2„É∂Êúà„ÅÆÂ§âÊèõÁéá„ÇíÂÖÉ„Å´ÈÄÜÁÆó</span>
                    </div>

                    <!-- ‰πñÈõ¢„ÉÅ„Çß„ÉÉ„ÇØË°®Á§∫„Ç®„É™„Ç¢ -->
                    <div id="ratesDivergenceWarnings" style="margin-top:8px"></div>
                </div>
            </div>

            <div class="section">
                <h2>„Ç§„É≥„Çπ„ÇøÊúàÈñìÁõÆÊ®ôË®≠ÂÆö</h2>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px">
                    <div class="form-group"><label>DMÈÄÅ‰ø°Êï∞</label><input type="number" id="igGoalSend" onchange="saveSettings()"></div>
                    <div class="form-group"><label>DMËøî‰ø°Êï∞</label><input type="number" id="igGoalReply" onchange="saveSettings()"></div>
                    <div class="form-group"><label>„Ç™„Éï„Ç°„ÉºÊï∞</label><input type="number" id="igGoalOffer" onchange="saveSettings()"></div>
                    <div class="form-group"><label>„Ç¢„ÉùÁç≤Âæó</label><input type="number" id="igGoalApoGet" onchange="saveSettings()"></div>
                    <div class="form-group"><label>„Ç¢„ÉùÂÆüÊñΩ</label><input type="number" id="igGoalApoExec" onchange="saveSettings()"></div>
                    <div class="form-group"><label>ÂãïÂì°ÂÆüÊñΩ</label><input type="number" id="igGoalDoinExec" onchange="saveSettings()"></div>
                    <div class="form-group"><label>ÊàêÁ¥Ñ</label><input type="number" id="igGoalSeiyaku" onchange="saveSettings()"></div>
                </div>
            </div>

            <div class="section">
                <h2>ÊúàÊú´„Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏Ë®òÈå≤</h2>
                <p style="font-size:12px;color:#94a3b8;margin-bottom:12px">ÁèæÂú®„ÅÆÂ§âÊèõÁéá„ÇíË®òÈå≤„Åó„ÄÅÊù•Êúà„ÅÆÁõÆÊ®ôËá™ÂãïË®≠ÂÆö„Å´‰ΩøÁî®„Åó„Åæ„Åô</p>
                <div id="monthlyRatesPreview" style="margin-bottom:12px"></div>
                <div style="display:flex;gap:10px;flex-wrap:wrap">
                    <button class="btn btn-primary" onclick="previewAndSaveMonthlyRates()">‰ªäÊúà„ÅÆÂÆüÁ∏æ„Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏„ÇíË®òÈå≤</button>
                    <button class="btn btn-secondary" onclick="showPastRatesHistory()">ÈÅéÂéª„ÅÆË®òÈå≤„ÇíÁ¢∫Ë™ç</button>
                </div>
                <div id="monthlyRatesSaveResult" style="margin-top:12px"></div>
                <div id="pastRatesHistory" style="margin-top:12px"></div>
                <!-- ÊúàÊú´Ëá™Âãï‰øùÂ≠ò„Éó„É≠„É≥„Éó„Éà -->
                <div id="monthEndRatePrompt" style="display:none;margin-top:12px;padding:12px;background:#78350f;border:1px solid #f59e0b;border-radius:8px">
                    <p style="color:#fbbf24;font-size:13px;font-weight:600">ÊúàÊú´„ÅåËøë„Å•„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÄÇ‰ªäÊúà„ÅÆÂÆüÁ∏æ„Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏„ÇíË®òÈå≤„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ</p>
                    <button class="btn" style="background:#f59e0b;color:#000;font-size:12px;margin-top:8px" onclick="previewAndSaveMonthlyRates()">‰ªä„Åô„ÅêË®òÈå≤</button>
                </div>
            </div>

            <div class="section">
                <h2>„Éá„Éº„ÇøÁÆ°ÁêÜ</h2>
                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
                    <button class="btn btn-secondary" onclick="exportData()">ÂÖ®„Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">„Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà</button>
                    <button class="btn btn-danger" onclick="clearData()">ÂÖ®„Éá„Éº„ÇøÂâäÈô§</button>
                    <button class="btn btn-danger" onclick="resetLocalOnly()">„É≠„Éº„Ç´„É´„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà</button>
                </div>
            </div>

            <div class="section">
                <h2>„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÁÆ°ÁêÜ</h2>
                <p style="font-size:12px;color:#94a3b8;margin-bottom:12px">„Ç§„É≥„Éù„Éº„ÉàÂâç„Éª1Êó•1Âõû„ÅÆËá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åå‰ΩúÊàê„Åï„Çå„Åæ„ÅôÔºàÊúÄÊñ∞20‰ª∂‰øùÊåÅÔºâ</p>
                <div style="display:flex;gap:10px;margin-bottom:12px">
                    <button class="btn btn-primary" onclick="createManualBackup()">‰ªä„Åô„Åê„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó</button>
                    <button class="btn btn-secondary" onclick="loadBackupList()">‰∏ÄË¶ß„ÇíÊõ¥Êñ∞</button>
                </div>
                <div id="backupList" style="max-height:400px;overflow-y:auto">
                    <p style="color:#64748b;font-size:13px">Ë™≠„ÅøËæº„Åø‰∏≠...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- „É°„É≥„Éê„ÉºËøΩÂä†„É¢„Éº„ÉÄ„É´ -->
    <div class="modal-overlay" id="memberModal">
        <div class="modal">
            <h3>„É°„É≥„Éê„ÉºËøΩÂä†</h3>
            <div class="form-group">
                <label>ÂêçÂâç</label>
                <input type="text" id="newMemberName">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('memberModal')">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="btn btn-primary" onclick="addMember()">ËøΩÂä†</button>
            </div>
        </div>
    </div>

    <!-- „Ç¢„Ç´„Ç¶„É≥„ÉàËøΩÂä†„É¢„Éº„ÉÄ„É´ -->
    <div class="modal-overlay" id="accountModal">
        <div class="modal">
            <h3>„Ç¢„Ç´„Ç¶„É≥„ÉàËøΩÂä†</h3>
            <div class="form-group">
                <label>„Ç¢„Ç´„Ç¶„É≥„ÉàÂêç</label>
                <input type="text" id="newAccountName" placeholder="‰æã: „ÇÜ„Çã„Ç§„ÉåÊ∏©Ê≥â">
            </div>
            <div class="form-group">
                <label>URLÔºà‰ªªÊÑèÔºâ</label>
                <input type="text" id="newAccountUrl" placeholder="https://instagram.com/...">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('accountModal')">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="btn btn-primary" onclick="saveNewAccount()">ËøΩÂä†</button>
            </div>
        </div>
    </div>

    <!-- ÂãïÁîª‰∏ÄÊã¨„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„É¢„Éº„ÉÄ„É´ -->
    <div class="modal-overlay" id="videoUploadModal">
        <div class="modal" style="max-width:700px">
            <h3>ÂãïÁîª„Çí‰∏ÄÊã¨„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÔºà1„É∂ÊúàÂàÜÔºâ</h3>
            <p style="margin-bottom:12px;color:#94a3b8;font-size:13px">ÂêÑÊó•„ÅÆ„Ç§„É≥„Éó„ÉÉ„ÉàÂãïÁîªURL„Çí„Åæ„Å®„ÇÅ„Å¶Ë®≠ÂÆö„Åß„Åç„Åæ„Åô„ÄÇ</p>
            <div id="videoUploadList" style="max-height:400px;overflow-y:auto"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('videoUploadModal')">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="btn btn-primary" onclick="saveVideoUrls()">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <!-- ÁÑ°ÁùÄÂú∞ÁêÜÁî±„É¢„Éº„ÉÄ„É´ -->
    <div class="modal-overlay" id="muchakuModal">
        <div class="modal" style="max-width:450px">
            <h3>ÁÑ°ÁùÄÂú∞„ÅÆÁêÜÁî± <span id="muchakuModalDate" style="font-size:14px;color:#94a3b8"></span></h3>
            <p style="margin-bottom:16px;color:#94a3b8;font-size:13px">Ë©≤ÂΩì„Åô„ÇãÁêÜÁî±„ÅÆ‰ª∂Êï∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            <div id="muchakuReasonInputs" style="display:grid;gap:8px"></div>
            <div class="form-group" style="margin-top:12px">
                <label>„Åù„ÅÆ‰ªñ„ÅÆË©≥Á¥∞Ôºà‰ªªÊÑèÔºâ</label>
                <input type="text" id="muchakuOtherNote" placeholder="„Åù„ÅÆ‰ªñ„ÅÆÂÖ∑‰ΩìÁöÑ„Å™ÁêÜÁî±...">
            </div>
            <div style="margin-top:12px;padding:10px;background:#0f172a;border-radius:6px;display:flex;justify-content:space-between">
                <span>ÂêàË®à</span>
                <span><strong id="muchakuReasonTotal">0</strong> / <span id="muchakuTargetCount">0</span></span>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('muchakuModal')">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="btn btn-primary" onclick="saveMuchakuReasons()">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <!-- NGÁêÜÁî±„É¢„Éº„ÉÄ„É´ -->
    <div class="modal-overlay" id="ngModal">
        <div class="modal" style="max-width:450px">
            <h3>NG„ÅÆÁêÜÁî± <span id="ngModalDate" style="font-size:14px;color:#94a3b8"></span></h3>
            <p style="margin-bottom:16px;color:#94a3b8;font-size:13px">Ë©≤ÂΩì„Åô„ÇãÁêÜÁî±„ÅÆ‰ª∂Êï∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            <div id="ngReasonInputs" style="display:grid;gap:8px"></div>
            <div class="form-group" style="margin-top:12px">
                <label>„Åù„ÅÆ‰ªñ„ÅÆË©≥Á¥∞Ôºà‰ªªÊÑèÔºâ</label>
                <input type="text" id="ngOtherNote" placeholder="„Åù„ÅÆ‰ªñ„ÅÆÂÖ∑‰ΩìÁöÑ„Å™ÁêÜÁî±...">
            </div>
            <div style="margin-top:12px;padding:10px;background:#0f172a;border-radius:6px;display:flex;justify-content:space-between">
                <span>ÂêàË®à</span>
                <span><strong id="ngReasonTotal">0</strong> / <span id="ngTargetCount">0</span></span>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('ngModal')">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="btn btn-primary" onclick="saveNgReasons()">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>


    <script>
        // „Éá„Éº„ÇøÊßãÈÄ†
        let data = {
            members: [],
            accounts: [],
            settings: {
                budget: { post: 56, apoGet: 50, apoExec: 46, doinGet: 7, doinExec: 4, mendan: 2, seiyaku: 1 },
                monthly: { post: 56, apoGet: 50, apoExec: 46, doinGet: 7, doinExec: 4, mendan: 2, seiyaku: 1 },
                currentUserId: null // ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„ÉºÔºà„É°„É≥„Éê„ÉºIDÔºâ
            },
            weeks: {},
            monthVideos: {},
            monthlyRates: {}, // „É°„É≥„Éê„ÉºÂà•„ÉªÊúàÂà•„ÅÆÂ§âÊèõÁéáË®òÈå≤ { [memberId]: { [YYYY-M]: { rates... } } }
            lastUpdated: null // „Çø„Ç§„É†„Çπ„Çø„É≥„ÉóÔºà„Éá„Éº„ÇøÊõ¥Êñ∞Ê§úÁü•Áî®Ôºâ
        };

        // ÁèæÂú®„ÅÆÊó•‰ªò„Åã„ÇâÈÄ±Áï™Âè∑„ÇíË®àÁÆóÔºàÂúüÊõúÂßã„Åæ„Çä„ÄÅ5ÈÄ±Âà∂Ôºâ
        function calculateCurrentWeek(date) {
            const day = date.getDate();
            // ÈÄ±1: 1-7, ÈÄ±2: 8-14, ÈÄ±3: 15-21, ÈÄ±4: 22-28, ÈÄ±5: 29-31
            return Math.min(Math.ceil(day / 7), 5);
        }

        // „Éö„Éº„Ç∏Áä∂ÊÖã„ÇílocalStorage„Åã„ÇâÂæ©ÂÖÉ
        const savedState = JSON.parse(localStorage.getItem('personalTrackerState') || '{}');
        const now = new Date();
        let currentYear = savedState.year || now.getFullYear();
        let currentMonth = savedState.month || (now.getMonth() + 1);
        let currentWeekNum = savedState.week || calculateCurrentWeek(now);
        let selectedMember = savedState.member || 'all';
        let selectedIgAccount = 'all'; // „Ç§„É≥„Çπ„ÇøÂàÜÊûêÁî®„ÅÆÈÅ∏Êäû„Ç¢„Ç´„Ç¶„É≥„Éà
        let syncStatus = 'local';
        let nippoViewMode = 'all'; // 'all' or 'single'
        let nippoSelectedMember = '';
        let viewPeriod = savedState.viewPeriod || 'week'; // 'week' or 'month'

        // Firebase Auth Èñ¢ÈÄ£
        let currentAuthUser = null;   // firebase.User
        let currentMemberId = null;   // auth„Åã„ÇâÂ∞éÂá∫„Åó„ÅümemberId
        let isAdmin = false;          // userMap„ÅÆisAdmin„Éï„É©„Ç∞
        let adminEditMode = false;    // ÁÆ°ÁêÜËÄÖÁ∑®ÈõÜ„É¢„Éº„ÉâON/OFF
        let userMap = {};             // teams/core/userMap „ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•

        // „Éö„Éº„Ç∏Áä∂ÊÖã„Çí‰øùÂ≠ò
        function savePageState() {
            localStorage.setItem('personalTrackerState', JSON.stringify({
                year: currentYear,
                month: currentMonth,
                week: currentWeekNum,
                member: selectedMember,
                viewPeriod: viewPeriod
            }));
        }

        // Êúà„Ç≠„Éº„ÇíÂèñÂæóÔºà‰æã: "2026-1"Ôºâ
        function getMonthKey() {
            return `${currentYear}-${currentMonth}`;
        }

        const metrics = [
            { cat: 'ÊäïÁ®ø', items: [
                { key: 'post', label: 'ÊäïÁ®øÊï∞' }
            ]},
            { cat: 'LINE', items: [
                { key: 'lineExchange', label: 'LINE‰∫§Êèõ' }
            ]},
            { cat: '„Ç¢„Éù', items: [
                { key: 'apoGet', label: 'Áç≤Âæó' },
                { key: 'apoExec', label: 'ÂÆüÊñΩÊï∞' },
                { key: 'apoCxl', label: 'CXL' },
                { key: 'testClose', label: '„ÉÜ„Çπ„ÇØ„É≠' },
                { key: 'offer', label: '„Ç™„Éï„Ç°„Éº' },
                { key: 'ng', label: 'NG' },
                { key: 'muchaku', label: 'ÁÑ°ÁùÄÂú∞' }
            ]},
            { cat: 'ÂãïÂì°', items: [
                { key: 'doinGet', label: 'ÂãïÂì°Áç≤Âæó' },
                { key: 'doinGetCxl', label: 'ÂãïÂì°Áç≤ÂæóÂæåCXL' },
                { key: 'doinExec', label: 'ÂãïÂì°ÂÆüÊñΩ' },
                { key: 'doinExecCxl', label: 'ÂãïÂì°ÂÆüÊñΩÂæåCXL' }
            ]},
            { cat: 'Èù¢Ë´á', items: [
                { key: 'mendanGet', label: 'Èù¢Ë´áÁç≤Âæó' },
                { key: 'mendanGetCxl', label: 'Èù¢Ë´áÁç≤ÂæóÂæåCXL' },
                { key: 'mendanExec', label: 'Èù¢Ë´áÂÆüÊñΩ' },
                { key: 'mendanExecCxl', label: 'Èù¢Ë´áÂÆüÊñΩÂæåCXL' }
            ]},
            { cat: 'ÊàêÁ¥Ñ', items: [
                { key: 'seiyaku', label: 'ÊàêÁ¥Ñ' },
                { key: 'coolingOff', label: '„ÇØ„Éº„É™„É≥„Ç∞„Ç™„Éï' }
            ]}
        ];

        const muchakuReasonLabels = ['„Åì„Å†„Çè„Çä„ÅåÂº∑„ÅÑ', 'Ê®™Êßç', 'ÂãßË™ò„Éñ„É≠„ÉÉ„ÇØ', '‰∏çÂÆâ„ÅåÂº∑„ÅÑ', '‰ªä„Åò„ÇÉ„Å™„ÅÑ', 'ÂÆåÂÖ®ÂâØÊ•≠„Éã„Éº„Ç∫', '„Åù„ÅÆ‰ªñ'];
        const ngReasonLabels = ['ÈáëÁ≠ñNG', 'Êó¢Â©öNG', 'ËÅ∑Ê•≠NG', '„Çπ„Çø„É≥„ÇπNG', 'Á≤æÁ•ûNG'];

        // ÂÆâÂÖ®„Å™ÈÖçÂàóÂêàË®àÔºàFirebase„Ååarray„Çíobject„Å´Â§âÊèõ„Åô„Çã„Ç±„Éº„Çπ„Å´ÂØæÂøúÔºâ
        function safeArraySum(arr) {
            if (!arr) return 0;
            if (Array.isArray(arr)) return arr.reduce((a, b) => a + (b || 0), 0);
            if (typeof arr === 'object') return Object.values(arr).reduce((a, b) => a + (b || 0), 0);
            return 0;
        }

        // Êúà„ÅÆÊúÄÂ§ßÈÄ±Áï™Âè∑„ÇíË®àÁÆóÔºàÂúüÊõúÂßã„Åæ„Çä„Ç™„Éï„Çª„ÉÉ„ÉàËÄÉÊÖÆÔºâ
        function getMaxWeekNum(year, month) {
            const daysInMonth = new Date(year, month, 0).getDate();
            const firstDay = new Date(year, month - 1, 1);
            const dow = (firstDay.getDay() + 1) % 7;
            return Math.ceil((daysInMonth + dow) / 7);
        }

        // „ÉÅ„Éº„É†„Éë„Çπ„ÉØ„Éº„ÉâÔºàÊñ∞Ë¶èÁôªÈå≤ÊôÇ„ÅÆ„Ç≤„Éº„ÉàÁî®Ôºâ
        const TEAM_PASSWORD = 'Cv6bL3yZ';

        // --- Firebase Auth Èñ¢Êï∞Áæ§ ---

        function showAuthError(msg) {
            const el = document.getElementById('authError');
            el.textContent = msg;
            el.style.display = 'block';
        }
        function hideAuthError() {
            document.getElementById('authError').style.display = 'none';
        }
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('memberLinkForm').style.display = 'none';
            document.getElementById('authLoading').style.display = 'none';
            hideAuthError();
        }
        function showSignupForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('memberLinkForm').style.display = 'none';
            document.getElementById('authLoading').style.display = 'none';
            hideAuthError();
        }
        function showAuthLoading() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('memberLinkForm').style.display = 'none';
            document.getElementById('authLoading').style.display = 'block';
            hideAuthError();
        }

        async function handleEmailLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) { showAuthError('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            hideAuthError();
            const btn = document.getElementById('loginBtn');
            btn.disabled = true; btn.textContent = '„É≠„Ç∞„Ç§„É≥‰∏≠...';
            try {
                await auth.signInWithEmailAndPassword(email, password);
                // onAuthStateChanged „ÅåÂá¶ÁêÜ„ÇíÂºï„ÅçÁ∂ô„Åê
            } catch (err) {
                console.error('„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº:', err);
                const msgs = {
                    'auth/user-not-found': '„Ç¢„Ç´„Ç¶„É≥„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì',
                    'auth/wrong-password': '„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì',
                    'auth/invalid-email': '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì',
                    'auth/too-many-requests': '„É≠„Ç∞„Ç§„É≥Ë©¶Ë°å„ÅåÂ§ö„Åô„Åé„Åæ„Åô„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åè„Å†„Åï„ÅÑ',
                    'auth/invalid-credential': '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åæ„Åü„ÅØ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì'
                };
                showAuthError(msgs[err.code] || '„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº: ' + err.message);
                btn.disabled = false; btn.textContent = '„É≠„Ç∞„Ç§„É≥';
            }
        }

        async function handleSignup() {
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const teamPw = document.getElementById('teamPasswordInput').value;
            if (!email || !password) { showAuthError('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            if (password.length < 6) { showAuthError('„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            if (teamPw !== TEAM_PASSWORD) { showAuthError('„ÉÅ„Éº„É†„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
            hideAuthError();
            const btn = document.getElementById('signupBtn');
            btn.disabled = true; btn.textContent = 'ÁôªÈå≤‰∏≠...';
            try {
                await auth.createUserWithEmailAndPassword(email, password);
                // onAuthStateChanged „ÅåÂá¶ÁêÜ„ÇíÂºï„ÅçÁ∂ô„Åê
            } catch (err) {
                console.error('Êñ∞Ë¶èÁôªÈå≤„Ç®„É©„Éº:', err);
                const msgs = {
                    'auth/email-already-in-use': '„Åì„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅØÊó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô',
                    'auth/invalid-email': '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì',
                    'auth/weak-password': '„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÂº±„Åô„Åé„Åæ„ÅôÔºà6ÊñáÂ≠ó‰ª•‰∏äÔºâ'
                };
                showAuthError(msgs[err.code] || 'ÁôªÈå≤„Ç®„É©„Éº: ' + err.message);
                btn.disabled = false; btn.textContent = 'Êñ∞Ë¶èÁôªÈå≤';
            }
        }

        async function handleLogout() {
            if (!confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü')) return;
            try {
                await auth.signOut();
                currentAuthUser = null;
                currentMemberId = null;
                isAdmin = false;
                adminEditMode = false;
                userMap = {};
                document.getElementById('mainContainer').style.display = 'none';
                document.getElementById('authModal').style.display = 'flex';
                showLoginForm();
            } catch (err) {
                console.error('„É≠„Ç∞„Ç¢„Ç¶„Éà„Ç®„É©„Éº:', err);
            }
        }

        async function loadUserMap() {
            try {
                const snapshot = await database.ref('teams/' + TEAM_ID + '/userMap').once('value');
                userMap = snapshot.val() || {};
                const uid = currentAuthUser.uid;
                if (userMap[uid]) {
                    currentMemberId = userMap[uid].memberId;
                    isAdmin = !!userMap[uid].isAdmin;
                    return true; // „Éû„ÉÉ„Éî„É≥„Ç∞„ÅÇ„Çä
                }
                return false; // „Éû„ÉÉ„Éî„É≥„Ç∞„Å™„Åó
            } catch (err) {
                console.error('userMapË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', err);
                return false;
            }
        }

        function showMemberLinkForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('authLoading').style.display = 'none';
            document.getElementById('memberLinkForm').style.display = 'block';
            hideAuthError();

            // Êó¢„Å´„Éû„ÉÉ„Éî„É≥„Ç∞„Åï„Çå„Å¶„ÅÑ„Çã„É°„É≥„Éê„ÉºID„ÇíÂèéÈõÜ
            const linkedMemberIds = new Set();
            for (const uid in userMap) {
                if (userMap[uid].memberId) linkedMemberIds.add(userMap[uid].memberId);
            }

            const select = document.getElementById('memberLinkSelect');
            select.innerHTML = '<option value="">-- „É°„É≥„Éê„Éº„ÇíÈÅ∏Êäû --</option>';
            data.members.forEach(m => {
                if (!linkedMemberIds.has(m.id)) {
                    select.innerHTML += `<option value="${m.id}">${m.name}</option>`;
                }
            });
            // „É™„É≥„ÇØÂèØËÉΩ„Å™„É°„É≥„Éê„Éº„Åå„Å™„ÅÑÂ†¥Âêà
            if (data.members.length === 0) {
                select.innerHTML += '<option value="" disabled>Ôºà„É°„É≥„Éê„Éº„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÁÆ°ÁêÜËÄÖ„Å´ÈÄ£Áµ°„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ</option>';
            } else if (select.options.length === 1) {
                select.innerHTML += '<option value="" disabled>ÔºàÂÖ®„É°„É≥„Éê„Éº„ÅåÁ¥ê‰ªò„ÅëÊ∏à„Åø„Åß„ÅôÔºâ</option>';
            }
        }

        async function linkMember() {
            let memberId = document.getElementById('memberLinkSelect').value;
            const newName = document.getElementById('newMemberNameInput').value.trim();

            // „Å©„Å°„Çâ„ÇÇÊú™ÂÖ•Âäõ„Å™„Çâ„Ç®„É©„Éº
            if (!memberId && !newName) { showAuthError('„É°„É≥„Éê„Éº„ÇíÈÅ∏Êäû„Åô„Çã„Åã„ÄÅÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            // ‰∏°ÊñπÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÊñ∞Ë¶èÂêçÂâç„ÇíÂÑ™ÂÖà
            if (newName) memberId = null;

            hideAuthError();
            const btn = document.getElementById('linkBtn');
            btn.disabled = true; btn.textContent = 'Ë®≠ÂÆö‰∏≠...';
            try {
                const uid = currentAuthUser.uid;

                // Êñ∞„Åó„ÅÑÂêçÂâç„ÅåÂÖ•Âäõ„Åï„Çå„ÅüÂ†¥Âêà„ÄÅ„É°„É≥„Éê„Éº„ÇíËá™ÂãïËøΩÂä†
                if (newName) {
                    memberId = 'mem_' + Date.now();
                    const newMember = { id: memberId, name: newName };
                    data.members.push(newMember);
                    // Firebase„Å´„É°„É≥„Éê„Éº„É™„Çπ„Éà„Çí‰øùÂ≠ò
                    await database.ref('teams/' + TEAM_ID + '/members').set(data.members);
                    console.log('Êñ∞„É°„É≥„Éê„ÉºËá™ÂãïËøΩÂä†:', newName, memberId);
                }

                // userMap„ÅåÁ©∫„Å™„ÇâÊúÄÂàù„ÅÆ„É¶„Éº„Ç∂„Éº ‚Üí Ëá™ÂãïAdmin
                const isFirstUser = Object.keys(userMap).length === 0;
                const entry = {
                    memberId: memberId,
                    email: currentAuthUser.email,
                    isAdmin: isFirstUser,
                    linkedAt: Date.now()
                };
                await database.ref('teams/' + TEAM_ID + '/userMap/' + uid).set(entry);
                userMap[uid] = entry;
                currentMemberId = memberId;
                isAdmin = isFirstUser;

                if (isFirstUser) {
                    console.log('üîë ÊúÄÂàù„ÅÆ„É¶„Éº„Ç∂„Éº„Å®„Åó„Å¶ÁÆ°ÁêÜËÄÖ„Å´Ë®≠ÂÆö„Åï„Çå„Åæ„Åó„Åü');
                }

                // „Ç¢„Éó„É™Ë°®Á§∫
                document.getElementById('authModal').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                updateHeaderUserInfo();
                await initApp();
            } catch (err) {
                console.error('„É°„É≥„Éê„ÉºÁ¥ê‰ªò„Åë„Ç®„É©„Éº:', err);
                showAuthError('Á¥ê‰ªò„Åë„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + err.message);
                btn.disabled = false; btn.textContent = 'ÈñãÂßã';
            }
        }

        function getCurrentMemberId() {
            return currentMemberId;
        }

        function canEditMember(memberId) {
            if (!currentMemberId) return false;
            if (adminEditMode && isAdmin) return true;
            return memberId === currentMemberId;
        }

        function toggleAdminEdit() {
            if (!isAdmin) return;
            adminEditMode = !adminEditMode;
            const btn = document.getElementById('headerAdminEditBtn');
            if (btn) {
                btn.textContent = 'ÁÆ°ÁêÜËÄÖÁ∑®ÈõÜ: ' + (adminEditMode ? 'ON' : 'OFF');
                btn.style.background = adminEditMode ? '#dc2626' : '#334155';
                btn.style.borderColor = adminEditMode ? '#ef4444' : '#475569';
            }
            renderAll();
        }

        function updateHeaderUserInfo() {
            const container = document.getElementById('headerUserInfo');
            if (!container) return;
            const memberName = data.members.find(m => m.id === currentMemberId)?.name || currentAuthUser?.email || '';
            document.getElementById('headerUserName').textContent = memberName;
            document.getElementById('headerAdminBadge').style.display = isAdmin ? 'inline' : 'none';
            document.getElementById('headerAdminEditBtn').style.display = isAdmin ? 'inline-block' : 'none';
            container.style.display = 'flex';
        }

        function setupAuthListener() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // „É≠„Ç∞„Ç§„É≥Ê∏à„Åø
                    currentAuthUser = user;
                    showAuthLoading();
                    loadData();
                    // Firebase„Åã„ÇâÊúÄÊñ∞„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶„Åã„Çâ„É°„É≥„Éê„ÉºÁ¥ê‰ªò„Åë„ÇíË°å„ÅÜ
                    try {
                        const snapshot = await database.ref('teams/' + TEAM_ID).once('value');
                        const fbData = snapshot.val();
                        if (fbData) {
                            if (fbData.members) {
                                data.members = Array.isArray(fbData.members) ? fbData.members : Object.values(fbData.members);
                            }
                            if (fbData.accounts) data.accounts = Array.isArray(fbData.accounts) ? fbData.accounts : Object.values(fbData.accounts);
                            if (fbData.settings) data.settings = fbData.settings;
                            if (fbData.weeks) data.weeks = fbData.weeks;
                            if (fbData.monthVideos) data.monthVideos = fbData.monthVideos;
                        }
                    } catch (e) {
                        console.error('ÂàùÂõû„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:', e);
                    }
                    const hasMapping = await loadUserMap();
                    if (hasMapping) {
                        // „Éû„ÉÉ„Éî„É≥„Ç∞„ÅÇ„Çä ‚Üí „Ç¢„Éó„É™Ë°®Á§∫
                        document.getElementById('authModal').style.display = 'none';
                        document.getElementById('mainContainer').style.display = 'block';
                        updateHeaderUserInfo();
                        await initApp();
                    } else {
                        // „Éû„ÉÉ„Éî„É≥„Ç∞„Å™„Åó ‚Üí „É°„É≥„Éê„ÉºÁ¥ê‰ªò„ÅëÁîªÈù¢
                        showMemberLinkForm();
                    }
                } else {
                    // Êú™„É≠„Ç∞„Ç§„É≥ ‚Üí „É≠„Ç∞„Ç§„É≥ÁîªÈù¢
                    currentAuthUser = null;
                    currentMemberId = null;
                    isAdmin = false;
                    adminEditMode = false;
                    document.getElementById('mainContainer').style.display = 'none';
                    document.getElementById('authModal').style.display = 'flex';
                    showLoginForm();
                }
            });
        }

        async function initApp() {
            // loadData()„ÅØsetupAuthListener„ÅßÊó¢„Å´ÂÆüË°åÊ∏à„Åø„ÄÇ„Åì„Åì„ÅßÂÜçÂ∫¶Âëº„Å∂„Å®Firebase„Éá„Éº„Çø„ÇílocalStorage„Åß‰∏äÊõ∏„Åç„Åó„Å¶„Åó„Åæ„ÅÜ
            setupFirebaseListener();
            updateWeekLabel();
            updateSyncStatus();
            renderAll();
            applySeasonalBackground();
            // „Ç¢„ÉùÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†ÔºàSupabaseÔºâ„Åã„ÇâÊÆãÊ°à‰ª∂„ÇíÂêåÊúü
            syncSupabaseCases();
        }

        function init() {
            setupAuthListener();
        }

        // Êàª„Çã„Éú„Çø„É≥„Åß„Éö„Éº„Ç∏„Å´Êàª„Å£„ÅüÊôÇ„ÅØÁâπ„Å´‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàonAuthStateChanged„ÅåÁÆ°ÁêÜÔºâ
        window.addEventListener('pageshow', function(event) {
            if (event.persisted && !currentAuthUser) {
                document.getElementById('authModal').style.display = 'flex';
                document.getElementById('mainContainer').style.display = 'none';
            }
        });

        function applySeasonalBackground() {
            // ÁèæÂú®„ÅÆÊúà„Å´Âü∫„Å•„ÅÑ„Å¶Â≠£ÁØÄ„ÅÆËÉåÊôØ„ÇíÈÅ©Áî®
            const month = currentMonth;
            document.body.className = `season-${month}`;

            // Êó¢Â≠ò„ÅÆË£ÖÈ£æ„ÇíÂâäÈô§
            document.querySelectorAll('.seasonal-deco, .seasonal-banner').forEach(el => el.remove());

            // Â≠£ÁØÄ„Éê„Éä„Éº„ÇíËøΩÂä†
            const banner = document.createElement('div');
            banner.className = 'seasonal-banner';
            document.body.appendChild(banner);

            // Êúà„Åî„Å®„ÅÆÁµµÊñáÂ≠ó„Å®ÈÖçÁΩÆ
            const seasonConfig = {
                1: { emojis: ['‚õÑ', '‚ùÑÔ∏è', 'üéç', '‚ú®', 'üå®Ô∏è'], name: 'ÂÜ¨' },
                2: { emojis: ['üíù', 'üíï', 'üç´', 'üíñ', 'üåπ'], name: '„Éê„É¨„É≥„Çø„Ç§„É≥' },
                3: { emojis: ['üå∏', 'üéé', 'üå∑', 'üêù', 'ü¶ã'], name: 'Êò•' },
                4: { emojis: ['üå∏', 'üå∑', 'üêù', 'ü¶ã', 'üåº'], name: 'Ê°ú' },
                5: { emojis: ['üåø', 'üçÉ', 'üåª', 'üå∫', 'üêû'], name: 'Êñ∞Á∑ë' },
                6: { emojis: ['‚òî', 'üê∏', 'üíß', 'üåßÔ∏è', '‚òÇÔ∏è'], name: 'Ê¢ÖÈõ®' },
                7: { emojis: ['üåä', 'üçâ', '‚õ±Ô∏è', 'üêö', 'ü¶Ä'], name: 'Â§è' },
                8: { emojis: ['üéÜ', 'üéá', 'üçß', 'üéê', 'üç®'], name: 'Â§èÁ•≠„Çä' },
                9: { emojis: ['üçÇ', 'üåæ', 'üéë', 'üçÅ', 'üå∞'], name: 'Áßã' },
                10: { emojis: ['üéÉ', 'üëª', 'ü¶á', 'üï∑Ô∏è', 'üç¨'], name: '„Éè„É≠„Ç¶„Ç£„É≥' },
                11: { emojis: ['üçÅ', 'üçÇ', 'ü¶É', 'üå∞', 'üçÑ'], name: 'Á¥ÖËëâ' },
                12: { emojis: ['üéÑ', '‚õÑ', 'üéÖ', 'üéÅ', '‚≠ê'], name: '„ÇØ„É™„Çπ„Éû„Çπ' }
            };

            const config = seasonConfig[month] || { emojis: ['‚ú®'], name: '' };

            // Ë£ÖÈ£æ„ÅÆÈÖçÁΩÆ‰ΩçÁΩÆÔºàÁîªÈù¢„ÅÆÁ´Ø„Å´Êï£„Çä„Å∞„ÇÅ„ÇãÔºâ
            const positions = [
                { top: '80px', left: '15px', size: 'large' },
                { top: '120px', right: '20px', size: 'normal' },
                { top: '200px', left: '25px', size: 'small' },
                { top: '280px', right: '15px', size: 'normal' },
                { top: '380px', left: '10px', size: 'normal' },
                { top: '450px', right: '25px', size: 'small' },
                { top: '550px', left: '20px', size: 'small' },
                { bottom: '250px', right: '15px', size: 'normal' },
                { bottom: '150px', left: '15px', size: 'large' },
                { bottom: '80px', right: '20px', size: 'small' },
            ];

            positions.forEach((pos, i) => {
                const emoji = config.emojis[i % config.emojis.length];
                const deco = document.createElement('div');
                deco.className = `seasonal-deco ${pos.size === 'small' ? 'small' : pos.size === 'large' ? 'large' : ''}`;
                deco.textContent = emoji;
                if (pos.top) deco.style.top = pos.top;
                if (pos.bottom) deco.style.bottom = pos.bottom;
                if (pos.left) deco.style.left = pos.left;
                if (pos.right) deco.style.right = pos.right;
                deco.style.animationDelay = `${i * 0.3}s`;
                document.body.appendChild(deco);
            });
        }

        function getWeekKey() { return `${currentYear}-${currentMonth}-W${currentWeekNum}`; }

        function getWeekData() {
            const k = getWeekKey();
            if (!data.weeks[k]) {
                data.weeks[k] = {
                    daily: {},
                    review: {
                        mainIssue: '', mainCause: '',
                        causeActions: [
                            { cause: '', actions: [] },
                            { cause: '', actions: [] },
                            { cause: '', actions: [] },
                            { cause: '', actions: [] },
                            { cause: '', actions: [] }
                        ],
                        muchakuReasons: {},
                        muchakuOther: '',
                        ngReasons: {},
                        doinMuchakuList: [],
                        cases: [],
                        cancels: []
                    },
                    instagram: {},
                    nippo: {}
                };
            }
            if (!data.weeks[k].nippo) data.weeks[k].nippo = {};
            if (!data.weeks[k].instagram) data.weeks[k].instagram = {};
            if (!data.weeks[k].review) data.weeks[k].review = {
                mainIssue: '', mainCause: '',
                causeActions: [
                    { cause: '', actions: [] },
                    { cause: '', actions: [] },
                    { cause: '', actions: [] },
                    { cause: '', actions: [] },
                    { cause: '', actions: [] }
                ],
                muchakuReasons: {},
                muchakuOther: '',
                ngReasons: {},
                doinMuchakuList: [],
                cases: [],
                cancels: []
            };
            return data.weeks[k];
        }

        function getMemberReview() {
            const w = getWeekData();
            const mid = (selectedMember && selectedMember !== 'all')
                ? selectedMember : getCurrentMemberId();
            if (!mid) {
                return { mainIssue: '', mainCause: '', causeActions: [
                    {cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]}
                ], topReasonAction: '' };
            }
            if (!w.memberReview) w.memberReview = {};
            if (!w.memberReview[mid]) {
                w.memberReview[mid] = {
                    mainIssue: '', mainCause: '',
                    causeActions: [{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]}],
                    topReasonAction: ''
                };
                if (mid === getCurrentMemberId() && w.review &&
                    (w.review.mainIssue || w.review.mainCause || w.review.topReasonAction ||
                     (w.review.causeActions && w.review.causeActions.some(ca => ca.cause || (ca.actions && ca.actions.length > 0))))) {
                    w.memberReview[mid].mainIssue = w.review.mainIssue || '';
                    w.memberReview[mid].mainCause = w.review.mainCause || '';
                    w.memberReview[mid].topReasonAction = w.review.topReasonAction || '';
                    if (w.review.causeActions) {
                        w.memberReview[mid].causeActions = JSON.parse(JSON.stringify(w.review.causeActions));
                    }
                }
            }
            if (!w.memberReview[mid].causeActions) {
                w.memberReview[mid].causeActions = [
                    {cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]}
                ];
            }
            return w.memberReview[mid];
        }

        function getNippoData(memberId, dayIndex) {
            const w = getWeekData();
            const key = `${memberId}_${dayIndex}`;
            if (!w.nippo[key]) {
                w.nippo[key] = { videoUrl: '', output: '', gratitude: '' };
            }
            return w.nippo[key];
        }

        function getMonthVideos() {
            const monthKey = `${currentYear}-${currentMonth}`;
            if (!data.monthVideos) data.monthVideos = {};
            if (!data.monthVideos[monthKey]) data.monthVideos[monthKey] = {};
            return data.monthVideos[monthKey];
        }

        function getMemberDaily(memberId) {
            const w = getWeekData();
            if (!w.daily) w.daily = {};
            if (!w.daily[memberId]) {
                w.daily[memberId] = {};
                metrics.forEach(c => c.items.forEach(m => { w.daily[memberId][m.key] = [0,0,0,0,0,0,0]; }));
            }
            return w.daily[memberId];
        }

        function getAccountData(accountId) {
            const w = getWeekData();
            if (!w.instagram[accountId]) {
                w.instagram[accountId] = {
                    follow: [0,0,0,0,0,0,0], follower: [0,0,0,0,0,0,0],
                    followCut: [0,0,0,0,0,0,0], followerCut: [0,0,0,0,0,0,0],
                    dmSend: [0,0,0,0,0,0,0], dmReply: [0,0,0,0,0,0,0], dmOffer: [0,0,0,0,0,0,0],
                    apoGet: [0,0,0,0,0,0,0], apoExec: [0,0,0,0,0,0,0],
                    doinPlan: [0,0,0,0,0,0,0], doinExec: [0,0,0,0,0,0,0],
                    seiyaku: [0,0,0,0,0,0,0], blocked: [false,false,false,false,false,false,false]
                };
            }
            return w.instagram[accountId];
        }

        function getWeekDates() {
            const firstDayOfMonth = new Date(currentYear, currentMonth - 1, 1);
            const dow = (firstDayOfMonth.getDay() + 1) % 7;
            const weekStart = 1 - dow + (currentWeekNum - 1) * 7;
            const dates = [];
            for (let i = 0; i < 7; i++) {
                dates.push(new Date(currentYear, currentMonth - 1, weekStart + i));
            }
            return dates;
        }

        function updateWeekLabel() {
            const dates = getWeekDates();
            const startDate = dates[0];
            const endDate = dates[6];
            document.getElementById('weekLabel').textContent = `${startDate.getMonth()+1}/${startDate.getDate()}„Äú${endDate.getMonth()+1}/${endDate.getDate()}ÔºàÁ¨¨${currentWeekNum}ÈÄ±Ôºâ`;
        }

        function updateMonthLabel() {
            const el = document.getElementById('monthLabel');
            if (el) el.textContent = `${currentYear}Âπ¥${currentMonth}Êúà`;
        }

        function updateSyncStatus() {
            const dot = document.getElementById('syncDot');
            const text = document.getElementById('syncText');
            const settingsStatus = document.getElementById('firebaseStatus');
            if (firebaseInitialized) {
                dot.className = 'sync-dot';
                text.textContent = 'üî• FirebaseÂêåÊúü‰∏≠';
                if (settingsStatus) {
                    settingsStatus.innerHTML = '<div style="display:flex;align-items:center;gap:8px"><span style="color:#22c55e">‚óè</span><span>FirebaseÂêåÊúüÂÆå‰∫Ü</span></div>';
                    settingsStatus.style.background = '#1e3a2f';
                }
            } else {
                dot.className = 'sync-dot syncing';
                text.textContent = 'Êé•Á∂ö‰∏≠...';
                if (settingsStatus) {
                    settingsStatus.innerHTML = '<div style="display:flex;align-items:center;gap:8px"><span style="color:#eab308">‚óè</span><span>FirebaseÊé•Á∂ö‰∏≠...</span></div>';
                    settingsStatus.style.background = '#3a3520';
                }
            }
        }

        function prevWeek() {
            saveAll();
            currentWeekNum--;
            if (currentWeekNum < 1) {
                currentMonth--;
                if (currentMonth < 1) { currentMonth = 12; currentYear--; }
                currentWeekNum = 5;
            }
            savePageState();
            updateWeekLabel(); renderAll(); applySeasonalBackground();
        }

        function nextWeek() {
            saveAll();
            currentWeekNum++;
            if (currentWeekNum > 5) {
                currentMonth++;
                if (currentMonth > 12) { currentMonth = 1; currentYear++; }
                currentWeekNum = 1;
            }
            savePageState();
            updateWeekLabel(); renderAll(); applySeasonalBackground();
        }

        function prevMonth() {
            saveAll();
            currentMonth--;
            if (currentMonth < 1) { currentMonth = 12; currentYear--; }
            currentWeekNum = 1;
            savePageState();
            updateMonthLabel(); renderAll(); applySeasonalBackground();
        }

        function nextMonth() {
            saveAll();
            currentMonth++;
            if (currentMonth > 12) { currentMonth = 1; currentYear++; }
            currentWeekNum = 1;
            savePageState();
            updateMonthLabel(); renderAll(); applySeasonalBackground();
        }

        function setViewPeriod(period) {
            viewPeriod = period;
            document.getElementById('btnWeek').className = 'period-btn' + (period === 'week' ? ' active' : '');
            document.getElementById('btnMonth').className = 'period-btn' + (period === 'month' ? ' active' : '');
            document.getElementById('weekNav').style.display = period === 'month' ? 'none' : 'flex';
            document.getElementById('monthSelector').style.display = period === 'month' ? 'flex' : 'none';
            savePageState();
            updateMonthLabel();
            renderAll();
        }

        function switchTab(id) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${id}')"]`).classList.add('active');
            document.getElementById(`tab-${id}`).classList.add('active');
            // Ë®≠ÂÆö„Çø„Éñ„ÅåÈñã„Åã„Çå„Åü„Å®„Åç„Å´renderSettings„ÇíÂÜçÂëº„Å≥Âá∫„Åó
            if (id === 'settings') {
                renderSettings();
                loadBackupList();
            }
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function onMemberChange() {
            selectedMember = document.getElementById('memberSelect').value;
            savePageState();
            // ÂÖ®„Å¶„ÅÆ„Çø„Éñ„ÇíÂÜç„É¨„É≥„ÉÄ„É™„É≥„Ç∞
            renderAll();
            // Ë®≠ÂÆö„Çø„Éñ„ÅÆ„É°„É≥„Éê„ÉºÈÅ∏Êäû„ÇÇÂêåÊúü
            settingsSelectedMember = selectedMember;
        }

        // „ÉÅ„É£„Éº„Éà„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó
        function showChartTooltip(event) {
            const tooltip = document.getElementById('chartTooltip');
            const label = event.target.getAttribute('data-label');
            const value = event.target.getAttribute('data-value');
            const target = event.target.getAttribute('data-target');

            tooltip.innerHTML = `<strong>${label}</strong><br>ÂÆüÁ∏æ: ${value}<br>ÁõÆÊ®ô: ${target}`;
            tooltip.classList.add('show');

            const rect = event.target.getBoundingClientRect();
            tooltip.style.left = (rect.left + window.scrollX - 30) + 'px';
            tooltip.style.top = (rect.top + window.scrollY - 60) + 'px';
        }

        function hideChartTooltip() {
            document.getElementById('chartTooltip').classList.remove('show');
        }

        function renderAll() {
            try { renderMemberSelect(); } catch(e) { console.error('renderMemberSelect:', e.message); }
            try { renderSummary(); } catch(e) { console.error('renderSummary:', e.message); }
            try { renderMemberTable(); } catch(e) { console.error('renderMemberTable:', e.message); }
            try { renderDailyInput(); } catch(e) { console.error('renderDailyInput:', e.message); }
            try { renderNippo(); } catch(e) { console.error('renderNippo:', e.message); }
            try { renderReview(); } catch(e) { console.error('renderReview:', e.message); }
            try { renderInstagram(); } catch(e) { console.error('renderInstagram:', e.message); }
            try { renderSettings(); } catch(e) { console.error('renderSettings:', e.message); }
            // SupabaseÈÄ£Êê∫„Éá„Éº„Çø„ÅÆÂÜç„É¨„É≥„ÉÄ„É™„É≥„Ç∞Ôºà„É°„É≥„Éê„ÉºÈÅ∏Êäû„Åß„Éï„Ç£„É´„ÇøÂèçÊò†Ôºâ
            try { renderSupabaseSummary(); } catch(e) { console.error('renderSupabaseSummary:', e.message); }
            try { renderSupabaseInputSection(); } catch(e) { console.error('renderSupabaseInputSection:', e.message); }
        }

        function renderMemberSelect() {
            const sel = document.getElementById('memberSelect');
            sel.innerHTML = '<option value="all">ÂÖ®‰Ωì</option>' + data.members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            sel.value = selectedMember;
        }

        function calcTotals() {
            const t = {};
            metrics.forEach(c => c.items.forEach(m => t[m.key] = 0));
            const members = selectedMember === 'all' ? data.members : data.members.filter(m => m.id === selectedMember);

            if (viewPeriod === 'month') {
                const maxW = getMaxWeekNum(currentYear, currentMonth);
                for (let w = 1; w <= maxW; w++) {
                    const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                    const weekData = data.weeks[weekKey];
                    if (weekData && weekData.daily) {
                        members.forEach(m => {
                            const d = weekData.daily[m.id];
                            if (d) {
                                metrics.forEach(c => c.items.forEach(met => {
                                    t[met.key] += safeArraySum(d[met.key]);
                                }));
                            }
                        });
                    }
                }
            } else {
                members.forEach(m => {
                    const d = getMemberDaily(m.id);
                    metrics.forEach(c => c.items.forEach(met => {
                        t[met.key] += safeArraySum(d[met.key]);
                    }));
                });
            }
            return t;
        }

        function calcMemberTotals(memberId) {
            const t = {};
            metrics.forEach(c => c.items.forEach(m => t[m.key] = 0));

            if (viewPeriod === 'month') {
                const maxW = getMaxWeekNum(currentYear, currentMonth);
                for (let w = 1; w <= maxW; w++) {
                    const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                    const weekData = data.weeks[weekKey];
                    if (weekData && weekData.daily && weekData.daily[memberId]) {
                        const d = weekData.daily[memberId];
                        metrics.forEach(c => c.items.forEach(met => {
                            t[met.key] += safeArraySum(d[met.key]);
                        }));
                    }
                }
            } else {
                const d = getMemberDaily(memberId);
                metrics.forEach(c => c.items.forEach(met => {
                    t[met.key] += safeArraySum(d[met.key]);
                }));
            }
            return t;
        }

        function pct(a, b) { return b > 0 ? Math.round((a / b) * 100) + '%' : '-'; }
        function pctNum(a, b) { return b > 0 ? Math.round((a / b) * 100) : 0; }

        function setRateDisplay(rateId, barId, actual, goal) {
            const rate = pctNum(actual, goal);
            const cls = rate >= 100 ? 'good' : rate >= 70 ? 'warning' : 'danger';
            document.getElementById(rateId).textContent = rate + '%';
            document.getElementById(rateId).className = 'rate ' + cls;
            const bar = document.getElementById(barId);
            bar.style.width = Math.min(rate, 100) + '%';
            bar.className = 'fill ' + cls;
        }

        function renderSummary() {
            const t = calcTotals();

            // „É°„É≥„Éê„ÉºÂà•„ÅÆÁõÆÊ®ô„ÇíÂèñÂæó
            let g = {};
            if (selectedMember === 'all') {
                // ÂÖ®‰ΩìÈÅ∏ÊäûÊôÇÔºöÂÖ®„É°„É≥„Éê„Éº„ÅÆÁõÆÊ®ô„ÇíÂêàË®à
                data.members.forEach(m => {
                    const memberGoals = getMemberGoals(m.id);
                    g.post = (g.post || 0) + (memberGoals.post || 0);
                    g.apoGet = (g.apoGet || 0) + (memberGoals.apoGet || 0);
                    g.apoExec = (g.apoExec || 0) + (memberGoals.apoExec || 0);
                    g.doinGet = (g.doinGet || 0) + (memberGoals.doinGet || 0);
                    g.doinExec = (g.doinExec || 0) + (memberGoals.doinExec || 0);
                    g.mendan = (g.mendan || 0) + (memberGoals.mendan || 0);
                    g.mendanExec = (g.mendanExec || 0) + (memberGoals.mendanExec || 0);
                    g.seiyaku = (g.seiyaku || 0) + (memberGoals.seiyaku || 0);
                });
            } else {
                // ÂÄãÂà•„É°„É≥„Éê„ÉºÈÅ∏ÊäûÊôÇÔºö„Åù„ÅÆ„É°„É≥„Éê„Éº„ÅÆÁõÆÊ®ô
                g = getMemberGoals(selectedMember);
            }
            console.log('üìä renderSummary - selectedMember:', selectedMember, 'ÁõÆÊ®ô:', JSON.stringify(g));

            // ‰ªäÊó•„Åæ„Åß„Å´ÈÅîÊàê„Åô„Åπ„ÅçÁõÆÊ®ô„ÇíË®àÁÆóÔºà‰Ωø„Åà„ÇãÊó•Êï∞ = ÊúàÊú´Êó•Êï∞ - 3Ôºâ
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const effectiveDays = daysInMonth - 3; // ‰Ωø„Åà„ÇãÊó•Êï∞
            const today = new Date();
            const isCurrentMonth = (today.getFullYear() === currentYear && today.getMonth() + 1 === currentMonth);
            const currentDay = isCurrentMonth ? today.getDate() : effectiveDays;
            const remainingDays = Math.max(effectiveDays - currentDay, 1); // ÊÆã„ÇäÊó•Êï∞ÔºàÊúÄ‰Ωé1Ôºâ

            // ‰ªäÊó•„Åæ„Åß„ÅÆÁõÆÊ®ô„ÇíË®àÁÆó„Åô„ÇãÈñ¢Êï∞
            const getTarget = (monthlyGoal) => {
                if (viewPeriod === 'month') {
                    // ÊúàÊ¨°Ôºö‰ªäÊó•„Åæ„Åß„ÅÆÊó•Ââ≤„ÇäÁõÆÊ®ôÔºà‰Ωø„Åà„ÇãÊó•Êï∞„Éô„Éº„ÇπÔºâ
                    return (monthlyGoal / effectiveDays) * Math.min(currentDay, effectiveDays);
                } else {
                    // ÈÄ±Ê¨°ÔºöÊúàÈñìÁõÆÊ®ô„Çí‰Ωø„Åà„ÇãÊó•Êï∞„ÅßÊó•Ââ≤„Çä√ó7Êó•
                    const weeklyGoal = (monthlyGoal / effectiveDays) * 7;
                    return weeklyGoal;
                }
            };

            // ÁèæÂú®„ÅÆÂ§âÊèõÁéá„ÇíË®àÁÆóÔºà„ÉÅ„Çß„Éº„É≥: ÊäïÁ®ø‚Üí„Ç¢„ÉùÁç≤Âæó‚Üí„Ç¢„ÉùÂÆüÊñΩ‚ÜíÂãïÂì°Áç≤Âæó‚ÜíÂãïÂì°ÂÆüÊñΩ‚ÜíÊàêÁ¥ÑÔºâ
            const convRate = (numerator, denominator) => denominator > 0 ? numerator / denominator : 0;
            const rates = {
                seiyaku: convRate(t.seiyaku, t.doinExec),        // ÊàêÁ¥ÑÁéá = ÊàêÁ¥Ñ/ÂãïÂì°ÂÆüÊñΩ
                doinExec: convRate(t.doinExec, t.doinGet),       // ÂãïÂì°ÂÆüÊñΩÁéá = ÂãïÂì°ÂÆüÊñΩ/ÂãïÂì°Áç≤Âæó
                doinGet: convRate(t.doinGet, t.apoExec),         // ÂãïÂì°Áéá = ÂãïÂì°Áç≤Âæó/„Ç¢„ÉùÂÆüÊñΩ
                apoExec: convRate(t.apoExec, t.apoGet),          // „Ç¢„ÉùÂÆüÊñΩÁéá = „Ç¢„ÉùÂÆüÊñΩ/„Ç¢„ÉùÁç≤Âæó
                apoGet: convRate(t.apoGet, t.post || 0),         // „Ç¢„ÉùÁç≤ÂæóÁéá = „Ç¢„ÉùÁç≤Âæó/ÊäïÁ®ø
                mendanExec: convRate(t.mendanExec, t.mendanGet)  // Èù¢Ë´áÂÆüÊñΩÁéá = Èù¢Ë´áÂÆüÊñΩ/Èù¢Ë´áÁç≤Âæó
            };

            // Áõ¥Êé•„ÅÆÊó•ÂΩì„Åü„ÇäÂøÖË¶ÅÊï∞ÔºàÁõÆÊ®ôÊÆã / ÊÆãÊó•Êï∞Ôºâ
            const directDaily = (goal, actual) => Math.max(goal - actual, 0) / remainingDays;

            // ===== Ë®àÁîª„Éô„Éº„Çπ: ÁõÆÊ®ôÂÄ§„Åã„ÇâÊöóÈªô„ÅÆËª¢ÊèõÁéá„ÇíË®àÁÆó„Åó„Å¶ÈÄÜÁÆó =====
            const planRates = {
                seiyaku: convRate(g.seiyaku || 0, g.doinExec || 0),
                doinExec: convRate(g.doinExec || 0, g.doinGet || 0),
                doinGet: convRate(g.doinGet || 0, g.apoExec || 0),
                apoExec: convRate(g.apoExec || 0, g.apoGet || 0),
                apoGet: convRate(g.apoGet || 0, g.post || 0),
                mendanExec: convRate(g.mendanExec || 0, g.mendan || 0)
            };

            const seiyakuDaily = directDaily(g.seiyaku || 0, t.seiyaku);

            const doinExecChain = planRates.seiyaku > 0 ? seiyakuDaily / planRates.seiyaku : 0;
            const doinExecDaily = Math.max(directDaily(g.doinExec || 0, t.doinExec), doinExecChain);

            const doinGetChain = planRates.doinExec > 0 ? doinExecDaily / planRates.doinExec : 0;
            const doinGetDaily = Math.max(directDaily(g.doinGet || 0, t.doinGet), doinGetChain);

            const apoExecChain = planRates.doinGet > 0 ? doinGetDaily / planRates.doinGet : 0;
            const apoExecDaily = Math.max(directDaily(g.apoExec || 0, t.apoExec), apoExecChain);

            const apoGetChain = planRates.apoExec > 0 ? apoExecDaily / planRates.apoExec : 0;
            const apoGetDaily = Math.max(directDaily(g.apoGet || 0, t.apoGet), apoGetChain);

            const postChain = planRates.apoGet > 0 ? apoGetDaily / planRates.apoGet : 0;
            const postDaily = Math.max(directDaily(g.post || 0, t.post || 0), postChain);

            const mendanGetDaily = directDaily(g.mendan || 0, t.mendanGet);

            const mendanExecChain = planRates.mendanExec > 0 ? mendanGetDaily / planRates.mendanExec : 0;
            const mendanExecDaily = Math.max(directDaily(g.mendanExec || 0, t.mendanExec), mendanExecChain);

            // ===== ÂÆüÁ∏æ„Éô„Éº„Çπ: ÂÆüÈöõ„ÅÆ„Éá„Éº„Çø„ÅÆËª¢ÊèõÁéá„Çí‰Ωø„Å£„Å¶ÈÄÜÁÆó =====
            const hasEnoughData = (t.apoGet > 2 || t.apoExec > 1); // ÊúÄ‰ΩéÈôê„ÅÆ„Éá„Éº„Çø„Åå„ÅÇ„Çã„Åã
            let actualPostDaily = postDaily;
            let actualApoGetDaily = apoGetDaily;
            let actualApoExecDaily = apoExecDaily;
            let actualDoinGetDaily = doinGetDaily;
            let actualDoinExecDaily = doinExecDaily;
            let actualMendanGetDaily = mendanGetDaily;
            let actualMendanExecDaily = mendanExecDaily;
            let actualSeiyakuDaily = seiyakuDaily;

            if (hasEnoughData) {
                // ÂÆüÁ∏æ„Éô„Éº„Çπ„ÅÆÈÄÜÁÆóÔºàÊàêÁ¥ÑÁõÆÊ®ôÊÆã„Åã„ÇâÈÄÜÁÆó„ÄÅÂÆüÁ∏æ„ÅÆÂ§âÊèõÁéá rates „Çí‰ΩøÁî®Ôºâ
                actualSeiyakuDaily = directDaily(g.seiyaku || 0, t.seiyaku);

                const actDoinExecChain = rates.seiyaku > 0 ? actualSeiyakuDaily / rates.seiyaku : 0;
                actualDoinExecDaily = Math.max(directDaily(g.doinExec || 0, t.doinExec), actDoinExecChain);

                const actDoinGetChain = rates.doinExec > 0 ? actualDoinExecDaily / rates.doinExec : 0;
                actualDoinGetDaily = Math.max(directDaily(g.doinGet || 0, t.doinGet), actDoinGetChain);

                const actApoExecChain = rates.doinGet > 0 ? actualDoinGetDaily / rates.doinGet : 0;
                actualApoExecDaily = Math.max(directDaily(g.apoExec || 0, t.apoExec), actApoExecChain);

                const actApoGetChain = rates.apoExec > 0 ? actualApoExecDaily / rates.apoExec : 0;
                actualApoGetDaily = Math.max(directDaily(g.apoGet || 0, t.apoGet), actApoGetChain);

                const actPostChain = rates.apoGet > 0 ? actualApoGetDaily / rates.apoGet : 0;
                actualPostDaily = Math.max(directDaily(g.post || 0, t.post || 0), actPostChain);

                actualMendanGetDaily = directDaily(g.mendan || 0, t.mendanGet);

                const actMendanExecChain = rates.mendanExec > 0 ? actualMendanGetDaily / rates.mendanExec : 0;
                actualMendanExecDaily = Math.max(directDaily(g.mendanExec || 0, t.mendanExec), actMendanExecChain);
            }

            // Change 5 & 8: ÊÆã„ÇäÊó•ÂΩì„Åü„ÇäË°®Á§∫„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞ÔºàÂ∞èÊï∞1Ê°Å + Âàá„Çä‰∏ä„ÅíÊï¥Êï∞Ë°®Á§∫ + Ë®àÁîªvsÂÆüÁ∏æÔºâ
            const setDailyDisplay = (elId, planDaily, actualDaily, monthlyGoal, actual) => {
                const el = document.getElementById(elId);
                if (!el) return;
                if (!isCurrentMonth) {
                    el.textContent = '';
                    return;
                }
                if ((monthlyGoal - actual) <= 0) {
                    el.innerHTML = '<span style="color:#22c55e">ÈÅîÊàê!</span>';
                    return;
                }

                const ceilVal = Math.ceil(actualDaily);
                let html = `ÊÆã${remainingDays}Êó• / Êó•${actualDaily.toFixed(1)}`;
                if (actualDaily % 1 !== 0) {
                    html += ` <span style="color:#fbbf24;font-size:11px">ËøΩ„ÅÜÊï∞Â≠ó: ${ceilVal}</span>`;
                }

                // Ë®àÁîª„Éô„Éº„Çπ„Å®ÂÆüÁ∏æ„Éô„Éº„Çπ„ÅåÂ§ß„Åç„ÅèÁï∞„Å™„ÇãÂ†¥ÂêàÔºà10%‰ª•‰∏ä‰πñÈõ¢Ôºâ„ÄÅ‰∏°ÊñπË°®Á§∫
                if (hasEnoughData && planDaily > 0 && Math.abs(planDaily - actualDaily) / planDaily > 0.1) {
                    html += `<br><span style="font-size:10px;color:#64748b">Ë®àÁîª: ${planDaily.toFixed(1)} / ÂÆüÁ∏æ: ${actualDaily.toFixed(1)}</span>`;
                }

                el.innerHTML = html;
            };

            // Change 5: ÁõÆÊ®ôË°®Á§∫ÔºàÂ∞èÊï∞1Ê°Å + Âàá„Çä‰∏ä„ÅíÊï¥Êï∞Ôºâ
            const setGoalDisplay = (elId, goalValue) => {
                const el = document.getElementById(elId);
                if (!el) return;
                const targetVal = getTarget(goalValue);
                const decimal = targetVal.toFixed(1);
                const ceil = Math.ceil(targetVal);
                if (targetVal % 1 !== 0 && targetVal > 0) {
                    el.innerHTML = `${decimal} <span style="font-size:10px;color:#fbbf24">(${ceil})</span>`;
                } else {
                    el.textContent = decimal;
                }
            };

            document.getElementById('sPost').textContent = t.post || 0;
            setGoalDisplay('sPostGoal', g.post || 0);
            setRateDisplay('sPostRate', 'sPostBar', t.post || 0, getTarget(g.post || 0));
            setDailyDisplay('sPostDaily', postDaily, actualPostDaily, g.post || 0, t.post || 0);

            document.getElementById('sApoGet').textContent = t.apoGet;
            setGoalDisplay('sApoGetGoal', g.apoGet);
            setRateDisplay('sApoGetRate', 'sApoGetBar', t.apoGet, getTarget(g.apoGet));
            setDailyDisplay('sApoGetDaily', apoGetDaily, actualApoGetDaily, g.apoGet || 0, t.apoGet);

            document.getElementById('sApoExec').textContent = t.apoExec;
            setGoalDisplay('sApoExecGoal', g.apoExec);
            setRateDisplay('sApoExecRate', 'sApoExecBar', t.apoExec, getTarget(g.apoExec));
            setDailyDisplay('sApoExecDaily', apoExecDaily, actualApoExecDaily, g.apoExec || 0, t.apoExec);

            document.getElementById('sDoinGet').textContent = t.doinGet;
            setGoalDisplay('sDoinGetGoal', g.doinGet);
            setRateDisplay('sDoinGetRate', 'sDoinGetBar', t.doinGet, getTarget(g.doinGet));
            setDailyDisplay('sDoinGetDaily', doinGetDaily, actualDoinGetDaily, g.doinGet || 0, t.doinGet);

            document.getElementById('sDoinExec').textContent = t.doinExec;
            setGoalDisplay('sDoinExecGoal', g.doinExec);
            setRateDisplay('sDoinExecRate', 'sDoinExecBar', t.doinExec, getTarget(g.doinExec));
            setDailyDisplay('sDoinExecDaily', doinExecDaily, actualDoinExecDaily, g.doinExec || 0, t.doinExec);

            document.getElementById('sMendan').textContent = t.mendanGet;
            setGoalDisplay('sMendanGoal', g.mendan);
            setRateDisplay('sMendanRate', 'sMendanBar', t.mendanGet, getTarget(g.mendan));
            setDailyDisplay('sMendanDaily', mendanGetDaily, actualMendanGetDaily, g.mendan || 0, t.mendanGet);

            document.getElementById('sMendanExec').textContent = t.mendanExec;
            setGoalDisplay('sMendanExecGoal', g.mendanExec || 0);
            setRateDisplay('sMendanExecRate', 'sMendanExecBar', t.mendanExec, getTarget(g.mendanExec || 0));
            setDailyDisplay('sMendanExecDaily', mendanExecDaily, actualMendanExecDaily, g.mendanExec || 0, t.mendanExec);

            document.getElementById('sSeiyaku').textContent = t.seiyaku;
            setGoalDisplay('sSeiyakuGoal', g.seiyaku);
            setRateDisplay('sSeiyakuRate', 'sSeiyakuBar', t.seiyaku, getTarget(g.seiyaku));
            setDailyDisplay('sSeiyakuDaily', seiyakuDaily, actualSeiyakuDaily, g.seiyaku || 0, t.seiyaku);

            // KPIËá™ÂãïË®àÁÆó
            document.getElementById('kMuchaku').textContent = pct(t.muchaku, t.apoExec);
            document.getElementById('kTarget').textContent = pct(t.apoExec - t.ng, t.apoExec);
            document.getElementById('kNg').textContent = pct(t.ng, t.apoExec);
            document.getElementById('kTestClose').textContent = pct(t.testClose, t.apoExec);
            document.getElementById('kOffer').textContent = pct(t.offer, t.apoExec);
            document.getElementById('kDoinGetRate').textContent = pct(t.doinGet, t.apoExec);
            document.getElementById('kDoinExecRate').textContent = pct(t.doinExec, t.apoExec);
            document.getElementById('kSeiyakuRate').textContent = pct(t.seiyaku, t.doinExec);

            // ÁÑ°ÁùÄÂú∞ÂÜÖË®≥„ÇíË°®Á§∫
            try { renderSummaryMuchakuBreakdown(); } catch(e) { console.error('renderSummaryMuchakuBreakdown error:', e); }
            // NGÁêÜÁî±ÂÜÖË®≥„ÇíË°®Á§∫
            try { renderSummaryNgBreakdown(); } catch(e) { console.error('renderSummaryNgBreakdown error:', e); }

            // ÊÆãÊ°à‰ª∂„Éª„Ç≠„É£„É≥„Çª„É´„ÉªÂãïÂì°ÂæåÁÑ°ÁùÄÂú∞„ÇíË°®Á§∫
            try { renderSummaryCasesAndCancels(); } catch(e) { console.error('renderSummaryCasesAndCancels error:', e); }

            // „ÉÅ„É£„Éº„Éà„ÇíÊèèÁîª
            try { renderLargeCharts(); } catch(e) { console.error('renderLargeCharts error:', e); }
        }

        function renderSummaryMuchakuBreakdown() {
            // „É°„É≥„Éê„ÉºÂà•„Å´Êó•Âà•„Éá„Éº„Çø„Åã„ÇâÈõÜË®à
            const members = selectedMember === 'all' ? data.members : data.members.filter(m => m.id === selectedMember);
            const totals = {};
            muchakuReasonLabels.forEach((_, i) => totals[i] = 0);

            if (viewPeriod === 'month') {
                // ÊúàÂÖ®‰Ωì„ÅÆÈõÜË®à
                const maxW = getMaxWeekNum(currentYear, currentMonth);
                for (let w = 1; w <= maxW; w++) {
                    const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                    const weekData = data.weeks[weekKey];
                    if (weekData && weekData.daily) {
                        members.forEach(member => {
                            const d = weekData.daily[member.id];
                            if (d && d.muchakuReasonsByDay) {
                                for (let day = 0; day < 7; day++) {
                                    const dayData = d.muchakuReasonsByDay[day] || {};
                                    const counts = dayData.counts || [];
                                    counts.forEach((count, i) => {
                                        totals[i] = (totals[i] || 0) + (count || 0);
                                    });
                                }
                            }
                        });
                    }
                }
            } else {
                // ÈÄ±„ÅÆÈõÜË®à
                members.forEach(member => {
                    const d = getMemberDaily(member.id);
                    const reasonsByDay = d.muchakuReasonsByDay || {};
                    for (let day = 0; day < 7; day++) {
                        const dayData = reasonsByDay[day] || {};
                        const counts = dayData.counts || [];
                        counts.forEach((count, i) => {
                            totals[i] = (totals[i] || 0) + (count || 0);
                        });
                    }
                });
            }

            let total = 0;
            let html = muchakuReasonLabels.map((label, i) => {
                const count = totals[i] || 0;
                total += count;
                const colorClass = count > 0 ? 'warning' : '';
                return `<div class="kpi-item"><div class="label" style="font-size:9px">${label}</div><div class="value ${colorClass}" style="font-size:18px">${count}</div></div>`;
            }).join('');

            document.getElementById('summaryMuchakuBreakdown').innerHTML = html;
            document.getElementById('sMuchakuTotal').textContent = `(${total}‰ª∂)`;
        }

        function renderSummaryNgBreakdown() {
            // „É°„É≥„Éê„ÉºÂà•„Å´Êó•Âà•„Éá„Éº„Çø„Åã„ÇâÈõÜË®à
            const members = selectedMember === 'all' ? data.members : data.members.filter(m => m.id === selectedMember);
            const totals = {};
            ngReasonLabels.forEach((_, i) => totals[i] = 0);

            if (viewPeriod === 'month') {
                // ÊúàÂÖ®‰Ωì„ÅÆÈõÜË®à
                const maxW = getMaxWeekNum(currentYear, currentMonth);
                for (let w = 1; w <= maxW; w++) {
                    const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                    const weekData = data.weeks[weekKey];
                    if (weekData && weekData.daily) {
                        members.forEach(member => {
                            const d = weekData.daily[member.id];
                            if (d && d.ngReasonsByDay) {
                                for (let day = 0; day < 7; day++) {
                                    const dayData = d.ngReasonsByDay[day] || {};
                                    const counts = dayData.counts || [];
                                    counts.forEach((count, i) => {
                                        totals[i] = (totals[i] || 0) + (count || 0);
                                    });
                                }
                            }
                        });
                    }
                }
            } else {
                // ÈÄ±„ÅÆÈõÜË®à
                members.forEach(member => {
                    const d = getMemberDaily(member.id);
                    const reasonsByDay = d.ngReasonsByDay || {};
                    for (let day = 0; day < 7; day++) {
                        const dayData = reasonsByDay[day] || {};
                        const counts = dayData.counts || [];
                        counts.forEach((count, i) => {
                            totals[i] = (totals[i] || 0) + (count || 0);
                        });
                    }
                });
            }

            let total = 0;

            let html = ngReasonLabels.map((label, i) => {
                const count = totals[i] || 0;
                total += count;
                const colorClass = count > 0 ? 'danger' : '';
                return `<div class="kpi-item"><div class="label" style="font-size:9px">${label}</div><div class="value ${colorClass}" style="font-size:18px">${count}</div></div>`;
            }).join('');

            document.getElementById('summaryNgBreakdown').innerHTML = html;
            document.getElementById('sNgTotal').textContent = `(${total}‰ª∂)`;
        }

        function renderSummaryCasesAndCancels() {
            // „Åì„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÅØÂÖ•Âäõ„Éï„Ç©„Éº„É†Áî®ÔºàcaseList, cancelList, doinMuchakuListÔºâ
            // Ë°®Á§∫„ÅÆ„Åø„ÅÆÊõ¥Êñ∞„Çí„Åì„Åì„ÅßË°å„ÅÜ
            renderCases();
            renderCancels();
            renderDoinMuchaku();

            // ÊñΩÁ≠ñ„Ç∑„Éº„ÉàÂÜÖ„ÅÆ„Çµ„Éû„É™„Éº„ÇÇÊõ¥Êñ∞
            renderReviewSummary();
        }

        function renderReviewSummary() {
            const t = calcTotals();

            // „É°„É≥„Éê„ÉºÂà•„ÅÆÁõÆÊ®ô„ÇíÂèñÂæó
            let g = {};
            if (selectedMember === 'all') {
                // ÂÖ®‰ΩìÈÅ∏ÊäûÊôÇÔºöÂÖ®„É°„É≥„Éê„Éº„ÅÆÁõÆÊ®ô„ÇíÂêàË®à
                data.members.forEach(m => {
                    const memberGoals = getMemberGoals(m.id);
                    g.post = (g.post || 0) + (memberGoals.post || 0);
                    g.apoGet = (g.apoGet || 0) + (memberGoals.apoGet || 0);
                    g.apoExec = (g.apoExec || 0) + (memberGoals.apoExec || 0);
                    g.doinGet = (g.doinGet || 0) + (memberGoals.doinGet || 0);
                    g.doinExec = (g.doinExec || 0) + (memberGoals.doinExec || 0);
                    g.mendan = (g.mendan || 0) + (memberGoals.mendan || 0);
                    g.mendanExec = (g.mendanExec || 0) + (memberGoals.mendanExec || 0);
                    g.seiyaku = (g.seiyaku || 0) + (memberGoals.seiyaku || 0);
                });
            } else {
                // ÂÄãÂà•„É°„É≥„Éê„ÉºÈÅ∏ÊäûÊôÇÔºö„Åù„ÅÆ„É°„É≥„Éê„Éº„ÅÆÁõÆÊ®ô
                g = getMemberGoals(selectedMember);
            }

            // ÁõÆÊ®ôË®àÁÆóÔºà‰Ωø„Åà„ÇãÊó•Êï∞ = ÊúàÊú´Êó•Êï∞ - 3Ôºâ
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const effectiveDays = daysInMonth - 3;
            const today = new Date();
            const currentDay = (today.getFullYear() === currentYear && today.getMonth() + 1 === currentMonth)
                ? today.getDate() : effectiveDays;
            const getTarget = (monthlyGoal) => Math.ceil((monthlyGoal || 0) / effectiveDays * Math.min(currentDay, effectiveDays));

            // Êï∞Â≠ó„Å®„Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº
            const metrics = [
                { id: 'rsPost', key: 'post', goal: g.post },
                { id: 'rsApoGet', key: 'apoGet', goal: g.apoGet },
                { id: 'rsApoExec', key: 'apoExec', goal: g.apoExec },
                { id: 'rsDoinGet', key: 'doinGet', goal: g.doinGet },
                { id: 'rsDoinExec', key: 'doinExec', goal: g.doinExec },
                { id: 'rsMendanGet', key: 'mendanGet', goal: g.mendan },
                { id: 'rsMendanExec', key: 'mendanExec', goal: g.mendanExec },
                { id: 'rsSeiyaku', key: 'seiyaku', goal: g.seiyaku }
            ];

            metrics.forEach(m => {
                const actual = t[m.key] || 0;
                const target = getTarget(m.goal || 0);
                document.getElementById(m.id).textContent = actual;
                document.getElementById(m.id + 'Goal').textContent = target;
                setRateDisplay(m.id + 'Rate', m.id + 'Bar', actual, target);
            });

            // KPI
            document.getElementById('rsMuchaku').textContent = pct(t.muchaku, t.apoExec);
            document.getElementById('rsNg').textContent = pct(t.ng, t.apoExec);
            document.getElementById('rsTestClose').textContent = pct(t.testClose, t.apoExec);
            document.getElementById('rsOffer').textContent = pct(t.offer, t.apoExec);
            document.getElementById('rsDoinRate').textContent = pct(t.doinGet, t.apoExec);
            document.getElementById('rsSeiyakuRate').textContent = pct(t.seiyaku, t.doinExec);

            // ÁÑ°ÁùÄÂú∞ÂÜÖË®≥Ôºà„É°„É≥„Éê„ÉºÂà•„Å´Êó•Âà•„Éá„Éº„Çø„Åã„ÇâÈõÜË®àÔºâ
            const members = selectedMember === 'all' ? data.members : data.members.filter(m => m.id === selectedMember);
            const muchakuTotals = {};
            muchakuReasonLabels.forEach((_, i) => muchakuTotals[i] = 0);

            if (viewPeriod === 'month') {
                const maxW = getMaxWeekNum(currentYear, currentMonth);
                for (let w = 1; w <= maxW; w++) {
                    const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                    const weekData = data.weeks[weekKey];
                    if (weekData && weekData.daily) {
                        members.forEach(member => {
                            const d = weekData.daily[member.id];
                            if (d && d.muchakuReasonsByDay) {
                                for (let day = 0; day < 7; day++) {
                                    const dayData = d.muchakuReasonsByDay[day] || {};
                                    const counts = dayData.counts || [];
                                    counts.forEach((count, i) => {
                                        muchakuTotals[i] = (muchakuTotals[i] || 0) + (count || 0);
                                    });
                                }
                            }
                        });
                    }
                }
            } else {
                members.forEach(member => {
                    const d = getMemberDaily(member.id);
                    const reasonsByDay = d.muchakuReasonsByDay || {};
                    for (let day = 0; day < 7; day++) {
                        const dayData = reasonsByDay[day] || {};
                        const counts = dayData.counts || [];
                        counts.forEach((count, i) => {
                            muchakuTotals[i] = (muchakuTotals[i] || 0) + (count || 0);
                        });
                    }
                });
            }

            let total = 0;
            let topReasonIndex = -1;
            let topReasonCount = 0;
            let breakdownHtml = muchakuReasonLabels.map((label, i) => {
                const count = muchakuTotals[i] || 0;
                total += count;
                if (count > topReasonCount) {
                    topReasonCount = count;
                    topReasonIndex = i;
                }
                return `<div style="padding:4px;background:#0f172a;border-radius:4px;display:flex;justify-content:space-between"><span>${label}</span><strong style="${count > 0 ? 'color:#eab308' : ''}">${count}</strong></div>`;
            }).join('');
            document.getElementById('rsMuchakuBreakdown').innerHTML = breakdownHtml;
            document.getElementById('rsMuchakuTotal').textContent = `(${total}‰ª∂)`;

            // ÊúÄÂ§öÁêÜÁî±„Å®ÂØæÁ≠ñ
            const topReasonLabel = topReasonIndex >= 0 ? muchakuReasonLabels[topReasonIndex] : '-';
            document.getElementById('rsTopReason').textContent = topReasonCount > 0 ? `${topReasonLabel}Ôºà${topReasonCount}‰ª∂Ôºâ` : '-';
            document.getElementById('rsTopReasonAction').value = getMemberReview().topReasonAction || '';

            // NGÁêÜÁî±ÂÜÖË®≥Ôºà„É°„É≥„Éê„ÉºÂà•„Å´Êó•Âà•„Éá„Éº„Çø„Åã„ÇâÈõÜË®àÔºâ
            const ngTotals = {};
            ngReasonLabels.forEach((_, i) => ngTotals[i] = 0);

            if (viewPeriod === 'month') {
                const maxW2 = getMaxWeekNum(currentYear, currentMonth);
                for (let w = 1; w <= maxW2; w++) {
                    const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                    const weekData = data.weeks[weekKey];
                    if (weekData && weekData.daily) {
                        members.forEach(member => {
                            const d = weekData.daily[member.id];
                            if (d && d.ngReasonsByDay) {
                                for (let day = 0; day < 7; day++) {
                                    const dayData = d.ngReasonsByDay[day] || {};
                                    const counts = dayData.counts || [];
                                    counts.forEach((count, i) => {
                                        ngTotals[i] = (ngTotals[i] || 0) + (count || 0);
                                    });
                                }
                            }
                        });
                    }
                }
            } else {
                members.forEach(member => {
                    const d = getMemberDaily(member.id);
                    const reasonsByDay = d.ngReasonsByDay || {};
                    for (let day = 0; day < 7; day++) {
                        const dayData = reasonsByDay[day] || {};
                        const counts = dayData.counts || [];
                        counts.forEach((count, i) => {
                            ngTotals[i] = (ngTotals[i] || 0) + (count || 0);
                        });
                    }
                });
            }

            let ngTotal = 0;
            let ngBreakdownHtml = ngReasonLabels.map((label, i) => {
                const count = ngTotals[i] || 0;
                ngTotal += count;
                return `<div style="padding:4px;background:#0f172a;border-radius:4px;display:flex;justify-content:space-between"><span>${label}</span><strong style="${count > 0 ? 'color:#ef4444' : ''}">${count}</strong></div>`;
            }).join('');
            document.getElementById('rsNgBreakdown').innerHTML = ngBreakdownHtml;
            document.getElementById('rsNgTotal').textContent = `(${ngTotal}‰ª∂)`;

            // ÊÆãÊ°à‰ª∂ÔºàSupabaseÈÄ£Êê∫ÊôÇ„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºâ
            if (supabaseCasesCache && supabaseCasesCache.length > 0) { renderSupabaseSummary(); }
            else {
            const reviewData = getWeekData().review;
            let allCases = [];
            if (viewPeriod === 'month') {
                const maxW3 = getMaxWeekNum(currentYear, currentMonth);
                for (let w = 1; w <= maxW3; w++) {
                    const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                    if (data.weeks[weekKey] && data.weeks[weekKey].review && data.weeks[weekKey].review.cases) {
                        allCases = allCases.concat(data.weeks[weekKey].review.cases);
                    }
                }
            } else {
                allCases = reviewData.cases || [];
            }
            const filteredCases = allCases.filter(c => selectedMember === 'all' || !c.memberId || c.memberId === selectedMember);
            document.getElementById('rsCasesCount').textContent = `(${filteredCases.length}‰ª∂)`;
            document.getElementById('rsCasesList').innerHTML = filteredCases.length === 0 ? '<p style="color:#64748b">„Å™„Åó</p>' :
                filteredCases.map(c => {
                    const memberName = selectedMember === 'all' && c.memberId ? (data.members.find(m => m.id === c.memberId)?.name || '') : '';
                    const badge = memberName ? `<span style="font-size:9px;background:#6366f1;padding:1px 4px;border-radius:3px;margin-right:4px">${memberName}</span>` : '';
                    return `<div style="padding:4px;background:#0f172a;border-radius:4px;margin-bottom:4px">${badge}${c.date || '-'} ${c.customer || 'Êú™ÂÖ•Âäõ'} <span style="color:#64748b;font-size:11px">${c.closer || ''}</span></div>`;
                }).join('');
            } // SupabaseÈÄ£Êê∫ else „Éñ„É≠„ÉÉ„ÇØÁµÇ‰∫Ü

            // „Ç≠„É£„É≥„Çª„É´Ôºà„É°„É≥„Éê„Éº„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ + ÁêÜÁî±Ë°®Á§∫ + ÊúàË°®Á§∫ÂØæÂøúÔºâ
            let allCancels = [];
            if (viewPeriod === 'month') {
                const maxW4 = getMaxWeekNum(currentYear, currentMonth);
                for (let w = 1; w <= maxW4; w++) {
                    const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                    if (data.weeks[weekKey] && data.weeks[weekKey].review && data.weeks[weekKey].review.cancels) {
                        allCancels = allCancels.concat(data.weeks[weekKey].review.cancels);
                    }
                }
            } else {
                allCancels = reviewData.cancels || [];
            }
            const filteredCancels = allCancels.filter(c => selectedMember === 'all' || !c.memberId || c.memberId === selectedMember);
            document.getElementById('rsCancelsCount').textContent = `(${filteredCancels.length}‰ª∂)`;
            document.getElementById('rsCancelsList').innerHTML = filteredCancels.length === 0 ? '<p style="color:#64748b">„Å™„Åó</p>' :
                filteredCancels.map(c => {
                    const memberName = selectedMember === 'all' && c.memberId ? (data.members.find(m => m.id === c.memberId)?.name || '') : '';
                    const badge = memberName ? `<span style="font-size:9px;background:#6366f1;padding:1px 4px;border-radius:3px;margin-right:4px">${memberName}</span>` : '';
                    const closerText = c.closer ? `<span style="color:#64748b;font-size:10px;margin-left:4px">[${c.closer}]</span>` : '';
                    return `<div style="padding:4px;background:#0f172a;border-radius:4px;margin-bottom:4px;border-left:2px solid #eab308">${badge}${c.date || '-'} ${c.customer || 'Êú™ÂÖ•Âäõ'}${closerText} <span style="color:#eab308;font-size:11px">${c.reason || ''}</span></div>`;
                }).join('');

            // ÂãïÂì°ÂæåÁÑ°ÁùÄÂú∞Ôºà„É°„É≥„Éê„Éº„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ + ÊúàË°®Á§∫ÂØæÂøúÔºâ
            let allDoinMuchaku = [];
            if (viewPeriod === 'month') {
                const maxW5 = getMaxWeekNum(currentYear, currentMonth);
                for (let w = 1; w <= maxW5; w++) {
                    const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                    if (data.weeks[weekKey] && data.weeks[weekKey].review && data.weeks[weekKey].review.doinMuchakuList) {
                        allDoinMuchaku = allDoinMuchaku.concat(data.weeks[weekKey].review.doinMuchakuList);
                    }
                }
            } else {
                allDoinMuchaku = reviewData.doinMuchakuList || [];
            }
            const filteredDoinMuchaku = allDoinMuchaku.filter(item => selectedMember === 'all' || !item.memberId || item.memberId === selectedMember);
            document.getElementById('rsDoinMuchakuCount').textContent = `(${filteredDoinMuchaku.length}‰ª∂)`;
            document.getElementById('rsDoinMuchakuList').innerHTML = filteredDoinMuchaku.length === 0 ? '<p style="color:#64748b">„Å™„Åó</p>' :
                filteredDoinMuchaku.map(item => {
                    const memberName = selectedMember === 'all' && item.memberId ? (data.members.find(m => m.id === item.memberId)?.name || '') : '';
                    const badge = memberName ? `<span style="font-size:9px;background:#6366f1;padding:1px 4px;border-radius:3px;margin-right:4px">${memberName}</span>` : '';
                    const closerText = item.closer ? `<span style="color:#64748b;font-size:10px;margin-left:4px">[${item.closer}]</span>` : '';
                    return `<div style="padding:4px;background:#0f172a;border-radius:4px;margin-bottom:4px;border-left:2px solid #ef4444">${badge}${item.date || '-'} ${item.customer || 'Êú™ÂÖ•Âäõ'}${closerText} <span style="color:#ef4444">${item.reason || ''}</span></div>`;
                }).join('');

            // „Çµ„Ç§„Éâ„Éê„ÉºÁî®„Ç∞„É©„Éï„ÇíÊèèÁîª
            renderReviewCharts();
        }

        function renderMiniCharts() {
            const g = data.settings.monthly || {};
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();

            const chartConfigs = [
                { id: 'chartPost', key: 'post', goal: g.post || 0 },
                { id: 'chartApoGet', key: 'apoGet', goal: g.apoGet || 0 },
                { id: 'chartApoExec', key: 'apoExec', goal: g.apoExec || 0 },
                { id: 'chartDoinGet', key: 'doinGet', goal: g.doinGet || 0 },
                { id: 'chartDoinExec', key: 'doinExec', goal: g.doinExec || 0 },
                { id: 'chartMendan', key: 'mendanGet', goal: g.mendan || 0 },
                { id: 'chartMendanExec', key: 'mendanExec', goal: g.mendanExec || 0 },
                { id: 'chartSeiyaku', key: 'seiyaku', goal: g.seiyaku || 0 }
            ];

            chartConfigs.forEach(config => {
                const container = document.getElementById(config.id);
                if (!container) return;

                const { actualData, targetData, numDays } = getChartData(config.key, config.goal);
                const maxVal = Math.max(...actualData, ...targetData, 1);
                container.innerHTML = createMiniChartSVG(actualData, targetData, maxVal, numDays);
            });
        }

        function renderLargeCharts() {
            // „É°„É≥„Éê„ÉºÈÅ∏Êäû„Å´Âøú„Åò„ÅüÁõÆÊ®ô„ÇíÂèñÂæó
            let g = {};
            if (selectedMember === 'all') {
                // ÂÖ®‰ΩìÈÅ∏ÊäûÊôÇÔºöÂÖ®„É°„É≥„Éê„Éº„ÅÆÁõÆÊ®ô„ÇíÂêàË®à
                data.members.forEach(m => {
                    const memberGoals = getMemberGoals(m.id);
                    g.post = (g.post || 0) + (memberGoals.post || 0);
                    g.apoGet = (g.apoGet || 0) + (memberGoals.apoGet || 0);
                    g.apoExec = (g.apoExec || 0) + (memberGoals.apoExec || 0);
                    g.doinGet = (g.doinGet || 0) + (memberGoals.doinGet || 0);
                    g.doinExec = (g.doinExec || 0) + (memberGoals.doinExec || 0);
                    g.mendan = (g.mendan || 0) + (memberGoals.mendan || 0);
                    g.mendanExec = (g.mendanExec || 0) + (memberGoals.mendanExec || 0);
                    g.seiyaku = (g.seiyaku || 0) + (memberGoals.seiyaku || 0);
                });
            } else {
                // ÁâπÂÆö„É°„É≥„Éê„ÉºÈÅ∏ÊäûÊôÇÔºö„Åù„ÅÆ„É°„É≥„Éê„Éº„ÅÆÁõÆÊ®ô
                g = getMemberGoals(selectedMember);
            }
            const container = document.getElementById('chartsGrid');
            if (!container) return;

            const chartConfigs = [
                { label: 'ÊäïÁ®øÊï∞', key: 'post', goal: g.post || 0 },
                { label: '„Ç¢„ÉùÁç≤Âæó', key: 'apoGet', goal: g.apoGet || 0 },
                { label: '„Ç¢„ÉùÂÆüÊñΩ', key: 'apoExec', goal: g.apoExec || 0 },
                { label: 'ÂãïÂì°Áõ¥„ÇØ„É≠Áç≤Âæó', key: 'doinGet', goal: g.doinGet || 0 },
                { label: 'ÂãïÂì°Áõ¥„ÇØ„É≠ÂÆüÊñΩ', key: 'doinExec', goal: g.doinExec || 0 },
                { label: 'Èù¢Ë´áÁç≤Âæó', key: 'mendanGet', goal: g.mendan || 0 },
                { label: 'Èù¢Ë´áÂÆüÊñΩ', key: 'mendanExec', goal: g.mendanExec || 0 },
                { label: 'ÊàêÁ¥Ñ', key: 'seiyaku', goal: g.seiyaku || 0 }
            ];

            container.innerHTML = chartConfigs.map(config => {
                const { actualData, targetData, numDays, labels } = getChartData(config.key, config.goal);
                const maxVal = Math.max(...actualData, ...targetData, 1);
                const svg = createLargeChartSVG(actualData, targetData, maxVal, numDays, labels);

                return `<div class="chart-card">
                    <h4>${config.label}</h4>
                    <div class="chart-container">${svg}</div>
                    <div class="chart-legend">
                        <span><div class="legend-line target"></div>ÁõÆÊ®ô</span>
                        <span><div class="legend-line actual"></div>ÂÆüÁ∏æ</span>
                    </div>
                </div>`;
            }).join('');
        }

        function renderReviewCharts() {
            // „É°„É≥„Éê„ÉºÈÅ∏Êäû„Å´Âøú„Åò„ÅüÁõÆÊ®ô„ÇíÂèñÂæó
            let g = {};
            if (selectedMember === 'all') {
                data.members.forEach(m => {
                    const memberGoals = getMemberGoals(m.id);
                    g.post = (g.post || 0) + (memberGoals.post || 0);
                    g.apoGet = (g.apoGet || 0) + (memberGoals.apoGet || 0);
                    g.apoExec = (g.apoExec || 0) + (memberGoals.apoExec || 0);
                    g.doinGet = (g.doinGet || 0) + (memberGoals.doinGet || 0);
                    g.doinExec = (g.doinExec || 0) + (memberGoals.doinExec || 0);
                    g.mendan = (g.mendan || 0) + (memberGoals.mendan || 0);
                    g.mendanExec = (g.mendanExec || 0) + (memberGoals.mendanExec || 0);
                    g.seiyaku = (g.seiyaku || 0) + (memberGoals.seiyaku || 0);
                });
            } else {
                g = getMemberGoals(selectedMember);
            }
            const container = document.getElementById('reviewChartsGrid');
            if (!container) return;

            const chartConfigs = [
                { label: 'ÊäïÁ®ø', key: 'post', goal: g.post || 0 },
                { label: '„Ç¢„ÉùÁç≤', key: 'apoGet', goal: g.apoGet || 0 },
                { label: '„Ç¢„ÉùÂÆü', key: 'apoExec', goal: g.apoExec || 0 },
                { label: 'ÂãïÂì°Áç≤', key: 'doinGet', goal: g.doinGet || 0 },
                { label: 'ÂãïÂì°ÂÆü', key: 'doinExec', goal: g.doinExec || 0 },
                { label: 'Èù¢Ë´áÁç≤', key: 'mendanGet', goal: g.mendan || 0 },
                { label: 'Èù¢Ë´áÂÆü', key: 'mendanExec', goal: g.mendanExec || 0 },
                { label: 'ÊàêÁ¥Ñ', key: 'seiyaku', goal: g.seiyaku || 0 }
            ];

            container.innerHTML = chartConfigs.map(config => {
                const { actualData, targetData, numDays } = getChartData(config.key, config.goal);
                const maxVal = Math.max(...actualData, ...targetData, 1);
                const svg = createCompactChartSVG(actualData, targetData, maxVal, numDays);

                return `<div style="background:#0f172a;border-radius:6px;padding:6px">
                    <div style="font-size:9px;color:#94a3b8;margin-bottom:4px">${config.label}</div>
                    <div style="height:40px">${svg}</div>
                </div>`;
            }).join('');
        }

        function createCompactChartSVG(actualData, targetData, maxVal, numDays) {
            const width = 140;
            const height = 40;
            const padding = 2;

            const xScale = (width - padding * 2) / (numDays - 1 || 1);
            const yScale = (height - padding * 2) / maxVal;

            const toPoint = (val, i) => {
                const x = padding + i * xScale;
                const y = height - padding - val * yScale;
                return `${x},${y}`;
            };

            const targetPoints = targetData.map((v, i) => toPoint(v, i)).join(' ');
            const actualPoints = actualData.map((v, i) => toPoint(v, i)).join(' ');

            return `<svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none" style="width:100%;height:100%">
                <polyline points="${targetPoints}" fill="none" stroke="#64748b" stroke-width="1" stroke-dasharray="2,2" />
                <polyline points="${actualPoints}" fill="none" stroke="#6366f1" stroke-width="1.5" />
            </svg>`;
        }

        function getChartData(metricKey, monthlyGoal) {
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const effectiveDays = daysInMonth - 3; // ‰Ωø„Åà„ÇãÊó•Êï∞
            let actualData = [];
            let targetData = [];
            let labels = [];
            let numDays;

            if (viewPeriod === 'month') {
                numDays = daysInMonth;
                const dailyGoal = monthlyGoal / effectiveDays;

                let cumulative = 0;
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayValue = getDayValueForChart(metricKey, day);
                    cumulative += dayValue;
                    actualData.push(cumulative);
                    targetData.push(dailyGoal * Math.min(day, effectiveDays));
                    labels.push(day.toString());
                }
            } else {
                numDays = 7;
                const weeklyGoal = (monthlyGoal / effectiveDays) * 7;
                const dailyGoal = weeklyGoal / 7;
                const dates = getWeekDates();
                const dayNames = ['Âúü','Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë'];

                let cumulative = 0;
                for (let i = 0; i < 7; i++) {
                    const dayValue = getWeekDayValueForChart(metricKey, i);
                    cumulative += dayValue;
                    actualData.push(cumulative);
                    targetData.push(dailyGoal * (i + 1));
                    labels.push(`${dates[i].getDate()}(${dayNames[i]})`);
                }
            }

            return { actualData, targetData, numDays, labels };
        }

        function getDayValueForChart(metricKey, day) {
            const date = new Date(currentYear, currentMonth - 1, day);
            if (date.getMonth() !== currentMonth - 1) return 0;

            const firstDay = new Date(currentYear, currentMonth - 1, 1);
            const dow = (firstDay.getDay() + 1) % 7;
            const weekNum = Math.ceil((day + dow) / 7);
            const dayOfWeek = (date.getDay() + 1) % 7;

            const weekKey = `${currentYear}-${currentMonth}-W${weekNum}`;
            const members = selectedMember === 'all' ? data.members : data.members.filter(m => m.id === selectedMember);

            let total = 0;
            members.forEach(m => {
                const weekData = data.weeks[weekKey];
                if (weekData && weekData.daily && weekData.daily[m.id]) {
                    const arr = weekData.daily[m.id][metricKey];
                    if (Array.isArray(arr)) {
                        total += arr[dayOfWeek] || 0;
                    } else if (arr && typeof arr === 'object') {
                        total += arr[dayOfWeek] || 0;
                    }
                }
            });
            return total;
        }

        function getWeekDayValueForChart(metricKey, dayIndex) {
            const members = selectedMember === 'all' ? data.members : data.members.filter(m => m.id === selectedMember);
            let total = 0;
            members.forEach(m => {
                const d = getMemberDaily(m.id);
                total += (d[metricKey] || [0,0,0,0,0,0,0])[dayIndex] || 0;
            });
            return total;
        }

        function createMiniChartSVG(actualData, targetData, maxVal, numDays) {
            const width = 120;
            const height = 40;
            const padding = 2;

            const xScale = (width - padding * 2) / (numDays - 1 || 1);
            const yScale = (height - padding * 2) / maxVal;

            const toPoint = (val, i) => {
                const x = padding + i * xScale;
                const y = height - padding - val * yScale;
                return `${x},${y}`;
            };

            const targetPoints = targetData.map((v, i) => toPoint(v, i)).join(' ');
            const actualPoints = actualData.map((v, i) => toPoint(v, i)).join(' ');

            return `<svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
                <polyline points="${targetPoints}" fill="none" stroke="#64748b" stroke-width="1" stroke-dasharray="3,2" />
                <polyline points="${actualPoints}" fill="none" stroke="#6366f1" stroke-width="2" />
            </svg>`;
        }

        function createLargeChartSVG(actualData, targetData, maxVal, numDays, labels) {
            const width = 280;
            const height = 120;
            const paddingLeft = 30;
            const paddingRight = 10;
            const paddingTop = 10;
            const paddingBottom = 25;

            const chartWidth = width - paddingLeft - paddingRight;
            const chartHeight = height - paddingTop - paddingBottom;

            const xScale = chartWidth / (numDays - 1 || 1);
            const yScale = chartHeight / maxVal;

            const toX = (i) => paddingLeft + i * xScale;
            const toY = (val) => height - paddingBottom - val * yScale;

            const toPoint = (val, i) => `${toX(i)},${toY(val)}`;

            const targetPoints = targetData.map((v, i) => toPoint(v, i)).join(' ');
            const actualPoints = actualData.map((v, i) => toPoint(v, i)).join(' ');

            // YËª∏„ÅÆ„Ç∞„É™„ÉÉ„Éâ„É©„Ç§„É≥
            const ySteps = 4;
            const yStep = maxVal / ySteps;
            let yAxisLabels = '';
            let gridLines = '';
            for (let i = 0; i <= ySteps; i++) {
                const val = Math.round(yStep * i);
                const y = toY(val);
                yAxisLabels += `<text x="${paddingLeft - 5}" y="${y + 3}" text-anchor="end" font-size="9" fill="#64748b">${val}</text>`;
                if (i > 0) {
                    gridLines += `<line x1="${paddingLeft}" y1="${y}" x2="${width - paddingRight}" y2="${y}" stroke="#334155" stroke-width="0.5" />`;
                }
            }

            // XËª∏„ÅÆ„É©„Éô„É´ÔºàÈñìÂºï„ÅÑ„Å¶Ë°®Á§∫Ôºâ
            let xAxisLabels = '';
            const labelInterval = numDays <= 7 ? 1 : Math.ceil(numDays / 7);
            for (let i = 0; i < numDays; i += labelInterval) {
                const x = toX(i);
                xAxisLabels += `<text x="${x}" y="${height - 5}" text-anchor="middle" font-size="8" fill="#64748b">${labels[i]}</text>`;
            }

            // ÂÆüÁ∏æ„Éá„Éº„Çø„ÅÆ„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Éù„Ç§„É≥„Éà
            let actualCircles = '';
            for (let i = 0; i < numDays; i++) {
                const x = toX(i);
                const y = toY(actualData[i]);
                actualCircles += `<circle cx="${x}" cy="${y}" r="4" fill="#6366f1" stroke="#1e293b" stroke-width="1"
                    data-label="${labels[i]}" data-value="${actualData[i]}" data-target="${targetData[i]}" class="chart-point"
                    onmouseenter="showChartTooltip(event)" onmouseleave="hideChartTooltip()" />`;
            }

            return `<svg viewBox="0 0 ${width} ${height}">
                ${gridLines}
                <line x1="${paddingLeft}" y1="${height - paddingBottom}" x2="${width - paddingRight}" y2="${height - paddingBottom}" stroke="#334155" stroke-width="1" />
                <line x1="${paddingLeft}" y1="${paddingTop}" x2="${paddingLeft}" y2="${height - paddingBottom}" stroke="#334155" stroke-width="1" />
                ${yAxisLabels}
                ${xAxisLabels}
                <polyline points="${targetPoints}" fill="none" stroke="#64748b" stroke-width="1.5" stroke-dasharray="4,3" />
                <polyline points="${actualPoints}" fill="none" stroke="#6366f1" stroke-width="2" />
                ${actualCircles}
            </svg>`;
        }

        function renderMemberTable() {
            document.getElementById('memberTable').innerHTML = data.members.map(m => {
                const t = calcMemberTotals(m.id);
                return `<tr>
                    <td><strong>${m.name}</strong></td>
                    <td>${t.post || 0}</td>
                    <td>${t.apoGet}</td><td>${t.apoExec}</td>
                    <td>${t.apoCxl}</td><td>${t.testClose}</td><td>${t.offer}</td>
                    <td>${t.ng}</td><td>${t.muchaku}</td><td>${t.doinGet}</td>
                    <td>${t.doinExec}</td><td>${t.mendanGet}</td><td>${t.mendanExec}</td><td>${t.seiyaku}</td>
                </tr>`;
            }).join('');
        }

        function renderDailyInput() {
            if (viewPeriod === 'month') {
                renderDailyInputMonth();
                return;
            }

            const dates = getWeekDates();
            const days = ['Âúü','Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë'];

            // „Éò„ÉÉ„ÉÄ„Éº
            let html = `<div class="daily-header"><div class="daily-cell header">È†ÖÁõÆ</div>${dates.map((d, i) => `<div class="daily-cell header">${days[i]}<br>${d.getMonth()+1}/${d.getDate()}</div>`).join('')}<div class="daily-cell header">ÂêàË®à</div></div>`;

            const members = selectedMember === 'all' ? data.members : data.members.filter(m => m.id === selectedMember);
            members.forEach(member => {
                const isMyData = canEditMember(member.id);
                const disabledAttr = isMyData ? '' : 'disabled';
                const rowStyle = isMyData ? '' : 'opacity:0.6;';
                const lockIcon = isMyData ? '' : ' üîí';

                html += `<div class="daily-row" style="${rowStyle}"><div class="daily-cell category" style="grid-column:1/-1">${member.name}${lockIcon}</div></div>`;
                metrics.forEach(cat => {
                    html += `<div class="daily-row" style="${rowStyle}"><div class="daily-cell label" style="color:#94a3b8;font-size:11px">${cat.cat}</div><div style="grid-column:2/-1"></div></div>`;
                    cat.items.forEach(m => {
                        const d = getMemberDaily(member.id);
                        const arr = d[m.key] || [0,0,0,0,0,0,0];
                        const total = arr.reduce((a,b)=>a+b,0);

                        if (m.key === 'muchaku') {
                            // ÁÑ°ÁùÄÂú∞„ÅØÁêÜÁî±„Éú„Çø„É≥‰ªò„Åç
                            html += `<div class="daily-row sub"><div class="daily-cell label">${m.label}</div>`;
                            html += [0,1,2,3,4,5,6].map(i => {
                                const dateLabel = `${dates[i].getMonth()+1}/${dates[i].getDate()}`;
                                const hasReasons = hasMuchakuReasons(member.id, i);
                                const btnStyle = arr[i] > 0 ? (hasReasons ? 'background:#22c55e;' : 'background:#eab308;') : 'background:#475569;opacity:0.5;';
                                return `<div class="daily-cell" style="display:flex;gap:2px;align-items:center;padding:2px">
                                    <input type="number" value="${arr[i]}" min="0" style="width:35px" ${disabledAttr} onchange="updateDaily('${member.id}','${m.key}',${i},this.value)">
                                    <button onclick="openMuchakuModal('${member.id}',${i},'${dateLabel}')" ${disabledAttr} style="padding:2px 6px;border:none;border-radius:4px;cursor:pointer;font-size:10px;color:white;${btnStyle}" title="ÁêÜÁî±„ÇíË®òÈå≤">?</button>
                                </div>`;
                            }).join('');
                            html += `<div class="daily-cell total">${total}</div></div>`;
                        } else if (m.key === 'ng') {
                            // NG„ÅØÁêÜÁî±„Éú„Çø„É≥‰ªò„Åç
                            html += `<div class="daily-row sub"><div class="daily-cell label">${m.label}</div>`;
                            html += [0,1,2,3,4,5,6].map(i => {
                                const dateLabel = `${dates[i].getMonth()+1}/${dates[i].getDate()}`;
                                const hasReasons = hasNgReasons(member.id, i);
                                const btnStyle = arr[i] > 0 ? (hasReasons ? 'background:#22c55e;' : 'background:#eab308;') : 'background:#475569;opacity:0.5;';
                                return `<div class="daily-cell" style="display:flex;gap:2px;align-items:center;padding:2px">
                                    <input type="number" value="${arr[i]}" min="0" style="width:35px" ${disabledAttr} onchange="updateDaily('${member.id}','${m.key}',${i},this.value)">
                                    <button onclick="openNgModal('${member.id}',${i},'${dateLabel}')" ${disabledAttr} style="padding:2px 6px;border:none;border-radius:4px;cursor:pointer;font-size:10px;color:white;${btnStyle}" title="NGÁêÜÁî±„ÇíË®òÈå≤">?</button>
                                </div>`;
                            }).join('');
                            html += `<div class="daily-cell total">${total}</div></div>`;
                        } else {
                            html += `<div class="daily-row sub"><div class="daily-cell label">${m.label}</div>${[0,1,2,3,4,5,6].map(i => `<div class="daily-cell"><input type="number" value="${arr[i]}" min="0" ${disabledAttr} onchange="updateDaily('${member.id}','${m.key}',${i},this.value)"></div>`).join('')}<div class="daily-cell total">${total}</div></div>`;
                        }
                    });
                });
            });
            document.getElementById('dailyInputArea').innerHTML = html;
        }

        function renderDailyInputMonth() {
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const members = selectedMember === 'all' ? data.members : data.members.filter(m => m.id === selectedMember);

            // ÊúàÊ¨°Ë°®Á§∫Áî®„ÅÆ„Ç∞„É™„ÉÉ„Éâ„Çπ„Çø„Ç§„É´
            const gridCols = `120px repeat(${daysInMonth}, 45px) 60px`;

            let html = `<div style="overflow-x:auto"><div style="min-width:${120 + daysInMonth * 49 + 60}px">`;

            // „Éò„ÉÉ„ÉÄ„ÉºË°å
            html += `<div style="display:grid;grid-template-columns:${gridCols};gap:2px;margin-bottom:4px;position:sticky;top:0;background:#1e293b;z-index:10;padding:8px 0">`;
            html += `<div class="daily-cell header">È†ÖÁõÆ</div>`;
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(currentYear, currentMonth - 1, d);
                const dayName = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'][date.getDay()];
                html += `<div class="daily-cell header" style="font-size:10px">${d}<br>${dayName}</div>`;
            }
            html += `<div class="daily-cell header">Ë®à</div></div>`;

            members.forEach(member => {
                const isMyData = canEditMember(member.id);
                const disabledAttr = isMyData ? '' : 'disabled';
                const rowStyle = isMyData ? '' : 'opacity:0.6;';
                const lockIcon = isMyData ? '' : ' üîí';

                html += `<div style="display:grid;grid-template-columns:${gridCols};gap:2px;margin-bottom:2px;${rowStyle}"><div class="daily-cell category" style="grid-column:1/-1">${member.name}${lockIcon}</div></div>`;

                metrics.forEach(cat => {
                    html += `<div style="display:grid;grid-template-columns:${gridCols};gap:2px;margin-bottom:2px;${rowStyle}"><div class="daily-cell label" style="color:#94a3b8;font-size:11px">${cat.cat}</div><div style="grid-column:2/-1"></div></div>`;

                    cat.items.forEach(m => {
                        let total = 0;
                        html += `<div style="display:grid;grid-template-columns:${gridCols};gap:2px;margin-bottom:2px;padding-left:20px;${rowStyle}">`;
                        html += `<div class="daily-cell label" style="width:100px">${m.label}</div>`;

                        for (let d = 1; d <= daysInMonth; d++) {
                            const val = getMonthDayValue(member.id, m.key, d);
                            total += val;
                            html += `<div class="daily-cell"><input type="number" value="${val}" min="0" style="width:100%;font-size:11px;padding:2px" ${disabledAttr} onchange="updateMonthDay('${member.id}','${m.key}',${d},this.value)"></div>`;
                        }

                        html += `<div class="daily-cell total">${total}</div></div>`;
                    });
                });
            });

            html += `</div></div>`;
            document.getElementById('dailyInputArea').innerHTML = html;
        }

        function getMonthDayValue(memberId, metricKey, day) {
            const date = new Date(currentYear, currentMonth - 1, day);
            const firstDay = new Date(currentYear, currentMonth - 1, 1);
            const dow = (firstDay.getDay() + 1) % 7;
            const weekNum = Math.ceil((day + dow) / 7);
            const dayOfWeek = (date.getDay() + 1) % 7;

            const weekKey = `${currentYear}-${currentMonth}-W${weekNum}`;
            const weekData = data.weeks[weekKey];
            if (weekData && weekData.daily && weekData.daily[memberId]) {
                const arr = weekData.daily[memberId][metricKey];
                if (arr) return (Array.isArray(arr) ? arr : Object.values(arr))[dayOfWeek] || 0;
            }
            return 0;
        }

        function updateMonthDay(memberId, metricKey, day, value) {
            const date = new Date(currentYear, currentMonth - 1, day);
            const firstDay = new Date(currentYear, currentMonth - 1, 1);
            const dow = (firstDay.getDay() + 1) % 7;
            const weekNum = Math.ceil((day + dow) / 7);
            const dayOfWeek = (date.getDay() + 1) % 7;

            const weekKey = `${currentYear}-${currentMonth}-W${weekNum}`;
            if (!data.weeks[weekKey]) {
                data.weeks[weekKey] = {
                    daily: {}, review: { mainIssue: '', mainCause: '', causeActions: [{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]}], muchakuReasons: {}, muchakuOther: '', ngReasons: {}, doinMuchakuList: [], cases: [], cancels: [] },
                    instagram: {}, nippo: {}
                };
            }
            if (!data.weeks[weekKey].daily[memberId]) {
                data.weeks[weekKey].daily[memberId] = {};
                metrics.forEach(c => c.items.forEach(m => { data.weeks[weekKey].daily[memberId][m.key] = [0,0,0,0,0,0,0]; }));
            }

            data.weeks[weekKey].daily[memberId][metricKey][dayOfWeek] = parseInt(value) || 0;
            saveData();
            renderSummary();
            renderMemberTable();
        }

        function updateDaily(memberId, key, idx, val) {
            getMemberDaily(memberId)[key][idx] = parseInt(val) || 0;
            saveData();
            renderSummary();
            renderMemberTable();
            const total = getMemberDaily(memberId)[key].reduce((a,b) => a+b, 0);
            event.target.closest('.daily-row').querySelector('.total').textContent = total;
        }

        function renderReview() {
            const r = getMemberReview();

            document.getElementById('mainIssue').value = r.mainIssue || '';
            document.getElementById('mainCause').value = r.mainCause || '';

            // ÁÑ°ÁùÄÂú∞ÁêÜÁî±ÔºàUIÂâäÈô§Ê∏à„ÅøÔºâ
            // document.getElementById('muchakuReasons').innerHTML = ...
            // document.getElementById('muchakuOther').value = r.muchakuOther || '';

            // NGÁêÜÁî±ÔºàUIÂâäÈô§Ê∏à„ÅøÔºâ
            // document.getElementById('ngReasons').innerHTML = ...

            renderCases();
            renderCancels();
            renderDoinMuchaku();
            renderCauseActions();
        }

        function saveReview() {
            const r = getMemberReview();
            r.mainIssue = document.getElementById('mainIssue').value;
            r.mainCause = document.getElementById('mainCause').value;
            // r.muchakuOther = document.getElementById('muchakuOther').value; // UIÂâäÈô§Ê∏à„Åø
            saveData();
        }

        function saveTopReasonAction() {
            const r = getMemberReview();
            r.topReasonAction = document.getElementById('rsTopReasonAction').value;
            saveData();
        }

        function updateMuchakuReason(i, v) { getWeekData().review.muchakuReasons[i] = parseInt(v)||0; saveData(); }
        function updateNgReason(i, v) { getWeekData().review.ngReasons[i] = parseInt(v)||0; saveData(); }

        // Êó•Âà•ÁÑ°ÁùÄÂú∞ÁêÜÁî±„ÅÆÁÆ°ÁêÜ
        let currentMuchakuMember = null;
        let currentMuchakuDay = null;

        function getMemberMuchakuReasons(memberId) {
            const d = getMemberDaily(memberId);
            if (!d.muchakuReasonsByDay) d.muchakuReasonsByDay = {};
            return d.muchakuReasonsByDay;
        }

        function openMuchakuModal(memberId, dayIndex, dateLabel) {
            currentMuchakuMember = memberId;
            currentMuchakuDay = dayIndex;

            const memberData = getMemberDaily(memberId);
            const muchakuCount = (memberData.muchaku || [0,0,0,0,0,0,0])[dayIndex] || 0;

            document.getElementById('muchakuModalDate').textContent = `(${dateLabel})`;
            document.getElementById('muchakuTargetCount').textContent = muchakuCount;

            const reasons = getMemberMuchakuReasons(memberId)[dayIndex] || { counts: [0,0,0,0,0,0,0], otherNote: '' };

            let html = muchakuReasonLabels.map((label, i) =>
                `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#0f172a;border-radius:6px">
                    <span>${label}</span>
                    <input type="number" class="input-sm muchaku-reason-input" data-index="${i}" value="${reasons.counts[i] || 0}" min="0" style="width:60px" onchange="updateMuchakuReasonTotal()">
                </div>`
            ).join('');
            document.getElementById('muchakuReasonInputs').innerHTML = html;
            document.getElementById('muchakuOtherNote').value = reasons.otherNote || '';

            updateMuchakuReasonTotal();
            openModal('muchakuModal');
        }

        function updateMuchakuReasonTotal() {
            const inputs = document.querySelectorAll('.muchaku-reason-input');
            let total = 0;
            inputs.forEach(inp => { total += parseInt(inp.value) || 0; });
            document.getElementById('muchakuReasonTotal').textContent = total;

            const target = parseInt(document.getElementById('muchakuTargetCount').textContent) || 0;
            const totalEl = document.getElementById('muchakuReasonTotal');
            if (total === target) {
                totalEl.style.color = '#22c55e';
            } else if (total > target) {
                totalEl.style.color = '#ef4444';
            } else {
                totalEl.style.color = '#eab308';
            }
        }

        function saveMuchakuReasons() {
            const inputs = document.querySelectorAll('.muchaku-reason-input');
            const counts = [];
            inputs.forEach(inp => { counts.push(parseInt(inp.value) || 0); });
            const otherNote = document.getElementById('muchakuOtherNote').value;

            const reasons = getMemberMuchakuReasons(currentMuchakuMember);
            reasons[currentMuchakuDay] = { counts, otherNote };

            saveData();
            closeModal('muchakuModal');
            renderDailyInput();

            // ÈÄ±Ê¨°„É¨„Éì„É•„Éº„ÅÆÁÑ°ÁùÄÂú∞ÁêÜÁî±„ÇÇËá™ÂãïÊõ¥Êñ∞
            aggregateMuchakuReasons();
        }

        function aggregateMuchakuReasons() {
            // ÂÖ®„É°„É≥„Éê„Éº„ÅÆÂÖ®Êó•„ÅÆÁÑ°ÁùÄÂú∞ÁêÜÁî±„ÇíÈõÜË®à„Åó„Å¶ÈÄ±Ê¨°„É¨„Éì„É•„Éº„Å´ÂèçÊò†
            const totals = [0,0,0,0,0,0,0];
            data.members.forEach(member => {
                const reasons = getMemberMuchakuReasons(member.id);
                for (let day = 0; day < 7; day++) {
                    if (reasons[day] && reasons[day].counts) {
                        reasons[day].counts.forEach((c, i) => {
                            totals[i] += c;
                        });
                    }
                }
            });
            const review = getWeekData().review;
            totals.forEach((t, i) => { review.muchakuReasons[i] = t; });
            saveData();
            renderReview();
        }

        function hasMuchakuReasons(memberId, dayIndex) {
            const reasons = getMemberMuchakuReasons(memberId)[dayIndex];
            if (!reasons) return false;
            return reasons.counts && reasons.counts.some(c => c > 0);
        }

        // Êó•Âà•NGÁêÜÁî±„ÅÆÁÆ°ÁêÜ
        let currentNgMember = null;
        let currentNgDay = null;

        function getMemberNgReasons(memberId) {
            const d = getMemberDaily(memberId);
            if (!d.ngReasonsByDay) d.ngReasonsByDay = {};
            return d.ngReasonsByDay;
        }

        function openNgModal(memberId, dayIndex, dateLabel) {
            currentNgMember = memberId;
            currentNgDay = dayIndex;

            const memberData = getMemberDaily(memberId);
            const ngCount = (memberData.ng || [0,0,0,0,0,0,0])[dayIndex] || 0;

            document.getElementById('ngModalDate').textContent = `(${dateLabel})`;
            document.getElementById('ngTargetCount').textContent = ngCount;

            const reasons = getMemberNgReasons(memberId)[dayIndex] || { counts: [0,0,0,0,0], otherNote: '' };

            let html = ngReasonLabels.map((label, i) =>
                `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#0f172a;border-radius:6px">
                    <span>${label}</span>
                    <input type="number" class="input-sm ng-reason-input" data-index="${i}" value="${reasons.counts[i] || 0}" min="0" style="width:60px" onchange="updateNgReasonTotal()">
                </div>`
            ).join('');
            document.getElementById('ngReasonInputs').innerHTML = html;
            document.getElementById('ngOtherNote').value = reasons.otherNote || '';

            updateNgReasonTotal();
            openModal('ngModal');
        }

        function updateNgReasonTotal() {
            const inputs = document.querySelectorAll('.ng-reason-input');
            let total = 0;
            inputs.forEach(inp => { total += parseInt(inp.value) || 0; });
            document.getElementById('ngReasonTotal').textContent = total;

            const target = parseInt(document.getElementById('ngTargetCount').textContent) || 0;
            const totalEl = document.getElementById('ngReasonTotal');
            if (total === target) {
                totalEl.style.color = '#22c55e';
            } else if (total > target) {
                totalEl.style.color = '#ef4444';
            } else {
                totalEl.style.color = '#eab308';
            }
        }

        function saveNgReasons() {
            const inputs = document.querySelectorAll('.ng-reason-input');
            const counts = [];
            inputs.forEach(inp => { counts.push(parseInt(inp.value) || 0); });
            const otherNote = document.getElementById('ngOtherNote').value;

            const reasons = getMemberNgReasons(currentNgMember);
            reasons[currentNgDay] = { counts, otherNote };

            saveData();
            closeModal('ngModal');
            renderDailyInput();

            // ÈÄ±Ê¨°„É¨„Éì„É•„Éº„ÅÆNGÁêÜÁî±„ÇÇËá™ÂãïÊõ¥Êñ∞
            aggregateNgReasons();
        }

        function aggregateNgReasons() {
            // ÂÖ®„É°„É≥„Éê„Éº„ÅÆÂÖ®Êó•„ÅÆNGÁêÜÁî±„ÇíÈõÜË®à„Åó„Å¶ÈÄ±Ê¨°„É¨„Éì„É•„Éº„Å´ÂèçÊò†
            const totals = [0,0,0,0,0];
            data.members.forEach(member => {
                const reasons = getMemberNgReasons(member.id);
                for (let day = 0; day < 7; day++) {
                    if (reasons[day] && reasons[day].counts) {
                        reasons[day].counts.forEach((c, i) => {
                            totals[i] += c;
                        });
                    }
                }
            });
            const review = getWeekData().review;
            if (!review.ngReasons) review.ngReasons = {};
            totals.forEach((t, i) => { review.ngReasons[i] = t; });
            saveData();
            renderReview();
        }

        function hasNgReasons(memberId, dayIndex) {
            const reasons = getMemberNgReasons(memberId)[dayIndex];
            if (!reasons) return false;
            return reasons.counts && reasons.counts.some(c => c > 0);
        }

        // ÊÆãÊ°à‰ª∂ÔºàSupabaseÈÄ£Êê∫ÊôÇ„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºâ
        function renderCases() {
            if (supabaseCasesCache && supabaseCasesCache.length > 0) { renderSupabaseInputSection(); return; }
            const allCases = getWeekData().review.cases || [];
            // „É°„É≥„Éê„Éº„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÔºàÂÖÉ„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Çí‰øùÊåÅÔºâ
            const filteredCases = allCases.map((c, i) => ({...c, _idx: i}))
                .filter(c => selectedMember === 'all' || !c.memberId || c.memberId === selectedMember);
            document.getElementById('sCasesCount').textContent = `(${filteredCases.length}‰ª∂)`;
            document.getElementById('caseList').innerHTML = filteredCases.length === 0 ? '<p style="color:#64748b;font-size:13px">ÊÆãÊ°à‰ª∂„Å™„Åó</p>' :
                filteredCases.map(c => {
                    const isEditable = !c.memberId || canEditMember(c.memberId);
                    const memberName = c.memberId ? (data.members.find(m => m.id === c.memberId)?.name || '') : '';
                    const memberBadge = selectedMember === 'all' && memberName ? `<span style="font-size:10px;background:#6366f1;padding:2px 6px;border-radius:4px;margin-right:4px">${memberName}</span>` : '';
                    return `<div class="case-item" style="${isEditable ? '' : 'opacity:0.6'}">${memberBadge}<input type="text" value="${c.date||''}" placeholder="Êó•‰ªò" onchange="updateCase(${c._idx},'date',this.value)" ${isEditable ? '' : 'disabled'}><input type="text" value="${c.customer||''}" placeholder="È°ßÂÆ¢Âêç" onchange="updateCase(${c._idx},'customer',this.value)" ${isEditable ? '' : 'disabled'}><input type="text" value="${c.closer||''}" placeholder="„ÇØ„É≠„Éº„Ç∂„Éº" onchange="updateCase(${c._idx},'closer',this.value)" ${isEditable ? '' : 'disabled'}><button class="btn btn-danger btn-sm" onclick="deleteCase(${c._idx})" ${isEditable ? '' : 'disabled'}>√ó</button></div>`;
                }).join('');
        }
        function addCase() {
            const currentUserId = getCurrentMemberId();
            if (!currentUserId) { alert('„É¶„Éº„Ç∂„Éº„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            getWeekData().review.cases.push({ memberId: currentUserId });
            saveData(); renderCases();
        }
        function updateCase(i,k,v) { getWeekData().review.cases[i][k] = v; saveData(); }
        function deleteCase(i) { getWeekData().review.cases.splice(i,1); saveData(); renderCases(); }

        // „Ç≠„É£„É≥„Çª„É´
        function renderCancels() {
            const allCancels = getWeekData().review.cancels || [];
            // „É°„É≥„Éê„Éº„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÔºàÂÖÉ„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Çí‰øùÊåÅÔºâ
            const filteredCancels = allCancels.map((c, i) => ({...c, _idx: i}))
                .filter(c => selectedMember === 'all' || !c.memberId || c.memberId === selectedMember);
            document.getElementById('sCancelsCount').textContent = `(${filteredCancels.length}‰ª∂)`;
            document.getElementById('cancelList').innerHTML = filteredCancels.length === 0 ? '<p style="color:#64748b;font-size:13px">„Ç≠„É£„É≥„Çª„É´„Å™„Åó</p>' :
                filteredCancels.map(c => {
                    const isEditable = !c.memberId || canEditMember(c.memberId);
                    const memberName = c.memberId ? (data.members.find(m => m.id === c.memberId)?.name || '') : '';
                    const memberBadge = selectedMember === 'all' && memberName ? `<span style="font-size:10px;background:#6366f1;padding:2px 6px;border-radius:4px;margin-right:4px">${memberName}</span>` : '';
                    return `
                    <div style="padding:10px;background:#0f172a;border-radius:6px;margin-bottom:8px;border-left:3px solid #eab308;${isEditable ? '' : 'opacity:0.6'}">
                        ${memberBadge}
                        <div style="display:grid;grid-template-columns:80px 1fr 80px 30px;gap:8px;align-items:center;margin-bottom:8px">
                            <input type="text" value="${c.date||''}" placeholder="Êó•‰ªò" style="font-size:12px" onchange="updateCancel(${c._idx},'date',this.value)" ${isEditable ? '' : 'disabled'}>
                            <input type="text" value="${c.customer||''}" placeholder="È°ßÂÆ¢Âêç" style="font-size:12px" onchange="updateCancel(${c._idx},'customer',this.value)" ${isEditable ? '' : 'disabled'}>
                            <input type="text" value="${c.closer||''}" placeholder="„ÇØ„É≠„Éº„Ç∂„Éº" style="font-size:12px" onchange="updateCancel(${c._idx},'closer',this.value)" ${isEditable ? '' : 'disabled'}>
                            <button class="btn btn-danger btn-sm" onclick="deleteCancel(${c._idx})" ${isEditable ? '' : 'disabled'}>√ó</button>
                        </div>
                        <input type="text" value="${c.reason||''}" placeholder="„Ç≠„É£„É≥„Çª„É´ÁêÜÁî±..." style="width:100%;font-size:12px" onchange="updateCancel(${c._idx},'reason',this.value)" ${isEditable ? '' : 'disabled'}>
                    </div>
                `}).join('');
        }
        function addCancel() {
            const currentUserId = getCurrentMemberId();
            if (!currentUserId) { alert('„É¶„Éº„Ç∂„Éº„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            getWeekData().review.cancels.push({ memberId: currentUserId });
            saveData(); renderCancels();
        }
        function updateCancel(i,k,v) { getWeekData().review.cancels[i][k] = v; saveData(); renderCancels(); }
        function deleteCancel(i) { getWeekData().review.cancels.splice(i,1); saveData(); renderCancels(); }

        // ÂãïÂì°ÂæåÁÑ°ÁùÄÂú∞
        function renderDoinMuchaku() {
            const r = getWeekData().review;
            if (!r.doinMuchakuList) r.doinMuchakuList = [];
            const allList = r.doinMuchakuList;
            // „É°„É≥„Éê„Éº„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÔºàÂÖÉ„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Çí‰øùÊåÅÔºâ
            const filteredList = allList.map((item, i) => ({...item, _idx: i}))
                .filter(item => selectedMember === 'all' || !item.memberId || item.memberId === selectedMember);
            document.getElementById('sDoinMuchakuLabel').textContent = `(${filteredList.length}‰ª∂)`;
            document.getElementById('doinMuchakuList').innerHTML = filteredList.length === 0 ? '<p style="color:#64748b;font-size:13px">ÂãïÂì°ÂæåÁÑ°ÁùÄÂú∞„Å™„Åó</p>' :
                filteredList.map(item => {
                    const isEditable = !item.memberId || canEditMember(item.memberId);
                    const memberName = item.memberId ? (data.members.find(m => m.id === item.memberId)?.name || '') : '';
                    const memberBadge = selectedMember === 'all' && memberName ? `<span style="font-size:10px;background:#6366f1;padding:2px 6px;border-radius:4px;margin-right:4px">${memberName}</span>` : '';
                    return `
                    <div style="padding:10px;background:#0f172a;border-radius:6px;margin-bottom:8px;border-left:3px solid #ef4444;${isEditable ? '' : 'opacity:0.6'}">
                        ${memberBadge}
                        <div style="display:grid;grid-template-columns:80px 1fr 80px 30px;gap:8px;align-items:center;margin-bottom:8px">
                            <input type="text" value="${item.date || ''}" placeholder="Êó•‰ªò" style="font-size:12px" onchange="updateDoinMuchaku(${item._idx},'date',this.value)" ${isEditable ? '' : 'disabled'}>
                            <input type="text" value="${item.customer || ''}" placeholder="È°ßÂÆ¢Âêç" style="font-size:12px" onchange="updateDoinMuchaku(${item._idx},'customer',this.value)" ${isEditable ? '' : 'disabled'}>
                            <input type="text" value="${item.closer || ''}" placeholder="„ÇØ„É≠„Éº„Ç∂„Éº" style="font-size:12px" onchange="updateDoinMuchaku(${item._idx},'closer',this.value)" ${isEditable ? '' : 'disabled'}>
                            <button class="btn btn-danger btn-sm" onclick="deleteDoinMuchaku(${item._idx})" ${isEditable ? '' : 'disabled'}>√ó</button>
                        </div>
                        <input type="text" value="${item.reason || ''}" placeholder="ÁÑ°ÁùÄÂú∞ÁêÜÁî±..." style="width:100%;font-size:12px" onchange="updateDoinMuchaku(${item._idx},'reason',this.value)" ${isEditable ? '' : 'disabled'}>
                    </div>
                `}).join('');
        }
        function addDoinMuchaku() {
            const currentUserId = getCurrentMemberId();
            if (!currentUserId) { alert('„É¶„Éº„Ç∂„Éº„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            const r = getWeekData().review;
            if (!r.doinMuchakuList) r.doinMuchakuList = [];
            r.doinMuchakuList.push({ memberId: currentUserId });
            saveData();
            renderDoinMuchaku();
        }
        function updateDoinMuchaku(i, k, v) {
            const r = getWeekData().review;
            if (!r.doinMuchakuList) r.doinMuchakuList = [];
            r.doinMuchakuList[i][k] = v;
            saveData();
            renderDoinMuchaku();
            renderSummary();
        }
        function deleteDoinMuchaku(i) {
            const r = getWeekData().review;
            r.doinMuchakuList.splice(i, 1);
            saveData();
            renderDoinMuchaku();
            renderSummary();
        }

        // ÂéüÂõ†+ÊñΩÁ≠ñ
        function renderCauseActions() {
            const r = getMemberReview();
            if (!r.causeActions) r.causeActions = [{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]}];
            document.getElementById('causeActionList').innerHTML = [0,1,2,3,4].map(i => {
                const ca = r.causeActions[i] || { cause: '', actions: [] };
                const actionsHtml = (ca.actions || []).map((a,j) => `
                    <div class="action-row ${a.done?'completed':''}">
                        <input type="text" value="${a.text||''}" placeholder="ÊñΩÁ≠ñ„ÇíÂÖ•Âäõ..." onchange="updateCauseAction(${i},${j},'text',this.value)">
                        <input type="text" value="${a.deadline||''}" placeholder="ÊúüÈôê" onchange="updateCauseAction(${i},${j},'deadline',this.value)">
                        <select onchange="updateCauseAction(${i},${j},'method',this.value)">
                            <option value="">ÁÆ°ÁêÜÊñπÊ≥ï</option>
                            ${['„ÉÅ„É£„ÉÉ„Éà','Google„Ç´„É¨„É≥„ÉÄ„Éº','FB','Èå≤ÁîªÊåØ„ÇäËøî„Çä','„Ç¢„Éù','„Ç¢„É©„Éº„É†'].map(m => `<option value="${m}" ${a.method===m?'selected':''}>${m}</option>`).join('')}
                        </select>
                        <input type="checkbox" ${a.done?'checked':''} onchange="toggleCauseAction(${i},${j})">
                    </div>
                `).join('');
                return `
                    <div class="cause-action-card ${i===0?'primary':''}">
                        <div class="cause-header">
                            <div class="cause-num ${i===0?'primary':''}">${i+1}</div>
                            <input type="text" class="cause-input" value="${ca.cause||''}" placeholder="ÂéüÂõ†${i+1}„ÇíÂÖ•Âäõ..." onchange="updateCause(${i},this.value)">
                        </div>
                        ${actionsHtml}
                        <button class="btn btn-secondary btn-sm" style="margin-top:8px" onclick="addCauseAction(${i})">+ ÊñΩÁ≠ñËøΩÂä†</button>
                    </div>
                `;
            }).join('');
        }

        function updateCause(i, v) {
            const r = getMemberReview();
            if (!r.causeActions[i]) r.causeActions[i] = { cause: '', actions: [] };
            r.causeActions[i].cause = v;
            saveData();
        }

        function addCauseAction(causeIdx) {
            const r = getMemberReview();
            if (!r.causeActions[causeIdx].actions) r.causeActions[causeIdx].actions = [];
            r.causeActions[causeIdx].actions.push({ text: '', deadline: '', method: '', done: false });
            saveData(); renderCauseActions();
        }

        function updateCauseAction(causeIdx, actionIdx, key, value) {
            getMemberReview().causeActions[causeIdx].actions[actionIdx][key] = value;
            saveData();
        }

        function toggleCauseAction(causeIdx, actionIdx) {
            const a = getMemberReview().causeActions[causeIdx].actions[actionIdx];
            a.done = !a.done;
            saveData(); renderCauseActions();
        }

        // Instagram
        function renderInstagram() {
            const dates = getWeekDates();
            const days = ['Âúü','Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë'];

            const myAccounts = getMyAccounts();

            // „Ç¢„Ç´„Ç¶„É≥„ÉàÈÅ∏Êäû„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÊõ¥Êñ∞
            const accountSelect = document.getElementById('igAccountSelect');
            if (accountSelect) {
                const currentSelection = selectedIgAccount;
                accountSelect.innerHTML = '<option value="all">ÂÖ®„Ç¢„Ç´„Ç¶„É≥„ÉàÂêàË®à</option>' +
                    myAccounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join('');
                // ÈÅ∏Êäû„ÇíÂæ©ÂÖÉÔºàÂ≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºâ
                if (currentSelection !== 'all' && myAccounts.some(acc => acc.id === currentSelection)) {
                    accountSelect.value = currentSelection;
                } else {
                    selectedIgAccount = 'all';
                    accountSelect.value = 'all';
                }
            }

            const noAccountMsg = selectedMember === 'all'
                ? '<p style="color:#64748b">„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>'
                : '<p style="color:#64748b">„Åì„ÅÆ„É°„É≥„Éê„Éº„Å´„ÅØ„Ç¢„Ç´„Ç¶„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Äå+ „Ç¢„Ç´„Ç¶„É≥„ÉàËøΩÂä†„Äç„ÅßËøΩÂä†„Åß„Åç„Åæ„Åô„ÄÇ</p>';
            document.getElementById('accountList').innerHTML = myAccounts.length === 0 ? noAccountMsg :
                myAccounts.map(acc => {
                    const d = getAccountData(acc.id);
                    return `<div class="account-section"><div class="account-header" onclick="toggleAccount('${acc.id}')"><h4>${acc.name}</h4><span style="color:#64748b;font-size:12px">„ÇØ„É™„ÉÉ„ÇØ„ÅßÂ±ïÈñã</span></div><div class="account-body" id="acc-${acc.id}"><div style="overflow-x:auto"><table style="min-width:600px"><thead><tr><th>È†ÖÁõÆ</th>${days.map((dy,i) => `<th>${dy}<br>${dates[i].getDate()}Êó•</th>`).join('')}<th>ÂêàË®à</th></tr></thead><tbody>${renderIgRow(acc.id,'follow','„Éï„Ç©„É≠„Éº',d)}${renderIgRow(acc.id,'follower','„Éï„Ç©„É≠„ÉØ„Éº',d)}${renderIgRow(acc.id,'followCut','„Éï„Ç©„É≠„ÉºÂâä„Çä',d)}${renderIgRow(acc.id,'followerCut','„Éï„Ç©„É≠„ÉØ„ÉºÂâä„Çä',d)}${renderIgRow(acc.id,'dmSend','DMÈÄÅ‰ø°',d)}${renderIgRow(acc.id,'dmReply','DMËøî‰ø°',d)}${renderIgRow(acc.id,'dmOffer','„Ç™„Éï„Ç°„Éº',d)}${renderIgRow(acc.id,'apoGet','„Ç¢„ÉùÁç≤Âæó',d)}${renderIgRow(acc.id,'apoExec','„Ç¢„ÉùÂÆüÊñΩ',d)}${renderIgRow(acc.id,'doinPlan','ÂãïÂì°‰∫àÂÆö',d)}${renderIgRow(acc.id,'doinExec','ÂãïÂì°ÂÆüÊñΩ',d)}${renderIgRow(acc.id,'seiyaku','ÊàêÁ¥Ñ',d)}</tbody></table></div><button class="btn btn-danger btn-sm" style="margin-top:12px" onclick="deleteAccount('${acc.id}')">„Ç¢„Ç´„Ç¶„É≥„ÉàÂâäÈô§</button></div></div>`;
                }).join('');

            // ÂàÜÊûêÂØæË±°„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíÊ±∫ÂÆö
            const analysisAccounts = selectedIgAccount === 'all'
                ? myAccounts
                : myAccounts.filter(acc => acc.id === selectedIgAccount);

            // ÊúàÂÖ®‰Ωì„ÅÆ„Éà„Éº„Çø„É´„ÇíË®àÁÆóÔºàÈÅ∏Êäû„Åó„Åü„Ç¢„Ç´„Ç¶„É≥„Éà„ÅÆ„ÅøÔºâ
            let totals = { follow: 0, follower: 0, followCut: 0, followerCut: 0, send: 0, reply: 0, offer: 0, apoGet: 0, apoExec: 0, doinPlan: 0, doinExec: 0, seiyaku: 0 };
            const maxWIg = getMaxWeekNum(currentYear, currentMonth);
            for (let w = 1; w <= maxWIg; w++) {
                const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                if (data.weeks[weekKey] && data.weeks[weekKey].instagram) {
                    analysisAccounts.forEach(acc => {
                        const d = data.weeks[weekKey].instagram[acc.id];
                        if (d) {
                            totals.follow += safeArraySum(d.follow);
                            totals.follower += safeArraySum(d.follower);
                            totals.followCut += safeArraySum(d.followCut);
                            totals.followerCut += safeArraySum(d.followerCut);
                            totals.send += safeArraySum(d.dmSend);
                            totals.reply += safeArraySum(d.dmReply);
                            totals.offer += safeArraySum(d.dmOffer);
                            totals.apoGet += safeArraySum(d.apoGet);
                            totals.apoExec += safeArraySum(d.apoExec);
                            totals.doinPlan += safeArraySum(d.doinPlan);
                            totals.doinExec += safeArraySum(d.doinExec);
                            totals.seiyaku += safeArraySum(d.seiyaku);
                        }
                    });
                }
            }

            // ‰ªäÊó•„Åæ„Åß„ÅÆÊó•Ââ≤„ÇäÁõÆÊ®ô„ÇíË®àÁÆóÔºà„É°„É≥„Éê„ÉºÂà•Ë®≠ÂÆö„Åã„ÇâÂèñÂæóÔºâ
            let ig = {};
            if (selectedMember === 'all') {
                // ÂÖ®‰ΩìÈÅ∏ÊäûÊôÇÔºöÂÖ®„É°„É≥„Éê„Éº„ÅÆ„Ç§„É≥„Çπ„ÇøÁõÆÊ®ô„ÇíÂêàË®à
                data.members.forEach(m => {
                    const monthKey = getMonthKey();
                    const memberIg = data.settings.memberSettings?.[m.id]?.[monthKey]?.instagram || {};
                    ig.send = (ig.send || 0) + (memberIg.send || 0);
                    ig.reply = (ig.reply || 0) + (memberIg.reply || 0);
                    ig.offer = (ig.offer || 0) + (memberIg.offer || 0);
                    ig.apoGet = (ig.apoGet || 0) + (memberIg.apoGet || 0);
                    ig.apoExec = (ig.apoExec || 0) + (memberIg.apoExec || 0);
                    ig.doinExec = (ig.doinExec || 0) + (memberIg.doinExec || 0);
                    ig.seiyaku = (ig.seiyaku || 0) + (memberIg.seiyaku || 0);
                });
            } else {
                // ÁâπÂÆö„É°„É≥„Éê„ÉºÈÅ∏ÊäûÊôÇÔºö„Åù„ÅÆ„É°„É≥„Éê„Éº„ÅÆ„Ç§„É≥„Çπ„ÇøÁõÆÊ®ô
                const monthKey = getMonthKey();
                ig = data.settings.memberSettings?.[selectedMember]?.[monthKey]?.instagram || {};
            }
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const today = new Date();
            const currentDay = (today.getFullYear() === currentYear && today.getMonth() + 1 === currentMonth)
                ? today.getDate() : daysInMonth;

            const proratedGoal = (goal) => Math.ceil((goal || 0) / daysInMonth * currentDay);

            // „Çµ„Éû„É™„Éº„Ç´„Éº„Éâ„ÅÆÂÄ§„Å®ÁõÆÊ®ô„ÇíË°®Á§∫
            document.getElementById('igSend').textContent = totals.send;
            document.getElementById('igSendGoal').textContent = proratedGoal(ig.send);
            setRateDisplay('igSendRate', 'igSendBar', totals.send, proratedGoal(ig.send));

            document.getElementById('igReply').textContent = totals.reply;
            document.getElementById('igReplyGoal').textContent = proratedGoal(ig.reply);
            setRateDisplay('igReplyRate', 'igReplyBar', totals.reply, proratedGoal(ig.reply));

            document.getElementById('igOffer').textContent = totals.offer;
            document.getElementById('igOfferGoal').textContent = proratedGoal(ig.offer);
            setRateDisplay('igOfferRate', 'igOfferBar', totals.offer, proratedGoal(ig.offer));

            document.getElementById('igApoGet').textContent = totals.apoGet;
            document.getElementById('igApoGetGoal').textContent = proratedGoal(ig.apoGet);
            setRateDisplay('igApoGetRate', 'igApoGetBar', totals.apoGet, proratedGoal(ig.apoGet));

            document.getElementById('igApoExec').textContent = totals.apoExec;
            document.getElementById('igApoExecGoal').textContent = proratedGoal(ig.apoExec);
            setRateDisplay('igApoExecRate', 'igApoExecBar', totals.apoExec, proratedGoal(ig.apoExec));

            document.getElementById('igDoinExec').textContent = totals.doinExec;
            document.getElementById('igDoinExecGoal').textContent = proratedGoal(ig.doinExec);
            setRateDisplay('igDoinExecRate', 'igDoinExecBar', totals.doinExec, proratedGoal(ig.doinExec));

            document.getElementById('igSeiyaku').textContent = totals.seiyaku;
            document.getElementById('igSeiyakuGoal').textContent = proratedGoal(ig.seiyaku);
            setRateDisplay('igSeiyakuRate', 'igSeiyakuBar', totals.seiyaku, proratedGoal(ig.seiyaku));

            // KPI„ÇíË®àÁÆó„ÉªË°®Á§∫
            document.getElementById('igKpiReply').textContent = pct(totals.reply, totals.send);
            document.getElementById('igKpiOfferReach').textContent = pct(totals.offer, totals.send);
            document.getElementById('igKpiOfferPass').textContent = pct(totals.apoGet, totals.offer);
            document.getElementById('igKpiApoGet').textContent = pct(totals.apoGet, totals.send);
            document.getElementById('igKpiApoExec').textContent = pct(totals.apoExec, totals.apoGet);
            document.getElementById('igKpiDoin').textContent = pct(totals.doinExec, totals.apoExec);
            document.getElementById('igKpiSeiyaku').textContent = pct(totals.seiyaku, totals.doinExec);

            // ÈÄ≤Êçó„Ç∞„É©„Éï„ÇíÊèèÁîª
            renderIgCharts(ig);

            // „Éï„Ç°„Éç„É´ÂàÜÊûê„ÇíÊèèÁîª
            renderIgFunnel(totals);

            // „Ç¢„Ç´„Ç¶„É≥„ÉàÂà•„Çµ„Éû„É™„Éº„ÉÜ„Éº„Éñ„É´„ÇíÊèèÁîª
            renderIgAccountSummaryTable();
        }

        function renderIgCharts(ig) {
            const container = document.getElementById('igChartsGrid');
            if (!container) return;

            const chartConfigs = [
                { label: '„Éï„Ç©„É≠„Éº', key: 'igFollow', goal: ig.follow || 0 },
                { label: '„Éï„Ç©„É≠„ÉØ„Éº', key: 'igFollower', goal: ig.follower || 0 },
                { label: '„Éï„Ç©„É≠„ÉºÂâä„Çä', key: 'igFollowCut', goal: ig.followCut || 0 },
                { label: '„Éï„Ç©„É≠„ÉØ„ÉºÂâä„Çä', key: 'igFollowerCut', goal: ig.followerCut || 0 },
                { label: 'DMÈÄÅ‰ø°', key: 'igSend', goal: ig.send || 0 },
                { label: 'DMËøî‰ø°', key: 'igReply', goal: ig.reply || 0 },
                { label: '„Ç™„Éï„Ç°„Éº', key: 'igOffer', goal: ig.offer || 0 },
                { label: '„Ç¢„ÉùÁç≤Âæó', key: 'igApoGet', goal: ig.apoGet || 0 },
                { label: '„Ç¢„ÉùÂÆüÊñΩ', key: 'igApoExec', goal: ig.apoExec || 0 },
                { label: 'ÂãïÂì°‰∫àÂÆö', key: 'igDoinPlan', goal: ig.doinPlan || 0 },
                { label: 'ÂãïÂì°ÂÆüÊñΩ', key: 'igDoinExec', goal: ig.doinExec || 0 },
                { label: 'ÊàêÁ¥Ñ', key: 'igSeiyaku', goal: ig.seiyaku || 0 }
            ];

            container.innerHTML = chartConfigs.map(config => {
                const { actualData, targetData, numDays, labels } = getIgChartData(config.key, config.goal);
                const maxVal = Math.max(...actualData, ...targetData, 1);
                const svg = createLargeChartSVG(actualData, targetData, maxVal, numDays, labels);

                return `<div class="chart-card">
                    <h4>${config.label}</h4>
                    <div class="chart-container">${svg}</div>
                    <div class="chart-legend">
                        <span><div class="legend-line target"></div>ÁõÆÊ®ô</span>
                        <span><div class="legend-line actual"></div>ÂÆüÁ∏æ</span>
                    </div>
                </div>`;
            }).join('');
        }

        function getIgChartData(metricKey, monthlyGoal) {
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            let actualData = [];
            let targetData = [];
            let labels = [];
            const numDays = daysInMonth;
            const dailyGoal = monthlyGoal / daysInMonth;

            const keyMap = {
                'igFollow': 'follow', 'igFollower': 'follower', 'igFollowCut': 'followCut', 'igFollowerCut': 'followerCut',
                'igSend': 'dmSend', 'igReply': 'dmReply', 'igOffer': 'dmOffer',
                'igApoGet': 'apoGet', 'igApoExec': 'apoExec', 'igDoinPlan': 'doinPlan', 'igDoinExec': 'doinExec', 'igSeiyaku': 'seiyaku'
            };
            const dataKey = keyMap[metricKey] || metricKey;

            let cumulative = 0;
            for (let day = 1; day <= daysInMonth; day++) {
                const dayValue = getIgDayValue(dataKey, day);
                cumulative += dayValue;
                actualData.push(cumulative);
                targetData.push(dailyGoal * day);
                labels.push(day.toString());
            }

            return { actualData, targetData, numDays, labels };
        }

        function getIgDayValue(dataKey, day) {
            const date = new Date(currentYear, currentMonth - 1, day);
            const firstDay = new Date(currentYear, currentMonth - 1, 1);
            const dow = (firstDay.getDay() + 1) % 7;
            const weekNum = Math.ceil((day + dow) / 7);
            const dayOfWeek = (date.getDay() + 1) % 7;

            const weekKey = `${currentYear}-${currentMonth}-W${weekNum}`;
            let total = 0;
            if (data.weeks[weekKey] && data.weeks[weekKey].instagram) {
                // ÈÅ∏Êäû„Åï„Çå„Åü„É°„É≥„Éê„Éº„Éª„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                const myAccounts = getMyAccounts();
                const analysisAccounts = selectedIgAccount === 'all'
                    ? myAccounts
                    : myAccounts.filter(acc => acc.id === selectedIgAccount);

                analysisAccounts.forEach(acc => {
                    const d = data.weeks[weekKey].instagram[acc.id];
                    if (d && d[dataKey]) {
                        total += d[dataKey][dayOfWeek] || 0;
                    }
                });
            }
            return total;
        }

        function renderIgFunnel(totals) {
            const container = document.getElementById('igFunnel');
            if (!container) return;

            const stages = [
                { label: '„Éï„Ç©„É≠„Éº', value: totals.follow, color: '#3b82f6' },
                { label: '„Éï„Ç©„É≠„ÉØ„Éº', value: totals.follower, color: '#0ea5e9' },
                { label: '„Éï„Ç©„É≠„ÉºÂâä„Çä', value: totals.followCut, color: '#06b6d4' },
                { label: '„Éï„Ç©„É≠„ÉØ„ÉºÂâä„Çä', value: totals.followerCut, color: '#14b8a6' },
                { label: 'DMÈÄÅ‰ø°', value: totals.send, color: '#6366f1' },
                { label: 'DMËøî‰ø°', value: totals.reply, color: '#8b5cf6' },
                { label: '„Ç™„Éï„Ç°„Éº', value: totals.offer, color: '#a855f7' },
                { label: '„Ç¢„ÉùÁç≤Âæó', value: totals.apoGet, color: '#d946ef' },
                { label: '„Ç¢„ÉùÂÆüÊñΩ', value: totals.apoExec, color: '#ec4899' },
                { label: 'ÂãïÂì°‰∫àÂÆö', value: totals.doinPlan, color: '#f97316' },
                { label: 'ÂãïÂì°ÂÆüÊñΩ', value: totals.doinExec, color: '#f43f5e' },
                { label: 'ÊàêÁ¥Ñ', value: totals.seiyaku, color: '#22c55e' }
            ];

            const maxValue = Math.max(...stages.map(s => s.value), 1);

            container.innerHTML = stages.map((stage, i) => {
                const widthPct = Math.max((stage.value / maxValue) * 100, 5);
                const convRate = i > 0 && stages[i-1].value > 0 ? Math.round((stage.value / stages[i-1].value) * 100) : 100;
                return `<div style="display:flex;align-items:center;gap:8px">
                    <div style="width:70px;font-size:11px;color:#94a3b8">${stage.label}</div>
                    <div style="flex:1;height:24px;background:#1e293b;border-radius:4px;overflow:hidden;position:relative">
                        <div style="width:${widthPct}%;height:100%;background:${stage.color};display:flex;align-items:center;justify-content:flex-end;padding-right:8px;font-size:11px;font-weight:600">${stage.value}</div>
                    </div>
                    <div style="width:40px;font-size:10px;color:${convRate >= 50 ? '#22c55e' : convRate >= 30 ? '#eab308' : '#ef4444'}">${i > 0 ? convRate + '%' : ''}</div>
                </div>`;
            }).join('');
        }

        function renderIgAccountSummaryTable() {
            const container = document.getElementById('igAccountSummaryTable');
            if (!container) return;

            const myAccounts = getMyAccounts();
            if (myAccounts.length === 0) {
                const msg = selectedMember === 'all'
                    ? '„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ'
                    : '„Åì„ÅÆ„É°„É≥„Éê„Éº„Å´„ÅØ„Ç¢„Ç´„Ç¶„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                container.innerHTML = `<tr><td colspan="10" style="text-align:center;color:#64748b">${msg}</td></tr>`;
                return;
            }

            container.innerHTML = myAccounts.map(acc => {
                // ÊúàÂÖ®‰Ωì„ÅÆ„Éà„Éº„Çø„É´„ÇíË®àÁÆó
                let t = { send: 0, reply: 0, offer: 0, apoGet: 0, apoExec: 0, doinExec: 0, seiyaku: 0 };
                const maxWIg2 = getMaxWeekNum(currentYear, currentMonth);
                for (let w = 1; w <= maxWIg2; w++) {
                    const weekKey = `${currentYear}-${currentMonth}-W${w}`;
                    if (data.weeks[weekKey] && data.weeks[weekKey].instagram && data.weeks[weekKey].instagram[acc.id]) {
                        const d = data.weeks[weekKey].instagram[acc.id];
                        t.send += safeArraySum(d.dmSend);
                        t.reply += safeArraySum(d.dmReply);
                        t.offer += safeArraySum(d.dmOffer);
                        t.apoGet += safeArraySum(d.apoGet);
                        t.apoExec += safeArraySum(d.apoExec);
                        t.doinExec += safeArraySum(d.doinExec);
                        t.seiyaku += safeArraySum(d.seiyaku);
                    }
                }
                const replyRate = t.send > 0 ? Math.round((t.reply / t.send) * 100) : 0;
                const seiyakuRate = t.doinExec > 0 ? Math.round((t.seiyaku / t.doinExec) * 100) : 0;

                return `<tr>
                    <td><strong>${acc.name}</strong></td>
                    <td>${t.send}</td>
                    <td>${t.reply}</td>
                    <td>${t.offer}</td>
                    <td>${t.apoGet}</td>
                    <td>${t.apoExec}</td>
                    <td>${t.doinExec}</td>
                    <td class="${t.seiyaku > 0 ? 'good' : ''}">${t.seiyaku}</td>
                    <td class="${replyRate >= 30 ? 'good' : replyRate >= 15 ? 'warning' : 'danger'}">${replyRate}%</td>
                    <td class="${seiyakuRate >= 50 ? 'good' : seiyakuRate >= 30 ? 'warning' : 'danger'}">${seiyakuRate}%</td>
                </tr>`;
            }).join('');
        }

        function renderIgRow(accId, key, label, d) {
            const arr = d[key] || [0,0,0,0,0,0,0];
            return `<tr><td>${label}</td>${[0,1,2,3,4,5,6].map(i => `<td><input type="number" class="input-sm" value="${arr[i]}" min="0" onchange="updateIg('${accId}','${key}',${i},this.value)"></td>`).join('')}<td><strong>${arr.reduce((a,b)=>a+b,0)}</strong></td></tr>`;
        }

        function changeIgAccount() {
            selectedIgAccount = document.getElementById('igAccountSelect').value;
            renderInstagram();
        }

        function updateIg(accId, key, idx, val) {
            // Èñã„ÅÑ„Å¶„ÅÑ„Çã„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíË®òÊÜ∂
            const openAccounts = [];
            data.accounts.forEach(acc => {
                const el = document.getElementById('acc-' + acc.id);
                if (el && el.classList.contains('open')) {
                    openAccounts.push(acc.id);
                }
            });

            getAccountData(accId)[key][idx] = parseInt(val) || 0;
            saveData();
            renderInstagram();

            // Èñã„ÅÑ„Å¶„ÅÑ„Åü„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíÂæ©ÂÖÉ
            openAccounts.forEach(id => {
                const el = document.getElementById('acc-' + id);
                if (el) el.classList.add('open');
            });
        }

        // Êó•Â†±ÔºàNippoÔºâÊ©üËÉΩ
        function renderWeekTabs() {
            const html = [1,2,3,4,5].map(w =>
                `<button class="week-tab ${w === currentWeekNum ? 'active' : ''}" onclick="switchWeekTab(${w})">Á¨¨${w}ÈÄ±</button>`
            ).join('');
            document.getElementById('weekTabs').innerHTML = html;
        }

        function switchWeekTab(weekNum) {
            saveAll();
            currentWeekNum = weekNum;
            updateWeekLabel();
            renderAll();
        }

        function setNippoView(mode) {
            nippoViewMode = mode;
            const btnAll = document.getElementById('btnAllMembers');
            const btnSingle = document.getElementById('btnSingleMember');
            const memberSelect = document.getElementById('nippoMemberSelect');

            if (mode === 'all') {
                btnAll.className = 'btn btn-sm active';
                btnSingle.className = 'btn btn-sm btn-secondary';
                memberSelect.style.display = 'none';
            } else {
                btnAll.className = 'btn btn-sm btn-secondary';
                btnSingle.className = 'btn btn-sm active';
                memberSelect.style.display = 'block';
                if (!nippoSelectedMember && data.members.length > 0) {
                    nippoSelectedMember = data.members[0].id;
                }
                memberSelect.value = nippoSelectedMember;
            }
            renderNippo();
        }

        function renderNippo() {
            renderWeekTabs();

            const dates = getWeekDates();
            const days = ['Âúü','Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë'];
            const monthVideos = getMonthVideos();

            let html = '';

            // „Ç∞„É≠„Éº„Éê„É´„ÅÆselectedMember„Çí‰ΩøÁî®
            const membersToShow = selectedMember === 'all' ? data.members :
                data.members.filter(m => m.id === selectedMember);

            if (membersToShow.length === 0) {
                html = '<p style="color:#64748b;text-align:center;padding:40px">„É°„É≥„Éê„Éº„ÇíË®≠ÂÆö„Çø„Éñ„ÅßËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>';
            } else {
                dates.forEach((date, dayIndex) => {
                    const dateStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
                    const videoUrl = monthVideos[dateStr] || '';

                    membersToShow.forEach(member => {
                        const nippoData = getNippoData(member.id, dayIndex);
                        const isMyData = canEditMember(member.id);
                        const disabledAttr = isMyData ? '' : 'disabled';
                        const cardStyle = isMyData ? '' : 'opacity:0.7;';
                        const lockIcon = isMyData ? '' : ' üîí';

                        html += `
                            <div class="nippo-day-card" style="${cardStyle}">
                                <div class="day-header">
                                    <div class="day-title">${days[dayIndex]}ÊõúÊó• - ${date.getMonth()+1}/${date.getDate()}</div>
                                    <div class="member-name">${member.name}${lockIcon}</div>
                                </div>

                                <div class="nippo-block">
                                    <div class="nippo-block-label"><span class="icon">üé¨</span> „Ç§„É≥„Éó„ÉÉ„ÉàÂãïÁîª</div>
                                    ${videoUrl ? `
                                        <div class="nippo-video-container">
                                            ${renderVideoEmbed(videoUrl)}
                                        </div>
                                    ` : `
                                        <p style="color:#64748b;font-size:13px;padding:12px;background:#1e293b;border-radius:8px">ÂãïÁîªÊú™Ë®≠ÂÆöÔºà‰∏äÈÉ®„ÅÆ„ÄåÂãïÁîª„Çí‰∏ÄÊã¨„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Äç„Åã„ÇâË®≠ÂÆöÔºâ</p>
                                    `}
                                </div>

                                <div class="nippo-block">
                                    <div class="nippo-block-label"><span class="icon">üìù</span> „Ç¢„Ç¶„Éà„Éó„ÉÉ„ÉàÔºàÂ≠¶„Çì„Å†„Åì„Å®„ÉªÊ∞ó„Å•„ÅçÔºâ</div>
                                    <textarea class="nippo-textarea" placeholder="‰ªäÊó•„ÅÆÂãïÁîª„Åã„ÇâÂ≠¶„Çì„Å†„Åì„Å®„ÇíÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ..." ${disabledAttr} onchange="updateNippo('${member.id}',${dayIndex},'output',this.value)">${nippoData.output || ''}</textarea>
                                </div>

                                <div class="nippo-block">
                                    <div class="nippo-block-label"><span class="icon">üôè</span> ÊÑüË¨ùÊó•Ë®ò</div>
                                    <textarea class="nippo-textarea" placeholder="‰ªäÊó•ÊÑüË¨ù„Åó„Åü„Åì„Å®„ÇíÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ..." ${disabledAttr} onchange="updateNippo('${member.id}',${dayIndex},'gratitude',this.value)">${nippoData.gratitude || ''}</textarea>
                                </div>
                            </div>
                        `;
                    });
                });
            }

            document.getElementById('nippoContent').innerHTML = html;
        }

        function renderVideoEmbed(url) {
            if (!url) return '';
            // YouTube
            const ytMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]+)/);
            if (ytMatch) {
                const videoId = ytMatch[1];
                const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                return `
                    <a href="https://www.youtube.com/watch?v=${videoId}" target="_blank"
                       style="display:block;width:100%;background:#0f172a;border-radius:8px;overflow:hidden;text-decoration:none;transition:transform 0.2s,box-shadow 0.2s;box-shadow:0 2px 8px rgba(0,0,0,0.3)"
                       onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(99,102,241,0.4)'"
                       onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 8px rgba(0,0,0,0.3)'">
                        <div style="position:relative;width:100%;height:200px;background:#000;overflow:hidden">
                            <img src="${thumbnailUrl}"
                                 style="width:100%;height:100%;object-fit:cover"
                                 onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
                            <div style="display:none;width:100%;height:100%;align-items:center;justify-content:center;background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%)">
                                <span style="font-size:48px">üé•</span>
                            </div>
                            <div style="position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.3)">
                                <div style="width:60px;height:60px;background:rgba(99,102,241,0.9);border-radius:50%;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)">
                                    <div style="width:0;height:0;border-left:20px solid white;border-top:12px solid transparent;border-bottom:12px solid transparent;margin-left:4px"></div>
                                </div>
                            </div>
                        </div>
                        <div style="padding:12px;background:#1e293b">
                            <div style="color:#e2e8f0;font-size:13px;font-weight:600;margin-bottom:4px">üì∫ „Ç§„É≥„Éó„ÉÉ„ÉàÂãïÁîª</div>
                            <div style="color:#94a3b8;font-size:11px">„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶YouTube„ÅßË¶ñËÅ¥</div>
                        </div>
                    </a>`;
            }
            // Vimeo
            const vimeoMatch = url.match(/vimeo\.com\/(\d+)/);
            if (vimeoMatch) {
                return `<iframe src="https://player.vimeo.com/video/${vimeoMatch[1]}" frameborder="0" allowfullscreen style="width:100%;height:200px;border-radius:6px"></iframe>`;
            }
            // Google Drive
            if (url.includes('drive.google.com')) {
                const driveMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
                if (driveMatch) {
                    const fileId = driveMatch[1];
                    return `
                        <a href="${url}" target="_blank"
                           style="display:block;width:100%;background:#0f172a;border-radius:8px;overflow:hidden;text-decoration:none;transition:transform 0.2s,box-shadow 0.2s;box-shadow:0 2px 8px rgba(0,0,0,0.3)"
                           onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(99,102,241,0.4)'"
                           onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 8px rgba(0,0,0,0.3)'">
                            <div style="position:relative;width:100%;height:200px;background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);display:flex;align-items:center;justify-content:center">
                                <div style="text-align:center">
                                    <div style="font-size:64px;margin-bottom:8px">üìÅ</div>
                                    <div style="width:60px;height:60px;background:rgba(99,102,241,0.9);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto">
                                        <div style="width:0;height:0;border-left:20px solid white;border-top:12px solid transparent;border-bottom:12px solid transparent;margin-left:4px"></div>
                                    </div>
                                </div>
                            </div>
                            <div style="padding:12px;background:#1e293b">
                                <div style="color:#e2e8f0;font-size:13px;font-weight:600;margin-bottom:4px">üìÅ „Ç§„É≥„Éó„ÉÉ„ÉàÂãïÁîª</div>
                                <div style="color:#94a3b8;font-size:11px">„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Google Drive„ÅßË¶ñËÅ¥</div>
                            </div>
                        </a>`;
                }
            }
            // Áõ¥Êé•„É™„É≥„ÇØ
            if (url.match(/\.(mp4|webm|ogg)$/i)) {
                return `<video controls src="${url}" style="width:100%;max-height:200px;border-radius:6px"></video>`;
            }
            // „Åù„ÅÆ‰ªñ„ÅØ„É™„É≥„ÇØË°®Á§∫
            return `<a href="${url}" target="_blank" style="color:#6366f1;word-break:break-all">${url}</a>`;
        }

        function updateNippo(memberId, dayIndex, field, value) {
            const nippoData = getNippoData(memberId, dayIndex);
            nippoData[field] = value;
            saveData();
        }

        function openVideoUploadModal() {
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const monthVideos = getMonthVideos();

            let html = `<p style="margin-bottom:12px;font-weight:600">${currentYear}Âπ¥${currentMonth}Êúà„ÅÆÂãïÁîªURL</p>`;

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const date = new Date(currentYear, currentMonth - 1, day);
                const dayOfWeek = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'][date.getDay()];
                const videoUrl = monthVideos[dateStr] || '';

                html += `
                    <div class="video-upload-row">
                        <div class="date-label">${currentMonth}/${day}Ôºà${dayOfWeek}Ôºâ</div>
                        <input type="text" class="nippo-video-url" id="video_${dateStr}" value="${videoUrl}" placeholder="ÂãïÁîªURLÔºàYouTube, Vimeo, Google DriveÁ≠âÔºâ">
                    </div>
                `;
            }

            document.getElementById('videoUploadList').innerHTML = html;
            openModal('videoUploadModal');
        }

        function saveVideoUrls() {
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const monthVideos = getMonthVideos();

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const input = document.getElementById(`video_${dateStr}`);
                if (input) {
                    monthVideos[dateStr] = input.value.trim();
                }
            }

            saveData();
            closeModal('videoUploadModal');
            renderNippo();
        }

        function exportNippoCsv() {
            const dates = getWeekDates();
            const days = ['Âúü','Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë'];
            const monthVideos = getMonthVideos();

            let csv = '\uFEFF'; // BOM for Excel
            csv += 'Êó•‰ªò,ÊõúÊó•,„É°„É≥„Éê„Éº,ÂãïÁîªURL,„Ç¢„Ç¶„Éà„Éó„ÉÉ„Éà,ÊÑüË¨ùÊó•Ë®ò\n';

            dates.forEach((date, dayIndex) => {
                const dateStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
                const videoUrl = monthVideos[dateStr] || '';

                data.members.forEach(member => {
                    const nippoData = getNippoData(member.id, dayIndex);
                    const row = [
                        `${date.getMonth()+1}/${date.getDate()}`,
                        days[dayIndex],
                        member.name,
                        videoUrl,
                        (nippoData.output || '').replace(/"/g, '""').replace(/\n/g, ' '),
                        (nippoData.gratitude || '').replace(/"/g, '""').replace(/\n/g, ' ')
                    ].map(v => `"${v}"`).join(',');
                    csv += row + '\n';
                });
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Êó•Â†±_${currentYear}Âπ¥${currentMonth}Êúà_Á¨¨${currentWeekNum}ÈÄ±.csv`;
            a.click();
        }

        // ÂãïÁîªURLÂ∞ÇÁî®CSV„Ç§„É≥„Éù„Éº„ÉàÔºàÊó•‰ªò,URLÂΩ¢ÂºèÔºâ
        function importVideoCsv(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());

                    if (lines.length < 2) {
                        alert('CSV„Éï„Ç°„Ç§„É´„Å´„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                        return;
                    }

                    if (!data.monthVideos) data.monthVideos = {};
                    let importCount = 0;

                    for (let i = 1; i < lines.length; i++) {
                        const row = parseCSVRow(lines[i]);
                        if (row.length < 2) continue;

                        const dateStr = row[0].trim();
                        const videoUrl = row[1].trim();

                        if (!videoUrl) continue;

                        // Êó•‰ªòÂΩ¢Âºè„ÇíÂà§ÂÆö„Åó„Å¶„Ç≠„Éº„ÇíÁîüÊàê
                        let dateKey = '';
                        let year, month;
                        if (dateStr.includes('-')) {
                            // YYYY-MM-DDÂΩ¢Âºè
                            const parts = dateStr.split('-').map(Number);
                            year = parts[0];
                            month = parts[1];
                            dateKey = dateStr;
                        } else if (dateStr.includes('/')) {
                            // M/DÂΩ¢Âºè ‚Üí ÁèæÂú®„ÅÆÂπ¥„ÅßË£úÂÆå
                            const parts = dateStr.split('/').map(Number);
                            month = parts[0];
                            const d = parts[1];
                            year = currentYear;
                            dateKey = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                        }

                        if (dateKey && year && month) {
                            // Ë©≤ÂΩìÂπ¥Êúà„ÅÆmonthVideos„Å´‰øùÂ≠ò
                            const monthKey = `${year}-${month}`;
                            if (!data.monthVideos[monthKey]) data.monthVideos[monthKey] = {};
                            data.monthVideos[monthKey][dateKey] = videoUrl;
                            importCount++;
                        }
                    }

                    saveData();
                    renderNippo();
                    alert(`${importCount}‰ª∂„ÅÆÂãïÁîªURL„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`);

                } catch (err) {
                    console.error(err);
                    alert('CSV„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + err.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }

        // Êó•‰ªò„Åã„ÇâÈÄ±ÊÉÖÂ†±„ÇíË®àÁÆó
        function getWeekInfoFromDate(dateObj) {
            const year = dateObj.getFullYear();
            const dayOfWeek = dateObj.getDay(); // 0=Êó•, 1=Êúà, ..., 6=Âúü
            const dayIndex = (dayOfWeek + 1) % 7; // Âúü=0, Êó•=1, Êúà=2, ...

            // „Åì„ÅÆÊó•‰ªò„ÅåÂê´„Åæ„Çå„ÇãÈÄ±„ÇíÊé¢„ÅôÔºàÁøåÊúà„Åã„ÇâÊ§úÁ¥¢ÈñãÂßã - ÊúàÊú´Êó•„ÅåÁøåÊúàÈÄ±1„Å´Â±û„Åô„ÇãÂ†¥ÂêàÂØæÂøúÔºâ
            const startMonth = Math.min(dateObj.getMonth() + 2, 12);
            for (let month = startMonth; month >= 1; month--) {
                for (let weekNum = 1; weekNum <= 5; weekNum++) {
                    const firstDay = new Date(year, month - 1, 1);
                    const dow = (firstDay.getDay() + 1) % 7;
                    const weekStart = new Date(year, month - 1, 1 - dow + (weekNum - 1) * 7);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);

                    if (dateObj >= weekStart && dateObj <= weekEnd) {
                        return { year, month, weekNum, dayIndex };
                    }
                }
            }
            return null;
        }

        function importNippoCsv(event) {
            const file = event.target.files[0];
            if (!file) return;

            createBackup('Êó•Â†±CSV„Ç§„É≥„Éù„Éº„ÉàÂâç');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let text = e.target.result;
                    // BOMÈô§Âéª
                    if (text.charCodeAt(0) === 0xFEFF) {
                        text = text.slice(1);
                    }
                    const lines = text.split('\n').filter(line => line.trim());

                    if (lines.length < 2) {
                        alert('CSV„Éï„Ç°„Ç§„É´„Å´„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                        return;
                    }

                    let importCount = 0;
                    let newMemberCount = 0;
                    const addedMembers = new Set();

                    for (let i = 1; i < lines.length; i++) {
                        const row = parseCSVRow(lines[i]);
                        if (row.length < 4) continue;

                        const [dateStr, dayName, memberName, videoUrl, output, gratitude] = row;
                        const trimmedName = (memberName || '').trim();
                        if (!trimmedName) continue;

                        // Êó•‰ªò„Çí„Éë„Éº„Çπ (M/DÂΩ¢Âºè)
                        const dateParts = (dateStr || '').trim().split('/');
                        if (dateParts.length !== 2) continue;
                        const month = parseInt(dateParts[0]);
                        const day = parseInt(dateParts[1]);
                        if (isNaN(month) || isNaN(day)) continue;

                        const dateObj = new Date(currentYear, month - 1, day);
                        const weekInfo = getWeekInfoFromDate(dateObj);
                        if (!weekInfo) continue;

                        // „É°„É≥„Éê„Éº„ÇíÊ§úÁ¥¢„ÄÅ„Å™„Åë„Çå„Å∞Ëá™ÂãïËøΩÂä†
                        let member = data.members.find(m => m.name === trimmedName);
                        if (!member) {
                            member = { id: 'member_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5), name: trimmedName };
                            data.members.push(member);
                            if (!addedMembers.has(trimmedName)) {
                                addedMembers.add(trimmedName);
                                newMemberCount++;
                            }
                        }

                        // Ë©≤ÂΩìÈÄ±„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæó„Åæ„Åü„ÅØ‰ΩúÊàê
                        const weekKey = `${weekInfo.year}-${weekInfo.month}-W${weekInfo.weekNum}`;
                        if (!data.weeks[weekKey]) {
                            data.weeks[weekKey] = { daily: {}, nippo: {}, review: { cases: [], cancels: [], doinMuchakuList: [] }, instagram: {} };
                        }
                        const weekData = data.weeks[weekKey];
                        if (!weekData.nippo) weekData.nippo = {};

                        // Êó•Â†±„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
                        const nippoKey = `${member.id}_${weekInfo.dayIndex}`;
                        if (!weekData.nippo[nippoKey]) {
                            weekData.nippo[nippoKey] = { output: '', gratitude: '' };
                        }
                        if (output && output.trim()) weekData.nippo[nippoKey].output = output.trim();
                        if (gratitude && gratitude.trim()) weekData.nippo[nippoKey].gratitude = gratitude.trim();

                        // ÂãïÁîªURL„ÇÇÊõ¥Êñ∞Ôºà„ÅÇ„Çå„Å∞Ôºâ
                        if (videoUrl && videoUrl.trim()) {
                            const dateKey = `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}-${String(dateObj.getDate()).padStart(2,'0')}`;
                            const monthKey = `${dateObj.getFullYear()}-${dateObj.getMonth()+1}`;
                            if (!data.monthVideos) data.monthVideos = {};
                            if (!data.monthVideos[monthKey]) data.monthVideos[monthKey] = {};
                            data.monthVideos[monthKey][dateKey] = videoUrl.trim();
                        }

                        importCount++;
                    }

                    saveData();
                    renderNippo();
                    renderAll();
                    let msg = `${importCount}‰ª∂„ÅÆÊó•Â†±„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`;
                    if (newMemberCount > 0) {
                        msg += `\nÊñ∞Ë¶è„É°„É≥„Éê„Éº ${newMemberCount}Âêç„ÇíËøΩÂä†: ${Array.from(addedMembers).join(', ')}`;
                    }
                    alert(msg);

                } catch (err) {
                    console.error(err);
                    alert('CSV„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + err.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }

        function parseCSVRow(row) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                if (char === '"') {
                    if (inQuotes && row[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // Êó•Âà•Êï∞Â≠ó„ÅÆCSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        function exportDailyCsv() {
            const dates = getWeekDates();
            const days = ['Âúü','Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë'];

            let csv = '\uFEFF'; // BOM for Excel
            csv += '„É°„É≥„Éê„Éº,„Ç´„ÉÜ„Ç¥„É™,È†ÖÁõÆ,' + dates.map((d,i) => `${days[i]}(${d.getMonth()+1}/${d.getDate()})`).join(',') + ',ÂêàË®à\n';

            data.members.forEach(member => {
                const d = getMemberDaily(member.id);
                metrics.forEach(cat => {
                    cat.items.forEach(m => {
                        const arr = d[m.key] || [0,0,0,0,0,0,0];
                        const total = arr.reduce((a,b) => a+b, 0);
                        csv += `"${member.name}","${cat.cat}","${m.label}",${arr.join(',')},${total}\n`;
                    });
                });
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Êó•Âà•Êï∞Â≠ó_${currentYear}Âπ¥${currentMonth}Êúà_Á¨¨${currentWeekNum}ÈÄ±.csv`;
            a.click();
        }

        // ÊúàÈñìCSV„Ç§„É≥„Éù„Éº„ÉàÔºàÁã¨Á´ãÈÅ∏ÊäúÊï∞Â≠ó„Ç∑„Éº„ÉàÂΩ¢ÂºèÔºâ
        // Ë§áÊï∞Ë°å„Å´„Åæ„Åü„Åå„ÇãÂºïÁî®Á¨¶‰ªò„Åç„Éï„Ç£„Éº„É´„Éâ„ÇíÂá¶ÁêÜ„Åó„Å¶CSVË°å„ÇíÂàÜÂâ≤
        function parseCSVLines(text) {
            const lines = [];
            let currentLine = '';
            let inQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                    currentLine += char;
                } else if ((char === '\n' || char === '\r') && !inQuotes) {
                    if (currentLine.trim()) {
                        lines.push(currentLine);
                    }
                    currentLine = '';
                    // Skip \r\n combination
                    if (char === '\r' && text[i + 1] === '\n') i++;
                } else {
                    currentLine += char;
                }
            }
            if (currentLine.trim()) {
                lines.push(currentLine);
            }
            return lines;
        }

        function importMonthCsv(event) {
            const file = event.target.files[0];
            if (!file) return;

            createBackup('ÊúàÈñìCSV„Ç§„É≥„Éù„Éº„ÉàÂâç');

            // „Éï„Ç°„Ç§„É´Âêç„Åã„Çâ„É°„É≥„Éê„ÉºÂêç„ÇíÊäΩÂá∫Ôºà‰æã: "1ÊúàÂêâÁî∞ÔºàÂÖ®Êó•Ôºâ"Ôºâ
            let memberNameFromFile = '';
            const fileMatch = file.name.match(/\d+Êúà([^Ôºà(]+)/);
            if (fileMatch) {
                memberNameFromFile = fileMatch[1].trim();
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = parseCSVLines(text);

                    // „É°„É≥„Éê„Éº„ÇíÊ§úÁ¥¢„Åæ„Åü„ÅØ‰ΩúÊàê
                    let member = data.members.find(m => m.name === memberNameFromFile);
                    if (!member && memberNameFromFile) {
                        member = { id: 'mem_' + Date.now(), name: memberNameFromFile };
                        data.members.push(member);
                    }
                    if (!member) {
                        // „Éï„Ç°„Ç§„É´Âêç„Åã„ÇâÂèñÂæó„Åß„Åç„Å™„Åã„Å£„ÅüÂ†¥Âêà„ÄÅÂÖ•Âäõ„ÇíÊ±Ç„ÇÅ„Çã
                        const name = prompt('„É°„É≥„Éê„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
                        if (!name) { alert('„Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åæ„Åó„Åü'); return; }
                        member = data.members.find(m => m.name === name);
                        if (!member) {
                            member = { id: 'mem_' + Date.now(), name: name };
                            data.members.push(member);
                        }
                    }

                    // È†ÖÁõÆÂêç„Å®„Ç≠„Éº„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞
                    const labelToKey = {
                        'ÊäïÁ®øÊï∞': 'post',
                        'ÊäïÁ®ø': 'post',
                        'Áç≤Âæó': 'apoGet',
                        'ÂÆüÊñΩÊï∞': 'apoExec',
                        'CXL': 'apoCxl',
                        '„ÉÜ„Çπ„ÇØ„É≠': 'testClose',
                        '„Ç™„Éï„Ç°„Éº': 'offer',
                        'NG': 'ng',
                        'ÁÑ°ÁùÄÂú∞': 'muchaku',
                        'ÂãïÂì°Áç≤Âæó': 'doinGet',
                        'ÂãïÂì°Áç≤ÂæóÂæåCXL': 'doinGetCxl',
                        'ÂãïÂì°ÂÆüÊñΩ': 'doinExec',
                        'ÂãïÂì°ÂÆüÊñΩÂæåCXL': 'doinExecCxl',
                        'Èù¢Ë´áÁç≤Âæó': 'mendanGet',
                        'Èù¢Ë´áÁç≤ÂæóÂæåCXL': 'mendanGetCxl',
                        'Èù¢Ë´áÂÆüÊñΩ': 'mendanExec',
                        'Èù¢Ë´áÂÆüÊñΩÂæåCXL': 'mendanExecCxl',
                        'ÊàêÁ¥Ñ': 'seiyaku',
                        '„ÇØ„Éº„É™„É≥„Ç∞„Ç™„Éï': 'coolingOff'
                    };

                    // Âπ¥Êúà„ÇíË®≠ÂÆöÔºàÁèæÂú®„ÅÆË®≠ÂÆö„Çí‰ΩøÁî®Ôºâ
                    const year = currentYear;
                    const month = currentMonth;

                    let importCount = 0;

                    for (let i = 0; i < lines.length; i++) {
                        const row = parseCSVRow(lines[i]);
                        if (row.length < 34) continue;

                        // È†ÖÁõÆÂêçÔºà3ÂàóÁõÆÔºâ
                        const itemLabel = row[2].trim();
                        const metricKey = labelToKey[itemLabel];
                        if (!metricKey) continue;

                        // 1Êó•„Äú31Êó•„ÅÆ„Éá„Éº„ÇøÔºà4ÂàóÁõÆ„Äú34ÂàóÁõÆ„ÄÅ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ3„Äú33Ôºâ
                        for (let day = 1; day <= 31; day++) {
                            const val = parseInt(row[2 + day]) || 0;

                            // „Åì„ÅÆÊó•‰ªò„Åå‰ΩïÈÄ±ÁõÆ„ÅãË®àÁÆó
                            const date = new Date(year, month - 1, day);
                            if (date.getMonth() !== month - 1) continue; // Â≠òÂú®„Åó„Å™„ÅÑÊó•‰ªò„Çí„Çπ„Ç≠„ÉÉ„Éó

                            const firstDay = new Date(year, month - 1, 1);
                            const dow = (firstDay.getDay() + 1) % 7; // ÂúüÊõúÂßã„Åæ„Çä
                            const weekNum = Math.ceil((day + dow) / 7);

                            // ÊõúÊó•„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÔºàÊúà=0, Êó•=6Ôºâ
                            const dayOfWeek = (date.getDay() + 1) % 7;

                            // ÈÄ±„Éá„Éº„Çø„ÇíÂèñÂæó„ÉªË®≠ÂÆö
                            const weekKey = `${year}-${month}-W${weekNum}`;
                            if (!data.weeks[weekKey]) {
                                data.weeks[weekKey] = {
                                    daily: {},
                                    review: {
                                        mainIssue: '', mainCause: '',
                                        causeActions: [{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]},{cause:'',actions:[]}],
                                        muchakuReasons: {}, muchakuOther: '', ngReasons: {}, doinMuchakuList: [], cases: [], cancels: []
                                    },
                                    instagram: {},
                                    nippo: {}
                                };
                            }
                            if (!data.weeks[weekKey].daily[member.id]) {
                                data.weeks[weekKey].daily[member.id] = {};
                                metrics.forEach(c => c.items.forEach(m => {
                                    data.weeks[weekKey].daily[member.id][m.key] = [0,0,0,0,0,0,0];
                                }));
                            }

                            data.weeks[weekKey].daily[member.id][metricKey][dayOfWeek] = val;
                            importCount++;
                        }
                    }

                    saveData();
                    renderAll();
                    alert(`${memberNameFromFile || member.name}„ÅÆ„Éá„Éº„Çø„ÇíÂèñ„ÇäËæº„Åø„Åæ„Åó„ÅüÔºà${importCount}‰ª∂Ôºâ`);

                } catch (err) {
                    console.error(err);
                    alert('CSV„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + err.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }

        // Êó•Âà•Êï∞Â≠ó„ÅÆCSV„Ç§„É≥„Éù„Éº„Éà
        function importDailyCsv(event) {
            const file = event.target.files[0];
            if (!file) return;

            createBackup('Êó•Âà•CSV„Ç§„É≥„Éù„Éº„ÉàÂâç');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let text = e.target.result;
                    // BOMÈô§Âéª
                    if (text.charCodeAt(0) === 0xFEFF) {
                        text = text.slice(1);
                    }
                    const lines = text.split('\n').filter(line => line.trim());

                    if (lines.length < 2) {
                        alert('CSV„Éï„Ç°„Ç§„É´„Å´„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                        return;
                    }

                    // ÂÖ®„É°„Éà„É™„ÉÉ„ÇØ„É©„Éô„É´„ÅÆ„Éû„ÉÉ„Éó„Çí‰ΩúÊàê
                    const labelToKey = {};
                    metrics.forEach(cat => {
                        cat.items.forEach(m => {
                            labelToKey[m.label] = m.key;
                        });
                    });

                    let importCount = 0;
                    let skippedZeroCount = 0;
                    let newMemberCount = 0;
                    let skippedLabels = new Set();
                    const addedMembers = new Set();

                    for (let i = 1; i < lines.length; i++) {
                        const row = parseCSVRow(lines[i]);
                        if (row.length < 10) continue;

                        const memberName = row[0].trim();
                        if (!memberName) continue;
                        const itemLabel = row[2].trim();

                        // „É°„É≥„Éê„Éº„ÇíÊ§úÁ¥¢„ÄÅ„Å™„Åë„Çå„Å∞Ëá™ÂãïËøΩÂä†
                        let member = data.members.find(m => m.name === memberName);
                        if (!member) {
                            member = { id: 'member_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5), name: memberName };
                            data.members.push(member);
                            if (!addedMembers.has(memberName)) {
                                addedMembers.add(memberName);
                                newMemberCount++;
                            }
                        }

                        // È†ÖÁõÆ„Ç≠„Éº„ÇíÊ§úÁ¥¢
                        const metricKey = labelToKey[itemLabel];
                        if (!metricKey) {
                            skippedLabels.add(itemLabel);
                            continue;
                        }

                        // ÂÖ®„Å¶0„ÅÆË°å„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºà„Éá„Éº„Çø‰∏äÊõ∏„ÅçÈò≤Ê≠¢Ôºâ
                        const allZero = Array.from({length: 7}, (_, idx) => parseInt(row[3 + idx]) || 0).every(v => v === 0);
                        if (allZero) {
                            skippedZeroCount++;
                            continue;
                        }

                        // Êó•Âà•„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
                        const d = getMemberDaily(member.id);
                        for (let day = 0; day < 7; day++) {
                            const val = parseInt(row[3 + day]) || 0;
                            d[metricKey][day] = val;
                        }
                        importCount++;
                    }

                    saveData();
                    renderAll();
                    let msg = `${importCount}‰ª∂„ÅÆ„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`;
                    if (skippedZeroCount > 0) {
                        msg += `\nÔºàÂÖ®0„ÅÆ${skippedZeroCount}Ë°å„Çí„Çπ„Ç≠„ÉÉ„ÉóÔºâ`;
                    }
                    if (newMemberCount > 0) {
                        msg += `\nÊñ∞Ë¶è„É°„É≥„Éê„Éº ${newMemberCount}Âêç„ÇíËøΩÂä†: ${Array.from(addedMembers).join(', ')}`;
                    }
                    if (skippedLabels.size > 0) {
                        msg += `\n‚ö†Ô∏è Êú™ÂØæÂøú„ÅÆÈ†ÖÁõÆ: ${Array.from(skippedLabels).join(', ')}`;
                    }
                    alert(msg);

                } catch (err) {
                    console.error(err);
                    alert('CSV„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + err.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }
        function toggleAccount(id) { document.getElementById('acc-' + id).classList.toggle('open'); }
        function addAccount() { openModal('accountModal'); }
        function saveNewAccount() {
            const name = document.getElementById('newAccountName').value.trim();
            if (!name) { alert('„Ç¢„Ç´„Ç¶„É≥„ÉàÂêç„ÇíÂÖ•Âäõ'); return; }
            if (selectedMember === 'all') { alert('„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†„Åô„Çã„É°„É≥„Éê„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÂÖ®‰Ωì„Åß„ÅØ„Å™„ÅèÁâπÂÆö„ÅÆ„É°„É≥„Éê„Éº„ÇíÈÅ∏ÊäûÔºâ'); return; }
            data.accounts.push({ id: 'acc_' + Date.now(), name, url: document.getElementById('newAccountUrl').value, ownerId: selectedMember });
            saveData(); closeModal('accountModal');
            document.getElementById('newAccountName').value = '';
            document.getElementById('newAccountUrl').value = '';
            renderInstagram();
        }

        // Instagram CSV„Ç§„É≥„Éù„Éº„Éà
        function importInstagramCsv(file) {
            if (!file) return;

            // „Éï„Ç°„Ç§„É´Âêç„Åã„ÇâÂπ¥ÊúàÈÄ±„ÇíÂèñÂæó (‰æã: instagram-2026-1-W4.csv)
            const match = file.name.match(/instagram-(\d+)-(\d+)-W(\d+)/i);
            if (!match) {
                alert('„Éï„Ç°„Ç§„É´Âêç„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ\n‰æã: instagram-2026-1-W4.csv');
                return;
            }
            const [, fileYear, fileMonth, fileWeek] = match.map(Number);
            const weekKey = `${fileYear}-${fileMonth}-W${fileWeek}`;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim() && !line.startsWith('---'));

                    // „Éò„ÉÉ„ÉÄ„Éº„Çí„Çπ„Ç≠„ÉÉ„Éó
                    const dataLines = lines.slice(1).filter(line => {
                        const first = line.split(',')[0];
                        return first && !first.includes('„Ç¢„Ç´„Ç¶„É≥„ÉàÂêç') && first.trim() !== '';
                    });

                    // ÊõúÊó•„Éû„ÉÉ„Éî„É≥„Ç∞ (ÂúüÊõúÂßã„Åæ„Çä)
                    const dayMap = { 'Âúü': 0, 'Êó•': 1, 'Êúà': 2, 'ÁÅ´': 3, 'Ê∞¥': 4, 'Êú®': 5, 'Èáë': 6 };

                    // „Éá„Éº„Çø„ÇíÊï¥ÁêÜ
                    const accountData = {};
                    dataLines.forEach(line => {
                        // CSVËß£ÊûêÔºà„ÉÄ„Éñ„É´„ÇØ„Ç©„Éº„ÉàÂØæÂøúÔºâ
                        const cols = line.match(/(".*?"|[^,]+)/g)?.map(c => c.replace(/^"|"$/g, '').trim()) || [];
                        if (cols.length < 14) return;

                        const accName = cols[0];
                        const dayName = cols[1];
                        const dayIndex = dayMap[dayName];

                        if (accName && dayIndex !== undefined) {
                            if (!accountData[accName]) {
                                accountData[accName] = {
                                    follow: [0,0,0,0,0,0,0],
                                    follower: [0,0,0,0,0,0,0],
                                    followCut: [0,0,0,0,0,0,0],
                                    followerCut: [0,0,0,0,0,0,0],
                                    dmSend: [0,0,0,0,0,0,0],
                                    dmReply: [0,0,0,0,0,0,0],
                                    dmOffer: [0,0,0,0,0,0,0],
                                    apoGet: [0,0,0,0,0,0,0],
                                    apoExec: [0,0,0,0,0,0,0],
                                    doinPlan: [0,0,0,0,0,0,0],
                                    doinExec: [0,0,0,0,0,0,0],
                                    seiyaku: [0,0,0,0,0,0,0]
                                };
                            }
                            accountData[accName].follow[dayIndex] = parseInt(cols[2]) || 0;
                            accountData[accName].follower[dayIndex] = parseInt(cols[3]) || 0;
                            accountData[accName].followCut[dayIndex] = parseInt(cols[4]) || 0;
                            accountData[accName].followerCut[dayIndex] = parseInt(cols[5]) || 0;
                            accountData[accName].dmSend[dayIndex] = parseInt(cols[6]) || 0;
                            accountData[accName].dmReply[dayIndex] = parseInt(cols[7]) || 0;
                            accountData[accName].dmOffer[dayIndex] = parseInt(cols[8]) || 0;
                            accountData[accName].apoGet[dayIndex] = parseInt(cols[9]) || 0;
                            accountData[accName].apoExec[dayIndex] = parseInt(cols[10]) || 0;
                            accountData[accName].doinPlan[dayIndex] = parseInt(cols[11]) || 0;
                            accountData[accName].doinExec[dayIndex] = parseInt(cols[12]) || 0;
                            accountData[accName].seiyaku[dayIndex] = parseInt(cols[13]) || 0;
                        }
                    });

                    // ÈÄ±„Éá„Éº„Çø„ÇíÁ¢∫‰øù
                    if (!data.weeks[weekKey]) {
                        data.weeks[weekKey] = { daily: {}, review: {}, instagram: {}, nippo: {} };
                    }
                    if (!data.weeks[weekKey].instagram) {
                        data.weeks[weekKey].instagram = {};
                    }

                    // „Ç¢„Ç´„Ç¶„É≥„Éà„Çí„Ç§„É≥„Éù„Éº„Éà
                    let importedCount = 0;
                    const currentOwnerId = selectedMember === 'all' ? (data.members[0]?.id || 'default') : selectedMember;

                    Object.keys(accountData).forEach(accName => {
                        // „Ç¢„Ç´„Ç¶„É≥„Éà„ÅåÂ≠òÂú®„Åó„Å™„Åë„Çå„Å∞‰ΩúÊàê
                        let acc = data.accounts.find(a => a.name === accName);
                        if (!acc) {
                            acc = { id: 'acc_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5), name: accName, url: '', ownerId: currentOwnerId };
                            data.accounts.push(acc);
                        }

                        // „Éá„Éº„Çø„Çí„Çª„ÉÉ„Éà
                        data.weeks[weekKey].instagram[acc.id] = accountData[accName];
                        importedCount++;
                    });

                    saveData();

                    // „Ç§„É≥„Éù„Éº„ÉàÂÖà„ÅÆÈÄ±„Å´ÁßªÂãï
                    currentYear = fileYear;
                    currentMonth = fileMonth;
                    currentWeekNum = fileWeek;
                    updateWeekLabel();
                    renderAll();

                    alert(`${importedCount}‰ª∂„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü„ÄÇ\n(${fileYear}Âπ¥${fileMonth}Êúà Á¨¨${fileWeek}ÈÄ±)`);

                } catch (err) {
                    console.error('CSV import error:', err);
                    alert('CSV„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + err.message);
                }
            };
            reader.readAsText(file, 'UTF-8');

            // „Éï„Ç°„Ç§„É´ÂÖ•Âäõ„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('igCsvImport').value = '';
        }

        // ÈÅ∏Êäû„Åï„Çå„Åü„É°„É≥„Éê„Éº„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíÂèñÂæó
        function getMyAccounts() {
            console.log('üîç getMyAccounts - selectedMember:', selectedMember);
            console.log('üîç ÂÖ®„Ç¢„Ç´„Ç¶„É≥„Éà:', data.accounts.map(a => ({name: a.name, ownerId: a.ownerId})));

            // „ÄåÂÖ®‰Ωì„ÄçÈÅ∏ÊäûÊôÇ„ÅØÂÖ®„Ç¢„Ç´„Ç¶„É≥„ÉàË°®Á§∫
            if (selectedMember === 'all') {
                console.log('üîç ÂÖ®‰ΩìÈÅ∏Êäû - ÂÖ®„Ç¢„Ç´„Ç¶„É≥„ÉàË°®Á§∫');
                return data.accounts;
            }

            // ÁâπÂÆö„É°„É≥„Éê„ÉºÈÅ∏ÊäûÊôÇ„ÅØ„Åù„ÅÆ„É°„É≥„Éê„Éº„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„ÅÆ„Åø
            const filtered = data.accounts.filter(acc => acc.ownerId === selectedMember);
            console.log('üîç „Éï„Ç£„É´„ÇøÂæå:', filtered.map(a => a.name));
            return filtered;
        }

        // „É°„É≥„Éê„Éº„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        function isUserSelected() {
            // „ÄåÂÖ®‰Ωì„Äç„Åæ„Åü„ÅØÁâπÂÆö„É°„É≥„Éê„Éº„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çå„Å∞OK
            return true;
        }
        function deleteAccount(id) { if (!confirm('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return; data.accounts = data.accounts.filter(a => a.id !== id); saveData(); renderInstagram(); }

        // Ë®≠ÂÆö
        let settingsSelectedMember = 'all';

        function renderSettings() {
            console.log('=== renderSettingsÈñãÂßã ===');
            console.log('„É°„É≥„Éê„ÉºÊï∞:', data.members.length);

            // „É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±Ë°®Á§∫„ÇíÊõ¥Êñ∞
            try {
                const memberName = data.members.find(m => m.id === getCurrentMemberId())?.name || '';
                const nameEl = document.getElementById('settingsUserName');
                const emailEl = document.getElementById('settingsUserEmail');
                const roleEl = document.getElementById('settingsUserRole');
                if (nameEl) nameEl.textContent = memberName || '(Êú™Á¥ê‰ªò„Åë)';
                if (emailEl) emailEl.textContent = currentAuthUser?.email || '';
                if (roleEl) roleEl.textContent = isAdmin ? 'ÁÆ°ÁêÜËÄÖ' : '‰∏ÄËà¨„É°„É≥„Éê„Éº';

                // ÁÆ°ÁêÜËÄÖ„É°„Éã„É•„ÉºË°®Á§∫
                const adminMenu = document.getElementById('adminMenu');
                if (adminMenu) {
                    adminMenu.style.display = isAdmin ? 'block' : 'none';
                    if (isAdmin) renderUserMapAdmin();
                }
            } catch (e) {
                console.error('‚ùå „É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±Ë°®Á§∫„Ç®„É©„Éº:', e);
            }

            // „É°„É≥„Éê„Éº„É™„Çπ„Éà
            try {
                document.getElementById('memberList').innerHTML = data.members.length === 0 ? '<p style="color:#64748b">„É°„É≥„Éê„Éº„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>' :
                    data.members.map(m => `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#0f172a;border-radius:6px;margin-bottom:6px"><span>${m.name}</span><button class="btn btn-danger btn-sm" onclick="deleteMember('${m.id}')">ÂâäÈô§</button></div>`).join('');
                console.log('‚úÖ „É°„É≥„Éê„Éº„É™„Çπ„ÉàÊõ¥Êñ∞ÂÆå‰∫Ü');
            } catch (e) {
                console.error('‚ùå „É°„É≥„Éê„Éº„É™„Çπ„ÉàÊõ¥Êñ∞„Ç®„É©„Éº:', e);
            }

            // „Éí„É≥„Éà„ÉÜ„Ç≠„Çπ„Éà„ÇíÊõ¥Êñ∞
            try {
                const hintEl = document.getElementById('settingsHint');
                const canEdit = canEditMember(selectedMember);

                if (selectedMember === 'all') {
                    if (hintEl) {
                        hintEl.innerHTML = '‚Äª <strong style="color:#f59e0b">„ÄåÂÖ®‰Ωì„ÄçÈÅ∏ÊäûÊôÇ„ÅØÈñ≤Ë¶ß„ÅÆ„Åø</strong> - ÂêÑ„É°„É≥„Éê„Éº„ÅÆÁõÆÊ®ôÂêàË®à„ÇíË°®Á§∫„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÁ∑®ÈõÜ„Åô„Çã„Å´„ÅØÂÄãÂà•„É°„É≥„Éê„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    }
                    displayTeamTotals();
                    disableInputs(true);
                } else if (!canEdit) {
                    const memberName = data.members.find(m => m.id === selectedMember)?.name || '';
                    if (hintEl) {
                        hintEl.innerHTML = `‚Äª <strong style="color:#ef4444">üîí „Äå${memberName}„Äç„Åï„Çì„ÅÆË®≠ÂÆö„ÅØÈñ≤Ë¶ß„ÅÆ„Åø</strong> - ‰ªñ„ÅÆ„É°„É≥„Éê„Éº„ÅÆË®≠ÂÆö„ÅØÁ∑®ÈõÜ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ`;
                    }
                    loadMemberSettings(selectedMember);
                    disableInputs(true);
                } else {
                    if (hintEl) {
                        const memberName = data.members.find(m => m.id === selectedMember)?.name || '';
                        hintEl.innerHTML = `‚Äª ÁèæÂú®„Äå<strong style="color:#6366f1">${memberName}</strong>„Äç„Åï„ÇìÂÄã‰∫∫„ÅÆÁõÆÊ®ô„ÇíË®≠ÂÆö‰∏≠`;
                    }
                    disableInputs(false);
                    loadMemberSettings(selectedMember);
                }
            } catch (e) {
                console.error('‚ùå Ë®≠ÂÆöË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
            }

            // Change 6: ‰πñÈõ¢„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÆüË°åÔºàË®≠ÂÆö„Çø„Éñ„ÅßÈÅ∏Êäû‰∏≠„ÅÆ„É°„É≥„Éê„Éº„Çí‰ΩøÁî®Ôºâ
            try {
                const divergenceMember = (settingsSelectedMember && settingsSelectedMember !== 'all')
                    ? settingsSelectedMember : selectedMember;
                checkRatesDivergence(divergenceMember);
            } catch (e) {
                console.error('‚ùå ‰πñÈõ¢„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº:', e);
            }

            // Change 7: ÊúàÊú´Ëá™Âãï‰øùÂ≠ò„Éó„É≠„É≥„Éó„Éà
            try {
                checkMonthEndRatePrompt();
            } catch (e) {
                console.error('‚ùå ÊúàÊú´„Éó„É≠„É≥„Éó„Éà„Ç®„É©„Éº:', e);
            }
        }

        function onSettingsMemberChange() {
            const selectEl = document.getElementById('settingsMemberSelect');
            if (!selectEl) {
                console.error('settingsMemberSelectË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            settingsSelectedMember = selectEl.value;
            console.log('=== „É°„É≥„Éê„ÉºÂ§âÊõ¥ ===');
            console.log('ÈÅ∏Êäû„Åï„Çå„Åü„É°„É≥„Éê„ÉºID:', settingsSelectedMember);

            // Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
            loadMemberSettings(settingsSelectedMember);

            // ‰πñÈõ¢„ÉÅ„Çß„ÉÉ„ÇØ„ÇÇÊõ¥Êñ∞
            try { checkRatesDivergence(settingsSelectedMember); } catch(e) { console.error('‰πñÈõ¢„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº:', e); }

            // ÈÅ∏Êäû„Åó„Åü„É°„É≥„Éê„Éº„ÅÆÂêçÂâç„ÇíË°®Á§∫
            const hintEl = document.getElementById('settingsHint');
            if (hintEl) {
                if (settingsSelectedMember === 'all') {
                    hintEl.innerHTML = '‚Äª„ÄåÂÖ®‰Ωì„Äç„ÇíÈÅ∏Êäû‰∏≠ - „ÉÅ„Éº„É†ÂÖ®‰Ωì„ÅÆÁõÆÊ®ôÂêàË®àÂÄ§„ÇíË®≠ÂÆö <span style="color:#22c55e">‚úì Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü</span>';
                } else {
                    const memberName = data.members.find(m => m.id === settingsSelectedMember)?.name || '';
                    hintEl.innerHTML = `‚Äª<strong style="color:#6366f1">${memberName}</strong>„Åï„ÇìÂÄã‰∫∫„ÅÆÁõÆÊ®ô„ÇíË®≠ÂÆö‰∏≠ <span style="color:#22c55e">‚úì Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü</span>`;
                }
                // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíÊï∞ÁßíÂæå„Å´Ê∂à„Åô
                setTimeout(() => {
                    if (settingsSelectedMember === 'all') {
                        hintEl.innerHTML = '‚Äª„ÄåÂÖ®‰Ωì„Äç„ÇíÈÅ∏Êäû‰∏≠ - „ÉÅ„Éº„É†ÂÖ®‰Ωì„ÅÆÁõÆÊ®ôÂêàË®àÂÄ§„ÇíË®≠ÂÆö';
                    } else {
                        const memberName = data.members.find(m => m.id === settingsSelectedMember)?.name || '';
                        hintEl.innerHTML = `‚Äª<strong style="color:#6366f1">${memberName}</strong>„Åï„ÇìÂÄã‰∫∫„ÅÆÁõÆÊ®ô„ÇíË®≠ÂÆö‰∏≠`;
                    }
                }, 2000);
            }
        }

        function disableInputs(disabled) {
            const inputIds = ['bPost', 'bApoGet', 'bApoExec', 'bDoinGet', 'bDoinExec', 'bMendan', 'bSeiyaku',
                'mPost', 'mApoGet', 'mApoExec', 'mDoinGet', 'mDoinExec', 'mMendan', 'mMendanExec', 'mSeiyaku',
                'igGoalSend', 'igGoalReply', 'igGoalOffer', 'igGoalApoGet', 'igGoalApoExec', 'igGoalDoinExec', 'igGoalSeiyaku'];
            inputIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.disabled = disabled;
                    el.style.opacity = disabled ? '0.5' : '1';
                    el.style.cursor = disabled ? 'not-allowed' : 'text';
                }
            });
        }

        function displayTeamTotals() {
            // ÂÖ®„É°„É≥„Éê„Éº„ÅÆË®≠ÂÆö„ÇíÂêàË®à
            let budgetTotal = { post: 0, apoGet: 0, apoExec: 0, doinGet: 0, doinExec: 0, mendan: 0, seiyaku: 0 };
            let monthlyTotal = { post: 0, apoGet: 0, apoExec: 0, doinGet: 0, doinExec: 0, mendan: 0, mendanExec: 0, seiyaku: 0 };
            let igTotal = { send: 0, reply: 0, offer: 0, apoGet: 0, apoExec: 0, doinExec: 0, seiyaku: 0 };

            const monthKey = getMonthKey();
            data.members.forEach(member => {
                if (data.settings.memberSettings && data.settings.memberSettings[member.id] && data.settings.memberSettings[member.id][monthKey]) {
                    const mb = data.settings.memberSettings[member.id][monthKey].budget || {};
                    const mm = data.settings.memberSettings[member.id][monthKey].monthly || {};
                    const mig = data.settings.memberSettings[member.id][monthKey].instagram || {};

                    budgetTotal.post += mb.post || 0;
                    budgetTotal.apoGet += mb.apoGet || 0;
                    budgetTotal.apoExec += mb.apoExec || 0;
                    budgetTotal.doinGet += mb.doinGet || 0;
                    budgetTotal.doinExec += mb.doinExec || 0;
                    budgetTotal.mendan += mb.mendan || 0;
                    budgetTotal.seiyaku += mb.seiyaku || 0;

                    monthlyTotal.post += mm.post || 0;
                    monthlyTotal.apoGet += mm.apoGet || 0;
                    monthlyTotal.apoExec += mm.apoExec || 0;
                    monthlyTotal.doinGet += mm.doinGet || 0;
                    monthlyTotal.doinExec += mm.doinExec || 0;
                    monthlyTotal.mendan += mm.mendan || 0;
                    monthlyTotal.mendanExec += mm.mendanExec || 0;
                    monthlyTotal.seiyaku += mm.seiyaku || 0;

                    igTotal.send += mig.send || 0;
                    igTotal.reply += mig.reply || 0;
                    igTotal.offer += mig.offer || 0;
                    igTotal.apoGet += mig.apoGet || 0;
                    igTotal.apoExec += mig.apoExec || 0;
                    igTotal.doinExec += mig.doinExec || 0;
                    igTotal.seiyaku += mig.seiyaku || 0;
                }
            });

            // ÂêàË®àÂÄ§„ÇíË°®Á§∫ÔºàË¶ÅÁ¥†„ÅÆÂ≠òÂú®„ÉÅ„Çß„ÉÉ„ÇØ‰ªò„ÅçÔºâ
            const setValueSafe = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.value = val;
            };
            setValueSafe('bPost', budgetTotal.post);
            setValueSafe('bApoGet', budgetTotal.apoGet);
            setValueSafe('bApoExec', budgetTotal.apoExec);
            setValueSafe('bDoinGet', budgetTotal.doinGet);
            setValueSafe('bDoinExec', budgetTotal.doinExec);
            setValueSafe('bMendan', budgetTotal.mendan);
            setValueSafe('bSeiyaku', budgetTotal.seiyaku);

            setValueSafe('mPost', monthlyTotal.post);
            setValueSafe('mApoGet', monthlyTotal.apoGet);
            setValueSafe('mApoExec', monthlyTotal.apoExec);
            setValueSafe('mDoinGet', monthlyTotal.doinGet);
            setValueSafe('mDoinExec', monthlyTotal.doinExec);
            setValueSafe('mMendan', monthlyTotal.mendan);
            setValueSafe('mMendanExec', monthlyTotal.mendanExec);
            setValueSafe('mSeiyaku', monthlyTotal.seiyaku);

            // „Ç§„É≥„Çπ„ÇøÁõÆÊ®ô„ÅÆÂêàË®à„ÇíË°®Á§∫
            setValueSafe('igGoalSend', igTotal.send);
            setValueSafe('igGoalReply', igTotal.reply);
            setValueSafe('igGoalOffer', igTotal.offer);
            setValueSafe('igGoalApoGet', igTotal.apoGet);
            setValueSafe('igGoalApoExec', igTotal.apoExec);
            setValueSafe('igGoalDoinExec', igTotal.doinExec);
            setValueSafe('igGoalSeiyaku', igTotal.seiyaku);
        }

        function loadMemberSettings(memberId) {
            console.log('loadMemberSettingsÂëº„Å≥Âá∫„Åó:', memberId);
            let b, mo, ig;
            if (memberId === 'all') {
                b = data.settings.budget || {};
                mo = data.settings.monthly || {};
                ig = {}; // ÂÖ®‰ΩìÈÅ∏ÊäûÊôÇ„ÅØ„Ç§„É≥„Çπ„ÇøÁõÆÊ®ô„ÅØÁ©∫
                console.log('ÂÖ®‰ΩìË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø');
            } else {
                const monthKey = getMonthKey();
                if (!data.settings.memberSettings) data.settings.memberSettings = {};
                if (!data.settings.memberSettings[memberId]) {
                    data.settings.memberSettings[memberId] = {};
                }
                if (!data.settings.memberSettings[memberId][monthKey]) {
                    data.settings.memberSettings[memberId][monthKey] = { budget: {}, monthly: {}, instagram: {} };
                }
                b = data.settings.memberSettings[memberId][monthKey].budget || {};
                mo = data.settings.memberSettings[memberId][monthKey].monthly || {};
                ig = data.settings.memberSettings[memberId][monthKey].instagram || {};
                console.log('„É°„É≥„Éê„ÉºÂÄãÂà•Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø:', memberId, 'Êúà:', monthKey);
            }
            console.log('budget:', JSON.stringify(b));
            console.log('monthly:', JSON.stringify(mo));
            console.log('instagram:', JSON.stringify(ig));

            // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Å´ÂÄ§„ÇíË®≠ÂÆö
            const fields = [
                ['bPost', b.post],
                ['bApoGet', b.apoGet],
                ['bApoExec', b.apoExec],
                ['bDoinGet', b.doinGet],
                ['bDoinExec', b.doinExec],
                ['bMendan', b.mendan],
                ['bSeiyaku', b.seiyaku],
                ['mPost', mo.post],
                ['mApoGet', mo.apoGet],
                ['mApoExec', mo.apoExec],
                ['mDoinGet', mo.doinGet],
                ['mDoinExec', mo.doinExec],
                ['mMendan', mo.mendan],
                ['mMendanExec', mo.mendanExec],
                ['mSeiyaku', mo.seiyaku],
                ['igGoalSend', ig.send],
                ['igGoalReply', ig.reply],
                ['igGoalOffer', ig.offer],
                ['igGoalApoGet', ig.apoGet],
                ['igGoalApoExec', ig.apoExec],
                ['igGoalDoinExec', ig.doinExec],
                ['igGoalSeiyaku', ig.seiyaku]
            ];

            fields.forEach(([id, val]) => {
                const el = document.getElementById(id);
                if (el) {
                    const newVal = val || 0;
                    const oldVal = el.value;
                    console.log(`${id}: ${oldVal} ‚Üí ${newVal}`);
                    el.value = newVal;
                    // ÂÄ§„ÅåÂ§â„Çè„Å£„ÅüÂ†¥Âêà„ÅØ„Éè„Ç§„É©„Ç§„Éà
                    if (String(oldVal) !== String(newVal)) {
                        el.classList.remove('settings-updated');
                        void el.offsetWidth; // reflow
                        el.classList.add('settings-updated');
                    }
                } else {
                    console.error(`Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${id}`);
                }
            });
            console.log('=== Ë®≠ÂÆöË™≠„ÅøËæº„ÅøÂÆå‰∫Ü ===');
        }

        function saveSettings() {
            // „Éò„ÉÉ„ÉÄ„Éº„ÅßÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„É°„É≥„Éê„Éº„Çí‰ΩøÁî®ÔºàsettingsSelectedMember„Åå'all'„ÅÆÂ†¥Âêà„ÅØselectedMember„Çí‰ΩøÁî®Ôºâ
            const targetMember = (settingsSelectedMember && settingsSelectedMember !== 'all')
                ? settingsSelectedMember
                : selectedMember;

            // ÂÖ®‰ΩìÈÅ∏ÊäûÊôÇ„ÅØ‰øùÂ≠ò‰∏çÂèØ
            if (targetMember === 'all') {
                console.log('ÂÖ®‰ΩìÈÅ∏ÊäûÊôÇ„ÅØ‰øùÂ≠ò„Åß„Åç„Åæ„Åõ„Çì');
                alert('‚ö†Ô∏è „É°„É≥„Éê„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n\n„ÄåÂÖ®‰Ωì„ÄçÈÅ∏Êäû‰∏≠„ÅØÁõÆÊ®ô„Çí‰øùÂ≠ò„Åß„Åç„Åæ„Åõ„Çì„ÄÇ\n„Éò„ÉÉ„ÉÄ„Éº„ÅÆ„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÅßÁâπÂÆö„ÅÆ„É°„É≥„Éê„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åã„ÇâÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            console.log('=== Ë®≠ÂÆö‰øùÂ≠ò ===');
            console.log('‰øùÂ≠òÂÖà:', targetMember);

            const budgetData = {
                post: parseInt(document.getElementById('bPost').value) || 0,
                apoGet: parseInt(document.getElementById('bApoGet').value) || 0,
                apoExec: parseInt(document.getElementById('bApoExec').value) || 0,
                doinGet: parseInt(document.getElementById('bDoinGet').value) || 0,
                doinExec: parseInt(document.getElementById('bDoinExec').value) || 0,
                mendan: parseInt(document.getElementById('bMendan').value) || 0,
                seiyaku: parseInt(document.getElementById('bSeiyaku').value) || 0
            };
            const monthlyData = {
                post: parseInt(document.getElementById('mPost').value) || 0,
                apoGet: parseInt(document.getElementById('mApoGet').value) || 0,
                apoExec: parseInt(document.getElementById('mApoExec').value) || 0,
                doinGet: parseInt(document.getElementById('mDoinGet').value) || 0,
                doinExec: parseInt(document.getElementById('mDoinExec').value) || 0,
                mendan: parseInt(document.getElementById('mMendan').value) || 0,
                mendanExec: parseInt(document.getElementById('mMendanExec').value) || 0,
                seiyaku: parseInt(document.getElementById('mSeiyaku').value) || 0
            };

            console.log('‰øùÂ≠ò„Åô„Çãbudget:', JSON.stringify(budgetData));
            console.log('‰øùÂ≠ò„Åô„Çãmonthly:', JSON.stringify(monthlyData));

            // ÂÄãÂà•„É°„É≥„Éê„Éº„ÅÆË®≠ÂÆö„Å®„Åó„Å¶‰øùÂ≠òÔºàÊúà„Åî„Å®Ôºâ
            const monthKey = getMonthKey();
            if (!data.settings.memberSettings) data.settings.memberSettings = {};
            if (!data.settings.memberSettings[targetMember]) {
                data.settings.memberSettings[targetMember] = {};
            }
            if (!data.settings.memberSettings[targetMember][monthKey]) {
                data.settings.memberSettings[targetMember][monthKey] = {};
            }
            data.settings.memberSettings[targetMember][monthKey].budget = budgetData;
            data.settings.memberSettings[targetMember][monthKey].monthly = monthlyData;

            // „Ç§„É≥„Çπ„ÇøÊúàÈñìÁõÆÊ®ô„ÇÇ„É°„É≥„Éê„Éº„Åî„Å®„Å´‰øùÂ≠ò
            data.settings.memberSettings[targetMember][monthKey].instagram = {
                send: parseInt(document.getElementById('igGoalSend').value) || 0,
                reply: parseInt(document.getElementById('igGoalReply').value) || 0,
                offer: parseInt(document.getElementById('igGoalOffer').value) || 0,
                apoGet: parseInt(document.getElementById('igGoalApoGet').value) || 0,
                apoExec: parseInt(document.getElementById('igGoalApoExec').value) || 0,
                doinExec: parseInt(document.getElementById('igGoalDoinExec').value) || 0,
                seiyaku: parseInt(document.getElementById('igGoalSeiyaku').value) || 0
            };
            console.log('„É°„É≥„Éê„ÉºÂÄãÂà•Ë®≠ÂÆö„Å®„Åó„Å¶‰øùÂ≠ò„Åó„Åæ„Åó„Åü:', targetMember, 'Êúà:', monthKey);

            saveData(); renderSummary(); renderReview(); renderInstagram();
        }

        // „É°„É≥„Éê„Éº„ÅÆÁõÆÊ®ô„ÇíÂèñÂæóÔºàÂÄã‰∫∫Ë®≠ÂÆö„Åå„ÅÇ„Çå„Å∞ÂÄã‰∫∫„ÄÅ„Å™„Åë„Çå„Å∞0Ôºâ
        function getMemberGoals(memberId) {
            const memberSettings = data.settings.memberSettings;
            const monthKey = getMonthKey();

            // „É°„É≥„Éê„Éº„ÅÆÂÄã‰∫∫Ë®≠ÂÆö„Åå„ÅÇ„Çå„Å∞Ôºà0„Åß„ÇÇÔºâ„Åù„Çå„Çí‰ΩøÁî®
            if (memberSettings && memberSettings[memberId] && memberSettings[memberId][monthKey] && memberSettings[memberId][monthKey].monthly) {
                const monthly = memberSettings[memberId][monthKey].monthly;
                return {
                    post: monthly.post || 0,
                    apoGet: monthly.apoGet || 0,
                    apoExec: monthly.apoExec || 0,
                    doinGet: monthly.doinGet || 0,
                    doinExec: monthly.doinExec || 0,
                    mendan: monthly.mendan || 0,
                    mendanExec: monthly.mendanExec || 0,
                    seiyaku: monthly.seiyaku || 0
                };
            }

            // ÂÄã‰∫∫Ë®≠ÂÆö„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ0„ÇíËøî„ÅôÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Åó„Å™„ÅÑÔºâ
            return {
                post: 0,
                apoGet: 0,
                apoExec: 0,
                doinGet: 0,
                doinExec: 0,
                mendan: 0,
                mendanExec: 0,
                seiyaku: 0
            };
        }

        // „Éá„Éê„ÉÉ„Ç∞Áî®: „Éá„Éº„ÇøÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
        function debugShowSettings() {
            const ms = data.settings.memberSettings || {};
            const memberList = data.members.map(m => `${m.name}(${m.id})`).join(', ');
            const currentMemberId = selectedMember;
            const currentMemberName = data.members.find(m => m.id === currentMemberId)?.name || '(ÂÖ®‰Ωì)';

            let msg = `„Äê„Éá„Éº„ÇøÁ¢∫Ë™ç„Äë\n\n`;
            msg += `‚ñ† ÁèæÂú®ÈÅ∏Êäû‰∏≠: ${currentMemberName} (${currentMemberId})\n\n`;
            msg += `‚ñ† „É°„É≥„Éê„Éº‰∏ÄË¶ß: ${memberList}\n\n`;
            msg += `‚ñ† memberSettings:\n`;

            for (const memberId in ms) {
                const memberName = data.members.find(m => m.id === memberId)?.name || '‰∏çÊòé';
                const monthly = ms[memberId]?.monthly || {};
                const hasValue = Object.values(monthly).some(v => v > 0);
                msg += `  ${memberName}: post=${monthly.post || 0}, apoGet=${monthly.apoGet || 0}, seiyaku=${monthly.seiyaku || 0} [${hasValue ? 'ÂÄ§„ÅÇ„Çä' : 'ÂÄ§„Å™„Åó'}]\n`;
            }

            msg += `\n‚ñ† getMemberGoals('${currentMemberId}')„ÅÆÁµêÊûú:\n`;
            const goals = getMemberGoals(currentMemberId);
            msg += `  post=${goals.post}, apoGet=${goals.apoGet}, seiyaku=${goals.seiyaku}\n`;

            alert(msg);
        }

        // „Éá„Éê„ÉÉ„Ç∞Áî®: NG„Éá„Éº„ÇøÁ¢∫Ë™ç
        function debugNgData() {
            const members = selectedMember === 'all' ? data.members : data.members.filter(m => m.id === selectedMember);
            const weekKey = `${currentYear}-${currentMonth}-W${currentWeekNum}`;

            let msg = `„ÄêNG„Éá„Éº„Çø „Éá„Éê„ÉÉ„Ç∞„Äë\n\n`;
            msg += `‚ñ† Ë°®Á§∫„É¢„Éº„Éâ: ${viewPeriod === 'month' ? 'ÊúàÊ¨°' : 'ÈÄ±Ê¨°'}\n`;
            msg += `‚ñ† ÈÅ∏Êäû„É°„É≥„Éê„Éº: ${selectedMember === 'all' ? 'ÂÖ®‰Ωì' : data.members.find(m => m.id === selectedMember)?.name || selectedMember}\n`;
            msg += `‚ñ† ÁèæÂú®„ÅÆÈÄ±: ${weekKey}\n\n`;

            if (viewPeriod === 'month') {
                const maxWDbg = getMaxWeekNum(currentYear, currentMonth);
                msg += `‚ñ† ÊúàÊ¨°„É¢„Éº„Éâ: W1„ÄúW${maxWDbg}„ÅÆÂÖ®„Éá„Éº„Çø„ÇíÈõÜË®à\n\n`;
                for (let w = 1; w <= maxWDbg; w++) {
                    const wk = `${currentYear}-${currentMonth}-W${w}`;
                    const wkData = data.weeks[wk];
                    if (wkData && wkData.daily) {
                        members.forEach(member => {
                            const d = wkData.daily[member.id];
                            if (d && d.ngReasonsByDay) {
                                for (let day = 0; day < 7; day++) {
                                    const dayData = d.ngReasonsByDay[day];
                                    if (dayData && dayData.counts && dayData.counts.some(c => c > 0)) {
                                        msg += `${wk} ${member.name} Day${day}: ${JSON.stringify(dayData.counts)}\n`;
                                    }
                                }
                            }
                        });
                    }
                }
            } else {
                msg += `‚ñ† ÈÄ±Ê¨°„É¢„Éº„Éâ: ÁèæÂú®„ÅÆÈÄ±„ÅÆ„Åø\n\n`;
                members.forEach(member => {
                    const d = getMemberDaily(member.id);
                    const reasonsByDay = d.ngReasonsByDay || {};
                    msg += `${member.name}:\n`;
                    let hasData = false;
                    for (let day = 0; day < 7; day++) {
                        const dayData = reasonsByDay[day];
                        if (dayData && dayData.counts && dayData.counts.some(c => c > 0)) {
                            msg += `  Day${day}: ${JSON.stringify(dayData.counts)}\n`;
                            hasData = true;
                        }
                    }
                    if (!hasData) {
                        msg += `  (NG„Éá„Éº„Çø„Å™„Åó)\n`;
                    }
                });
            }

            alert(msg);
        }

        function saveCurrentUser() {
            // Ë™çË®º„Éô„Éº„Çπ„ÅßID„ÅåÊ±∫„Åæ„Çã„Åü„ÇÅ„ÄÅ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
        }

        function renderUserMapAdmin() {
            if (!isAdmin) return;
            const listEl = document.getElementById('userMapList');
            if (!listEl) return;
            let html = '<table style="width:100%;font-size:12px;border-collapse:collapse">';
            html += '<tr style="color:#94a3b8"><th style="text-align:left;padding:4px">„É°„Éº„É´</th><th style="text-align:left;padding:4px">„É°„É≥„Éê„Éº</th><th style="text-align:left;padding:4px">Ê®©Èôê</th></tr>';
            for (const uid in userMap) {
                const entry = userMap[uid];
                const memberName = data.members.find(m => m.id === entry.memberId)?.name || entry.memberId;
                const roleBadge = entry.isAdmin ? '<span style="color:#f59e0b;font-weight:600">ÁÆ°ÁêÜËÄÖ</span>' : '‰∏ÄËà¨';
                html += `<tr><td style="padding:4px;color:#e2e8f0">${entry.email}</td><td style="padding:4px;color:#e2e8f0">${memberName}</td><td style="padding:4px">${roleBadge}</td></tr>`;
            }
            html += '</table>';
            listEl.innerHTML = html;
        }

        function showRelinkForm() {
            const form = document.getElementById('relinkForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
            const select = document.getElementById('relinkSelect');
            select.innerHTML = '<option value="">-- „É°„É≥„Éê„Éº„ÇíÈÅ∏Êäû --</option>';
            data.members.forEach(m => {
                select.innerHTML += `<option value="${m.id}">${m.name}</option>`;
            });
        }

        async function relinkMember() {
            const memberId = document.getElementById('relinkSelect').value;
            if (!memberId) { alert('„É°„É≥„Éê„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            const uid = currentAuthUser.uid;
            try {
                await database.ref('teams/' + TEAM_ID + '/userMap/' + uid + '/memberId').set(memberId);
                userMap[uid].memberId = memberId;
                currentMemberId = memberId;
                document.getElementById('relinkForm').style.display = 'none';
                updateHeaderUserInfo();
                renderAll();
                alert('Á¥ê‰ªò„Åë„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü: ' + (data.members.find(m => m.id === memberId)?.name || memberId));
            } catch (err) {
                alert('Êõ¥Êñ∞Â§±Êïó: ' + err.message);
            }
        }

        function addMember() {
            try {
                console.log('=== addMemberÈñãÂßã ===');
                const name = document.getElementById('newMemberName').value.trim();
                console.log('ÂÖ•Âäõ„Åï„Çå„ÅüÂêçÂâç:', name);
                if (!name) { alert('ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }

                const newMember = { id: 'mem_' + Date.now(), name };
                console.log('Êñ∞„Åó„ÅÑ„É°„É≥„Éê„Éº:', newMember);
                data.members.push(newMember);
                console.log('ÁèæÂú®„ÅÆ„É°„É≥„Éê„ÉºÊï∞:', data.members.length);

                saveData();
                closeModal('memberModal');
                document.getElementById('newMemberName').value = '';

                console.log('renderAll()„ÇíÂëº„Å≥Âá∫„Åó„Åæ„Åô');
                renderAll();

                console.log('‚úÖ „É°„É≥„Éê„ÉºËøΩÂä†ÂÆå‰∫Ü');
            } catch (e) {
                console.error('‚ùå „É°„É≥„Éê„ÉºËøΩÂä†„Ç®„É©„Éº:', e);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + e.message);
            }
        }

        function deleteMember(id) {
            if (!confirm('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
            data.members = data.members.filter(m => m.id !== id);
            // ÂâäÈô§„Åï„Çå„Åü„É°„É≥„Éê„ÉºID„ÇíËøΩË∑°„É™„Çπ„Éà„Å´ËøΩÂä†
            if (!data.deletedMembers) data.deletedMembers = [];
            if (!data.deletedMembers.includes(id)) {
                data.deletedMembers.push(id);
            }
            saveData();
            renderAll();
        }

        // „Éá„Éº„Çø
        let firebaseInitialized = false;

        let lastBackupDate = null;

        async function createBackup(reason) {
            if (!firebaseInitialized) return;
            try {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const backupRef = database.ref('backups/' + TEAM_ID + '/' + timestamp);
                const backupData = {
                    reason: reason,
                    createdAt: Date.now(),
                    data: JSON.parse(JSON.stringify(data))
                };
                await backupRef.set(backupData);
                await cleanupOldBackups();
                console.log('üì¶ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ΩúÊàê:', reason);
            } catch (err) {
                console.error('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ΩúÊàê„Ç®„É©„Éº:', err);
            }
        }

        async function cleanupOldBackups() {
            const ref = database.ref('backups/' + TEAM_ID);
            const snapshot = await ref.orderByChild('createdAt').once('value');
            const backups = [];
            snapshot.forEach(child => backups.push({ key: child.key, createdAt: child.val().createdAt }));
            if (backups.length > 20) {
                backups.sort((a, b) => a.createdAt - b.createdAt);
                const toDelete = backups.slice(0, backups.length - 20);
                for (const b of toDelete) {
                    await ref.child(b.key).remove();
                }
            }
        }

        async function loadBackupList() {
            if (!firebaseInitialized) return;
            const listEl = document.getElementById('backupList');
            if (!listEl) return;
            try {
                const ref = database.ref('backups/' + TEAM_ID);
                const snapshot = await ref.orderByChild('createdAt').once('value');
                const backups = [];
                snapshot.forEach(child => {
                    const val = child.val();
                    backups.push({ key: child.key, reason: val.reason, createdAt: val.createdAt });
                });
                backups.sort((a, b) => b.createdAt - a.createdAt);

                if (backups.length === 0) {
                    listEl.innerHTML = '<p style="color:#64748b;font-size:13px">„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                    return;
                }

                listEl.innerHTML = backups.map(b => {
                    const d = new Date(b.createdAt);
                    const dateStr = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#0f172a;border-radius:6px;margin-bottom:4px">
                        <div>
                            <span style="color:#e2e8f0;font-size:13px">${dateStr}</span>
                            <span style="color:#64748b;font-size:12px;margin-left:8px">${b.reason || ''}</span>
                        </div>
                        <button class="btn" style="background:#3b82f6;font-size:11px;padding:4px 10px" onclick="restoreBackup('${b.key}')">Âæ©ÂÖÉ</button>
                    </div>`;
                }).join('');
            } catch (err) {
                console.error('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰∏ÄË¶ßÂèñÂæó„Ç®„É©„Éº:', err);
                listEl.innerHTML = '<p style="color:#ef4444;font-size:13px">‰∏ÄË¶ß„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>';
            }
        }

        async function restoreBackup(key) {
            if (!confirm('„Åì„ÅÆ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Å´Âæ©ÂÖÉ„Åó„Åæ„Åô„ÅãÔºü\nÁèæÂú®„ÅÆ„Éá„Éº„Çø„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇ')) return;
            try {
                await createBackup('Âæ©ÂÖÉÂâç„ÅÆËá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó');
                const snapshot = await database.ref('backups/' + TEAM_ID + '/' + key).once('value');
                const backup = snapshot.val();
                if (!backup || !backup.data) {
                    alert('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    return;
                }
                data = backup.data;
                saveData();
                renderAll();
                alert('Âæ©ÂÖÉÂÆå‰∫Ü');
            } catch (err) {
                console.error('Âæ©ÂÖÉ„Ç®„É©„Éº:', err);
                alert('Âæ©ÂÖÉ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + err.message);
            }
        }

        async function createManualBackup() {
            await createBackup('ÊâãÂãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó');
            alert('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü');
            loadBackupList();
        }

        function saveData() {
            localStorage.setItem('salesPro_personal', JSON.stringify(data));
            saveToFirebase();
        }

        let debugSaveCount = 0;
        let debugListenerCount = 0;
        let saveTimer = null;
        let isSaving = false;

        function saveToFirebase() {
            if (!firebaseInitialized) return;
            // „Éá„Éê„Ç¶„É≥„Çπ: 800ms‰ª•ÂÜÖ„ÅÆÈÄ£Á∂öÂëº„Å≥Âá∫„Åó„Çí„Åæ„Å®„ÇÅ„Çã
            const text = document.getElementById('syncText');
            const dot = document.getElementById('syncDot');
            if (text) text.textContent = 'üíæ ‰øùÂ≠ò‰∏≠...';
            if (dot) dot.className = 'sync-dot syncing';
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(() => doFirebaseSave(), 800);
        }

        function doFirebaseSave() {
            // Êó•Ê¨°Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÔºà1Êó•1ÂõûÔºâ
            const today = new Date().toDateString();
            if (lastBackupDate !== today) {
                lastBackupDate = today;
                createBackup('Êó•Ê¨°Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó');
            }

            const text = document.getElementById('syncText');
            const dot = document.getElementById('syncDot');

            isSaving = true;
            const localData = JSON.parse(JSON.stringify(data));
            localData.lastUpdated = Date.now();

            // „Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥„ÅßË™≠„ÅøÂèñ„Çä‚Üí„Éû„Éº„Ç∏‚ÜíÊõ∏„ÅçËæº„ÅøÔºà‰ªñ‰∫∫„ÅÆÂ§âÊõ¥„Çí‰∏äÊõ∏„Åç„Åó„Å™„ÅÑÔºâ
            database.ref('teams/' + TEAM_ID).transaction(currentData => {
                if (!currentData) return localData;
                // Firebase‰∏ä„ÅÆÊúÄÊñ∞„Éá„Éº„Çø„Å´„É≠„Éº„Ç´„É´„ÅÆÂ§âÊõ¥„Çí„Éû„Éº„Ç∏
                deepMerge(currentData, localData);
                return currentData;
            })
                .then((result) => {
                    // „Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥ÊàêÂäüÂæå„ÄÅFirebase„ÅÆ„Éû„Éº„Ç∏Ê∏à„ÅøÊúÄÁµÇÁä∂ÊÖã„Åß„É≠„Éº„Ç´„É´„ÇíÁΩÆÊèõ
                    if (result.committed && result.snapshot) {
                        const merged = result.snapshot.val();
                        if (merged) {
                            // „Éû„Éº„Ç∏Ê∏à„Åø„Éá„Éº„Çø„ÅßÁõ¥Êé•‰∏äÊõ∏„ÅçÔºàdeepMerge„Åó„Å™„ÅÑ‚Üí‰∫åÈáçÈÅ©Áî®Èò≤Ê≠¢Ôºâ
                            const localOnlyKeys = ['deletedMembers'];
                            Object.keys(merged).forEach(k => { data[k] = merged[k]; });
                            // ÈÖçÂàó‰øÆÂæ©
                            if (data.members && !Array.isArray(data.members))
                                data.members = Object.values(data.members);
                            if (!data.members) data.members = [];
                            if (data.accounts && !Array.isArray(data.accounts))
                                data.accounts = Object.values(data.accounts);
                            localStorage.setItem('salesPro_personal', JSON.stringify(data));
                        }
                    }
                    isSaving = false;
                    debugSaveCount++;
                    const el = document.getElementById('debugSaveCount');
                    if (el) el.textContent = 'ÈÄÅ‰ø°: ' + debugSaveCount + 'Âõû';
                    console.log('üî• Firebase‰øùÂ≠òÂÆå‰∫Ü v3.2 (transaction+smartMerge), ÈÄÅ‰ø°#' + debugSaveCount);
                    if (text) text.textContent = '‚úì ‰øùÂ≠òÂÆå‰∫Ü';
                    if (dot) dot.className = 'sync-dot';
                    setTimeout(() => { updateSyncStatus(); }, 2000);
                })
                .catch(err => {
                    isSaving = false;
                    console.error('Firebase‰øùÂ≠ò„Ç®„É©„Éº:', err);
                    if (text) text.textContent = '‚ùå ‰øùÂ≠ò„Ç®„É©„Éº';
                    if (dot) dot.className = 'sync-dot offline';
                    alert('‰øùÂ≠ò„Ç®„É©„Éº: ' + err.message);
                });
        }

        function loadData() {
            const s = localStorage.getItem('salesPro_personal');
            if (s) {
                data = JSON.parse(s);
                if (!data.monthVideos) data.monthVideos = {};
                if (!data.monthlyRates) data.monthlyRates = {};
                if (!data.settings.budget) {
                    data.settings.budget = data.settings.weekly || { post: 56, apoGet: 50, apoExec: 46, doinGet: 7, doinExec: 4, mendan: 2, seiyaku: 1 };
                }
                if (!data.lastUpdated) data.lastUpdated = null;
                if (!data.deletedMembers) data.deletedMembers = [];
                // members„ÅåÈÖçÂàó„Åß„ÅÇ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
                if (data.members && !Array.isArray(data.members)) {
                    data.members = Object.values(data.members);
                    console.log('‚ö†Ô∏è loadData: members„Çí„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Åã„ÇâÈÖçÂàó„Å´Â§âÊèõ„Åó„Åæ„Åó„Åü');
                }
                if (!data.members) {
                    data.members = [];
                }
                if (data.weeks) {
                    for (const weekKey in data.weeks) {
                        if (data.weeks[weekKey].review && !data.weeks[weekKey].review.ngReasons) {
                            data.weeks[weekKey].review.ngReasons = {};
                        }
                    }
                }
            }
        }

        function deepMerge(target, source) {
            for (const key of Object.keys(source)) {
                const s = source[key];
                const t = target[key];

                if (s && typeof s === 'object' && !Array.isArray(s)
                    && t && typeof t === 'object' && !Array.isArray(t)) {
                    // „Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÂêåÂ£´: ÂÜçÂ∏∞„Éû„Éº„Ç∏
                    deepMerge(t, s);
                } else if (Array.isArray(s) && Array.isArray(t)
                    && s.length === t.length && s.length > 0
                    && typeof s[0] === 'number') {
                    // Âêå„ÅòÈï∑„Åï„ÅÆÊï∞ÂÄ§ÈÖçÂàóÔºàÊó•Âà•„Éá„Éº„Çø [0,0,0,0,0,0,0]Ôºâ: Ë¶ÅÁ¥†Âçò‰Ωç„Éû„Éº„Ç∏
                    // source„Å´Èùû„Çº„É≠ÂÄ§„Åå„ÅÇ„Çå„Å∞„Åù„Å°„Çâ„ÇíÊé°Áî®„ÄÅ„Å™„Åë„Çå„Å∞target„ÇíÁ∂≠ÊåÅ
                    for (let i = 0; i < s.length; i++) {
                        if (s[i] !== 0) {
                            t[i] = s[i];
                        }
                    }
                } else if ((key === 'members' || key === 'accounts')
                    && Array.isArray(s) && Array.isArray(t)) {
                    // members/accountsÈÖçÂàó: IDÂü∫Ê∫ñ„Åß„Éû„Éº„Ç∏ÔºàËøΩÂä†„ÉªÊõ¥Êñ∞„Çí‰∏°Á´ãÔºâ
                    const merged = [...t];
                    s.forEach(sItem => {
                        if (!sItem || !sItem.id) return;
                        const idx = merged.findIndex(m => m && m.id === sItem.id);
                        if (idx >= 0) {
                            merged[idx] = sItem; // Êó¢Â≠ò: Êõ¥Êñ∞
                        } else {
                            merged.push(sItem);  // Êñ∞Ë¶è: ËøΩÂä†
                        }
                    });
                    target[key] = merged;
                } else {
                    target[key] = s;
                }
            }
        }

        function setupFirebaseListener() {
            database.ref('teams/' + TEAM_ID).on('value', (snapshot) => {
                const firebaseData = snapshot.val();
                if (!firebaseData) return;

                // Ëá™ÂàÜ„ÅÆÊõ∏„ÅçËæº„Åø‰∏≠„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºà„Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥ÂÆå‰∫ÜÂæå„Å´ÂèçÊò†Ê∏à„ÅøÔºâ
                if (isSaving) return;

                debugListenerCount++;
                const now = new Date();
                const timeStr = now.getHours() + ':' + String(now.getMinutes()).padStart(2,'0') + ':' + String(now.getSeconds()).padStart(2,'0');

                // Ë®∫Êñ≠Ë°®Á§∫Êõ¥Êñ∞
                const dp = document.getElementById('debugPanel');
                if (dp) dp.style.display = 'block';
                const el1 = document.getElementById('debugLastSync');
                if (el1) el1.textContent = 'ÂêåÊúü: ' + timeStr;
                const el2 = document.getElementById('debugListenerCount');
                if (el2) el2.textContent = 'Âèó‰ø°: ' + debugListenerCount + 'Âõû';

                // „Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂÖ•ÂäõÊ¨Ñ„ÅÆÁä∂ÊÖã„Çí‰øùÂ≠òÔºàÂÜçÊèèÁîªÂæå„Å´Âæ©ÂÖÉ„Åô„Çã„Åü„ÇÅÔºâ
                const activeEl = document.activeElement;
                let savedInput = null;
                if (activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.tagName === 'SELECT')) {
                    savedInput = {
                        id: activeEl.id,
                        name: activeEl.name,
                        value: activeEl.value,
                        selStart: activeEl.selectionStart,
                        selEnd: activeEl.selectionEnd,
                        // onchangeÂ±ûÊÄß„ÅßË¶ÅÁ¥†„ÇíÁâπÂÆöÔºàID„Åå„Å™„ÅÑÂ†¥ÂêàÔºâ
                        onchange: activeEl.getAttribute('onchange') || ''
                    };
                }

                // „Éá„Ç£„Éº„Éó„Éû„Éº„Ç∏Ôºà„Éç„Çπ„ÉàÊßãÈÄ†„Çí‰øùÊåÅÔºâ
                deepMerge(data, firebaseData);

                // ÈÖçÂàó‰øÆÂæ©ÔºàFirebase„ÅØ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´Â§âÊèõ„Åô„ÇãÂ†¥Âêà„Åå„ÅÇ„ÇãÔºâ
                if (data.members && !Array.isArray(data.members)) {
                    data.members = Object.values(data.members);
                }
                if (!data.members) data.members = [];
                if (data.accounts && !Array.isArray(data.accounts)) {
                    data.accounts = Object.values(data.accounts);
                }

                // userMap„ÅÆÊõ¥Êñ∞
                if (firebaseData.userMap) userMap = firebaseData.userMap;

                localStorage.setItem('salesPro_personal', JSON.stringify(data));
                updateHeaderUserInfo();
                renderAll();

                // „Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂÖ•ÂäõÊ¨Ñ„ÅÆÂæ©ÂÖÉ
                if (savedInput) {
                    let target = null;
                    if (savedInput.id) {
                        target = document.getElementById(savedInput.id);
                    }
                    if (!target && savedInput.onchange) {
                        target = document.querySelector('[onchange="' + CSS.escape(savedInput.onchange) + '"]')
                            || document.querySelector('[onchange="' + savedInput.onchange.replace(/"/g, '&quot;') + '"]');
                    }
                    if (target) {
                        target.focus();
                        if (target.value !== savedInput.value) {
                            target.value = savedInput.value;
                        }
                        try {
                            if (savedInput.selStart !== null) {
                                target.setSelectionRange(savedInput.selStart, savedInput.selEnd);
                            }
                        } catch(e) {}
                    }
                }

                console.log('üî• FirebaseÂêåÊúüÂÆå‰∫Ü v3.2 (smartMerge+preserve) Âèó‰ø°#' + debugListenerCount + ', „É°„É≥„Éê„ÉºÊï∞:', data.members.length);
            });
            firebaseInitialized = true;
            updateSyncStatus();
            console.log('üî• Firebase„É™„Çπ„Éä„ÉºË®≠ÂÆöÂÆå‰∫Ü v3.2');
        }

        // Âº∑Âà∂ÂÜçË™≠Ëæº: Firebase„Åã„ÇâÊúÄÊñ∞„Éá„Éº„Çø„ÇíÂèñÂæó
        async function forceReload() {
            try {
                const snapshot = await database.ref('teams/' + TEAM_ID).once('value');
                const firebaseData = snapshot.val();
                if (firebaseData) {
                    deepMerge(data, firebaseData);
                    if (data.members && !Array.isArray(data.members)) data.members = Object.values(data.members);
                    if (!data.members) data.members = [];
                    if (data.accounts && !Array.isArray(data.accounts)) data.accounts = Object.values(data.accounts);
                    if (firebaseData.userMap) userMap = firebaseData.userMap;
                    localStorage.setItem('salesPro_personal', JSON.stringify(data));
                    renderAll();
                    alert('ÂÜçË™≠ËæºÂÆå‰∫ÜÔºÅ„É°„É≥„Éê„ÉºÊï∞: ' + data.members.length);
                } else {
                    alert('Firebase„Å´„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                }
            } catch (err) {
                alert('ÂÜçË™≠Ëæº„Ç®„É©„Éº: ' + err.message);
            }
        }

        function saveAll() { saveReview(); saveData(); }

        async function loadFromCloud() {
            console.log('üî• Firebase„É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü‰∏≠...');
            return true;
        }

        function exportData() {
            saveAll();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `sales-data-${getWeekKey()}.json`;
            a.click();
        }

        function importData(e) {
            const f = e.target.files[0];
            if (!f) return;
            createBackup('JSON„Ç§„É≥„Éù„Éº„ÉàÂâç');
            const r = new FileReader();
            r.onload = ev => { try { data = JSON.parse(ev.target.result); saveData(); renderAll(); alert('„Ç§„É≥„Éù„Éº„ÉàÂÆå‰∫Ü'); } catch { alert('Ë™≠„ÅøËæº„ÅøÂ§±Êïó'); } };
            r.readAsText(f);
            e.target.value = '';
        }

        function exportInstagramCSV() {
            const weekKey = getWeekKey();
            const weekData = data.weeks[weekKey];
            if (!weekData || !weekData.instagram) {
                alert('„Åì„ÅÆÈÄ±„ÅÆInstagram„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            const days = ['Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü', 'Êó•'];
            const headers = ['„Ç¢„Ç´„Ç¶„É≥„ÉàÂêç', 'Êó•‰ªò', '„Éï„Ç©„É≠„Éº', '„Éï„Ç©„É≠„ÉØ„Éº', '„Éï„Ç©„É≠„ÉºËß£Èô§', '„Éï„Ç©„É≠„ÉØ„ÉºËß£Èô§', 'DMÈÄÅ‰ø°', 'DMËøî‰ø°', 'DM„Ç™„Éï„Ç°„Éº', '„Ç¢„ÉùÁç≤Âæó', '„Ç¢„ÉùÂÆüÊñΩ', 'ÂãïÂì°‰∫àÂÆö', 'ÂãïÂì°ÂÆüÊñΩ', 'ÊàêÁ¥Ñ', '„Éñ„É≠„ÉÉ„ÇØ'];

            let csv = headers.join(',') + '\n';

            data.accounts.forEach(account => {
                const igData = weekData.instagram[account.id];
                if (!igData) return;

                for (let i = 0; i < 7; i++) {
                    const row = [
                        `"${account.name}"`,
                        days[i],
                        igData.follow?.[i] || 0,
                        igData.follower?.[i] || 0,
                        igData.followCut?.[i] || 0,
                        igData.followerCut?.[i] || 0,
                        igData.dmSend?.[i] || 0,
                        igData.dmReply?.[i] || 0,
                        igData.dmOffer?.[i] || 0,
                        igData.apoGet?.[i] || 0,
                        igData.apoExec?.[i] || 0,
                        igData.doinPlan?.[i] || 0,
                        igData.doinExec?.[i] || 0,
                        igData.seiyaku?.[i] || 0,
                        igData.blocked?.[i] ? '„ÅØ„ÅÑ' : '„ÅÑ„ÅÑ„Åà'
                    ];
                    csv += row.join(',') + '\n';
                }
            });

            csv += '\n--- ÈÄ±Âà•ÂêàË®à ---\n';
            csv += '„Ç¢„Ç´„Ç¶„É≥„ÉàÂêç,„Éï„Ç©„É≠„ÉºË®à,„Éï„Ç©„É≠„ÉØ„ÉºË®à,DMÈÄÅ‰ø°Ë®à,DMËøî‰ø°Ë®à,DM„Ç™„Éï„Ç°„ÉºË®à,„Ç¢„ÉùÁç≤ÂæóË®à,„Ç¢„ÉùÂÆüÊñΩË®à,ÂãïÂì°ÂÆüÊñΩË®à,ÊàêÁ¥ÑË®à\n';

            data.accounts.forEach(account => {
                const igData = weekData.instagram[account.id];
                if (!igData) return;

                const sum = (arr) => (arr || []).reduce((a, b) => a + (b || 0), 0);
                const row = [
                    `"${account.name}"`,
                    sum(igData.follow),
                    sum(igData.follower),
                    sum(igData.dmSend),
                    sum(igData.dmReply),
                    sum(igData.dmOffer),
                    sum(igData.apoGet),
                    sum(igData.apoExec),
                    sum(igData.doinExec),
                    sum(igData.seiyaku)
                ];
                csv += row.join(',') + '\n';
            });

            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csv], { type: 'text/csv;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `instagram-${weekKey}.csv`;
            a.click();
        }

        function clearData() { if (!confirm('ÂÖ®„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return; localStorage.removeItem('salesPro_personal'); location.reload(); }

        function resetLocalOnly() {
            const msg = `„Äê„É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÅÆ„É™„Çª„ÉÉ„Éà„Äë

„Åì„Çå„ÇíÂÆüË°å„Åô„Çã„Å®Ôºö
‚úÖ „ÅÇ„Å™„Åü„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅÆ„Éá„Éº„Çø„Å†„Åë„Åå„ÇØ„É™„Ç¢„Åï„Çå„Åæ„Åô
‚úÖ Firebase„ÅÆ„Éá„Éº„Çø„Å´„ÅØÂΩ±Èüø„Åó„Åæ„Åõ„Çì
‚úÖ „É™„Çª„ÉÉ„ÉàÂæå„ÄÅFirebase„Åã„ÇâÊúÄÊñ∞„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Åæ„Åô

Á∂öË°å„Åó„Åæ„Åô„ÅãÔºü`;
            if (!confirm(msg)) return;

            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Çí„ÇØ„É™„Ç¢
            localStorage.removeItem('salesPro_personal');

            alert('„É≠„Éº„Ç´„É´„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇ\n\n„Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Åæ„Åô„ÄÇ');
            location.reload();
        }

        // ===========================================================
        // Change 1 & 3: ÊúàÂà•„Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏Ë®òÈå≤„ÉªÂèñÂæóÊ©üËÉΩ
        // ===========================================================

        /**
         * „É°„É≥„Éê„Éº„ÅÆÊåáÂÆöÊúà„ÅÆÂÖ®ÈÄ±„Éá„Éº„Çø„Åã„Çâ„Éà„Éº„Çø„É´„ÇíË®àÁÆó„Åô„Çã
         * ÔºàcalcMemberTotals „Å®ÂêåÊßò„Å†„Åå„ÄÅ‰ªªÊÑè„ÅÆÂπ¥Êúà„ÇíÊåáÂÆöÂèØËÉΩÔºâ
         */
        function calcMemberTotalsForMonth(memberId, year, month) {
            console.log(`[calcMemberTotalsForMonth] memberId=${memberId}, year=${year}, month=${month}`);
            const t = {};
            metrics.forEach(c => c.items.forEach(m => t[m.key] = 0));

            const maxW = getMaxWeekNum(year, month);
            for (let w = 1; w <= maxW; w++) {
                const weekKey = `${year}-${month}-W${w}`;
                const weekData = data.weeks[weekKey];
                if (weekData && weekData.daily && weekData.daily[memberId]) {
                    const d = weekData.daily[memberId];
                    metrics.forEach(c => c.items.forEach(met => {
                        t[met.key] += safeArraySum(d[met.key]);
                    }));
                }
            }
            console.log(`[calcMemberTotalsForMonth] ÁµêÊûú:`, JSON.stringify(t));
            return t;
        }

        /**
         * ÊåáÂÆö„É°„É≥„Éê„Éº„ÉªÊåáÂÆöÊúà„ÅÆÂ§âÊèõÁéá„ÇíË®àÁÆó„Åô„Çã
         */
        function calcRatesFromTotals(totals) {
            const safeDiv = (a, b) => b > 0 ? a / b : 0;
            const rates = {
                apoGetRate: safeDiv(totals.apoGet, totals.post || 0),         // „Ç¢„ÉùÁç≤ÂæóÁéá = „Ç¢„ÉùÁç≤Âæó/ÊäïÁ®ø
                apoExecRate: safeDiv(totals.apoExec, totals.apoGet),           // „Ç¢„ÉùÂÆüÊñΩÁéá = „Ç¢„ÉùÂÆüÊñΩ/„Ç¢„ÉùÁç≤Âæó
                doinGetRate: safeDiv(totals.doinGet, totals.apoExec),          // ÂãïÂì°Áç≤ÂæóÁéá = ÂãïÂì°Áç≤Âæó/„Ç¢„ÉùÂÆüÊñΩ
                doinExecRate: safeDiv(totals.doinExec, totals.doinGet),        // ÂãïÂì°ÂÆüÊñΩÁéá = ÂãïÂì°ÂÆüÊñΩ/ÂãïÂì°Áç≤Âæó
                mendanExecRate: safeDiv(totals.mendanExec, totals.mendanGet),  // Èù¢Ë´áÂÆüÊñΩÁéá = Èù¢Ë´áÂÆüÊñΩ/Èù¢Ë´áÁç≤Âæó
                seiyakuRate: safeDiv(totals.seiyaku, totals.doinExec)          // ÊàêÁ¥ÑÁéá = ÊàêÁ¥Ñ/ÂãïÂì°ÂÆüÊñΩ
            };
            console.log(`[calcRatesFromTotals] ÁÆóÂá∫Áéá:`, JSON.stringify(rates));
            return rates;
        }

        /**
         * Change 3: „É°„É≥„Éê„Éº„ÅÆÊúàÂà•„Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏„ÇíFirebase„Å´‰øùÂ≠ò„Åô„Çã
         */
        function saveMonthlyRates(memberId, monthKey) {
            console.log(`[saveMonthlyRates] ÈñãÂßã: memberId=${memberId}, monthKey=${monthKey}`);

            if (!memberId || memberId === 'all') {
                console.error('[saveMonthlyRates] ÁÑ°Âäπ„Å™memberId:', memberId);
                return null;
            }

            // monthKey„Åã„Çâyear, month„ÇíÂèñÂæó
            const parts = monthKey.split('-');
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]);

            // „Åù„ÅÆ„É°„É≥„Éê„Éº„ÅÆ„Åù„ÅÆ„ÅÆÊúà„ÅÆÂÖ®„Éá„Éº„Çø„ÇíÈõÜË®à
            const totals = calcMemberTotalsForMonth(memberId, year, month);

            // Â§âÊèõÁéá„ÇíË®àÁÆó
            const rates = calcRatesFromTotals(totals);

            // ‰øùÂ≠ò„Éá„Éº„Çø„ÇíÊßãÁØâ
            const rateData = {
                apoGetRate: rates.apoGetRate,
                apoExecRate: rates.apoExecRate,
                doinGetRate: rates.doinGetRate,
                doinExecRate: rates.doinExecRate,
                mendanExecRate: rates.mendanExecRate,
                seiyakuRate: rates.seiyakuRate,
                savedAt: Date.now(),
                totals: {
                    post: totals.post || 0,
                    apoGet: totals.apoGet || 0,
                    apoExec: totals.apoExec || 0,
                    doinGet: totals.doinGet || 0,
                    doinExec: totals.doinExec || 0,
                    mendanGet: totals.mendanGet || 0,
                    mendanExec: totals.mendanExec || 0,
                    seiyaku: totals.seiyaku || 0
                }
            };

            // data.monthlyRates„Å´‰øùÂ≠ò
            if (!data.monthlyRates) data.monthlyRates = {};
            if (!data.monthlyRates[memberId]) data.monthlyRates[memberId] = {};
            data.monthlyRates[memberId][monthKey] = rateData;

            console.log(`[saveMonthlyRates] ‰øùÂ≠ò„Éá„Éº„Çø:`, JSON.stringify(rateData));

            // Firebase„Å´‰øùÂ≠ò
            saveData();

            return rateData;
        }

        /**
         * Change 3: ÈÅéÂéª2„É∂Êúà„ÅÆÂπ≥ÂùáÂ§âÊèõÁéá„ÇíÂèñÂæó„Åô„Çã
         */
        function getAvgPastRates(memberId) {
            console.log(`[getAvgPastRates] ÈñãÂßã: memberId=${memberId}`);

            if (!memberId || memberId === 'all') {
                console.log('[getAvgPastRates] ÁÑ°Âäπ„Å™memberId„ÄÅnullËøîÂç¥');
                return null;
            }

            if (!data.monthlyRates || !data.monthlyRates[memberId]) {
                console.log('[getAvgPastRates] monthlyRates„Éá„Éº„Çø„Å™„Åó„ÄÅnullËøîÂç¥');
                return null;
            }

            const memberRates = data.monthlyRates[memberId];
            const monthKeys = Object.keys(memberRates).sort((a, b) => {
                const [ay, am] = a.split('-').map(Number);
                const [by, bm] = b.split('-').map(Number);
                return (by * 12 + bm) - (ay * 12 + am); // Êñ∞„Åó„ÅÑÈ†ÜÔºàÂπ¥Êúà„ÇíÊï∞ÂÄ§„ÅßÊØîËºÉÔºâ
            });

            // ÁèæÂú®„ÅÆÊúà„Ç≠„Éº„ÇíÈô§Â§ñÔºàË®òÈå≤Ê∏à„Åø„Åß„ÇÇÂΩìÊúà„ÅØÈô§Â§ñÔºâ
            const currentMonthKey = getMonthKey();
            const pastKeys = monthKeys.filter(k => k !== currentMonthKey);

            if (pastKeys.length === 0) {
                console.log('[getAvgPastRates] ÈÅéÂéª„Éá„Éº„Çø„Å™„Åó„ÄÅnullËøîÂç¥');
                return null;
            }

            // ÊúÄÂ§ß2„É∂ÊúàÂàÜÂèñÂæó
            const keysToUse = pastKeys.slice(0, 2);
            console.log(`[getAvgPastRates] ‰ΩøÁî®„Åô„ÇãÊúà:`, keysToUse);

            const rateKeys = ['apoGetRate', 'apoExecRate', 'doinGetRate', 'doinExecRate', 'mendanExecRate', 'seiyakuRate'];
            const avgRates = {};

            rateKeys.forEach(rk => {
                let sum = 0;
                let count = 0;
                keysToUse.forEach(mk => {
                    const val = memberRates[mk][rk];
                    if (val !== undefined && val !== null && !isNaN(val)) {
                        sum += val;
                        count++;
                    }
                });
                avgRates[rk] = count > 0 ? sum / count : 0;
            });

            console.log(`[getAvgPastRates] Âπ≥ÂùáÁéá(${keysToUse.length}„É∂ÊúàÂàÜ):`, JSON.stringify(avgRates));
            return { rates: avgRates, monthsUsed: keysToUse.length, months: keysToUse };
        }

        // ===========================================================
        // Change 2: ‰∫àÁÆó„Åã„ÇâËá™ÂãïË®àÁÆó (x1.2)
        // ===========================================================

        function autoCalcGoals() {
            console.log('[autoCalcGoals] ‰∫àÁÆó„Åã„ÇâÁõÆÊ®ô„ÇíËá™ÂãïË®àÁÆó');

            const budgetFields = [
                { budget: 'bPost', goal: 'mPost' },
                { budget: 'bApoGet', goal: 'mApoGet' },
                { budget: 'bApoExec', goal: 'mApoExec' },
                { budget: 'bDoinGet', goal: 'mDoinGet' },
                { budget: 'bDoinExec', goal: 'mDoinExec' },
                { budget: 'bMendan', goal: 'mMendan' },
                { budget: 'bSeiyaku', goal: 'mSeiyaku' }
            ];

            budgetFields.forEach(({ budget, goal }) => {
                const budgetEl = document.getElementById(budget);
                const goalEl = document.getElementById(goal);
                if (budgetEl && goalEl) {
                    const budgetVal = parseFloat(budgetEl.value) || 0;
                    const calculated = budgetVal * 1.2;
                    // Â∞èÊï∞ÁÇπ‰ª•‰∏ã„Åå.0„Åß„Å™„ÅÑÂ†¥Âêà„ÅØÂàá„Çä‰∏ä„Åí
                    const goalVal = (calculated % 1 === 0) ? calculated : Math.ceil(calculated);
                    goalEl.value = goalVal;
                    console.log(`[autoCalcGoals] ${budget}(${budgetVal}) x 1.2 = ${calculated} ‚Üí ${goalVal}`);

                    // „Éè„Ç§„É©„Ç§„Éà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                    goalEl.classList.remove('settings-updated');
                    void goalEl.offsetWidth;
                    goalEl.classList.add('settings-updated');
                }
            });

            // Èù¢Ë´áÂÆüÊñΩ„ÅØÈù¢Ë´áÁç≤Âæó„Å®Âêå„ÅòÂÄ§„ÇíË®≠ÂÆöÔºàÈù¢Ë´á„ÅØÁç≤Âæó„ÅÆ„Åø‰∫àÁÆó„Åå„ÅÇ„Çã„Åü„ÇÅÔºâ
            const mendanGoal = document.getElementById('mMendan');
            const mendanExecGoal = document.getElementById('mMendanExec');
            if (mendanGoal && mendanExecGoal) {
                mendanExecGoal.value = mendanGoal.value;
            }

            // Ë®≠ÂÆö„Çí‰øùÂ≠ò
            saveSettings();
        }

        // ===========================================================
        // Change 4: ÈÅéÂéªÂÆüÁ∏æ„Åã„ÇâÁõÆÊ®ôËá™ÂãïË®≠ÂÆö
        // ===========================================================

        function autoSetTargetsFromRatesUI() {
            console.log('[autoSetTargetsFromRatesUI] ÈñãÂßã');

            // ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆ„É°„É≥„Éê„Éº„ÇíÂèñÂæó
            const targetMember = (settingsSelectedMember && settingsSelectedMember !== 'all')
                ? settingsSelectedMember
                : selectedMember;

            if (targetMember === 'all') {
                alert('„É°„É≥„Éê„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n„ÄåÂÖ®‰Ωì„ÄçÈÅ∏Êäû‰∏≠„ÅØËá™ÂãïË®≠ÂÆö„Åß„Åç„Åæ„Åõ„Çì„ÄÇ');
                return;
            }

            // ÈÅéÂéªÂÆüÁ∏æ„ÇíÂèñÂæó
            const pastData = getAvgPastRates(targetMember);
            if (!pastData || !pastData.rates) {
                alert('ÈÅéÂéª„ÅÆÂÆüÁ∏æ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ\n\nÂÖà„Å´„Äå‰ªäÊúà„ÅÆÂÆüÁ∏æ„Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏„ÇíË®òÈå≤„Äç„ÅßÈÅéÂéªÊúà„ÅÆ„Éá„Éº„Çø„Çí‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            const rates = pastData.rates;
            const memberName = data.members.find(m => m.id === targetMember)?.name || targetMember;

            // ÊàêÁ¥Ñ‰∫àÁÆó„ÇíÂÖ•Âäõ„Åã„ÇâÂèñÂæó
            const seiyakuBudget = parseInt(document.getElementById('bSeiyaku').value) || 0;
            if (seiyakuBudget <= 0) {
                alert('ÊàêÁ¥Ñ„ÅÆ‰∫àÁÆó„ÇíÂÖà„Å´ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            // ÊàêÁ¥ÑÁõÆÊ®ô = ‰∫àÁÆó x 1.2
            const seiyakuGoal = Math.ceil(seiyakuBudget * 1.2);

            // ÈÄÜÁÆó„Åó„Å¶ÁõÆÊ®ô„ÇíËá™ÂãïË®≠ÂÆö
            autoSetTargetsFromRates(targetMember, rates, seiyakuGoal);

            console.log(`[autoSetTargetsFromRatesUI] ${memberName}„ÅÆÁõÆÊ®ô„ÇíÈÅéÂéª${pastData.monthsUsed}„É∂ÊúàÂπ≥Âùá„Åã„ÇâËá™ÂãïË®≠ÂÆöÂÆå‰∫Ü`);
        }

        function autoSetTargetsFromRates(memberId, rates, seiyakuGoal) {
            console.log(`[autoSetTargetsFromRates] memberId=${memberId}, seiyakuGoal=${seiyakuGoal}`);
            console.log(`[autoSetTargetsFromRates] ‰ΩøÁî®Áéá:`, JSON.stringify(rates));

            // ÈÄÜÁÆó: ÊàêÁ¥ÑÁõÆÊ®ô„Åã„ÇâÂêÑÊåáÊ®ô„ÇíÊ±Ç„ÇÅ„Çã
            // ÂãïÂì°ÂÆüÊñΩÂøÖË¶ÅÊï∞ = ceil(ÊàêÁ¥ÑÁõÆÊ®ô / ÊàêÁ¥ÑÁéá)
            const doinExecGoal = rates.seiyakuRate > 0
                ? Math.ceil(seiyakuGoal / rates.seiyakuRate)
                : seiyakuGoal;

            // ÂãïÂì°Áç≤ÂæóÂøÖË¶ÅÊï∞ = ceil(ÂãïÂì°ÂÆüÊñΩÂøÖË¶ÅÊï∞ / ÂãïÂì°ÂÆüÊñΩÁéá)
            const doinGetGoal = rates.doinExecRate > 0
                ? Math.ceil(doinExecGoal / rates.doinExecRate)
                : doinExecGoal;

            // „Ç¢„ÉùÂÆüÊñΩÂøÖË¶ÅÊï∞ = ceil(ÂãïÂì°Áç≤ÂæóÂøÖË¶ÅÊï∞ / ÂãïÂì°Áç≤ÂæóÁéá)
            const apoExecGoal = rates.doinGetRate > 0
                ? Math.ceil(doinGetGoal / rates.doinGetRate)
                : doinGetGoal;

            // „Ç¢„ÉùÁç≤ÂæóÂøÖË¶ÅÊï∞ = ceil(„Ç¢„ÉùÂÆüÊñΩÂøÖË¶ÅÊï∞ / „Ç¢„ÉùÂÆüÊñΩÁéá)
            const apoGetGoal = rates.apoExecRate > 0
                ? Math.ceil(apoExecGoal / rates.apoExecRate)
                : apoExecGoal;

            // ÊäïÁ®øÂøÖË¶ÅÊï∞ = ceil(„Ç¢„ÉùÁç≤ÂæóÂøÖË¶ÅÊï∞ / „Ç¢„ÉùÁç≤ÂæóÁéá)
            const postGoal = rates.apoGetRate > 0
                ? Math.ceil(apoGetGoal / rates.apoGetRate)
                : apoGetGoal;

            console.log(`[autoSetTargetsFromRates] ÈÄÜÁÆóÁµêÊûú: post=${postGoal}, apoGet=${apoGetGoal}, apoExec=${apoExecGoal}, doinGet=${doinGetGoal}, doinExec=${doinExecGoal}, seiyaku=${seiyakuGoal}`);

            // ÁõÆÊ®ô„Éï„Ç£„Éº„É´„Éâ„Å´Ë®≠ÂÆö
            const setField = (id, val) => {
                const el = document.getElementById(id);
                if (el) {
                    el.value = val;
                    el.classList.remove('settings-updated');
                    void el.offsetWidth;
                    el.classList.add('settings-updated');
                }
            };

            // Èù¢Ë´á„ÇÇÈÄÜÁÆóÔºàÈù¢Ë´áÂÆüÊñΩÁéá„Åã„ÇâÔºâ
            const mendanGoal = rates.mendanExecRate > 0
                ? Math.ceil(doinExecGoal / rates.mendanExecRate)
                : doinExecGoal;

            setField('mPost', postGoal);
            setField('mApoGet', apoGetGoal);
            setField('mApoExec', apoExecGoal);
            setField('mDoinGet', doinGetGoal);
            setField('mDoinExec', doinExecGoal);
            setField('mMendan', mendanGoal);
            setField('mMendanExec', mendanGoal);
            setField('mSeiyaku', seiyakuGoal);

            // Á¢∫Ë™ç„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
            const memberName = data.members.find(m => m.id === memberId)?.name || memberId;
            const msg = `${memberName}„ÅÆÁõÆÊ®ô„ÇíËá™ÂãïË®≠ÂÆö„Åó„Åæ„Åó„Åü:\n\n` +
                `ÊäïÁ®ø: ${postGoal} („Ç¢„ÉùÁç≤ÂæóÁéá: ${(rates.apoGetRate * 100).toFixed(1)}%)\n` +
                `„Ç¢„ÉùÁç≤Âæó: ${apoGetGoal} („Ç¢„ÉùÂÆüÊñΩÁéá: ${(rates.apoExecRate * 100).toFixed(1)}%)\n` +
                `„Ç¢„ÉùÂÆüÊñΩ: ${apoExecGoal} (ÂãïÂì°Áç≤ÂæóÁéá: ${(rates.doinGetRate * 100).toFixed(1)}%)\n` +
                `ÂãïÂì°Áç≤Âæó: ${doinGetGoal} (ÂãïÂì°ÂÆüÊñΩÁéá: ${(rates.doinExecRate * 100).toFixed(1)}%)\n` +
                `ÂãïÂì°ÂÆüÊñΩ: ${doinExecGoal} (ÊàêÁ¥ÑÁéá: ${(rates.seiyakuRate * 100).toFixed(1)}%)\n` +
                `ÊàêÁ¥Ñ: ${seiyakuGoal}`;
            alert(msg);

            // Ë®≠ÂÆö„Çí‰øùÂ≠ò
            saveSettings();
        }

        // ===========================================================
        // Change 6: ‰πñÈõ¢„ÉÅ„Çß„ÉÉ„ÇØÔºàË®≠ÂÆöÁîªÈù¢„ÅßÁõÆÊ®ôvsÂÆüÁ∏æ„ÅÆ‰πñÈõ¢„ÇíË°®Á§∫Ôºâ
        // ===========================================================

        function checkRatesDivergence(memberId) {
            console.log(`[checkRatesDivergence] ÈñãÂßã: memberId=${memberId}`);
            const warningsEl = document.getElementById('ratesDivergenceWarnings');
            if (!warningsEl) return;

            if (!memberId || memberId === 'all') {
                warningsEl.innerHTML = '';
                return;
            }

            const pastData = getAvgPastRates(memberId);
            if (!pastData || !pastData.rates) {
                warningsEl.innerHTML = '<p style="font-size:12px;color:#64748b">ÈÅéÂéª„ÅÆÂÆüÁ∏æ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„ÇìÔºà‰πñÈõ¢„ÉÅ„Çß„ÉÉ„ÇØ‰∏çÂèØÔºâ</p>';
                return;
            }

            // ÁèæÂú®„ÅÆÁõÆÊ®ô„Åã„ÇâÊöóÈªô„ÅÆÂ§âÊèõÁéá„ÇíË®àÁÆó
            const monthKey = getMonthKey();
            const goals = getMemberGoals(memberId);
            const safeDiv = (a, b) => b > 0 ? a / b : 0;

            const goalRates = {
                apoGetRate: safeDiv(goals.apoGet, goals.post),
                apoExecRate: safeDiv(goals.apoExec, goals.apoGet),
                doinGetRate: safeDiv(goals.doinGet, goals.apoExec),
                doinExecRate: safeDiv(goals.doinExec, goals.doinGet),
                seiyakuRate: safeDiv(goals.seiyaku, goals.doinExec)
            };

            const actualRates = pastData.rates;
            const labels = {
                apoGetRate: '„Ç¢„ÉùÁç≤ÂæóÁéá',
                apoExecRate: '„Ç¢„ÉùÂÆüÊñΩÁéá',
                doinGetRate: 'ÂãïÂì°Áç≤ÂæóÁéá',
                doinExecRate: 'ÂãïÂì°ÂÆüÊñΩÁéá',
                seiyakuRate: 'ÊàêÁ¥ÑÁéá'
            };

            let html = '';
            let hasWarnings = false;

            for (const [key, label] of Object.entries(labels)) {
                const goalRate = goalRates[key] * 100;
                const actualRate = actualRates[key] * 100;

                // ÁõÆÊ®ô„Åå0„ÅÆÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                if (goalRate === 0 && actualRate === 0) continue;

                const divergence = Math.abs(goalRate - actualRate);

                if (divergence > 25) {
                    html += `<div style="padding:6px 10px;background:#7f1d1d;border:1px solid #ef4444;border-radius:6px;margin-bottom:4px;font-size:12px;color:#fca5a5">
                        <strong>${label}:</strong> ÁõÆÊ®ô${goalRate.toFixed(0)}% vs ÂÆüÁ∏æ${actualRate.toFixed(0)}% (${divergence.toFixed(0)}%‰πñÈõ¢)
                    </div>`;
                    hasWarnings = true;
                } else if (divergence > 10) {
                    html += `<div style="padding:6px 10px;background:#78350f;border:1px solid #f59e0b;border-radius:6px;margin-bottom:4px;font-size:12px;color:#fde68a">
                        <strong>${label}:</strong> ÁõÆÊ®ô${goalRate.toFixed(0)}% vs ÂÆüÁ∏æ${actualRate.toFixed(0)}% (${divergence.toFixed(0)}%‰πñÈõ¢)
                    </div>`;
                    hasWarnings = true;
                }
            }

            if (hasWarnings) {
                html = `<p style="font-size:12px;color:#94a3b8;margin-bottom:6px;font-weight:600">ÁõÆÊ®ô vs ÈÅéÂéª${pastData.monthsUsed}„É∂ÊúàÂπ≥Âùá„ÅÆ‰πñÈõ¢„ÉÅ„Çß„ÉÉ„ÇØ:</p>` + html;
            }

            warningsEl.innerHTML = html;
            console.log(`[checkRatesDivergence] ‰πñÈõ¢„ÉÅ„Çß„ÉÉ„ÇØÂÆå‰∫Ü„ÄÅË≠¶ÂëäÊï∞: ${hasWarnings ? '„ÅÇ„Çä' : '„Å™„Åó'}`);
        }

        // ===========================================================
        // Change 7: ÊúàÊú´„Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏Ë®òÈå≤UI
        // ===========================================================

        function previewAndSaveMonthlyRates() {
            console.log('[previewAndSaveMonthlyRates] ÈñãÂßã');

            const targetMember = (settingsSelectedMember && settingsSelectedMember !== 'all')
                ? settingsSelectedMember
                : selectedMember;

            if (targetMember === 'all') {
                // ÂÖ®„É°„É≥„Éê„ÉºÂàÜ„Çí‰∏ÄÊã¨„Åß‰øùÂ≠ò
                const monthKey = getMonthKey();
                let results = [];
                data.members.forEach(m => {
                    const result = saveMonthlyRates(m.id, monthKey);
                    if (result) {
                        results.push({ name: m.name, rates: result });
                    }
                });

                if (results.length === 0) {
                    alert('Ë®òÈå≤„Åß„Åç„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                    return;
                }

                // ÁµêÊûú„ÇíË°®Á§∫
                let html = `<div style="padding:12px;background:#14532d;border:1px solid #22c55e;border-radius:8px">
                    <p style="color:#86efac;font-weight:600;margin-bottom:8px">${monthKey} „ÅÆÂÆüÁ∏æ„Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏„Çí${results.length}ÂêçÂàÜË®òÈå≤„Åó„Åæ„Åó„Åü</p>`;
                results.forEach(r => {
                    html += `<div style="margin-bottom:6px;padding:6px 8px;background:#0f172a;border-radius:4px">
                        <strong style="color:#e2e8f0">${r.name}</strong>
                        <span style="font-size:11px;color:#94a3b8;margin-left:8px">
                            „Ç¢„ÉùÁç≤ÂæóÁéá:${(r.rates.apoGetRate*100).toFixed(1)}%
                            „Ç¢„ÉùÂÆüÊñΩÁéá:${(r.rates.apoExecRate*100).toFixed(1)}%
                            ÂãïÂì°Áç≤ÂæóÁéá:${(r.rates.doinGetRate*100).toFixed(1)}%
                            ÂãïÂì°ÂÆüÊñΩÁéá:${(r.rates.doinExecRate*100).toFixed(1)}%
                            ÊàêÁ¥ÑÁéá:${(r.rates.seiyakuRate*100).toFixed(1)}%
                        </span>
                    </div>`;
                });
                html += `</div>`;

                const resultEl = document.getElementById('monthlyRatesSaveResult');
                if (resultEl) resultEl.innerHTML = html;
                return;
            }

            // ÂÄãÂà•„É°„É≥„Éê„Éº„ÅÆ‰øùÂ≠ò
            const monthKey = getMonthKey();
            const memberName = data.members.find(m => m.id === targetMember)?.name || targetMember;

            // „Éó„É¨„Éì„É•„Éº„ÇíÂÖà„Å´Ë°®Á§∫
            const parts = monthKey.split('-');
            const totals = calcMemberTotalsForMonth(targetMember, parseInt(parts[0]), parseInt(parts[1]));
            const rates = calcRatesFromTotals(totals);

            const previewMsg = `${memberName} (${monthKey}) „ÅÆÂÆüÁ∏æ„Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏:\n\n` +
                `ÊäïÁ®ø: ${totals.post || 0}\n` +
                `„Ç¢„ÉùÁç≤Âæó: ${totals.apoGet || 0} (Áç≤ÂæóÁéá: ${(rates.apoGetRate*100).toFixed(1)}%)\n` +
                `„Ç¢„ÉùÂÆüÊñΩ: ${totals.apoExec || 0} (ÂÆüÊñΩÁéá: ${(rates.apoExecRate*100).toFixed(1)}%)\n` +
                `ÂãïÂì°Áç≤Âæó: ${totals.doinGet || 0} (Áç≤ÂæóÁéá: ${(rates.doinGetRate*100).toFixed(1)}%)\n` +
                `ÂãïÂì°ÂÆüÊñΩ: ${totals.doinExec || 0} (ÂÆüÊñΩÁéá: ${(rates.doinExecRate*100).toFixed(1)}%)\n` +
                `Èù¢Ë´áÁç≤Âæó: ${totals.mendanGet || 0}\n` +
                `Èù¢Ë´áÂÆüÊñΩ: ${totals.mendanExec || 0} (ÂÆüÊñΩÁéá: ${(rates.mendanExecRate*100).toFixed(1)}%)\n` +
                `ÊàêÁ¥Ñ: ${totals.seiyaku || 0} (ÊàêÁ¥ÑÁéá: ${(rates.seiyakuRate*100).toFixed(1)}%)\n\n` +
                `„Åì„ÅÆÂÜÖÂÆπ„ÇíË®òÈå≤„Åó„Åæ„Åô„ÅãÔºü`;

            if (!confirm(previewMsg)) return;

            const result = saveMonthlyRates(targetMember, monthKey);
            if (result) {
                const html = `<div style="padding:12px;background:#14532d;border:1px solid #22c55e;border-radius:8px">
                    <p style="color:#86efac;font-weight:600">${memberName} (${monthKey}) „ÅÆÂÆüÁ∏æ„ÇíË®òÈå≤„Åó„Åæ„Åó„Åü</p>
                    <p style="font-size:12px;color:#94a3b8;margin-top:4px">
                        „Ç¢„ÉùÁç≤ÂæóÁéá:${(result.apoGetRate*100).toFixed(1)}%
                        | „Ç¢„ÉùÂÆüÊñΩÁéá:${(result.apoExecRate*100).toFixed(1)}%
                        | ÂãïÂì°Áç≤ÂæóÁéá:${(result.doinGetRate*100).toFixed(1)}%
                        | ÂãïÂì°ÂÆüÊñΩÁéá:${(result.doinExecRate*100).toFixed(1)}%
                        | Èù¢Ë´áÂÆüÊñΩÁéá:${(result.mendanExecRate*100).toFixed(1)}%
                        | ÊàêÁ¥ÑÁéá:${(result.seiyakuRate*100).toFixed(1)}%
                    </p>
                </div>`;

                const resultEl = document.getElementById('monthlyRatesSaveResult');
                if (resultEl) resultEl.innerHTML = html;
            }
        }

        function showPastRatesHistory() {
            console.log('[showPastRatesHistory] ÈñãÂßã');
            const el = document.getElementById('pastRatesHistory');
            if (!el) return;

            const targetMember = (settingsSelectedMember && settingsSelectedMember !== 'all')
                ? settingsSelectedMember
                : selectedMember;

            if (!data.monthlyRates) {
                el.innerHTML = '<p style="font-size:12px;color:#64748b">Ë®òÈå≤„Åï„Çå„Åü„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            let html = '<div style="padding:12px;background:#1e293b;border-radius:8px">';
            html += '<h4 style="font-size:13px;color:#94a3b8;margin-bottom:8px">ÈÅéÂéª„ÅÆË®òÈå≤‰∏ÄË¶ß</h4>';

            if (targetMember === 'all') {
                // ÂÖ®„É°„É≥„Éê„Éº„ÅÆË®òÈå≤„ÇíË°®Á§∫
                data.members.forEach(m => {
                    if (data.monthlyRates[m.id]) {
                        html += `<div style="margin-bottom:8px"><strong style="color:#e2e8f0;font-size:13px">${m.name}</strong>`;
                        const months = Object.keys(data.monthlyRates[m.id]).sort().reverse();
                        months.forEach(mk => {
                            const r = data.monthlyRates[m.id][mk];
                            html += `<div style="font-size:11px;color:#94a3b8;padding:2px 0 2px 12px">
                                ${mk}: „Ç¢„ÉùÁç≤Âæó${(r.apoGetRate*100).toFixed(1)}% | „Ç¢„ÉùÂÆüÊñΩ${(r.apoExecRate*100).toFixed(1)}% | ÂãïÂì°Áç≤Âæó${(r.doinGetRate*100).toFixed(1)}% | ÂãïÂì°ÂÆüÊñΩ${(r.doinExecRate*100).toFixed(1)}% | ÊàêÁ¥Ñ${(r.seiyakuRate*100).toFixed(1)}%
                            </div>`;
                        });
                        html += `</div>`;
                    }
                });
            } else {
                // ÂÄãÂà•„É°„É≥„Éê„Éº
                const memberName = data.members.find(m => m.id === targetMember)?.name || targetMember;
                html += `<p style="color:#e2e8f0;font-size:13px;margin-bottom:6px">${memberName}</p>`;
                if (data.monthlyRates[targetMember]) {
                    const months = Object.keys(data.monthlyRates[targetMember]).sort().reverse();
                    months.forEach(mk => {
                        const r = data.monthlyRates[targetMember][mk];
                        html += `<div style="font-size:12px;color:#94a3b8;padding:4px 0;border-bottom:1px solid #334155">
                            <strong>${mk}</strong>:
                            ÊäïÁ®ø${r.totals?.post||0}
                            ‚Üí „Ç¢„ÉùÁç≤Âæó${r.totals?.apoGet||0} (${(r.apoGetRate*100).toFixed(1)}%)
                            ‚Üí „Ç¢„ÉùÂÆüÊñΩ${r.totals?.apoExec||0} (${(r.apoExecRate*100).toFixed(1)}%)
                            ‚Üí ÂãïÂì°Áç≤Âæó${r.totals?.doinGet||0} (${(r.doinGetRate*100).toFixed(1)}%)
                            ‚Üí ÂãïÂì°ÂÆüÊñΩ${r.totals?.doinExec||0} (${(r.doinExecRate*100).toFixed(1)}%)
                            ‚Üí ÊàêÁ¥Ñ${r.totals?.seiyaku||0} (${(r.seiyakuRate*100).toFixed(1)}%)
                        </div>`;
                    });
                    if (months.length === 0) {
                        html += '<p style="font-size:12px;color:#64748b">Ë®òÈå≤„Å™„Åó</p>';
                    }
                } else {
                    html += '<p style="font-size:12px;color:#64748b">Ë®òÈå≤„Å™„Åó</p>';
                }
            }

            html += '</div>';
            el.innerHTML = html;
        }

        /**
         * Change 7: ÊúàÊú´„ÅåËøë„ÅÑÂ†¥Âêà„ÅÆËá™Âãï„Éó„É≠„É≥„Éó„ÉàË°®Á§∫
         */
        function checkMonthEndRatePrompt() {
            const today = new Date();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const daysRemaining = daysInMonth - today.getDate();

            const promptEl = document.getElementById('monthEndRatePrompt');
            if (!promptEl) return;

            // ÊúàÊú´7Êó•‰ª•ÂÜÖ
            if (daysRemaining <= 7) {
                // ‰ªäÊúà„ÅÆË®òÈå≤„Åå„Åæ„Å†„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫
                const currentMonthKey = getMonthKey();
                const memberId = getCurrentMemberId();
                if (memberId && data.monthlyRates && data.monthlyRates[memberId] && data.monthlyRates[memberId][currentMonthKey]) {
                    // Êó¢„Å´Ë®òÈå≤Ê∏à„Åø
                    promptEl.style.display = 'none';
                } else {
                    promptEl.style.display = 'block';
                }
            } else {
                promptEl.style.display = 'none';
            }
        }

        init();
    </script>
</body>
</html>
